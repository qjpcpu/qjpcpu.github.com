<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Jason's space]]></title>
  <link href="http://qjpcpu.github.io/atom.xml" rel="self"/>
  <link href="http://qjpcpu.github.io/"/>
  <updated>2018-09-17T15:52:12+08:00</updated>
  <id>http://qjpcpu.github.io/</id>
  <author>
    <name><![CDATA[Jason]]></name>
    <email><![CDATA[qjpcpu@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[Rebuild Ethereum](二)区块基础结构]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/09/10/qu-kuai-ji-chu-jie-gou/"/>
    <updated>2018-09-10T14:24:59+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/09/10/qu-kuai-ji-chu-jie-gou</id>
    <content type="html"><![CDATA[<p>区块链是融合了密码学、分布式技术等等多个计算机领域的产物，虽然这些技术听起来都很高大上，并且不同区块链的源码看起来也都是很庞杂，令人望而生畏，但是我们回归到区块链最本身，她的基础数据结构——“链”，却是很简单的，就是一条单向链表。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">数据结构</a>    <ul>
      <li><a href="#header">Header</a></li>
      <li><a href="#transactions">Transactions</a></li>
    </ul>
  </li>
  <li><a href="#section-1">存储结构</a>    <ul>
      <li><a href="#section-2">区块头</a></li>
      <li><a href="#section-3">区块体</a></li>
      <li><a href="#section-4">交易索引</a></li>
      <li><a href="#section-5">其他</a></li>
    </ul>
  </li>
  <li><a href="#section-6">为什么是单向链表呢？</a>    <ul>
      <li><a href="#section-7">简单</a></li>
      <li><a href="#section-8">世界线</a></li>
    </ul>
  </li>
  <li><a href="#rebuild">关于rebuild</a></li>
</ul>

<h1 id="section">数据结构</h1>

<p>首先，我们来看看以太坊区块的基本结构(省略了部分非核心成员变量)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Block represents an entire block in the Ethereum blockchain.</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">Block</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">header</span>       <span class="o">*</span><span class="nx">Header</span>
</span><span class="line">	<span class="nx">transactions</span> <span class="nx">Transactions</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// 省略其他辅助成员</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>一个区块主要由两部分组成: <code>Header</code>和 <code>Transactions</code>列表。</p>

<p><code>Transactions</code>列表就是区块的核心业务数据，无论是ETH的转账，还是某个合约调用，他们都是以一笔笔交易的形式打包到区块里,区块链被称之为分布式账本，那么这些交易就是构成账本的一笔笔流水,通过从账本第一页逐笔交易”翻阅”到最后一页,就可以还原成每个人所以的交易及账户余额。</p>

<p><code>Header</code>是区块链的索引结构，也可以看做单向链表的指向”上一个链节点”的指针，我们所谓的”翻阅”这个行为，其实就是根据这个<code>Header</code>指针遍历单向链表的过程。</p>

<p>看到这里，有数据结构基础的同学应该已经非常明白区块链的核心结构了。生产环境的区块链结果不外乎就是这条单向链表在易用性、安全性、传输、存储等多方便调和的产物。</p>

<p>下面我们还是看看以太坊的具体实现。</p>

<h2 id="header">Header</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Header represents a block header in the Ethereum blockchain.</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">Header</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">ParentHash</span>  <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;parentHash&quot;       gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">Number</span>      <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>       <span class="s">`json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// 省略其他非结构性成员</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>header</code>的结构成员有大概15个，这里我们省略了其他和链遍历无关的成员(其他成员也很重要，包含挖矿难度、交易、共识相关参数，只是与本文无关,详细介绍可以参考<a href="http://qjpcpu.github.io/blog/2018/02/24/shen-ru-ethereumyuan-ma-cong-qu-kuai-tou-kan-gong-shi-wa-kuang/">从区块头看共识挖矿</a>).</p>

<p>结构体里面的<code>ParentHash</code>就是上一个区块的”地址”，而这里面还有一个参数<code>Number</code>就是我们常说的区块高度。单向链表的指针可以从当前最新区块回溯到创世区块，而<code>Number</code>就类似于数组序号，可以方便地直接按区块高度直接访问到某个区块。这个两个参数合起来，可以做到随机访问和顺序访问的双重满足。</p>

<blockquote>
  <p>P.S.某个区块的”地址”值由block.Hash()方法获得.</p>
</blockquote>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-core-struct1.jpeg" alt="eth-core-struct1" /></p>

<h2 id="transactions">Transactions</h2>

<p>区块中的<code>Transactions</code>是交易列表,交易结构就是区块链真正的业务数据。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Transaction</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">data</span> <span class="nx">txdata</span>
</span><span class="line">	<span class="c1">// 省略cache成员</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">txdata</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">AccountNonce</span> <span class="kt">uint64</span>          <span class="s">`json:&quot;nonce&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">Price</span>        <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>        <span class="s">`json:&quot;gasPrice&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">GasLimit</span>     <span class="kt">uint64</span>          <span class="s">`json:&quot;gas&quot;      gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">Recipient</span>    <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Address</span> <span class="s">`json:&quot;to&quot;       rlp:&quot;nil&quot;`</span> <span class="c1">// nil means contract creation</span>
</span><span class="line">	<span class="nx">Amount</span>       <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>        <span class="s">`json:&quot;value&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">Payload</span>      <span class="p">[]</span><span class="kt">byte</span>          <span class="s">`json:&quot;input&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// Signature values</span>
</span><span class="line">	<span class="nx">V</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;v&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">R</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;r&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">	<span class="nx">S</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;s&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// This is only used when marshaling to JSON.</span>
</span><span class="line">	<span class="nx">Hash</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span> <span class="s">`json:&quot;hash&quot; rlp:&quot;-&quot;`</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>AccountNonce</code>是每个账户的交易自增序号,以太坊的个人交易其实是串行执行的，比如同一个账户发出<code>AccountNonce=10</code>和<code>AccountNonce=11</code>的两笔交易，即便是11先到区块链节点，最终还是需要等待10号交易打包入区块才有可能执行11号交易。</li>
  <li><code>Price</code>就是矿工的快乐源泉用户的头痛症,gasPrice。</li>
  <li><code>GasLimit</code>交易指令执行上限，这也是耳熟能详的参数了。</li>
  <li><code>Recipient</code>交易收据</li>
  <li><code>Amount</code>交易包含的eth</li>
  <li><code>Payload</code>交易体数据包</li>
  <li><code>V,R,S</code>签名数据</li>
  <li><code>Hash</code>交易hash</li>
</ul>

<h1 id="section-1">存储结构</h1>

<p>以太坊底层使用leveldb作为基础存储层，leveldb是一个高性能的k-v本地存储。那么我们主要看看它是怎么把区块数据组织起来便于CRUD的。</p>

<h2 id="section-2">区块头</h2>

<p>首先是区块头,以太坊中很多时候我们只需要获取区块头，比如轻钱包做区块查询时并不需要获取整个区块数据，仅需要header数据就足够了。</p>

<p>以太坊的区块头是这样的k-v结构:</p>

<ul>
  <li><code>key</code>:固定前缀h+区块高度大端编码+区块hash</li>
  <li><code>value</code>: rlp编码的header头数据</li>
</ul>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-core-struct-header.jpeg" alt="eth-core-struct" /></p>

<h2 id="section-3">区块体</h2>

<p>区块体的存储和区块头非常相似:</p>

<ul>
  <li><code>key</code>:固定前缀b+区块高度大端编码+区块hash</li>
  <li><code>value</code>:rlp编码的交易列表和叔区块header体</li>
</ul>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-core-struct-block.jpeg" alt="eth-core-struct" /></p>

<p>注意交易的数据是存在区块体中的,那么我们平时在使用以太坊浏览器的时候，可能大部分时候都是根据交易hash查询交易，如果每次都要读取区块体才知道交易性能就太低了，所以我们再看看交易存储</p>

<h2 id="section-4">交易索引</h2>

<p>为了便于查询，以太坊额外存储了交易的索引信息:</p>

<ul>
  <li><code>key</code>:固定前缀l+交易hash</li>
  <li><code>value</code>:区块hash,区块高度,交易在区块中的序号</li>
</ul>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-core-struct-tx.jpeg" alt="eth-core-struct" /></p>

<h2 id="section-5">其他</h2>

<p>区块其他存储结构(比如收据,难度td)都以类似的k-v结构存储在leveldb中，他们共同构成了以太坊的存储结构。详细代码比较简单,可以参考<code>github.com/ethereum/go-ethereum/core/rawdb</code>和<code>github.com/ethereum/go-ethereum/ethdb</code>这两个包。</p>

<p>以太坊的基础数据结构非常简单，在看源码之前最好先熟悉一下。我之前就是忽略了这个基础，在阅读区块重组reorg的代码的时候看到<code>DeleteTxLookupEntry</code>以为是删除交易数据，导致对叔区块的理解障碍，后来补看了rawdb源码才知道，这只是删除了交易索引。</p>

<h1 id="section-6">为什么是单向链表呢？</h1>

<p>回到开头，那么为什么大多数区块链都选择了单向链表作为基础数据结构呢，我擅自揣摩可能有这样几点原因:</p>

<h2 id="section-7">简单</h2>

<p>简单既是技术抉择的原因，也是技术成型后的结果。毫无疑问，单向链表是简单的,上完第一节数据结构课的同学应该都能轻松实现一条简单链表。它简单才能易于拓展,才能在这上面方便地设计状态机，从而完成滚动记账。</p>

<h2 id="section-8">世界线</h2>

<p>这里借用一个二次元的概念,区块链的数据是有严格上下文关系的，不能摒弃历史凭空捏造数据，它天生就是交易流水串起来的一条连续的线,这和我们现实世界类似，现实世界的当前状态不过是一个一个事件串联起来的，连续演化出的结果,这就是世界线,它具有状态转移的连续性，唯一性。从这个概念的描述也能感受出，这个业务场景和单向链表也是非常匹配的,我们接触区块链很多时候都是从了解”历史不可篡改”开始，然而链表指向父节点的指针，天然承认了数据历史这一需求。</p>

<h1 id="rebuild">关于rebuild</h1>

<p>所以呢，最后我还是偷了个懒，这块的基础结构比较简单,我就不手动写Demo了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[rebuild ethereum](一) 搭建p2p网络]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/09/02/rebuild-ethereum-da-jian-p2pwang-luo/"/>
    <updated>2018-09-02T14:24:16+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/09/02/rebuild-ethereum-da-jian-p2pwang-luo</id>
    <content type="html"><![CDATA[<p>接触使用ethereum已经有大半年时间，一直觉得对以太坊了解无法更进一步。结合自己以前的经验, the most efficient way of learn something is to build one. 想要深入学习一样东西，最有效的方式就是自己弄脏手，从头搭建一个。</p>

<p>比如动手做linux from scratch来学习linux的五脏六腑，rebuild rails来学习rails，所以我想尝试做一个rebuild ethereum系列,来解构ethereum。</p>

<p>在该rebuild系列中，我将把视角定在构成区块链的大模块纬度,先从以太坊源码中抽离该模块,然后使用该模块编写一个可执行的程序，这样能够真实感受到这个模块的运行机制和使用方法；最终能产生”以太坊(区块链)不外乎就是这几个模块组装起来的”这种印象就达到我的目的的。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">前言</a></li>
  <li><a href="#section-1">基本诉求</a></li>
  <li><a href="#ethereum-p2pp2p">基于ethereum-p2p实现一个自定义协议的p2p网络</a>    <ul>
      <li><a href="#foo-bar">foo-bar网络</a></li>
      <li><a href="#section-2">启动网络</a></li>
      <li><a href="#section-3">观察模块运行</a></li>
    </ul>
  </li>
  <li><a href="#real-ethereum-p2p">real ethereum p2p</a></li>
  <li><a href="#section-4">本文源码</a></li>
</ul>

<h1 id="section">前言</h1>

<p>这是rebuild ethereum的第一篇,我将尝试抽离以太坊底层的p2p网络模块,搭建一个可执行的3节点的p2p网络。在这里，我不会深入介绍具体细节，其中涉及到技术细节读者可以直接查看ethereum源代码,也可以参考我之前关于以太坊p2p实现细节的几篇博客。</p>

<h1 id="section-1">基本诉求</h1>

<p>先来看看我们对于一个p2p网络模块的基本诉求:</p>

<ul>
  <li>接入网络的便利性,其实也可以表述成网络易于建立，有足够的内网穿透能力</li>
  <li>具备节点发现和维护的能力</li>
  <li>提供上层协议的拓展能力,以tcp类比,能做到在不清楚tcp的底层细节就能够开发出http协议</li>
</ul>

<h1 id="ethereum-p2pp2p">基于ethereum-p2p实现一个自定义协议的p2p网络</h1>

<h2 id="foo-bar">foo-bar网络</h2>

<p>我们实现的这个p2p网络叫foo-bar网络,她的功能很简单,接入网络后向新节点发一条<code>welcome</code>消息,然后再发一条<code>foo</code>,当节点收到后会回复一条<code>bar</code>消息.</p>

<p>定义foo-bar协议:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">MessageType</span> <span class="p">=</span> <span class="kt">uint64</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 消息类型必须从0开始递增</span>
</span><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">	<span class="nx">MT_HelloWorld</span> <span class="nx">MessageType</span> <span class="p">=</span> <span class="kc">iota</span>
</span><span class="line">	<span class="nx">MT_FooBar</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Message</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">FooBarProtocol</span><span class="p">()</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">{</span>
</span><span class="line">		<span class="nx">Name</span><span class="p">:</span>    <span class="s">&quot;FooBarProtocol&quot;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">Version</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">		<span class="nx">Length</span><span class="p">:</span>  <span class="mi">2</span><span class="p">,</span>  <span class="c1">// 有几种消息类型就是几</span>
</span><span class="line">		<span class="nx">Run</span><span class="p">:</span>     <span class="nx">msgHandler</span><span class="p">,</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>要注意关于协议支持的消息类型的定义，具体原因和以太坊实现细节有关,具体可以查阅<a href="http://qjpcpu.github.io/blog/2018/01/29/shen-ru-ethereumyuan-ma-p2pmo-kuai-ji-chu-jie-gou/">p2p模块基础结构</a></p>

<p>实现foo-bar协议handler内容:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">msgHandler</span><span class="p">(</span><span class="nx">peer</span> <span class="o">*</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Peer</span><span class="p">,</span> <span class="nx">ws</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">MsgReadWriter</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">	<span class="c1">// send msg</span>
</span><span class="line">	<span class="nx">log</span><span class="p">.</span><span class="nx">Infof</span><span class="p">(</span><span class="s">&quot;new peer connected:%v&quot;</span><span class="p">,</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</span><span class="line">	<span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">MT_HelloWorld</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">NodeInfo</span><span class="p">().</span><span class="nx">Name</span><span class="o">+</span><span class="s">&quot;:welcome &quot;</span><span class="o">+</span><span class="nx">peer</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
</span><span class="line">	<span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">MT_FooBar</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="k">for</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">ReadMsg</span><span class="p">()</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Warningf</span><span class="p">(</span><span class="s">&quot;peer %s disconnected&quot;</span><span class="p">,</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
</span><span class="line">			<span class="k">return</span> <span class="nx">err</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">
</span><span class="line">		<span class="kd">var</span> <span class="nx">myMessage</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="nx">Message</span>
</span><span class="line">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;decode msg err:%v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">			<span class="c1">// handle decode error</span>
</span><span class="line">			<span class="k">continue</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;code:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span> <span class="s">&quot;receiver at:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">ReceivedAt</span><span class="p">,</span> <span class="s">&quot;msg:&quot;</span><span class="p">,</span> <span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="k">switch</span> <span class="nx">myMessage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
</span><span class="line">		<span class="k">case</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span>
</span><span class="line">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">MT_FooBar</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span>
</span><span class="line">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">				<span class="nx">log</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;send bar error:%v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">				<span class="k">return</span> <span class="nx">err</span>
</span><span class="line">			<span class="p">}</span>
</span><span class="line">		<span class="k">default</span><span class="p">:</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;recv:&quot;</span><span class="p">,</span> <span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-2">启动网络</h2>

<p>这里我们启动3个节点,对于测试网络结构及运转已经足够了.</p>

<p>首先编译二进制程序:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">cd</span> <span class="nx">ethereum</span><span class="o">-</span><span class="nx">from</span><span class="o">-</span><span class="nx">scratch</span><span class="o">/</span><span class="nx">p2p</span><span class="o">-</span><span class="nx">network</span> <span class="o">&amp;&amp;</span> <span class="k">go</span> <span class="nx">build</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>启动3个节点</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="err">#</span> <span class="err">启动节点</span><span class="mi">1</span>
</span><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">start_node1</span><span class="p">.</span><span class="nx">sh</span>
</span><span class="line">
</span><span class="line"><span class="err">#</span> <span class="err">打开新终端窗口启动节点</span><span class="mi">2</span>
</span><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">start_node2</span><span class="p">.</span><span class="nx">sh</span>
</span><span class="line">
</span><span class="line"><span class="err">#</span> <span class="err">打开新终端窗口启动节点</span><span class="mi">3</span>
</span><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">start_node3</span><span class="p">.</span><span class="nx">sh</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/foo-bar-node1.png" alt="foo-bar1" /></p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/foo-bar-node2.png" alt="foo-bar2" /></p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/foo-bar-node3.png" alt="foo-bar3" /></p>

<h2 id="section-3">观察模块运行</h2>

<p>从日志可以看出,ethereum的p2p模块功能非常完备，在由种子节点接入网络后,可以自动完成节点发现，并且不断刷新自身的连接表，对已经建立的节点链路发送心跳保持连接。协议数据包使用rlp格式打包,不管是消息发送还是分拆都对上层提供了极为简单的接口，所以基于次实现高级协议就非常方便了，比如以太坊whisper协议。这是向上的延展。</p>

<p>如果要向下深入，那么就可以逐个了解，rlp拆包解包，子协议拓展规则,kad网络节点发现机制,内网穿透，等等</p>

<h1 id="real-ethereum-p2p">real ethereum p2p</h1>

<p>回到真实以太坊,geth节点启动最终执行启动p2p网络的地方位于<code>github.com/ethereum/go-ethereum/node/node.go</code>文件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Start create a live P2P node and starts running it.</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
</span><span class="line">	<span class="k">defer</span> <span class="nx">n</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// Short circuit if the node&#39;s already running</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">server</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="k">return</span> <span class="nx">ErrNodeRunning</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">openDataDir</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="k">return</span> <span class="nx">err</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// Initialize the p2p server. This creates the node key and</span>
</span><span class="line">	<span class="c1">// discovery databases.</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">P2P</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">PrivateKey</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NodeKey</span><span class="p">()</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">()</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">Logger</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">log</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">StaticNodes</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">StaticNodes</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">StaticNodes</span><span class="p">()</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">TrustedNodes</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">TrustedNodes</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">TrustedNodes</span><span class="p">()</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">NodeDatabase</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">NodeDatabase</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NodeDB</span><span class="p">()</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">running</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Config</span><span class="p">:</span> <span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">}</span>
</span><span class="line">	<span class="nx">n</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;Starting peer-to-peer node&quot;</span><span class="p">,</span> <span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// Otherwise copy and specialize the P2P configuration</span>
</span><span class="line">    <span class="o">......</span><span class="p">..</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>是不是和我们的demo基本一模一样.</p>

<p>具体的协议参考源码文件<code>github.com/ethereum/go-ethereum/eth/handler.go</code>子协议管理器<code>ProtocolManager</code></p>

<h1 id="section-4">本文源码</h1>

<p><a href="https://github.com/qjpcpu/ethereum-from-scratch/tree/master/p2p-network">本文源码</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hyperledger-fabric服务端开发]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/07/25/hyperledger-fabricfu-wu-duan-kai-fa/"/>
    <updated>2018-07-25T14:23:59+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/07/25/hyperledger-fabricfu-wu-duan-kai-fa</id>
    <content type="html"><![CDATA[<p>这篇文章并不是介绍fabric智能合约怎么编写的,因为这类的文章随便在google上一搜一大把. 但反而是fabric服务端开发应该怎么做需要有人稍稍点拨一下。本文就以golang服务端为例，介绍一下fabric服务端基本做法。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#fabric-sdk-go">fabric-sdk-go</a></li>
  <li><a href="#section">准备基础配置文件</a></li>
  <li><a href="#sdk">初始化sdk</a></li>
  <li><a href="#section-1">初始化通道</a></li>
  <li><a href="#chaincode">操作ChainCode</a></li>
  <li><a href="#section-2">完整示例</a></li>
  <li><a href="#section-3">其他官方示例</a></li>
</ul>

<h1 id="fabric-sdk-go">fabric-sdk-go</h1>

<p>fabric目前主要提供了<code>node</code>和<code>go</code>的SDK，我们将以<a href="https://github.com/hyperledger/fabric-sdk-go">fabric-sdk-go</a>为例搭建一个简单服务端程序。</p>

<p>首先安装fabric开发基础库:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">go get -u github.com/hyperledger/fabric/orderer
</span><span class="line">go get -u github.com/hyperledger/fabric/peer
</span><span class="line">go get -u github.com/hyperledger/fabric-sdk-go
</span><span class="line">
</span><span class="line"><span class="c"># Optional - populate vendor directory (if needed by your downstream vendoring solution)</span>
</span><span class="line"><span class="c"># cd $GOPATH/src/github.com/hyperledger/fabric-sdk-go/</span>
</span><span class="line"><span class="c"># make populate</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section">准备基础配置文件</h1>

<p>首先准备一份客户端连接的配置文件，配置连接orderer、peer节点，证书路径等信息:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>config_e2e.yaml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
<span class="line-number">144</span>
<span class="line-number">145</span>
<span class="line-number">146</span>
<span class="line-number">147</span>
<span class="line-number">148</span>
<span class="line-number">149</span>
<span class="line-number">150</span>
<span class="line-number">151</span>
<span class="line-number">152</span>
<span class="line-number">153</span>
<span class="line-number">154</span>
<span class="line-number">155</span>
<span class="line-number">156</span>
<span class="line-number">157</span>
<span class="line-number">158</span>
<span class="line-number">159</span>
<span class="line-number">160</span>
<span class="line-number">161</span>
<span class="line-number">162</span>
<span class="line-number">163</span>
<span class="line-number">164</span>
<span class="line-number">165</span>
<span class="line-number">166</span>
<span class="line-number">167</span>
<span class="line-number">168</span>
<span class="line-number">169</span>
<span class="line-number">170</span>
<span class="line-number">171</span>
<span class="line-number">172</span>
<span class="line-number">173</span>
<span class="line-number">174</span>
<span class="line-number">175</span>
<span class="line-number">176</span>
<span class="line-number">177</span>
<span class="line-number">178</span>
<span class="line-number">179</span>
<span class="line-number">180</span>
<span class="line-number">181</span>
<span class="line-number">182</span>
<span class="line-number">183</span>
<span class="line-number">184</span>
<span class="line-number">185</span>
<span class="line-number">186</span>
<span class="line-number">187</span>
<span class="line-number">188</span>
<span class="line-number">189</span>
<span class="line-number">190</span>
<span class="line-number">191</span>
<span class="line-number">192</span>
<span class="line-number">193</span>
<span class="line-number">194</span>
<span class="line-number">195</span>
<span class="line-number">196</span>
<span class="line-number">197</span>
<span class="line-number">198</span>
<span class="line-number">199</span>
<span class="line-number">200</span>
<span class="line-number">201</span>
<span class="line-number">202</span>
<span class="line-number">203</span>
<span class="line-number">204</span>
<span class="line-number">205</span>
<span class="line-number">206</span>
<span class="line-number">207</span>
<span class="line-number">208</span>
<span class="line-number">209</span>
<span class="line-number">210</span>
<span class="line-number">211</span>
<span class="line-number">212</span>
<span class="line-number">213</span>
<span class="line-number">214</span>
<span class="line-number">215</span>
<span class="line-number">216</span>
<span class="line-number">217</span>
<span class="line-number">218</span>
<span class="line-number">219</span>
<span class="line-number">220</span>
<span class="line-number">221</span>
<span class="line-number">222</span>
<span class="line-number">223</span>
<span class="line-number">224</span>
<span class="line-number">225</span>
<span class="line-number">226</span>
<span class="line-number">227</span>
<span class="line-number">228</span>
<span class="line-number">229</span>
<span class="line-number">230</span>
<span class="line-number">231</span>
<span class="line-number">232</span>
<span class="line-number">233</span>
<span class="line-number">234</span>
<span class="line-number">235</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># Schema version of the content. Used by the SDK to apply the corresponding parsing rules.</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.0.0</span>
</span><span class="line">
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># The client section used by GO SDK.</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Which organization does this application instance belong to? The value must be the name of an org</span>
</span><span class="line">  <span class="c1"># defined under &quot;organizations&quot;</span>
</span><span class="line">  <span class="l-Scalar-Plain">organization</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org1</span>
</span><span class="line">
</span><span class="line">  <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">info</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Root of the MSP directories with keys and certs.</span>
</span><span class="line">  <span class="l-Scalar-Plain">cryptoconfig</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/.local/src/playfabric/first-network/crypto-config</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Some SDKs support pluggable KV stores, the properties under &quot;credentialStore&quot;</span>
</span><span class="line">  <span class="c1"># are implementation specific</span>
</span><span class="line">  <span class="l-Scalar-Plain">credentialStore</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="c1"># [Optional]. Used by user store. Not needed if all credentials are embedded in configuration</span>
</span><span class="line">    <span class="c1"># and enrollments are performed elswhere.</span>
</span><span class="line">    <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="s">&quot;/tmp/state-store&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># [Optional]. Specific to the CryptoSuite implementation used by GO SDK. Software-based implementations</span>
</span><span class="line">    <span class="c1"># requiring a key store. PKCS#11 based implementations does not.</span>
</span><span class="line">    <span class="l-Scalar-Plain">cryptoStore</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1"># Specific to the underlying KeyValueStore that backs the crypto key store.</span>
</span><span class="line">      <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/tmp/msp</span>
</span><span class="line">
</span><span class="line">   <span class="c1"># BCCSP config for the client. Used by GO SDK.</span>
</span><span class="line">  <span class="l-Scalar-Plain">BCCSP</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
</span><span class="line">     <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">     <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="s">&quot;SW&quot;</span>
</span><span class="line">     <span class="l-Scalar-Plain">hashAlgorithm</span><span class="p-Indicator">:</span> <span class="s">&quot;SHA2&quot;</span>
</span><span class="line">     <span class="l-Scalar-Plain">softVerify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">     <span class="l-Scalar-Plain">level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">256</span>
</span><span class="line">
</span><span class="line">  <span class="l-Scalar-Plain">tlsCerts</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="c1"># [Optional]. Use system certificate pool when connecting to peers, orderers (for negotiating TLS) Default: false</span>
</span><span class="line">    <span class="l-Scalar-Plain">systemCertPool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">
</span><span class="line"><span class="l-Scalar-Plain">channels</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="c1"># name of the channel</span>
</span><span class="line">  <span class="l-Scalar-Plain">mychannel</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="c1"># Required. list of peers from participating orgs</span>
</span><span class="line">    <span class="l-Scalar-Plain">peers</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">peer0.org1.example.com</span><span class="p-Indicator">:</span>
</span><span class="line">        <span class="c1"># [Optional]. will this peer be sent transaction proposals for endorsement? The peer must</span>
</span><span class="line">        <span class="c1"># have the chaincode installed. The app can also use this property to decide which peers</span>
</span><span class="line">        <span class="c1"># to send the chaincode install request. Default: true</span>
</span><span class="line">        <span class="l-Scalar-Plain">endorsingPeer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line">        <span class="c1"># [Optional]. will this peer be sent query proposals? The peer must have the chaincode</span>
</span><span class="line">        <span class="c1"># installed. The app can also use this property to decide which peers to send the</span>
</span><span class="line">        <span class="c1"># chaincode install request. Default: true</span>
</span><span class="line">        <span class="l-Scalar-Plain">chaincodeQuery</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line">        <span class="c1"># [Optional]. will this peer be sent query proposals that do not require chaincodes, like</span>
</span><span class="line">        <span class="c1"># queryBlock(), queryTransaction(), etc. Default: true</span>
</span><span class="line">        <span class="l-Scalar-Plain">ledgerQuery</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line">        <span class="c1"># [Optional]. will this peer be the target of the SDK&#39;s listener registration? All peers can</span>
</span><span class="line">        <span class="c1"># produce events but the app typically only needs to connect to one to listen to events.</span>
</span><span class="line">        <span class="c1"># Default: true</span>
</span><span class="line">        <span class="l-Scalar-Plain">eventSource</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># [Optional]. The application can use these options to perform channel operations like retrieving channel</span>
</span><span class="line">    <span class="c1"># config etc.</span>
</span><span class="line">    <span class="l-Scalar-Plain">policies</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1">#[Optional] options for retrieving channel configuration blocks</span>
</span><span class="line">      <span class="l-Scalar-Plain">queryChannelConfig</span><span class="p-Indicator">:</span>
</span><span class="line">        <span class="c1">#[Optional] min number of success responses (from targets/peers)</span>
</span><span class="line">        <span class="l-Scalar-Plain">minResponses</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class="line">        <span class="c1">#[Optional] channel config will be retrieved for these number of random targets</span>
</span><span class="line">        <span class="l-Scalar-Plain">maxTargets</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class="line">        <span class="c1">#[Optional] retry options for query config block</span>
</span><span class="line">        <span class="l-Scalar-Plain">retryOpts</span><span class="p-Indicator">:</span>
</span><span class="line">          <span class="c1">#[Optional] number of retry attempts</span>
</span><span class="line">          <span class="l-Scalar-Plain">attempts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class="line">          <span class="c1">#[Optional] the back off interval for the first retry attempt</span>
</span><span class="line">          <span class="l-Scalar-Plain">initialBackoff</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">500ms</span>
</span><span class="line">          <span class="c1">#[Optional] the maximum back off interval for any retry attempt</span>
</span><span class="line">          <span class="l-Scalar-Plain">maxBackoff</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5s</span>
</span><span class="line">          <span class="c1">#[Optional] he factor by which the initial back off period is exponentially incremented</span>
</span><span class="line">          <span class="l-Scalar-Plain">backoffFactor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.0</span>
</span><span class="line">
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># list of participating organizations in this network</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="l-Scalar-Plain">organizations</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">org1</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">mspid</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Org1MSP</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># This org&#39;s MSP store (absolute path or relative to client.cryptoconfig)</span>
</span><span class="line">    <span class="l-Scalar-Plain">cryptoPath</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">peerOrganizations/org1.example.com/users/{username}@org1.example.com/msp</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">peers</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">peer0.org1.example.com</span>
</span><span class="line">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">peer1.org1.example.com</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># [Optional]. Certificate Authorities issue certificates for identification purposes in a Fabric based</span>
</span><span class="line">    <span class="c1"># network. Typically certificates provisioning is done in a separate process outside of the</span>
</span><span class="line">    <span class="c1"># runtime network. Fabric-CA is a special certificate authority that provides a REST APIs for</span>
</span><span class="line">    <span class="c1"># dynamic certificate management (enroll, revoke, re-enroll). The following section is only for</span>
</span><span class="line">    <span class="c1"># Fabric-CA servers.</span>
</span><span class="line">    <span class="l-Scalar-Plain">certificateAuthorities</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ca.org1.example.com</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># the profile will contain public information about organizations other than the one it belongs to.</span>
</span><span class="line">  <span class="c1"># These are necessary information to make transaction lifecycles work, including MSP IDs and</span>
</span><span class="line">  <span class="c1"># peers with a public URL to send transaction proposals. The file will not contain private</span>
</span><span class="line">  <span class="c1"># information reserved for members of the organization, such as admin key and certificate,</span>
</span><span class="line">  <span class="c1"># fabric-ca registrar enroll ID and secret, etc.</span>
</span><span class="line">  <span class="l-Scalar-Plain">org2</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">mspid</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Org2MSP</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># This org&#39;s MSP store (absolute path or relative to client.cryptoconfig)</span>
</span><span class="line">    <span class="l-Scalar-Plain">cryptoPath</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">peerOrganizations/org2.example.com/users/{username}@org2.example.com/msp</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">peers</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">peer0.org2.example.com</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">certificateAuthorities</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ca.org2.example.com</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Orderer Org name</span>
</span><span class="line">  <span class="l-Scalar-Plain">ordererorg</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1"># Membership Service Provider ID for this organization</span>
</span><span class="line">      <span class="l-Scalar-Plain">mspID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OrdererMSP</span>
</span><span class="line">
</span><span class="line">      <span class="c1"># Needed to load users crypto keys and certs for this org (absolute path or relative to global crypto path, DEV mode)</span>
</span><span class="line">      <span class="l-Scalar-Plain">cryptoPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ordererOrganizations/example.com/users/{username}@example.com/msp</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># List of orderers to send transaction and channel create/update requests to. For the time</span>
</span><span class="line"><span class="c1"># being only one orderer is needed. If more than one is defined, which one get used by the</span>
</span><span class="line"><span class="c1"># SDK is implementation specific. Consult each SDK&#39;s documentation for its handling of orderers.</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="l-Scalar-Plain">orderers</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">orderer.example.com</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">orderer.example.com:7050</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># these are standard properties defined by the gRPC library</span>
</span><span class="line">    <span class="c1"># they will be passed in as-is to gRPC client constructor</span>
</span><span class="line">    <span class="l-Scalar-Plain">grpcOptions</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">ssl-target-name-override</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">orderer.example.com</span>
</span><span class="line">      <span class="c1"># These parameters should be set in coordination with the keepalive policy on the server,</span>
</span><span class="line">      <span class="c1"># as incompatible settings can result in closing of connection.</span>
</span><span class="line">      <span class="c1"># When duration of the &#39;keep-alive-time&#39; is set to 0 or less the keep alive client parameters are disabled</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-permit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="l-Scalar-Plain">fail-fast</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="c1"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span>
</span><span class="line">      <span class="l-Scalar-Plain">allow-insecure</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">tlsCACerts</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1"># Certificate location absolute path</span>
</span><span class="line">      <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/repository/golang-repos/src/playfabric/first-network/crypto-config/ordererOrganizations/example.com/tlsca/tlsca.example.com-cert.pem</span>
</span><span class="line">
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># List of peers to send various requests to, including endorsement, query</span>
</span><span class="line"><span class="c1"># and event listener registration.</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="l-Scalar-Plain">peers</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">peer0.org1.example.com</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="c1"># this URL is used to send endorsement and query requests</span>
</span><span class="line">    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org1.example.com:7051</span>
</span><span class="line">    <span class="c1"># eventUrl is only needed when using eventhub (default is delivery service)</span>
</span><span class="line">    <span class="l-Scalar-Plain">eventUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org1.example.com:7053</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">grpcOptions</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">ssl-target-name-override</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org1.example.com</span>
</span><span class="line">      <span class="c1"># These parameters should be set in coordination with the keepalive policy on the server,</span>
</span><span class="line">      <span class="c1"># as incompatible settings can result in closing of connection.</span>
</span><span class="line">      <span class="c1"># When duration of the &#39;keep-alive-time&#39; is set to 0 or less the keep alive client parameters are disabled</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-permit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="l-Scalar-Plain">fail-fast</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="c1"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span>
</span><span class="line">      <span class="l-Scalar-Plain">allow-insecure</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">tlsCACerts</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1"># Certificate location absolute path</span>
</span><span class="line">      <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/repository/golang-repos/src/playfabric/first-network/crypto-config/peerOrganizations/org1.example.com/tlsca/tlsca.org1.example.com-cert.pem</span>
</span><span class="line">
</span><span class="line">  <span class="l-Scalar-Plain">peer1.org1.example.com</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="c1"># this URL is used to send endorsement and query requests</span>
</span><span class="line">    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer1.org1.example.com:7151</span>
</span><span class="line">    <span class="c1"># eventUrl is only needed when using eventhub (default is delivery service)</span>
</span><span class="line">    <span class="l-Scalar-Plain">eventUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer1.org1.example.com:7153</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">grpcOptions</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">ssl-target-name-override</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer1.org1.example.com</span>
</span><span class="line">      <span class="c1"># These parameters should be set in coordination with the keepalive policy on the server,</span>
</span><span class="line">      <span class="c1"># as incompatible settings can result in closing of connection.</span>
</span><span class="line">      <span class="c1"># When duration of the &#39;keep-alive-time&#39; is set to 0 or less the keep alive client parameters are disabled</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-permit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="l-Scalar-Plain">fail-fast</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="c1"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span>
</span><span class="line">      <span class="l-Scalar-Plain">allow-insecure</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">tlsCACerts</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="c1"># Certificate location absolute path</span>
</span><span class="line">      <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/repository/golang-repos/src/playfabric/first-network/crypto-config/peerOrganizations/org1.example.com/tlsca/tlsca.org1.example.com-cert.pem</span>
</span><span class="line">
</span><span class="line">  <span class="l-Scalar-Plain">peer0.org2.example.com</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org2.example.com:8051</span>
</span><span class="line">    <span class="c1"># eventUrl is only needed when using eventhub (default is delivery service)</span>
</span><span class="line">    <span class="l-Scalar-Plain">eventUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org2.example.com:8053</span>
</span><span class="line">    <span class="l-Scalar-Plain">grpcOptions</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">ssl-target-name-override</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peer0.org2.example.com</span>
</span><span class="line">      <span class="c1"># These parameters should be set in coordination with the keepalive policy on the server,</span>
</span><span class="line">      <span class="c1"># as incompatible settings can result in closing of connection.</span>
</span><span class="line">      <span class="c1"># When duration of the &#39;keep-alive-time&#39; is set to 0 or less the keep alive client parameters are disabled</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-time</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20s</span>
</span><span class="line">      <span class="l-Scalar-Plain">keep-alive-permit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="l-Scalar-Plain">fail-fast</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">      <span class="c1"># allow-insecure will be taken into consideration if address has no protocol defined, if true then grpc or else grpcs</span>
</span><span class="line">      <span class="l-Scalar-Plain">allow-insecure</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class="line">
</span><span class="line">    <span class="l-Scalar-Plain">tlsCACerts</span><span class="p-Indicator">:</span>
</span><span class="line">      <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/repository/golang-repos/src/playfabric/first-network/crypto-config/peerOrganizations/org2.example.com/tlsca/tlsca.org2.example.com-cert.pem</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="sdk">初始化sdk</h1>

<p>使用<code>github.com/hyperledger/fabric-sdk-go/pkg/core/config</code>包读取并解析配置文件,加载完成后即可初始化sdk</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">configPath</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;GOPATH&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/src/playfabric/config_e2e.yaml&quot;</span>
</span><span class="line"><span class="nx">configOpt</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">FromFile</span><span class="p">(</span><span class="nx">configPath</span><span class="p">)</span>
</span><span class="line"><span class="nx">sdk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">configOpt</span><span class="p">)</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">defer</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-1">初始化通道</h1>

<p>初始化channelContext及channel,至此初始化工作完成，可以操作chain code或者查询账本。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">//prepare channel client context using client context</span>
</span><span class="line"><span class="nx">clientChannelContext</span> <span class="o">:=</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">ChannelContext</span><span class="p">(</span><span class="s">&quot;mychannel&quot;</span><span class="p">,</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithUser</span><span class="p">(</span><span class="s">&quot;User1&quot;</span><span class="p">),</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithOrg</span><span class="p">(</span><span class="nx">orgName</span><span class="p">))</span>
</span><span class="line"><span class="c1">// Channel client is used to query and execute transactions (Org1 is default org)</span>
</span><span class="line"><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">clientChannelContext</span><span class="p">)</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Failed to create new channel client: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="chaincode">操作ChainCode</h1>

<p>以官方example02的chain code（代币转移合约）为例:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// a =&gt; b转账2个代币</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">executeCC</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">ChaincodeID</span><span class="p">:</span> <span class="nx">ccID</span><span class="p">,</span> <span class="nx">Fcn</span><span class="p">:</span> <span class="s">&quot;invoke&quot;</span><span class="p">,</span> <span class="nx">Args</span><span class="p">:</span> <span class="nx">makeArgs</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">)},</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithRetry</span><span class="p">(</span><span class="nx">retry</span><span class="p">.</span><span class="nx">DefaultChannelOpts</span><span class="p">))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;exe tx:&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TransactionID</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="c1">// 查询某个账户代币余额</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">who</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">ChaincodeID</span><span class="p">:</span> <span class="nx">ccID</span><span class="p">,</span> <span class="nx">Fcn</span><span class="p">:</span> <span class="s">&quot;query&quot;</span><span class="p">,</span> <span class="nx">Args</span><span class="p">:</span> <span class="nx">makeArgs</span><span class="p">(</span><span class="nx">who</span><span class="p">)},</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithRetry</span><span class="p">(</span><span class="nx">retry</span><span class="p">.</span><span class="nx">DefaultChannelOpts</span><span class="p">),</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithTargetEndpoints</span><span class="p">(),</span>
</span><span class="line">	<span class="p">)</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;query tx:&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">TransactionID</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Failed to query funds: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Payload</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-2">完整示例</h1>

<p>完整示例很简单，包含代币转让及查询、底层账本查询（对应fabric1.1，BYFN示例网络）</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;encoding/hex&quot;</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/pkg/client/ledger&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/third_party/github.com/hyperledger/fabric/protos/common&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric/common/util&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/pkg/common/errors/retry&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/pkg/client/channel&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/pkg/core/config&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/hyperledger/fabric-sdk-go/pkg/fabsdk&quot;</span>
</span><span class="line">	<span class="s">&quot;os&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">	<span class="nx">channelID</span>      <span class="p">=</span> <span class="s">&quot;mychannel&quot;</span>
</span><span class="line">	<span class="nx">orgName</span>        <span class="p">=</span> <span class="s">&quot;Org1&quot;</span>
</span><span class="line">	<span class="nx">orgAdmin</span>       <span class="p">=</span> <span class="s">&quot;Admin&quot;</span>
</span><span class="line">	<span class="nx">ordererOrgName</span> <span class="p">=</span> <span class="s">&quot;OrdererOrg&quot;</span>
</span><span class="line">	<span class="nx">ccID</span>           <span class="p">=</span> <span class="s">&quot;mycc&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">queryLedgerExample</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">configPath</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;GOPATH&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/src/playfabric/config_e2e.yaml&quot;</span>
</span><span class="line">	<span class="nx">configOpt</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">FromFile</span><span class="p">(</span><span class="nx">configPath</span><span class="p">)</span>
</span><span class="line">	<span class="nx">sdk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">configOpt</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">defer</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">	<span class="c1">//prepare channel client context using client context</span>
</span><span class="line">	<span class="nx">clientChannelContext</span> <span class="o">:=</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">ChannelContext</span><span class="p">(</span><span class="nx">channelID</span><span class="p">,</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithUser</span><span class="p">(</span><span class="s">&quot;User1&quot;</span><span class="p">),</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithOrg</span><span class="p">(</span><span class="nx">orgName</span><span class="p">))</span>
</span><span class="line">	<span class="c1">// Channel client is used to query and execute transactions (Org1 is default org)</span>
</span><span class="line">	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ledger</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">clientChannelContext</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Failed to create new channel client: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">ledgerInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">QueryInfo</span><span class="p">()</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">printBCI</span><span class="p">(</span><span class="nx">ledgerInfo</span><span class="p">.</span><span class="nx">BCI</span><span class="p">)</span>
</span><span class="line">	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">QueryBlock</span><span class="p">(</span><span class="nx">ledgerInfo</span><span class="p">.</span><span class="nx">BCI</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">printBlock</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span>
</span><span class="line">	<span class="c1">// txid := &quot;63abb9a2ae8e7f3f689498f4ccedef6001ab7902ba9dfe69e2c270a4f7ff1d4d&quot;</span>
</span><span class="line">	<span class="c1">// tx, err := client.QueryTransaction(fab.TransactionID(txid))</span>
</span><span class="line">	<span class="c1">// if err != nil {</span>
</span><span class="line">	<span class="c1">// 	fmt.Println(err)</span>
</span><span class="line">	<span class="c1">// 	os.Exit(1)</span>
</span><span class="line">	<span class="c1">// }</span>
</span><span class="line">	<span class="c1">// fmt.Println(&quot;Tx:&quot;, txid, &quot;payload:&quot;, hex.EncodeToString(tx.GetTransactionEnvelope().GetPayload()))</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">printBCI</span><span class="p">(</span><span class="nx">blk</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">BlockchainInfo</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;block height:&quot;</span><span class="p">,</span> <span class="nx">blk</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">())</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;block hash:&quot;</span><span class="p">,</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">blk</span><span class="p">.</span><span class="nx">GetCurrentBlockHash</span><span class="p">()))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;block prevhash:&quot;</span><span class="p">,</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">blk</span><span class="p">.</span><span class="nx">GetPreviousBlockHash</span><span class="p">()))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=====================================================&quot;</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">printBlock</span><span class="p">(</span><span class="nx">blk</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;BlockNO:%v\n&quot;</span><span class="p">,</span> <span class="nx">blk</span><span class="p">.</span><span class="nx">GetHeader</span><span class="p">().</span><span class="nx">GetNumber</span><span class="p">())</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;prevhash:&quot;</span><span class="p">,</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">blk</span><span class="p">.</span><span class="nx">GetHeader</span><span class="p">().</span><span class="nx">GetPreviousHash</span><span class="p">()))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;hash:&quot;</span><span class="p">,</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">ComputeSHA256</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">ConcatenateBytes</span><span class="p">(</span><span class="nx">blk</span><span class="p">.</span><span class="nx">GetData</span><span class="p">().</span><span class="nx">GetData</span><span class="p">()</span><span class="o">...</span><span class="p">))))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;=====================================================&quot;</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">configPath</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;GOPATH&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/src/playfabric/config_e2e.yaml&quot;</span>
</span><span class="line">	<span class="nx">configOpt</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">FromFile</span><span class="p">(</span><span class="nx">configPath</span><span class="p">)</span>
</span><span class="line">	<span class="nx">sdk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">configOpt</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">defer</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">	<span class="c1">//prepare channel client context using client context</span>
</span><span class="line">	<span class="nx">clientChannelContext</span> <span class="o">:=</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">ChannelContext</span><span class="p">(</span><span class="nx">channelID</span><span class="p">,</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithUser</span><span class="p">(</span><span class="s">&quot;User1&quot;</span><span class="p">),</span> <span class="nx">fabsdk</span><span class="p">.</span><span class="nx">WithOrg</span><span class="p">(</span><span class="nx">orgName</span><span class="p">))</span>
</span><span class="line">	<span class="c1">// Channel client is used to query and execute transactions (Org1 is default org)</span>
</span><span class="line">	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">clientChannelContext</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Failed to create new channel client: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">)))</span>
</span><span class="line">
</span><span class="line">	<span class="nx">executeCC</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">)))</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">executeCC</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">ChaincodeID</span><span class="p">:</span> <span class="nx">ccID</span><span class="p">,</span> <span class="nx">Fcn</span><span class="p">:</span> <span class="s">&quot;invoke&quot;</span><span class="p">,</span> <span class="nx">Args</span><span class="p">:</span> <span class="nx">makeArgs</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">)},</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithRetry</span><span class="p">(</span><span class="nx">retry</span><span class="p">.</span><span class="nx">DefaultChannelOpts</span><span class="p">))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;exe tx:&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TransactionID</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">queryCC</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">who</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">ChaincodeID</span><span class="p">:</span> <span class="nx">ccID</span><span class="p">,</span> <span class="nx">Fcn</span><span class="p">:</span> <span class="s">&quot;query&quot;</span><span class="p">,</span> <span class="nx">Args</span><span class="p">:</span> <span class="nx">makeArgs</span><span class="p">(</span><span class="nx">who</span><span class="p">)},</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithRetry</span><span class="p">(</span><span class="nx">retry</span><span class="p">.</span><span class="nx">DefaultChannelOpts</span><span class="p">),</span>
</span><span class="line">		<span class="nx">channel</span><span class="p">.</span><span class="nx">WithTargetEndpoints</span><span class="p">(),</span>
</span><span class="line">	<span class="p">)</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;query tx:&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">TransactionID</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Failed to query funds: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Payload</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">makeArgs</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">[][]</span><span class="kt">byte</span> <span class="p">{</span>
</span><span class="line">	<span class="kd">var</span> <span class="nx">ccargs</span> <span class="p">[][]</span><span class="kt">byte</span>
</span><span class="line">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">ccargs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ccargs</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">arg</span><span class="p">))</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">ccargs</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-3">其他官方示例</h1>

<ul>
  <li><a href="https://github.com/hyperledger/fabric-sdk-go/tree/master/test/integration/e2e/end_to_end.go">E2E Test</a>: Basic example that uses SDK to query and execute transaction</li>
  <li><a href="https://github.com/hyperledger/fabric-sdk-go/tree/master/test/integration/pkg/client/ledger/ledger_queries_test.go">Ledger Query Test</a>: Basic example that uses SDK to query a channel’s underlying ledger</li>
  <li><a href="https://github.com/hyperledger/fabric-sdk-go/tree/master/test/integration/e2e/orgs/multiple_orgs_test.go">Multi Org Test</a>: An example that has multiple organisations involved in transaction</li>
  <li><a href="https://github.com/hyperledger/fabric-sdk-go/tree/master/test/integration/pkg/fabsdk/provider/sdk_provider_test.go">Dynamic Endorser Selection</a>: An example that uses dynamic endorser selection (based on chaincode policy)</li>
  <li><a href="https://github.com/hyperledger/fabric-sdk-go/tree/master/test/integration/e2e/pkcs11/e2e_test.go">E2E PKCS11 Test</a>: E2E Test using a PKCS11 crypto suite and configuration</li>
  <li><a href="https://github.com/securekey/fabric-examples/tree/master/fabric-cli/">CLI</a>: An example CLI for Fabric built with the Go SDK.</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hyperledger-fabric分布式部署]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/07/23/hyperledger-fabricfen-bu-shi-bu-shu/"/>
    <updated>2018-07-23T10:48:30+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/07/23/hyperledger-fabricfen-bu-shi-bu-shu</id>
    <content type="html"><![CDATA[<p>fabric官方文档给出了怎样搭建第一个联盟网络(<a href="https://hyperledger-fabric.readthedocs.io/en/latest/build_network.html">Build your first network</a>),然而这个文档实际只给出了单机部署多个docker实例的例子,如果要在真实分布式环境部署，还是得费不少力气.</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">基本思路</a></li>
  <li><a href="#section-1">搭建流程</a>    <ul>
      <li><a href="#section-2">创建必要配置文件</a></li>
      <li><a href="#swarm">创建swarm集群</a></li>
      <li><a href="#section-3">创建集群网络</a></li>
      <li><a href="#fabric">创建fabric控制脚本</a></li>
      <li><a href="#section-4">启动网络</a>        <ul>
          <li><a href="#orderer">启动orderer</a></li>
          <li><a href="#peer">启动peer</a></li>
          <li><a href="#fabric-1">配置fabric网络</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#section-5">后记</a></li>
</ul>

<h1 id="section">基本思路</h1>

<blockquote>
  <p>题外话:老实说，fabric这个部署文档写得并不漂亮。因为他引入了过多的先决知识，譬如docker,docker-compose等多个docker组件，虽然使用docker大大提高了部署成功率，然而这样做对于fabric入门来说却走偏了，容易让初学者产生一种疑惑: 好似很容易就”得到”了一个完整的fabric网络，然而实际上，好像对于fabric是怎么运行起来的仍然一无所知。如果想要了解怎么样一步步将fabric搭建起来的话，可以仔细看看<code>fabric-samples/first-network</code>文件夹的脚本及compose配置文件，或者参考<code>[区块链原理、设计、与应用] 作者:杨保华,陈昌</code>这本书第9章,相信这样的搭建教程才能让人有直观的了解。所以，本文也不必一步步拆分搭建步骤，本文的目的是为了想读者展示如果利用现有的BYFN文档及脚本搭建真正分布式网络。</p>
</blockquote>

<p>所有的宿主机环境以及fabric二进制程序的安装还是按照Build Your First Network文档所说进行，在完成后，用docker swarm将各个宿主机上的docker实例连接起来。</p>

<h1 id="section-1">搭建流程</h1>

<p>假设我们有5台宿主机</p>

<ul>
  <li>orderer(cli) 我们将在orderer宿主机上启动客户端cli配置网络，实际上这个cli可以在任意机器上启动</li>
  <li>peer0.org1</li>
  <li>peer1.org1</li>
  <li>peer0.org2</li>
  <li>peer1.org2</li>
</ul>

<p>在5台宿主机上同构部署fabric环境，具体操作参考<a href="https://hyperledger-fabric.readthedocs.io/en/latest/build_network.html">Build your first network</a></p>

<h2 id="section-2">创建必要配置文件</h2>

<p>在任意一台机器上生成配置文件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">cd ./fabric-samples/first-network
</span><span class="line">./byfn.sh generate</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后将生成的配置同步到所有其他几台宿主机的相同目录,同步的文件包含</p>

<ul>
  <li>channel-artifacts</li>
  <li>crypto-config</li>
</ul>

<h2 id="swarm">创建swarm集群</h2>

<p>假设我们将cli作为集群manager，则在cli上创建swarm集群:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">docker swarm init</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>查看集群join token:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">docker swarm join-token manager</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>输出可能类似这样:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">docker swarm join — token SWMTKN-1–3as8cvf3yxk8e7zj98954jhjza3w75mngmxh543llgpo0c8k7z-61zyibtaqjjimkqj8p6t9lwgu 172.16.0.153:2377</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在其他所有机器上执行这条输出的命令，完成后说明所以机器处于同一集群.</p>

<h2 id="section-3">创建集群网络</h2>

<p>在cli宿主机执行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">docker network create --attachable --driver overlay byfn</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="fabric">创建fabric控制脚本</h2>

<p>现在，所有宿主均处于swarm集群，然而docker-compose并不直接使用swarm,所以我这里不再使用docker-compose，原因有两个: 1.docker-compose主要用于多个服务打包部署，然而我们在每个宿主机仅部署单个docker，不必非要使用compose 2.docker-compose还需要单独配置才能运行在swarm模式下。 所以，我将docker启动命令独立出来，写入一个shell脚本，将这个shell脚本放入所有宿主机<code>./fabric-samples/first-network/</code>下命令为<code>control</code>文件.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line"><span class="nv">NETWORK</span><span class="o">=</span>byfn    <span class="c"># 网络名称必须和创建的集群网络名称一致</span>
</span><span class="line"><span class="nv">IMAGETAG</span><span class="o">=</span>latest
</span><span class="line">
</span><span class="line"><span class="k">function </span>startOrderer<span class="o">()</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">    docker run --rm -d --network<span class="o">=</span><span class="k">${</span><span class="nv">NETWORK</span><span class="k">}</span> --name orderer.example.com -p 7050:7050 <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_LOGLEVEL</span><span class="o">=</span>INFO <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_LISTENADDRESS</span><span class="o">=</span>0.0.0.0 <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_GENESISMETHOD</span><span class="o">=</span>file <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_GENESISFILE</span><span class="o">=</span>/var/hyperledger/orderer/orderer.genesis.block <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_LOCALMSPID</span><span class="o">=</span>OrdererMSP <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_LOCALMSPDIR</span><span class="o">=</span>/var/hyperledger/orderer/msp <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_TLS_PRIVATEKEY</span><span class="o">=</span>/var/hyperledger/orderer/tls/server.key <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_TLS_CERTIFICATE</span><span class="o">=</span>/var/hyperledger/orderer/tls/server.crt <span class="se">\</span>
</span><span class="line">    -e <span class="nv">ORDERER_GENERAL_TLS_ROOTCAS</span><span class="o">=[</span>/var/hyperledger/orderer/tls/ca.crt<span class="o">]</span> <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/channel-artifacts/genesis.block,target<span class="o">=</span>/var/hyperledger/orderer/orderer.genesis.block    <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp,target<span class="o">=</span>/var/hyperledger/orderer/msp    <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/,target<span class="o">=</span>/var/hyperledger/orderer/tls    <span class="se">\</span>
</span><span class="line">    hyperledger/fabric-orderer:<span class="k">${</span><span class="nv">IMAGETAG</span><span class="k">}</span> orderer
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c"># startPeer 0 1 means start peer 0 of org 1</span>
</span><span class="line"><span class="k">function </span>startPeer<span class="o">()</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">	<span class="nv">PEER</span><span class="o">=</span><span class="nv">$1</span>
</span><span class="line">	<span class="nv">ORG</span><span class="o">=</span><span class="nv">$2</span>
</span><span class="line">	<span class="nv">PEER2</span><span class="o">=</span>1
</span><span class="line">	<span class="o">[</span> <span class="nv">$PEER</span> -eq 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">PEER2</span><span class="o">=</span>0
</span><span class="line">	<span class="nv">BOOT</span><span class="o">=</span>peer<span class="k">${</span><span class="nv">PEER2</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com:7051
</span><span class="line">    docker run --rm -d  --network<span class="o">=</span><span class="k">${</span><span class="nv">NETWORK</span><span class="k">}</span> --name peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com -p 7051:7051 -p 7053:7053 <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_ID</span><span class="o">=</span>peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com:7051 <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_GOSSIP_BOOTSTRAP</span><span class="o">=</span><span class="k">${</span><span class="nv">BOOT</span><span class="k">}</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><span class="o">=</span>peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com:7051 <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span>Org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>MSP <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_VM_ENDPOINT</span><span class="o">=</span>unix:///host/var/run/docker.sock <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK</span><span class="k">}</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_LOGGING_LEVEL</span><span class="o">=</span>INFO <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_PROFILE_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_TLS_CERT_FILE</span><span class="o">=</span>/etc/hyperledger/fabric/tls/server.crt <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_TLS_KEY_FILE</span><span class="o">=</span>/etc/hyperledger/fabric/tls/server.key <span class="se">\</span>
</span><span class="line">    -e <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/etc/hyperledger/fabric/tls/ca.crt <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/var/run/,target<span class="o">=</span>/host/var/run/ <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/crypto-config/peerOrganizations/org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com/peers/peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com/msp,target<span class="o">=</span>/etc/hyperledger/fabric/msp <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/crypto-config/peerOrganizations/org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com/peers/peer<span class="k">${</span><span class="nv">PEER</span><span class="k">}</span>.org<span class="k">${</span><span class="nv">ORG</span><span class="k">}</span>.example.com/tls,target<span class="o">=</span>/etc/hyperledger/fabric/tls <span class="se">\</span>
</span><span class="line">    hyperledger/fabric-peer:<span class="k">${</span><span class="nv">IMAGETAG</span><span class="k">}</span>  peer node start
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c"># scripts/script.sh $CHANNEL_NAME $CLI_DELAY $LANGUAGE $CLI_TIMEOUT</span>
</span><span class="line"><span class="k">function </span>startCli<span class="o">()</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">    docker run --rm -it --network<span class="o">=</span><span class="k">${</span><span class="nv">NETWORK</span><span class="k">}</span> --name cli <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CHANNEL_NAME</span><span class="o">=</span><span class="s2">&quot;mychannel&quot;</span> <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CLI_DELAY</span><span class="o">=</span>3 <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">LANGUAGE</span><span class="o">=</span>golang <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CLI_TIMEOUT</span><span class="o">=</span>10 <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">GOPATH</span><span class="o">=</span>/opt/gopath <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_VM_ENDPOINT</span><span class="o">=</span>unix:///host/var/run/docker.sock <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_LOGGING_LEVEL</span><span class="o">=</span>INFO <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_ID</span><span class="o">=</span>cli <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org1.example.com:7051 <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span>Org1MSP <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_TLS_CERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_TLS_KEY_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt <span class="se">\</span>
</span><span class="line">    -e  <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/var/run/,target<span class="o">=</span>/host/var/run/ <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/chaincode/,target<span class="o">=</span>/opt/gopath/src/github.com/chaincode <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/crypto-config,target<span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/scripts,target<span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ <span class="se">\</span>
</span><span class="line">    --mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/root/fabric/fabric-samples/first-network/channel-artifacts,target<span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts <span class="se">\</span>
</span><span class="line">    --workdir /opt/gopath/src/github.com/hyperledger/fabric/peer <span class="se">\</span>
</span><span class="line">    hyperledger/fabric-tools:<span class="k">${</span><span class="nv">IMAGETAG</span><span class="k">}</span> /bin/bash
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">case </span>X<span class="nv">$1</span> in
</span><span class="line">    Xorderer<span class="o">)</span>
</span><span class="line">        startOrderer
</span><span class="line">        ;;
</span><span class="line">    Xpeer<span class="o">)</span>
</span><span class="line">        startPeer <span class="nv">$2</span> <span class="nv">$3</span>
</span><span class="line">        ;;
</span><span class="line">    Xcli<span class="o">)</span>
</span><span class="line">        startCli
</span><span class="line">        ;;
</span><span class="line">    X*<span class="o">)</span>
</span><span class="line">        <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 orderer|peer|cli&quot;</span>
</span><span class="line">        <span class="nb">exit</span> -1
</span><span class="line">        ;;
</span><span class="line"><span class="k">esac</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-4">启动网络</h2>

<h3 id="orderer">启动orderer</h3>

<p>在orderer宿主机执行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nb">cd</span> ./fabric-samples/first-network
</span><span class="line">./contrl orderer
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="peer">启动peer</h3>

<p>在peer0.org1宿主机执行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nb">cd</span> ./fabric-samples/first-network
</span><span class="line">./contrl peer 0 1
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在peer1.org1宿主机执行</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nb">cd</span> ./fabric-samples/first-network
</span><span class="line">./contrl peer 1 1
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>同理启动org2的peer</p>

<h3 id="fabric-1">配置fabric网络</h3>

<p>在任意宿主机,这里我们就用orderer宿主机:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nb">cd</span> ./fabric-samples/first-network
</span><span class="line">./control cli
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>执行这个命令后进入客户端配置实例,直接运行配置脚本即可:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">scripts/script.sh <span class="nv">$CHANNEL_NAME</span> <span class="nv">$CLI_DELAY</span> <span class="nv">$LANGUAGE</span> <span class="nv">$CLI_TIMEOUT</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>出现的配置及测试输出应该和单机部署一样,至此部署完成。</p>

<h1 id="section-5">后记</h1>

<p>按这个步骤，应该是可以将这个分布式fabric搭建起来的，但是其他优化还需要自行完成，比如为了测试方便，我并没有将区块链数据挂载出来，所以docker重启后区块数据就没有了，生产环境得自己将数据卷挂载上去；还有，为了权限隔离，一般也不会将整个crypto-config文件夹分发给各个联盟节点，而是需要什么给什么，保持目录结构一致即可。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[利用call实现合约任意调用]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/07/02/li-yong-callshi-xian-he-yue-ren-yi-diao-yong/"/>
    <updated>2018-07-02T13:50:25+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/07/02/li-yong-callshi-xian-he-yue-ren-yi-diao-yong</id>
    <content type="html"><![CDATA[<p>call()是一个底层的接口，用来向一个合约发送消息，也就是说如果你想实现自己的消息传递，可以使用这个函数。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">需求场景</a>    <ul>
      <li><a href="#section-1">业务需求</a></li>
      <li><a href="#section-2">明确需求</a></li>
    </ul>
  </li>
  <li><a href="#section-3">实现关键点</a>    <ul>
      <li><a href="#section-4">调用任意合约</a></li>
      <li><a href="#section-5">权限控制</a></li>
    </ul>
  </li>
  <li><a href="#section-6">实现参考</a>    <ul>
      <li><a href="#section-7">热钱包工厂</a></li>
      <li><a href="#section-8">热钱包合约</a></li>
    </ul>
  </li>
  <li><a href="#section-9">后记</a></li>
</ul>

<h1 id="section">需求场景</h1>

<p>“合约动态调用”的需求场景是什么呢,答案是”热钱包”。为什么是热钱包呢,我们可以从最终需求出发一步步来推导:</p>

<h2 id="section-1">业务需求</h2>

<p>首先,假设一个业务需求，我们现在要做一个ERC721的热钱包，用户可以托管他全部的数字资产给项目方，项目方代表用户对其资产进行任意操作，这样我们可以向用户屏蔽以太坊的细节，大大提升用户体验，只有当用户想要提现资产的时候，才把资产归还到用户的冷钱包地址中去。</p>

<h2 id="section-2">明确需求</h2>

<p>初看这个需求很简单，我们可以为每个用户生成一个私钥从而建立对应地址。每次需要对资产进行操作的时候，读取这个私钥进行链上交互就行了。</p>

<p>好像很完美，但细想下来，在真正生产环境中实践却会有诸多问题: 首先带来的就是管理问题，众多的私钥不容许有一丝数据的丢失损坏，否则就需要承担用户资产的遗失风险; 其次是泄露的风险，私钥的众多更加大了泄露的风险系数，一旦有任何一个私钥泄露，项目方基本上是属于束手无策的，以太坊上可没有账户封禁这一说。</p>

<p>那么，怎么解决这个问题呢？我这里提供的一个解决方案就是利用合约。</p>

<p>我们为每个用户创建的热钱包并不是一个普通钱包地址，而是一个合约。所有的用户的热钱包都统一受控于项目方的管理账户地址,只有管理账户有权操作合约，如果有任何问题，我们只需要使用管理账户进行维护操作就行，不需要更改其他东西。 但利用合约来做热钱包又带来另一个问题，合约能调用的方法在上链之后就无法更改了或新增了，如果我们要对接的某个721藏品后续支持了某个新方法，那么我们的热钱包岂不是不能完成这个调用了？所以，如果使用合约做热钱包，还必须能够实现这个钱包合约能够动态调用其他合约。</p>

<p>归纳一下，这个721热钱包细化下来的技术需求有这样几点需要满足:</p>

<ol>
  <li>管理收敛，所有热钱包管理最好收敛到一个管理账户下</li>
  <li>管理账户能更改</li>
  <li>如果是合约热钱包,这个钱包必须能适配各类标准非标准藏品合约的调用</li>
</ol>

<p>这里对第3点补充说明一下，可能有的读者会疑惑，既然erc721都是标准化的协议，为什么还需要适配各种非标接口呢？原因之一是我们业务需求里已经说了，要能对用户资产进行任意操作，不仅仅限制于基本721的几个API。此外，ERC721的藏品通常都不会只包含721协议里几个基础接口，各个项目方会根据自己的业务研发出诸如繁殖、战斗等等资产操作，一个好的721钱包最好是能适配这些功能。还有，即便是ERC721协议本身，也可能出现变动，比如日前刚确认的721协议的最终版和以CryptoKitty所代表的beta版，协议本身就差别不小。</p>

<h1 id="section-3">实现关键点</h1>

<h2 id="section-4">调用任意合约</h2>

<p>这是本文要讲述的关键点。</p>

<p>其实要实现这个功能,使用<code>call</code>方法就可以了。call调用失败会返回一个调用成功与否的布尔值，需要检查一下</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">DynamicCaller</span><span class="p">{</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">dyn_call</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_constract</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">_data</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_constract</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">)(</span><span class="nx">_data</span><span class="p">)){</span>
</span><span class="line">            <span class="nx">revert</span><span class="p">();</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果<code>DynamicCaller</code>就是我们的热钱包合约，那么这个<code>dyn_call</code>方法就可以实现任意调用，注意这个动态方法最终调用的合约和对应方法都是由参数传递进来；</p>

<p>在ropsten部署这个合约,合约地址是<code>0x5ec567cf2137da526945f4820d0c0621ddcd02ce</code>。现在我们有一份任意合约<code>AnyContract</code>(这里先不以ERC721合约举例，为了阐明任意调用这个点，使用了一个简单合约示例)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">AnyContract</span><span class="p">{</span>
</span><span class="line">    <span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">numbers</span><span class="p">;</span>
</span><span class="line">    <span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">texts</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_a</span><span class="p">,</span><span class="nx">uint256</span> <span class="nx">_b</span><span class="p">)</span> <span class="kr">public</span><span class="p">{</span>
</span><span class="line">        <span class="nx">numbers</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span><span class="nx">_a</span><span class="o">+</span><span class="nx">_b</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">write</span><span class="p">(</span><span class="nx">string</span> <span class="nx">_text</span><span class="p">)</span> <span class="kr">public</span><span class="p">{</span>
</span><span class="line">        <span class="nx">texts</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_text</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">batchWrite</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_a</span><span class="p">,</span><span class="nx">uint256</span> <span class="nx">_b</span><span class="p">,</span><span class="nx">string</span> <span class="nx">_text</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
</span><span class="line">        <span class="nx">numbers</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span><span class="nx">_a</span><span class="o">+</span><span class="nx">_b</span><span class="p">;</span>
</span><span class="line">        <span class="nx">texts</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_text</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">getBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">uint256</span><span class="p">){</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>现在我们怎么进行调用呢？我们可以使用<code>github.com/qjpcpu/ethereum/contracts</code>提供的参数打包方法<code>PackArguments</code>生成<code>dyn_call</code>要的数据，比如我们要从<code>DynamicCaller</code>调用<code>AnyContract</code>的add方法:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">anyABI</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">ParseABI</span><span class="p">(</span><span class="s">&quot;[{\&quot;constant\&quot;:true,\&quot;inputs\&quot;:[{\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;address\&quot;}],\&quot;name\&quot;:\&quot;texts\&quot;,\&quot;outputs\&quot;:[{\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;string\&quot;}],\&quot;payable\&quot;:false,\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;},{\&quot;constant\&quot;:true,\&quot;inputs\&quot;:[],\&quot;name\&quot;:\&quot;getBalance\&quot;,\&quot;outputs\&quot;:[{\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;}],\&quot;payable\&quot;:false,\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;},{\&quot;constant\&quot;:false,\&quot;inputs\&quot;:[{\&quot;name\&quot;:\&quot;_a\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;},{\&quot;name\&quot;:\&quot;_b\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;}],\&quot;name\&quot;:\&quot;add\&quot;,\&quot;outputs\&quot;:[],\&quot;payable\&quot;:false,\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;},{\&quot;constant\&quot;:false,\&quot;inputs\&quot;:[{\&quot;name\&quot;:\&quot;_a\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;},{\&quot;name\&quot;:\&quot;_b\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;},{\&quot;name\&quot;:\&quot;_text\&quot;,\&quot;type\&quot;:\&quot;string\&quot;}],\&quot;name\&quot;:\&quot;batchWrite\&quot;,\&quot;outputs\&quot;:[],\&quot;payable\&quot;:true,\&quot;stateMutability\&quot;:\&quot;payable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;},{\&quot;constant\&quot;:true,\&quot;inputs\&quot;:[{\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;address\&quot;}],\&quot;name\&quot;:\&quot;numbers\&quot;,\&quot;outputs\&quot;:[{\&quot;name\&quot;:\&quot;\&quot;,\&quot;type\&quot;:\&quot;uint256\&quot;}],\&quot;payable\&quot;:false,\&quot;stateMutability\&quot;:\&quot;view\&quot;,\&quot;type\&quot;:\&quot;function\&quot;},{\&quot;constant\&quot;:false,\&quot;inputs\&quot;:[{\&quot;name\&quot;:\&quot;_text\&quot;,\&quot;type\&quot;:\&quot;string\&quot;}],\&quot;name\&quot;:\&quot;write\&quot;,\&quot;outputs\&quot;:[],\&quot;payable\&quot;:false,\&quot;stateMutability\&quot;:\&quot;nonpayable\&quot;,\&quot;type\&quot;:\&quot;function\&quot;}]&quot;</span><span class="p">)</span>
</span><span class="line"><span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">PackArguments</span><span class="p">(</span><span class="nx">anyABI</span><span class="p">,</span> <span class="s">&quot;add&quot;</span><span class="p">,</span> <span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">builder</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">NewTxOptsBuilderFromPK</span><span class="p">(</span><span class="nx">pk</span><span class="p">)</span>
</span><span class="line"><span class="nx">dc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">NewDynamicCaller</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="nx">DynamicCallerAddres</span><span class="p">),</span> <span class="nx">conn</span><span class="p">)</span>
</span><span class="line"><span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nx">DynCall</span><span class="p">(</span><span class="nx">builder</span><span class="p">.</span><span class="nx">Get</span><span class="p">(),</span> <span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="s">&quot;0x2f44fc640F9708FD969620466F9eddD21859e8E9&quot;</span><span class="p">),</span> <span class="nx">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>完整代码示例参考<a href="https://github.com/qjpcpu/dynamic-caller">dynamic-caller</a></p>

<h2 id="section-5">权限控制</h2>

<p>对于热钱包创建合约,需要能更改管理账户,并且<code>dyn_call</code>这个函数只有管理账户能够调用,这个继承<code>Ownable</code>合约就可能办到了。</p>

<p>对于热钱包合约本身,除了提现操作，所有方法调用必须来自管理合约的管理员。</p>

<h1 id="section-6">实现参考</h1>

<h2 id="section-7">热钱包工厂</h2>

<p>热钱包工厂唯一作用就是创建热并记录用户的热钱包，唯一需要注意的就是控制权的管理</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">Ownable</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="nx">constructor</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">modifier</span> <span class="nx">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
</span><span class="line">        <span class="nx">_</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">transferOwnership</span><span class="p">(</span><span class="nx">address</span> <span class="nx">newOwner</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="nx">newOwner</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">owner</span> <span class="o">=</span> <span class="nx">newOwner</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">getOwner</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">owner</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">contract</span> <span class="nx">WalletFactory</span> <span class="nx">is</span> <span class="nx">Ownable</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 记录用户热钱包地址</span>
</span><span class="line">    <span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">address</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">hotwallets</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 仅管理员owner可以创建热钱包</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">createWallet</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// 每个用户仅有一个热钱包</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">hotwallets</span><span class="p">[</span><span class="nx">_owner</span><span class="p">]</span> <span class="o">==</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class="line">        <span class="nx">HotWallet</span> <span class="nx">w</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HotWallet</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">_owner</span><span class="p">);</span>
</span><span class="line">        <span class="nx">hotwallets</span><span class="p">[</span><span class="nx">_owner</span><span class="p">]</span> <span class="o">=</span> <span class="nx">address</span><span class="p">(</span><span class="nx">w</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">isWalletFactory</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">pure</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">){</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>其实，在实际应用中,这里还潜藏了一个问题: 比如通常的产品逻辑会在用户注册完成时就生成热钱包备用,但这个以太坊交易被打包最快可能也要15秒左右，如果我们要在用户注册完成就显示用户热钱包地址好像是不可能的。实际上呢？交易打包确认确实要很长时间,但是我们却可以提前获知热钱包的地址:</p>

<p>以太坊中合约地址的生成规则是这样的:根据<code>(msg.sender + nonce)</code>二元组的hash来生成合约地址的,这个生成算法很简单,有兴趣可以查阅源码<code>crypto</code>包。</p>

<p>举个例子,加入<code>WalletFactory</code>这个合约地址是<code>0x5ec567cf2137da526945f4820d0c0621ddcd02ce</code>,那么第一次调用<code>createWallet</code>时nonce肯定是1，则对应生成的<code>HotWallet</code>地址可以这样算出: <code>addr := crypto.CreateAddress(common.HexToAddress("0x5ec567cf2137da526945f4820d0c0621ddcd02ce"), 1) // 热钱包地址是:0xE139cd3E5FcC127A54B0fF8687c703265E282842</code></p>

<h2 id="section-8">热钱包合约</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">HotWallet</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
</span><span class="line">    <span class="nx">WalletFactory</span> <span class="kr">public</span> <span class="nx">factory</span><span class="p">;</span>
</span><span class="line">    <span class="c1">// 这里的owner是热钱包所属用户</span>
</span><span class="line">    <span class="nx">modifier</span> <span class="nx">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
</span><span class="line">        <span class="nx">_</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="c1">// 保证动态方法的调用者一定是管理员</span>
</span><span class="line">    <span class="nx">modifier</span> <span class="nx">onlyAdmin</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">getOwner</span><span class="p">());</span>
</span><span class="line">        <span class="nx">_</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">constructor</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_admin</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">_admin</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">_owner</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class="line">        <span class="nx">factory</span> <span class="o">=</span> <span class="nx">WalletFactory</span><span class="p">(</span><span class="nx">_admin</span><span class="p">);</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">factory</span><span class="p">.</span><span class="nx">isWalletFactory</span><span class="p">());</span>
</span><span class="line">        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_owner</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kd">function</span> <span class="nx">isHotWallet</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">pure</span> <span class="nx">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">){</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// the msg.sender must be factory.owner</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">dyn_call</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_constract</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">_data</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="nx">onlyAdmin</span> <span class="p">{</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_constract</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">)(</span><span class="nx">_data</span><span class="p">)){</span>
</span><span class="line">            <span class="nx">revert</span><span class="p">();</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 能提现eth</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">withdraw</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">onlyOwner</span><span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">owner</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class="line">        <span class="nx">owner</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 很多场景下都需要能接受eth转账</span>
</span><span class="line">    <span class="kd">function</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// other functions</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><a href="https://github.com/qjpcpu/dynamic-caller/blob/master/wallets.sol">完整合约代码</a></p>

<h1 id="section-9">后记</h1>

<p>要完成个业务特定热钱包,可以在这个基础上修改HotWallet代码即可,比如数字资产的提现等等,但要特别注意: <code>call</code>方法是一个非常底层方法，为了合约安全，该方法不应该接受直接来自用户的数据。</p>

<p>此外,我观察到一些交易所给用户分配的以太热钱包地址也是一份用户独立的合约而不是普通地址,所以我猜想他们可能也是为了业务灵活性和管理性才这样做的，不过是不是使用call来实现，就不得而知了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[怎样实现以太坊交易可靠提交]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/06/14/zen-yang-shi-xian-yi-tai-fang-jiao-yi-ke-kao-ti-jiao/"/>
    <updated>2018-06-14T14:54:01+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/06/14/zen-yang-shi-xian-yi-tai-fang-jiao-yi-ke-kao-ti-jiao</id>
    <content type="html"><![CDATA[<p>在真实环境下的以太坊Dapp开发,是一定涉及到链上链下逻辑的交互的。那么开发者可能会遇到这样一种场景,当用户使用metamask签名交易并提交后,Dapp的中心服务端需要拿到这个交易ID,并跟踪这个交易的执行,甚至会根据这笔交易去触发后端逻辑(当然使用event可以一定程度避开这个问题,但这种回避式的解决方案不在此讨论)，但现实情况往往是令人痛苦的，因为很可能会因为种种原因，我们无法取到metamask的回调，导致开发者因此”丢失”掉这笔交易。</p>

<p>那么，如果我们要直面这个问题，要怎么样实现交易可靠提交呢？</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">提炼问题</a>    <ul>
      <li><a href="#metamask">1. 最显而易见,metamask能够提供可靠回调</a></li>
      <li><a href="#metamask-1">2. metamask将交易签名和发送拆分开来</a></li>
      <li><a href="#section-1">3. 弄脏手自己做</a></li>
    </ul>
  </li>
  <li><a href="#section-2">关键实现</a>    <ul>
      <li><a href="#section-3">1.前端获取裸交易数据</a></li>
      <li><a href="#hash">2.后端计算裸交易hash</a></li>
      <li><a href="#metamask-2">3.前端唤起metamask签名</a></li>
      <li><a href="#section-4">4.后端发送交易</a></li>
    </ul>
  </li>
  <li><a href="#section-5">反思</a>    <ul>
      <li><a href="#section-6">1.安全性</a></li>
      <li><a href="#section-7">2.用户体验</a></li>
      <li><a href="#section-8">3.时效性</a></li>
    </ul>
  </li>
</ul>

<h1 id="section">提炼问题</h1>

<p>首先，我再次描述下问题的发生场景: 在metamask环境下，我们需要拿到用户提交的交易来触发后续中心化逻辑，但是在现实情况下很可能拿不到这个回调交易ID.</p>

<p>看起来，问题的核心并不是交易可靠提交，而是可靠地拿到交易提交的回调。那么解决问题，就有两种思路:</p>

<h5 id="metamask">1. 最显而易见,metamask能够提供可靠回调</h5>

<p>这个解决方案最无痛，然而完全依赖于metamask团队的开发意愿。所幸的是metamask团队在接收开发者的反馈后，有意愿往这方面努力。但开发时间不确定，甚至于我认为，在浏览器环境下，可能无法完美解决。所以短期内，这个方向是无法在生产环境实施的。</p>

<h5 id="metamask-1">2. metamask将交易签名和发送拆分开来</h5>

<p>如果没做过以太坊Dapp开发，可能不清楚metamask提交交易其实是串行执行了两步操作： 一.先对交易裸数据签名，得到签名后的交易,二.将签名后的交易提交到以太坊。</p>

<p>实际上，在metamask完成第一步签名后，这个交易就已经是一笔以太坊合法交易了，任何一个以太坊节点都可以拿着这笔交易进行全网广播，要求矿工打包。试想，如果metamsk将这两个操作拆分开来，那么开发者就可以要求metamask先对裸交易签名，然后客户端将这笔交易发送给服务端，让服务端向以太坊节点提交交易，这样应用开发者就能够使用各种传统手段保证交易提交，并且能够实施后续各种中心化逻辑了。</p>

<p>看似很美好，然而metamask目前不提供这样的接口。虽然web3js已经有这样的接口，但metamask并没有对接。不过前景还是可以期望的,metamask团队表示已经会进行操作拆分，将来可以这样做。详细可以参考<a href="https://github.com/MetaMask/metamask-extension/issues/3475">Issue#3475</a>.</p>

<h5 id="section-1">3. 弄脏手自己做</h5>

<p>既然靠不了别人，就自己来解决。这第3种解决方案，其实和第二种思路是一样的，只是达到这个目的有些纠结。</p>

<p>首先，metamsk支持web3js一个比较原始的签名方法<code>web3.eth.sign</code>,他是对一段数据进行以太坊签名，看起来可以满足我们的需求，不过为了使用这个方法我们还需要做很多工作。</p>

<p>该方法输入是交易的hash，但web3并没有提供从裸交易数据计算hash的方法，所以我选择让前端提交裸交易数据到服务端，服务端计算出hash值返还给前端;</p>

<p>前端拿到这个交易hash后，就可以调用<code>web3.eth.sign</code>唤起metamask签名，然后将签名字段和裸交易数据再次发送给服务端，服务端负责验证签名并且将交易和签名拼装好后发送到以太坊。</p>

<h1 id="section-2">关键实现</h1>

<h2 id="section-3">1.前端获取裸交易数据</h2>

<p>前端直面用户，可以拿到裸交易全部数据</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class=""><span class="line">{
</span><span class="line">    from: "0x...",
</span><span class="line">    to: "0x....",
</span><span class="line">    value: "0x...",
</span><span class="line">    gas: 10000,
</span><span class="line">    gasPrice: 21000,
</span><span class="line">    data: "0x...",
</span><span class="line">    nonce: "0x..."
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="hash">2.后端计算裸交易hash</h2>

<p>后端拿到前端的裸交易json，可以很容易计算出交易hash，下面给出计算的golang代码</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">tx</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NewTransaction</span><span class="p">(</span><span class="o">...</span><span class="p">.)</span>
</span><span class="line"><span class="nx">hash</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">HomesteadSigner</span><span class="p">{}.</span><span class="nx">Hash</span><span class="p">(</span><span class="nx">tx</span><span class="p">).</span><span class="nx">Hex</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后将计算出的hash返回给前端</p>

<h2 id="metamask-2">3.前端唤起metamask签名</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// 第一个参数是返回的交易hash</span>
</span><span class="line"><span class="c1">// 第二个参数是用户地址</span>
</span><span class="line"><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="s2">&quot;0x...&quot;</span><span class="p">,</span> <span class="s2">&quot;0x...&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里将唤起metamask.</p>

<h2 id="section-4">4.后端发送交易</h2>

<p>前端将裸交易数据和第3步得到的签名发送给后端，后端验证签名并发送到以太坊,关键go代码如下:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">sign</span> <span class="o">:=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Hex2Bytes</span><span class="p">(</span><span class="nx">txSign</span><span class="p">)</span>
</span><span class="line"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">sign</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">65</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;bad sign&quot;</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">if</span> <span class="nx">sign</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">27</span> <span class="o">&amp;&amp;</span> <span class="nx">sign</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">28</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;invalid Ethereum signature (V is not 27 or 28)&quot;</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">sign</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">27</span>
</span><span class="line"><span class="nx">signer</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">HomesteadSigner</span><span class="p">{}</span>
</span><span class="line"><span class="nx">signedTx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">WithSignature</span><span class="p">(</span><span class="nx">signer</span><span class="p">,</span> <span class="nx">sign</span><span class="p">)</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">ethConn</span><span class="p">.</span><span class="nx">SendTransaction</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span> <span class="nx">signedTx</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-5">反思</h1>

<p>看起来，上面的技术方案好像完美解决了问题，实则不然，这只是当前环境下的较优方案罢了，并且这个方案还是存在诸多问题:</p>

<h2 id="section-6">1.安全性</h2>

<p>这是最大的问题,因为调用<code>web3.eth.sign</code>进行数据签名时，metamask无法展示签名的数据，所以用户根本不了解他到底是在对什么授权签名。这是非常可怕的，这可能被骇客利用，让用户对一笔转出自己账户所有余额的交易进行签名，导致资金盗窃。</p>

<h2 id="section-7">2.用户体验</h2>

<p>还是因为签名的方法，metamask在签名时会展示一段红色警告，导致用户体验下降。</p>

<h2 id="section-8">3.时效性</h2>

<p>因为这个安全原因，metamask团队将来也许会放弃对这个方法的支持，不过我倒是觉得，保留对这个方法的支持，将签名数据做详细展示，让开发者自己做安全性的权衡。</p>

<p>最后聊一点感想吧，目前区块链上簇拥了太多投机者，真正致力于深耕技术的人不多，metamask团队算一个，区块链是个有意思的技术，因为它的技术背后，隐含了人类社会化的意识，它目前的基础组件都还不够完善，需要我们热爱技术的所有人，去投入，去发展。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[那些以太坊DApp服务端开发期望已久的轮子]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/05/16/na-xie-yi-tai-fang-dappfu-wu-duan-kai-fa-qi-wang-yi-jiu-de-lun-zi/"/>
    <updated>2018-05-16T17:20:33+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/05/16/na-xie-yi-tai-fang-dappfu-wu-duan-kai-fa-qi-wang-yi-jiu-de-lun-zi</id>
    <content type="html"><![CDATA[<p>以太坊虽说是一个去中心化的东西,但DApp却并非是完全去中心化的应用,其主要原因不外乎是以太坊的处理能力和资源有限,无法承载一个完整应用全部的逻辑。所以，目前市面上所有的DApp应用都是需要中心化服务解释的。那么，本文就是列举一些可能会用到的轮子,帮助快速构建应用。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#nonce">nonce管理</a></li>
  <li><a href="#section">交易重发</a></li>
  <li><a href="#section-1">交易备注</a>    <ul>
      <li><a href="#eth">裸交易(仅发送eth的交易)</a></li>
      <li><a href="#section-2">合约调用交易</a></li>
    </ul>
  </li>
  <li><a href="#section-3">事件扫描器</a></li>
  <li><a href="#section-4">登录</a></li>
  <li><a href="#section-5">其他</a></li>
  <li><a href="#qjpcpuethereumhttpsgithubcomqjpcpuethereum"><a href="https://github.com/qjpcpu/ethereum">代码地址qjpcpu/ethereum</a></a></li>
</ul>

<h1 id="nonce">nonce管理</h1>

<p>重要的放在前面,nonce管理应该是所有以太坊开发者遇到的第一个问题。nonce类似于账户的自增主键,必须连续提交,如果每次都使用<code>pending nonce</code>自动提交交易,就会造成之前交易被丢弃,除非你想要替换原交易，否则这可能不是我们期望的结果。</p>

<p><code>github.com/qjpcpu/ethereum/ethnonce</code>包将nonce存储在redis中,使用类似事务的方式申请、使用nonce。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">TestWrap</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">mgr</span> <span class="o">:=</span> <span class="nx">_testinit</span><span class="p">()</span>
</span><span class="line">	<span class="nx">addr</span> <span class="o">:=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="s">`0xe35f3e2a93322b61e5d8931f806ff38f4a4f4d88`</span><span class="p">)</span>
</span><span class="line">    <span class="nx">mgr</span><span class="p">.</span><span class="nx">SyncNonce</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>  <span class="c1">// 注意,该方法仅在程序第一次运行做初始化时需要调用,或者nonce发生不一致时调用</span>
</span><span class="line">	<span class="nx">tx</span><span class="p">,</span><span class="nx">err</span><span class="o">:=</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">GiveNonceForTx</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">nonce</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// 向以太坊提交交易</span>
</span><span class="line">        <span class="c1">// 使用nonce manager注入的nonce进行交易提交</span>
</span><span class="line">		<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">),</span> <span class="kc">nil</span>
</span><span class="line">	<span class="p">})</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span><span class="o">!=</span><span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">    <span class="nx">t</span><span class="p">.</span><span class="nx">Log</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>P.S. 该包基于redis lua脚本,实现nonce的原子读写,可适用于多协程并行操作。</p>

<h1 id="section">交易重发</h1>

<p>对于要做以太坊交易的可靠提交,我相信交易重发绝对是DApp后端程序员的痛点需求。通常,在以太坊拥堵的时候,常常提交的交易会发生”丢失”,以太坊浏览器上搜索这笔交易会被提示: <code>Sorry, we are unable to locate this Transaction Hash</code>。发生这种情况主要有两个可能: 1.用户给的gas太低,导致交易长时间挂在pending队列不能打包进区块 2. 网络环境恶劣,导致投放的节点丢弃交易(网络环境恶劣只是诱因,其真实的丢包原因是及其复杂的)</p>

<p><code>github.com/qjpcpu/ethereum/contracts</code>提交交易重发的函数</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">ResendTransaction</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ethclient</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">signerFunc</span> <span class="nx">bind</span><span class="p">.</span><span class="nx">SignerFn</span><span class="p">,</span> <span class="nx">nonce</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">gasPrice</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>conn, eth client</li>
  <li>tx, 需要重发的交易</li>
  <li>signerFunc, 交易签名函数</li>
  <li>nonce, 可选参数,为0表示将交易重发为全新的交易,非0表示替换之前未被打包的交易</li>
  <li>gasPrice,可选参数,为nil表示自动选择合适的price</li>
</ul>

<p>返回值为重发的新交易数据结构。</p>

<p>通常的使用场景是:</p>

<ol>
  <li>发送交易,并将返回的交易tx marshal为json存储到数据库</li>
  <li>定时检查交易是否成功打包</li>
  <li>超过超时时间后,调用ResendTransaction重发交易，再进入第1步循环</li>
</ol>

<p>结合第一步<code>ethnonce</code>包管理nonce,可以比较完美实现以太坊可靠交易提交。</p>

<p>简单的代码示例:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">signerFunc</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">SignerFuncOf</span><span class="p">(</span><span class="nx">keyJson</span><span class="p">,</span> <span class="nx">keyPwd</span><span class="p">)</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">oldTx</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span> <span class="p">=</span> <span class="nx">getLastTxFromDB</span><span class="p">()</span>
</span><span class="line"><span class="nx">contracts</span><span class="p">.</span><span class="nx">ResendTransaction</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">oldTx</span><span class="p">,</span> <span class="nx">signerFunc</span><span class="p">,</span> <span class="nx">oldTx</span><span class="p">.</span><span class="nx">Nonce</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-1">交易备注</h1>

<p>交易备注其实就是在交易<code>data</code>字段附加一些额外的数据,前端时间有人收费在以太坊永久”刻字”其实就是干的这个事情。那么，抛开这个噱头不说,正常开发中怎么会有这个需求呢?</p>

<p>比如,我们要基于以太坊做一个区块链商品抢购,前端在提交了交易后拿到<code>metafox</code>回调后,才能通知到后端是抢购的哪个商品,但是很多时候<code>metafox</code>的回调并不可靠,那其实就可以使用交易备注,等后端收到这个交易的event log后,再去查询交易的备注信息就知道了是哪个商品。</p>

<p>相关辅助方法还是在<code>github.com/qjpcpu/ethereum/contracts</code>包中,目前交易备注有两种场景</p>

<h2 id="eth">裸交易(仅发送eth的交易)</h2>

<p>有两个生成交易数据的辅助方法:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// 备注字符串</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">PackString</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
</span><span class="line"><span class="c1">// 备注一个数字</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">PackNum</span><span class="p">(</span><span class="nx">num</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-2">合约调用交易</h2>

<p>也有两个辅助方法,他们均是将备注信息放置在合约方法参数最后:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">PackArgumentsWithNumber</span><span class="p">(</span><span class="nx">_abi</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ABI</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">PackArgumentsWithString</span><span class="p">(</span><span class="nx">_abi</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">ABI</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最后调用发送<code>raw</code>交易的方法提交:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">SendRawTransaction</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ethclient</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">value</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">signerFunc</span> <span class="nx">bind</span><span class="p">.</span><span class="nx">SignerFn</span><span class="p">,</span> <span class="nx">nonce</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">gasPrice</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">gasLimit</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>简单的代码示例(不可直接运行):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">mgr</span> <span class="o">:=</span> <span class="nx">GetNonceManager</span><span class="p">()</span>
</span><span class="line"><span class="nx">_abi</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">ParseABI</span><span class="p">(</span><span class="nx">myABI</span><span class="p">)</span>
</span><span class="line"><span class="nx">signer</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">SignerFuncOf</span><span class="p">(</span><span class="nx">keyjson</span><span class="p">,</span> <span class="nx">keypwd</span><span class="p">)</span>
</span><span class="line"><span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">GiveNonceForTx</span><span class="p">(</span><span class="nx">from_addr</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">nonce</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 该合约方法function_name只有一个number参数,后面额外的参数2是备注</span>
</span><span class="line">	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">PackArgumentsWithNumber</span><span class="p">(</span><span class="nx">_abi</span><span class="p">,</span> <span class="s">&quot;function_name&quot;</span><span class="p">,</span> <span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">contracts</span><span class="p">.</span><span class="nx">SendRawTransaction</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">EthConn</span><span class="p">(),</span> <span class="nx">from_addr</span><span class="p">,</span> <span class="nx">getContractAddress</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">signer</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line"><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-3">事件扫描器</h1>

<p>扫描某个/某些事件并更改中心化服务器数据状态,这个需求很常见,直接上代码.</p>

<p>举个例子,扫描 <code>CryptoKitties</code> 的怀孕事件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/common&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/ethclient&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/qjpcpu/ethereum/events&quot;</span>
</span><span class="line">	<span class="s">&quot;os&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ethclient</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;https://api.myetherapi.com/eth&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">dataCh</span><span class="p">,</span> <span class="nx">errCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">events</span><span class="p">.</span><span class="nx">Event</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="nx">b</span> <span class="o">:=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">NewScanBuilder</span><span class="p">()</span>
</span><span class="line">	<span class="nx">rep</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">SetClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">).</span>
</span><span class="line">		<span class="nx">SetContract</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="s">`0x06012c8cf97BEaD5deAe237070F9587f8E7A266d`</span><span class="p">),</span><span class="nx">abi_text</span><span class="p">,</span><span class="s">&quot;Pregnant&quot;</span><span class="p">).</span>
</span><span class="line">		<span class="nx">SetFrom</span><span class="p">(</span><span class="mi">5547829</span><span class="p">).</span>
</span><span class="line">		<span class="nx">SetGracefullExit</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span>
</span><span class="line">		<span class="nx">BuildAndRun</span><span class="p">(</span><span class="nx">dataCh</span><span class="p">,</span> <span class="nx">errCh</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">done</span> <span class="o">:=</span> <span class="nx">rep</span><span class="p">.</span><span class="nx">WaitChan</span><span class="p">()</span>
</span><span class="line">		<span class="k">for</span> <span class="p">{</span>
</span><span class="line">			<span class="k">select</span> <span class="p">{</span>
</span><span class="line">			<span class="k">case</span> <span class="nx">data</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">dataCh</span><span class="p">:</span>
</span><span class="line">				<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s\n&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</span><span class="line">			<span class="k">case</span> <span class="nx">err1</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">errCh</span><span class="p">:</span>
</span><span class="line">				<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;error:&quot;</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
</span><span class="line">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span><span class="line">				<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;EXIT&quot;</span><span class="p">)</span>
</span><span class="line">				<span class="k">return</span>
</span><span class="line">			<span class="p">}</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}()</span>
</span><span class="line">
</span><span class="line">	<span class="nx">rep</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-4">登录</h1>

<p>以太坊登录其实就是签名和验签.</p>

<p>代码位于包<code>github.com/qjpcpu/ethereum/key</code></p>

<p>示例:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">key</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="nx">crand</span> <span class="s">&quot;crypto/rand&quot;</span>
</span><span class="line">    <span class="s">&quot;github.com/ethereum/go-ethereum/common/hexutil&quot;</span>
</span><span class="line">    <span class="s">&quot;github.com/ethereum/go-ethereum/crypto&quot;</span>
</span><span class="line">    <span class="s">&quot;testing&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">TestSignature</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">pk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">newKey</span><span class="p">(</span><span class="nx">crand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">msg</span> <span class="o">:=</span> <span class="s">&quot;JasonGeek&quot;</span>
</span><span class="line">    <span class="nx">sign</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">Sign</span><span class="p">(</span><span class="nx">pk</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">from</span> <span class="o">:=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">PubkeyToAddress</span><span class="p">(</span><span class="nx">pk</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">).</span><span class="nx">Hex</span><span class="p">()</span>
</span><span class="line">    <span class="nx">signHex</span> <span class="o">:=</span> <span class="nx">hexutil</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">sign</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">VerifySign</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">signHex</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-5">其他</h1>

<p>其他辅助小方法,可能痛点不是那么强烈,我简单列举,有需要的自行参看代码 <a href="https://github.com/qjpcpu/ethereum">qjpcpu/ethereum</a></p>

<ul>
  <li>获取合约From自段 <code>func (tx *TransactionWithExtra) From() common.Address</code></li>
  <li>合约是否执行成功 <code>func (tx *TransactionWithExtra) IsSuccess(conn *ethclient.Client) (bool, error)</code></li>
  <li>某个地址是否是个合约 <code>func IsContract(conn *ethclient.Client, hexAddr string) bool</code></li>
  <li>交易构造builder <code>func NewTxOptsBuilder(keyJson, keyPwd string) *TxOptsBuilder</code></li>
  <li>等待交易完成 <code>func WaitTxDone(conn *ethclient.Client, txhash common.Hash, timeout ...time.Duration) error</code></li>
  <li>根据keystore私钥生成签名方法 <code>func SignerFuncOf(keyJson, keyPasswd string) bind.SignerFn</code></li>
  <li>直接发送ETH <code>func TransferETH(conn *ethclient.Client, from, to common.Address, amount *big.Int, signerFunc bind.SignerFn, nonce uint64, gasPrice *big.Int, notes ...string) (*types.Transaction, error)</code></li>
  <li>私钥导入导出 <code>key</code>包</li>
</ul>

<h1 id="qjpcpuethereumhttpsgithubcomqjpcpuethereum"><a href="https://github.com/qjpcpu/ethereum">代码地址qjpcpu/ethereum</a></h1>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ethereum-solidity的坑]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/04/02/ethereum-solidityde-keng/"/>
    <updated>2018-04-02T10:54:43+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/04/02/ethereum-solidityde-keng</id>
    <content type="html"><![CDATA[<p>以太坊合约的坑.</p>

<!-- more -->

<h1 id="section">被意外更改的合约变量</h1>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">11</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="nx">contract</span> <span class="nx">Test</span><span class="p">{</span>
</span><span class="line">    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">a</span><span class="p">;</span>
</span><span class="line">    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">b</span><span class="p">;</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">Test</span><span class="p">()</span> <span class="kr">public</span><span class="p">{</span>
</span><span class="line">        <span class="nx">a</span><span class="o">=</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
</span><span class="line">        <span class="nx">b</span><span class="o">=</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
</span><span class="line">        <span class="nx">uint256</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="nx">g</span><span class="o">=</span><span class="p">[</span><span class="nx">uint256</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="nx">uint256</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>
</span><span class="line">        <span class="nx">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nx">uint256</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果<code>msg.sender</code>是 <code>0xca35b7d915458ef540ade6068dfe2f44e8fa733c</code>,那么想象中的合约变量<code>a,b</code>都应该是这个值,但是结果却是:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// a: address: 0xffffffffffffffffffffffffffffffffffffffff</span>
</span><span class="line"><span class="c1">// b: address: 0xca35b7d915458ef540ade6068dfe2f44e8fa733c</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以看出<code>a</code>变成了 <code>g[0]</code>的值。 这是因为solidity对于这个未初始化的数组时,把它指向了合约变量地址,所以修改 <code>g[0]</code>就相当于修改了 <code>a</code>,读者可以试试修改 <code>g[1]</code>实际是修改了 <code>b</code>.</p>

<p>解决办法是将数组改成<code>memory</code>,防止他变成<code>storage</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">uint256</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="nx">memory</span> <span class="nx">g</span> <span class="o">=</span> <span class="p">[</span><span class="nx">uint256</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nx">uint256</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[以太坊合约开发中那些危险的坑]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/03/18/yi-tai-fang-he-yue-kai-fa-zhong-na-xie-wei-xian-de-keng/"/>
    <updated>2018-03-18T16:29:02+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/03/18/yi-tai-fang-he-yue-kai-fa-zhong-na-xie-wei-xian-de-keng</id>
    <content type="html"><![CDATA[<p>列举合约开发中那些危险的操作.</p>

<!-- more -->

<p><a href="https://github.com/ConsenSys/smart-contract-best-practices/blob/master/README-zh.md">以太坊智能合约 —— 最佳安全开发指南</a></p>

<p><a href="http://me.tryblockchain.org/blockchain-solidity-fallback.html">Solidity的fallback函数</a></p>

<p><a href="http://me.tryblockchain.org/Solidity-call-callcode-delegatecall.html">深入浅出Solidity call相关函数</a></p>

<p><a href="http://me.tryblockchain.org/blockchain-solidity-send-ether-bestpractice.html">Solidity发送ether最佳实践</a></p>

<p><a href="http://solidity.readthedocs.io/en/v0.4.21/contracts.html#fallback-function">Fallback Function</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[以太坊实战-交易爬虫]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/03/13/yi-tai-fang-shi-zhan-jiao-yi-pa-chong/"/>
    <updated>2018-03-13T19:46:40+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/03/13/yi-tai-fang-shi-zhan-jiao-yi-pa-chong</id>
    <content type="html"><![CDATA[<p>本文从一个区块链跑路项目说起,怎么通过大家可见的区块数据进行自己的业务分析,目的主要是讲述中间涉及到的技术,如果你能从中获益,并因此构建自己更加强大的分析工具,我深感荣幸.</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">防止区块链项目跑路</a></li>
  <li><a href="#section-1">服务端控制智能合约</a></li>
  <li><a href="#erc20">ERC20关键参数获取</a>    <ul>
      <li><a href="#section-2">某个地址是否合约</a></li>
      <li><a href="#from">From</a></li>
      <li><a href="#to">To</a>        <ul>
          <li><a href="#section-3">函数签名</a></li>
          <li><a href="#section-4">参数编码</a></li>
          <li><a href="#transfer">transfer</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#put-it-together">Put it together</a></li>
  <li><a href="#section-5">参考文献</a></li>
</ul>

<h1 id="section">防止区块链项目跑路</h1>

<p>首先要说说这个争议颇多的英雄链: 做为首个全球加密数字货币区块链博彩平台的建设者，HeroChain致力打造数字货币一站式博彩娱乐互动平台，是实现在区块链上加密数字货币的娱乐和产品集合服务平台。HeroChain团队目标是落地与合作全球85个博彩合法的国家和地区，或博彩业合法牌照或与当地博彩业紧密合作，未来使得HEC能与线下赌场打通，使得HEC拥有更大的交易场景。团队认为：HEC的应用覆盖和使用领域确实足以支撑这个巨量加密数字货币的流通市值。由于没有税收，使得HeroChain团队每年可以拿出收益的30%，在进行市场回购HEC， 让参与者获利。关键这个博彩业市场不像之前其它项目的预测的预期市场，是庞大而真实的网络娱乐刚需市场。</p>

<p>从这段描述来看，英雄链所针对的应用场景和未来目标都是非常有说服力的。然而目前出现有用户和项目团队因为破发矛盾激化,进而对该项目本身也产生各种质疑。媒体也对其核心人员的资金流向进行了分析:</p>

<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/JFoxiaVESXq0R8KvzDkcyicO28Yyo94Ngzl8JoqNXcPxFBgibetLQ74ENNDiaFY1S3gQokIAddFrxI9snaPooY4dWA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="balance flow" /></p>

<p>从结果来看，项目募集的资金都最终流向了某一个地址，确实存在发行者卷款跑路的可能(详细分析可以查阅参考文献两篇文章)。</p>

<p>我这里只是以这件事件做一个引子，由于区块链的数据对大众完全透明公开,所有人的资金流向其实都摆在眼前，只是说现在链上基础工具不完善，普通人很难去分析这庞大而精细的交易记录。如果我们做一个交易爬虫，能够轻松分析任意账户的资金流动，那么不论是对普通小白验证项目的可信度还是金融从业者分析深度数据，都是很有价值的。</p>

<p>下面，我就介绍下，如果要产生ERC20某个代币的资金流向图(类似下图)，要注意哪些技术关键点。</p>

<p><img src="https://mmbiz.qpic.cn/mmbiz_png/JFoxiaVESXq0R8KvzDkcyicO28Yyo94NgzgqH5wW9TgI5o4zoBZB3owgvXNbykPhEkEep9zHS5rjqm0GD12BfgRg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="hec" /></p>

<h1 id="section-1">服务端控制智能合约</h1>

<p>要和智能合约进行交互,显然需要完成通用编程语言对合约的控制,这里我们以<code>golang</code>代码为例,展示怎么从<code>golang</code>中调用合约函数。<a href="https://github.com/ethereum/go-ethereum">官方go-ethereum</a>已经提供了这样的工具<code>abigen</code>,直接从合约<code>sol</code>代码生成go代码:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Command</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code>abigen</code></td>
      <td>Source code generator to convert Ethereum contract definitions into easy to use, compile-time type-safe Go packages. It operates on plain <a href="https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI">Ethereum contract ABIs</a> with expanded functionality if the contract bytecode is also available. However it also accepts Solidity source files, making development much more streamlined. Please see our <a href="https://github.com/ethereum/go-ethereum/wiki/Native-DApps:-Go-bindings-to-Ethereum-contracts">Native DApps</a> wiki page for details.</td>
    </tr>
  </tbody>
</table>

<p>那我们要分析erc20的代币，所以定义好一份接口合约即可:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">Token</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">name</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">string</span> <span class="nx">name</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// 可选方法，返回代币符号，如EOS</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">symbol</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">string</span> <span class="nx">symbol</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// 可选方法,返回代币小数位数，如8</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">decimals</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint8</span> <span class="nx">decimals</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 货币总发行量</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">totalSupply</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">totalSupply</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// 获取某个账户的代币余额</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">balance</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// (本人)向某人转账</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// (本人)批准只能合约可以向某人转账</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_spender</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// 合约代理from向to转账(须先经过from账户approve)</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">transferFrom</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// 查询_owner允许合约代理向_spender转账的金额</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">allowance</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_spender</span><span class="p">)</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">remaining</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后使用<code>abigen</code>工具生成go代码</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">abigen --sol ./erc20.sol --pkg erc20 --out token.go
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后在<code>golang</code>中就可以像这样调用合约函数:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;log&quot;</span>
</span><span class="line">
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/common&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/ethclient&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="c1">// Create an IPC based RPC connection to a remote node</span>
</span><span class="line">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ethclient</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;/home/karalabe/.ethereum/testnet/geth.ipc&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to connect to the Ethereum client: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="c1">// Instantiate the contract and display its name</span>
</span><span class="line">	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">NewToken</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="s">&quot;0x21e6fc92f93c8a1bb41e2be64b4e1f88a54d3576&quot;</span><span class="p">),</span> <span class="nx">conn</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to instantiate a Token contract: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Name</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to retrieve token name: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Token name:&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="erc20">ERC20关键参数获取</h1>

<p>做交易爬虫,现在最关键的是分析交易参数,比如这是<code>etherscan.io</code>上一个<code>MCAP</code>转账交易:</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-tx.png" alt="tx" /></p>

<h2 id="section-2">某个地址是否合约</h2>

<p>在交易里，如果是合约的调用那么<code>To</code>字段必然是一个合约地址,那么当我们拿到一个交易时，怎么判断这个交易是否一次合约调用呢，或者怎么判断<code>To</code>是合约地址而不是用户钱包地址呢？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="err">很简单</span><span class="p">,</span><span class="err">地址对应存储位置上有代码则是合约地址</span><span class="p">,</span><span class="err">反之是用户钱包</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>理解了这个原理,那么在go代码里就很容易判断了:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// 某个地址是否合约</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">IsContract</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ethclient</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">hexAddr</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">code</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">CodeAt</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span> <span class="nx">common</span><span class="p">.</span><span class="nx">HexToAddress</span><span class="p">(</span><span class="nx">hexAddr</span><span class="p">),</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>这里附上其他环境判断是否合约的方法</p>
</blockquote>

<p>在合约solidity代码里判断:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">function</span> <span class="nx">isContract</span><span class="p">(</span><span class="nx">address</span> <span class="nx">addr</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">uint</span> <span class="nx">size</span><span class="p">;</span>
</span><span class="line">  <span class="nx">assembly</span> <span class="p">{</span> <span class="nx">size</span> <span class="o">:=</span> <span class="nx">extcodesize</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在<code>geth</code>的console:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">eth.getCode<span class="o">(</span><span class="s2">&quot;0xbfb2e296d9cf3e593e79981235aed29ab9984c0f&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="from">From</h2>

<p><code>From</code>无法直接从交易函数里获取,因为来源地址可以从签名里反解出来,为了拿取到这个字段,用的方法是解析交易的<code>String()</code>输出来获取,虽然办法效率不高,但为了不改动源码这是最简单的。</p>

<p>[update]<code>from</code>获取已经更新,不再使用正则解析,详见代码<a href="https://github.com/qjpcpu/ethereum/blob/f3fa29e5d9ef3762d69dd838a465ee0e8b116e1f/contracts/helper.go#L35">get from field</a></p>

<h2 id="to">To</h2>

<p>收款地址的获取就比较麻烦一些了，它不像eth的直接转账,交易的<code>to</code>字段就是收款地址,合约调用的<code>To</code>是合约地址,真正的收款地址存放在<code>Data</code>字段里,那么我们来看看<code>Data</code>字段怎么编码的。</p>

<h3 id="section-3">函数签名</h3>

<p><code>Data</code>的起始4个字节是函数签名的sha3结果的前缀,举个例子,对于下面的合约</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">Foo</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">bar</span><span class="p">(</span><span class="nx">fixed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="nx">xy</span><span class="p">)</span> <span class="p">{}</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">baz</span><span class="p">(</span><span class="nx">uint32</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">bool</span> <span class="nx">y</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="nx">y</span><span class="p">;</span> <span class="p">}</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">sam</span><span class="p">(</span><span class="nx">bytes</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">bool</span> <span class="nx">z</span><span class="p">,</span> <span class="nx">uint</span><span class="p">[]</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><code>
如果要调用</code>baz<code>函数,则结果应该是</code>keccak256(“baz(uint32,bool)”)[0:4]<code>转换为16进制是</code>0xcdcd77c0`</p>

<h3 id="section-4">参数编码</h3>

<p>参数编码是依次对函数签名每个参数进行32字节左补齐编码,如<code>baz(69,true)</code>这次调用,参数<code>69</code>和<code>true</code>分别编码结果是:</p>

<ul>
  <li><code>69</code>,编码为<code>0x0000000000000000000000000000000000000000000000000000000000000045</code></li>
  <li><code>true</code>,编码为<code>0x0000000000000000000000000000000000000000000000000000000000000001</code></li>
</ul>

<p>那么整合起来,<code>baz(69,true)</code>调用时交易的<code>Data</code>应该为:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="mh">0xcdcd77c000000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="transfer">transfer</h3>

<p>回到我们的需求,我们要分析的20代币的转账，其实就是分析<code>transfer(address _to,unit256 _value)</code>的合约函数调用,该函数签名编码是<code>0xa9059cbb</code>,比如我们要对<code>0x54d28e24df3a2381d4c072118da0ef0a51a4fcd9</code>转账<code>493480000</code>个MCAP,编码过程为:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nb">Function</span><span class="o">:</span> <span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="nx">MethodID</span><span class="o">:</span> <span class="mh">0xa9059cbb</span>
</span><span class="line"><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span>  <span class="mi">00000000000000000000000054</span><span class="nx">d28e24df3a2381d4c072118da0ef0a51a4fcd9</span>
</span><span class="line"><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span>  <span class="mi">000000000000000000000000000000000000000000000000000000001</span><span class="nx">d69e840</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最终结果<code>Data</code>是</p>

<p><code>0xa9059cbb00000000000000000000000054d28e24df3a2381d4c072118da0ef0a51a4fcd9000000000000000000000000000000000000000000000000000000001d69e840</code></p>

<h1 id="put-it-together">Put it together</h1>

<p>把这上面关键点整合起来,就可以构建一个简单爬虫,这个爬虫执行流程应该是:</p>

<ul>
  <li>遍历区块交易,取到我们关注的某个合约的所有转账交易</li>
  <li>解析交易关键字段,包含交易ID,from,to,金额,时间戳</li>
  <li>入库,提供webAPI给应用层</li>
</ul>

<h1 id="section-5">参考文献</h1>

<ul>
  <li><a href="https://mp.weixin.qq.com/s/2wG9-NyeHwan8pgmlaLSwQ">英雄链深度调查 永不说谎的地址</a></li>
  <li><a href="https://mp.weixin.qq.com/s/KPIDMwujSZI_MhpmMIG5Gg?scene=25#wechat_redirect">谁是英雄链背后的英雄</a></li>
  <li><a href="https://github.com/ethereum/go-ethereum/wiki/Native-DApps:-Go-bindings-to-Ethereum-contracts">Go bindings to Ethereum contracts</a></li>
  <li><a href="https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI#argument-encoding">Ethereum Contract ABI</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[solidity备忘录]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/03/08/soliditybei-wang-lu/"/>
    <updated>2018-03-08T09:38:45+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/03/08/soliditybei-wang-lu</id>
    <content type="html"><![CDATA[<p>关于以太坊solidity语言一些有趣或者有意义的tips.</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#basic-sytax">basic sytax</a>    <ul>
      <li><a href="#section">字符串比较</a></li>
      <li><a href="#storage-vs-memory">storage vs memory</a></li>
    </ul>
  </li>
  <li><a href="#function">function</a>    <ul>
      <li><a href="#section-1">访问修饰符</a></li>
      <li><a href="#section-2">函数修饰符</a></li>
    </ul>
  </li>
  <li><a href="#msg">msg</a></li>
  <li><a href="#section-3">接口</a></li>
  <li><a href="#ownable">Ownable</a></li>
  <li><a href="#section-4">性能优化</a></li>
  <li><a href="#section-5">间接转账</a>    <ul>
      <li><a href="#section-6">将发到合约的转账再转给另一个地址</a></li>
      <li><a href="#eth">将发到合约的eth再转发给另一个合约调用</a></li>
    </ul>
  </li>
</ul>

<h1 id="basic-sytax">basic sytax</h1>

<h2 id="section">字符串比较</h2>

<p><code>solidity</code>本身无法直接比较字符串,需要转换成整数比较</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;aaaab&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;bbbbbc&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="storage-vs-memory">storage vs memory</h2>

<ul>
  <li><code>storage</code>,变量将存储到链上,如合约变量默认即storage</li>
  <li><code>memory</code>, 内存临时变量</li>
</ul>

<h1 id="function">function</h1>

<h2 id="section-1">访问修饰符</h2>

<ul>
  <li><code>public</code>, 任何人可以调用,包括其他合约</li>
  <li><code>private</code>, 仅本合约可调用</li>
  <li><code>internal</code>, 本合约和继承本合约的合约可调用</li>
  <li><code>external</code>, 仅能外部调用</li>
</ul>

<h2 id="section-2">函数修饰符</h2>

<ul>
  <li><code>view</code>, 仅查看数据不修改数据,另外注意<code>view</code>修饰符不耗费gas,因为它只做本地查询</li>
  <li><code>pure</code>, 根本不访问(区块链)数据,如仅做内存数学计算</li>
</ul>

<p>函数修饰符还可以带参数:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// 存储用户年龄的映射</span>
</span><span class="line"><span class="nx">mapping</span> <span class="p">(</span><span class="nx">uint</span> <span class="o">=&gt;</span> <span class="nx">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">age</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 限定用户年龄的修饰符</span>
</span><span class="line"><span class="nx">modifier</span> <span class="nx">olderThan</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_age</span><span class="p">,</span> <span class="nx">uint</span> <span class="nx">_userId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">require</span><span class="p">(</span><span class="nx">age</span><span class="p">[</span><span class="nx">_userId</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_age</span><span class="p">);</span>
</span><span class="line">  <span class="nx">_</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 必须年满16周岁才允许开车 (至少在美国是这样的).</span>
</span><span class="line"><span class="c1">// 我们可以用如下参数调用`olderThan` 修饰符:</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">driveCar</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">_userId</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">olderThan</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nx">_userId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// 其余的程序逻辑</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="msg">msg</h1>

<p>msg对象有几个常用属性</p>

<ul>
  <li><code>msg.sender</code>, 合约调用者</li>
  <li><code>msg.value</code>, 合约调用者发送的ETH金额</li>
</ul>

<h1 id="section-3">接口</h1>

<p>接口定义及使用非常简单,不需要额外语言描述.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// 声明</span>
</span><span class="line"><span class="nx">contract</span> <span class="nx">NumberInterface</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">getNum</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_myAddress</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">contract</span> <span class="nx">MyContract</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">address</span> <span class="nx">NumberInterfaceAddress</span> <span class="o">=</span> <span class="mh">0x06012c8cf97BEaD5deAe237070F9587f8E</span><span class="p">....;</span>
</span><span class="line">  <span class="c1">// ^ The address of the FavoriteNumber contract on Ethereum</span>
</span><span class="line">  <span class="nx">NumberInterface</span> <span class="nx">numberContract</span> <span class="o">=</span> <span class="nx">NumberInterface</span><span class="p">(</span><span class="nx">NumberInterfaceAddress</span><span class="p">);</span>
</span><span class="line">  <span class="c1">// Now numberContract is pointing to the other contract</span>
</span><span class="line">
</span><span class="line">  <span class="kd">function</span> <span class="nx">someFunction</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
</span><span class="line">     <span class="c1">// Now we can call getNum from that contract:</span>
</span><span class="line">     <span class="nx">uint</span> <span class="nx">num</span> <span class="o">=</span> <span class="nx">numberContract</span><span class="p">.</span><span class="nx">getNum</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
</span><span class="line">    <span class="c1">// ...and do something with num here</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>接口的使用和实现分离的特点,也是实战中重要特性:解决bugfix,调用外部合同等等灵活场景.</p>

<h1 id="ownable">Ownable</h1>

<p><code>Ownable</code>是进行合约管理的常用手段</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * @title Ownable</span>
</span><span class="line"><span class="cm"> * @dev The Ownable contract has an owner address, and provides basic authorization control</span>
</span><span class="line"><span class="cm"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="nx">contract</span> <span class="nx">Ownable</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">address</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>
</span><span class="line">  <span class="nx">event</span> <span class="nx">OwnershipTransferred</span><span class="p">(</span><span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">previousOwner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">newOwner</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * @dev The Ownable constructor sets the original `owner` of the contract to the sender</span>
</span><span class="line"><span class="cm">   * account.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">Ownable</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * @dev Throws if called by any account other than the owner.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nx">modifier</span> <span class="nx">onlyOwner</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">);</span>
</span><span class="line">    <span class="nx">_</span><span class="p">;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * @dev Allows the current owner to transfer control of the contract to a newOwner.</span>
</span><span class="line"><span class="cm">   * @param newOwner The address to transfer ownership to.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">transferOwnership</span><span class="p">(</span><span class="nx">address</span> <span class="nx">newOwner</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">require</span><span class="p">(</span><span class="nx">newOwner</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class="line">    <span class="nx">OwnershipTransferred</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">newOwner</span><span class="p">);</span>
</span><span class="line">    <span class="nx">owner</span> <span class="o">=</span> <span class="nx">newOwner</span><span class="p">;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-4">性能优化</h1>

<p>通常情况下我们不会考虑使用 unit 变种，因为无论如何定义 uint的大小，Solidity 为它保留256位的存储空间。例如，使用 uint8 而不是uint（uint256）不会为你节省任何gas。</p>

<p>除非，把 unit 绑定到 struct 里面。</p>

<p>如果一个 struct 中有多个 uint，则尽可能使用较小的 uint, Solidity 会将这些 uint 打包在一起，从而占用较少的存储空间。例如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">struct</span> <span class="nx">NormalStruct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">uint</span> <span class="nx">a</span><span class="p">;</span>
</span><span class="line">  <span class="nx">uint</span> <span class="nx">b</span><span class="p">;</span>
</span><span class="line">  <span class="nx">uint</span> <span class="nx">c</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">struct</span> <span class="nx">MiniMe</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">uint32</span> <span class="nx">a</span><span class="p">;</span>
</span><span class="line">  <span class="nx">uint32</span> <span class="nx">b</span><span class="p">;</span>
</span><span class="line">  <span class="nx">uint</span> <span class="nx">c</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>// 因为使用了结构打包，<code>mini</code> 比 <code>normal</code> 占用的空间更少</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">NormalStruct</span> <span class="nx">normal</span> <span class="o">=</span> <span class="nx">NormalStruct</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
</span><span class="line"><span class="nx">MiniMe</span> <span class="nx">mini</span> <span class="o">=</span> <span class="nx">MiniMe</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>所以，当 uint 定义在一个 struct 中的时候，尽量使用最小的整数子类型以节约空间。 并且把同样类型的变量放一起（即在struct中将把变量按照类型依次放置），这样 Solidity 可以将存储空间最小化。例如，有两个 struct：</p>

<p>uint c; uint32 a; uint32 b; 和 uint32 a; uint c; uint32 b;</p>

<p>前者比后者需要的gas更少，因为前者把uint32放一起了。</p>

<h1 id="section-5">间接转账</h1>

<p>直接转账用<code>who.transfer(value)</code>,这个很常见, 但有时候还是需要间接转账</p>

<h2 id="section-6">将发到合约的转账再转给另一个地址</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">function</span> <span class="nx">delayTransfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">_to</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个示例就是一个间接转账,这笔转账能够完成的原因其实是,调用这个函数时，用户发过来的eth已经加到合约上了，所以可以再转给第三个地址。</p>

<h2 id="eth">将发到合约的eth再转发给另一个合约调用</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">Sub</span> <span class="p">{</span>
</span><span class="line">   <span class="nx">address</span> <span class="nx">realReceiver</span><span class="p">;</span>
</span><span class="line">   <span class="kd">function</span> <span class="nx">recevice</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
</span><span class="line">       <span class="nx">realReceiver</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">contract</span> <span class="nx">Main</span><span class="p">{</span>
</span><span class="line">  <span class="nx">Sub</span> <span class="nx">sub</span><span class="p">;</span>
</span><span class="line">  <span class="kd">function</span> <span class="nx">transferToSub</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span><span class="p">{</span>
</span><span class="line">      <span class="nx">sub</span><span class="p">.</span><span class="nx">recevice</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">)();</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>上面示例将用户的eth通过两次转发最终发给了<code>realReceiver</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[基于以太坊的数字资产]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/03/06/ji-yu-yi-tai-fang-de-shu-zi-zi-chan/"/>
    <updated>2018-03-06T18:24:35+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/03/06/ji-yu-yi-tai-fang-de-shu-zi-zi-chan</id>
    <content type="html"><![CDATA[<p>代币(token)是什么?</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">什么是代币</a>    <ul>
      <li><a href="#section-1">最小可用代币</a></li>
    </ul>
  </li>
  <li><a href="#erc20">ERC20</a>    <ul>
      <li><a href="#section-2">大纲</a></li>
      <li><a href="#section-3">摘要</a></li>
      <li><a href="#section-4">动机</a></li>
      <li><a href="#section-5">标准内容</a>        <ul>
          <li><a href="#section-6">方法定义</a></li>
          <li><a href="#section-7">事件定义</a></li>
          <li><a href="#section-8">范例</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#erc721">ERC721</a>    <ul>
      <li><a href="#section-9">实用性</a></li>
      <li><a href="#nft-ids">NFT IDs</a></li>
      <li><a href="#section-10">向后兼容性</a></li>
    </ul>
  </li>
  <li><a href="#section-11">其他问题</a>    <ul>
      <li><a href="#gas">自动装填gas</a></li>
    </ul>
  </li>
  <li><a href="#section-12">参考文献</a></li>
</ul>

<h1 id="section">什么是代币</h1>

<p>通常区块链上由矿工挖出的币种,我们把它称之为初代币，初代币是该区块链最底层的货币，链上的转账及各类基础交易都是以初代币作为结算依据。比如比特币对于比特币区块链，以太币之于以太坊等等。</p>

<p>而通常我们说的代币,或者token(令牌),又指的是什么呢？代币是基于区块链的智能合约定义出的二代币,如果把比特币/以太币比作tcp层的数据包，那么代币就可以类比为http层的http包，它是一个更加上层的概念。</p>

<p>目前市场上发行的代币大部分都是基于以太坊，这是因为以太坊本身是一个图灵完备的区块链，即它的智能合约语言是图灵完备语言。对比起来比特币链上的脚本是非图灵完备的。正是因为以太坊的图灵完备性，使得基于以太坊的开发者可以根据自己的业务需求设计出各种特性各异的代币,它们可以代表任何可替代的可交易商品: 虚拟货币，忠诚点，金牌，白条，游戏内物品等。</p>

<h2 id="section-1">最小可用代币</h2>

<p>标准令牌合约可能相当复杂。但实际上，一个非常基本的令牌归结为:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">contract</span> <span class="nx">MyToken</span> <span class="p">{</span>
</span><span class="line">    <span class="cm">/* This creates an array with all balances */</span>
</span><span class="line">    <span class="nx">mapping</span> <span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">balanceOf</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/* Initializes contract with initial supply tokens to the creator of the contract */</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">MyToken</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">initialSupply</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">balanceOf</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">initialSupply</span><span class="p">;</span>              <span class="c1">// Give the creator all initial tokens</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/* Send coins */</span>
</span><span class="line">    <span class="kd">function</span> <span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">balanceOf</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_value</span><span class="p">);</span>           <span class="c1">// Check if the sender has enough</span>
</span><span class="line">        <span class="nx">require</span><span class="p">(</span><span class="nx">balanceOf</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span> <span class="o">+</span> <span class="nx">_value</span> <span class="o">&gt;=</span> <span class="nx">balanceOf</span><span class="p">[</span><span class="nx">_to</span><span class="p">]);</span> <span class="c1">// Check for overflows</span>
</span><span class="line">        <span class="nx">balanceOf</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">_value</span><span class="p">;</span>                    <span class="c1">// Subtract from the sender</span>
</span><span class="line">        <span class="nx">balanceOf</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">_value</span><span class="p">;</span>                           <span class="c1">// Add the same to the recipient</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>阅读这段代码时，请不要拘泥于<code>token</code>的字面意思。这里的<code>MyToken</code>在发行时限定了发行总额(合约构造函数),同时具备了转账功能<code>transfer</code>。那么其实他就是一个简易的货币,具备作为物物交易的中间桥梁来转移价值的能力。</p>

<h1 id="erc20">ERC20</h1>

<p>以以太坊为例，由于大家均在链上以大致相同的方式发行了各自的代币，逐渐发现其实这里面有共同的模式可以被提炼出来:由于所有代币都以标准方式实施一些基本功能，这也意味着您的代币将立即与以太坊钱包和任何其他使用相同标准的客户或合同兼容.于是就出现了<code>ERC20</code>提案。</p>

<h2 id="section-2">大纲</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">EIP</span><span class="o">:</span> <span class="mi">20</span>
</span><span class="line"><span class="nx">Title</span><span class="o">:</span> <span class="nx">ERC</span><span class="o">-</span><span class="mi">20</span> <span class="nx">Token</span> <span class="nx">Standard</span>
</span><span class="line"><span class="nx">Author</span><span class="o">:</span> <span class="nx">Fabian</span> <span class="nx">Vogelsteller</span> <span class="o">&lt;</span><span class="nx">fabian</span><span class="err">@</span><span class="nx">ethereum</span><span class="p">.</span><span class="nx">org</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">Vitalik</span> <span class="nx">Buterin</span> <span class="o">&lt;</span><span class="nx">vitalik</span><span class="p">.</span><span class="nx">buterin</span><span class="err">@</span><span class="nx">ethereum</span><span class="p">.</span><span class="nx">org</span><span class="o">&gt;</span>
</span><span class="line"><span class="nx">Type</span><span class="o">:</span> <span class="nx">Standard</span>
</span><span class="line"><span class="nx">Category</span><span class="o">:</span> <span class="nx">ERC</span>
</span><span class="line"><span class="nx">Status</span><span class="o">:</span> <span class="nx">Accepted</span>
</span><span class="line"><span class="nx">Created</span><span class="o">:</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">19</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-3">摘要</h2>

<p>以下标准定义了在智能合约中实施代币的标准API。该标准提供了传送代币的基本功能，并允许代币被批准，以便其他链上第三方可以使用它们。</p>

<h2 id="section-4">动机</h2>

<p>标准接口允许其他应用程序重新使用以太坊上的任何令牌：从钱包到分散式交换。</p>

<h2 id="section-5">标准内容</h2>

<h3 id="section-6">方法定义</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// 可选方法,返回代币名称,如MyToken</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">name</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">string</span> <span class="nx">name</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 可选方法，返回代币符号，如EOS</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">symbol</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">string</span> <span class="nx">symbol</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 可选方法,返回代币小数位数，如8</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">decimals</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint8</span> <span class="nx">decimals</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 货币总发行量</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">totalSupply</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">totalSupply</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 获取某个账户的代币余额</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">)</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">balance</span><span class="p">)</span>
</span><span class="line"><span class="c1">// (本人)向某人转账</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">)</span>
</span><span class="line"><span class="c1">// (本人)批准只能合约可以向某人转账</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">approve</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_spender</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 合约代理from向to转账(须先经过from账户approve)</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">transferFrom</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 查询_owner允许合约代理向_spender转账的金额</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">allowance</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_owner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">_spender</span><span class="p">)</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">remaining</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-7">事件定义</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// 转移代币时必须触发该事件</span>
</span><span class="line"><span class="nx">event</span> <span class="nx">Transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">_from</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span>
</span><span class="line"><span class="c1">// 批准代币时必须触发该事件</span>
</span><span class="line"><span class="nx">event</span> <span class="nx">Approval</span><span class="p">(</span><span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">_owner</span><span class="p">,</span> <span class="nx">address</span> <span class="nx">indexed</span> <span class="nx">_spender</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-8">范例</h3>

<p><a href="https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/contracts/token/ERC20/StandardToken.sol">https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/contracts/token/ERC20/StandardToken.sol</a>
<a href="https://github.com/ConsenSys/Tokens/blob/master/contracts/eip20/EIP20.sol">https://github.com/ConsenSys/Tokens/blob/master/contracts/eip20/EIP20.sol</a></p>

<h1 id="erc721">ERC721</h1>

<p>至于erc721的产生是为了解决数字资产唯一性问题。本质上说，erc20的两个代币之间是没有任何区别的，所以它适合作为通用的数字货币来流通，单还有一类有区别的场景，比如数字世界里我的一栋房子和你的一栋房子，他们的面积，朝向，颜色等等都会有区别，是无法同质化标识的，所以就有了erc721.</p>

<p>ERC721官方称谓是:Non-fungible Token Standard(NFT),非同质化代币标准。</p>

<p>ERC721的标准内容我这里不再详述，具体标准可以参考github上以太坊提案,实现实例的话，以太猫就是最好的代表。</p>

<h3 id="section-9">实用性</h3>

<p>许多以太坊智能合约的建议用途都依赖于跟踪单个非同质币（NFTs）。现有或计划中的NFTs 有很多，例如 Decentraland 中的 LAND，与CryptoPunks 项目同名的punks（朋克），以及Dmarket 或 EnjinCoin 等系统的游戏内物品。未来的用途包括检测真实世界中的非同质资产，例如房地产（例如 Ubitquity 或 Propy 等公司所设想的）。在这些情况下，项目在账本中不是“集中在一起的”，相反，每单位代币必须有独立的所有权并自动跟踪，这非常重要。无论这些项目的性质如何，如果我们有一个标准化的接口，并且建立跨功能的NFTs管理和销售平台，这将使得生态系统更加强大。</p>

<h3 id="nft-ids">NFT IDs</h3>

<p>该标准的基础是，每一个 NFT 在跟踪它的合约中，用唯一的一个256 位无符号整数进行标识。每个NFT 的 ID 标号在智能合约的生命周期内不允许改变。元组 ( contract address, asset ID ) 是每个特定 NFT 在以太坊生态系统中的全局唯一且完全合格的标识。虽然某些合约可能觉得 ID 从 0 开始编码，并且对于每一个新 NFT 的 ID 简单增 1 进行编码更加简便，但是使用者绝不能假设 ID 编号具有任何特定模式，并且需要将 ID 编码看做 “黑盒”。</p>

<h3 id="section-10">向后兼容性</h3>

<p>本标准尽可能遵循 ERC-20 的语义，但由于同质代币与非同质代币之间的根本差异，并不能完全兼容 ERC-20。</p>

<h1 id="section-11">其他问题</h1>

<h2 id="gas">自动装填gas</h2>

<p>每次，您在Ethereum上进行交易，您需要向该块矿工支付费用，以计算您的智能合约的结果。虽然这可能会在未来发生变化，但目前费用只能在以太网中支付，因此您的代币的所有用户都需要它。账户余额小于费用的账户被卡住，直到业主可以支付必要的费用。但在某些使用案例中，您可能不希望用户考虑以太坊，区块链或如何获得以太网，因此只要检测到平衡危险性低，您的硬币就会自动重新填充用户余额。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">uint</span> <span class="nx">minBalanceForAccounts</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">function</span> <span class="nx">setMinBalance</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">minimumBalanceInFinney</span><span class="p">)</span> <span class="nx">onlyOwner</span> <span class="p">{</span>
</span><span class="line">     <span class="nx">minBalanceForAccounts</span> <span class="o">=</span> <span class="nx">minimumBalanceInFinney</span> <span class="o">*</span> <span class="mi">1</span> <span class="nx">finney</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="cm">/* Send coins */</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span> <span class="nx">_to</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">_value</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="p">...</span>
</span><span class="line">    <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">balance</span> <span class="o">&lt;</span> <span class="nx">minBalanceForAccounts</span><span class="p">)</span>
</span><span class="line">        <span class="nx">sell</span><span class="p">((</span><span class="nx">minBalanceForAccounts</span> <span class="o">-</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">balance</span><span class="p">)</span> <span class="o">/</span> <span class="nx">sellPrice</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-12">参考文献</h1>

<ul>
  <li><a href="http://ethfans.org/posts/eip-721-non-fungible-token-standard">干货ERC721 Non-fungible Token Standard</a></li>
  <li><a href="https://ethereum.org/token">Create your own CRYPTO-CURRENCY with Ethereum</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[以太坊交易]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/03/05/yi-tai-fang-jiao-yi/"/>
    <updated>2018-03-05T14:26:24+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/03/05/yi-tai-fang-jiao-yi</id>
    <content type="html"><![CDATA[<p>交易是区块链和重中之重,不论是简单的转账还是复杂的智能合约的执行,都是依托于交易来完成。但是我回头仔细研究了一把以太坊的交易,并梳理这篇文章的原因,仅仅是因为在面试的时候没有回答上来,羞愧……</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">交易的主要结构</a></li>
  <li><a href="#section-1">交易打包流程</a>    <ul>
      <li><a href="#section-2">拼装交易参数</a></li>
      <li><a href="#section-3">对交易签名</a></li>
      <li><a href="#section-4">是否重复交易</a></li>
      <li><a href="#section-5">验证交易参数</a></li>
      <li><a href="#section-6">丢弃低价交易</a></li>
      <li><a href="#section-7">替换重复交易(更新旧交易)</a></li>
      <li><a href="#section-8">提交交易进入交易队列</a></li>
      <li><a href="#nonce">关于交易nonce</a>        <ul>
          <li><a href="#txpoolvalidatetxnoncenonce">TxPool.validateTx()检查当前交易的<code>nonce</code>大于最新区块中账户<code>nonce</code>值</a></li>
          <li><a href="#pending">检查<code>pending</code>队列中是否有旧交易需要更新</a></li>
          <li><a href="#pendingnonce">尝试将交易加入<code>pending</code>队列时检查是否需要剔除过期的nonce</a></li>
          <li><a href="#noncependingnonce">从队列中获取所有<code>nonce</code>值小于等于账户<code>pending</code>状态的<code>nonce</code>值</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#section-9">关于失败的交易</a></li>
</ul>

<h1 id="section">交易的主要结构</h1>

<p>废话不多说,先看看交易的基础数据结构。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/core/types/transaction.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">txdata</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">AccountNonce</span> <span class="kt">uint64</span>          <span class="s">`json:&quot;nonce&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Price</span>        <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>        <span class="s">`json:&quot;gasPrice&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">GasLimit</span>     <span class="kt">uint64</span>          <span class="s">`json:&quot;gas&quot;      gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Recipient</span>    <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Address</span> <span class="s">`json:&quot;to&quot;       rlp:&quot;nil&quot;`</span> <span class="c1">// nil means contract creation</span>
</span><span class="line">    <span class="nx">Amount</span>       <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>        <span class="s">`json:&quot;value&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Payload</span>      <span class="p">[]</span><span class="kt">byte</span>          <span class="s">`json:&quot;input&quot;    gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Signature values</span>
</span><span class="line">    <span class="nx">V</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;v&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">R</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;r&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">S</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="s">`json:&quot;s&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// This is only used when marshaling to JSON.</span>
</span><span class="line">    <span class="nx">Hash</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span> <span class="s">`json:&quot;hash&quot; rlp:&quot;-&quot;`</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<ul>
  <li><code>AccountNonce</code>,交易发起者内部唯一标识交易的字段,避免交易双重支付</li>
  <li><code>Price</code>,此交易的gas price</li>
  <li><code>GasLimit</code>,此交易允许的最大gas量</li>
  <li><code>Recipient</code>,交易接收者,如果为<code>nil</code>说明是个合同创建交易</li>
  <li><code>Amount</code>, 交易转移的<code>ETH</code>数量,单位是<code>wei</code></li>
  <li><code>Payload</code>, 交易数据</li>
  <li><code>V,R,S</code>, 交易签名,通过交易签名可以计算出交易发送者地址</li>
</ul>

<h1 id="section-1">交易打包流程</h1>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/transaction-pkg.png" alt="pkg" /></p>

<h2 id="section-2">拼装交易参数</h2>

<p>拼装交易参数主要在<code>github.com/ethereum/go-ethereum/internal/ethapi/api.go setDefaults()</code>实现。</p>

<ul>
  <li><code>Gas</code>如果未设置,设置未默认值<code>90000</code></li>
  <li><code>GasPrice</code>如果未设置，设置为建议值</li>
  <li><code>Nonce</code>如果未设置,自动生成nonce值,该值等于当前账户nonce偏移量加上账户nonces数组长度,由此可见账户交易的nonce值是连续递增量</li>
</ul>

<h2 id="section-3">对交易签名</h2>

<p>首先使用账户的私钥对交易hash信息生成签名,注意该hash计算了包含了<code>nonce</code>值和<code>chainId</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">EIP155Signer</span><span class="p">)</span> <span class="nx">Hash</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Transaction</span><span class="p">)</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">rlpHash</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{}{</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">AccountNonce</span><span class="p">,</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">Price</span><span class="p">,</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">GasLimit</span><span class="p">,</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">Recipient</span><span class="p">,</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">Amount</span><span class="p">,</span>
</span><span class="line">		<span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">Payload</span><span class="p">,</span>
</span><span class="line">		<span class="nx">s</span><span class="p">.</span><span class="nx">chainId</span><span class="p">,</span> <span class="nb">uint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">uint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class="line">	<span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>将签名信息的<code>0-31</code>字节放入<code>R</code>,<code>32-63</code>放入<code>S</code>,<code>64</code>放入<code>V</code>(共65字节).</p>

<p>签名完成后,开始向以太坊提交交易.注意,如果交易的<code>To</code>字段为空,说明是个合同创建交易,则自动生成合约地址,合约地址生成规则其实是<code>hash(from_addr,nonce)</code>函数:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Creates an ethereum address given the bytes and the nonce</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">CreateAddress</span><span class="p">(</span><span class="nx">b</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">nonce</span> <span class="kt">uint64</span><span class="p">)</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Address</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">data</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">rlp</span><span class="p">.</span><span class="nx">EncodeToBytes</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{}{</span><span class="nx">b</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">})</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">common</span><span class="p">.</span><span class="nx">BytesToAddress</span><span class="p">(</span><span class="nx">Keccak256</span><span class="p">(</span><span class="nx">data</span><span class="p">)[</span><span class="mi">12</span><span class="p">:])</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-4">是否重复交易</h2>

<p>通过检查交易池里是否存在该交易hash判断是否是重复交易</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">hash</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Hash</span><span class="p">()</span>
</span><span class="line"><span class="k">if</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">all</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Trace</span><span class="p">(</span><span class="s">&quot;Discarding already known transaction&quot;</span><span class="p">,</span> <span class="s">&quot;hash&quot;</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;known transaction: %x&quot;</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-5">验证交易参数</h2>

<ul>
  <li>检查交易大小是否小于等于<code>32KB</code>,防止DOS攻击</li>
  <li>检查是否正确签名</li>
  <li>检查gas是否超过区块gas限制</li>
  <li>抛弃非local的且gas price偏低的交易</li>
  <li>检查nonce是否过小</li>
  <li>检查账户余额是否足够,<code>balance &gt;= gas_price * gas_limit + amount</code></li>
</ul>

<h2 id="section-6">丢弃低价交易</h2>

<p>如果交易池已满，需要将交易池中低于当前交易的踢出一个,注意踢出的交易仅限于远端交易，本地节点的交易不受影响</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Discard finds a number of most underpriced transactions, removes them from the</span>
</span><span class="line"><span class="c1">// priced list and returns them for further removal from the entire pool.</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">txPricedList</span><span class="p">)</span> <span class="nx">Discard</span><span class="p">(</span><span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">local</span> <span class="o">*</span><span class="nx">accountSet</span><span class="p">)</span> <span class="nx">types</span><span class="p">.</span><span class="nx">Transactions</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">drop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transactions</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="c1">// Remote underpriced transactions to drop</span>
</span><span class="line">    <span class="nx">save</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transactions</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>    <span class="c1">// Local underpriced transactions to keep</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">l</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// Discard stale transactions if found during cleanup</span>
</span><span class="line">        <span class="nx">tx</span> <span class="o">:=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">Pop</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">items</span><span class="p">).(</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">l</span><span class="p">.</span><span class="nx">all</span><span class="p">)[</span><span class="nx">tx</span><span class="p">.</span><span class="nx">Hash</span><span class="p">()];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">l</span><span class="p">.</span><span class="nx">stales</span><span class="o">--</span>
</span><span class="line">            <span class="k">continue</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="c1">// Non stale transaction found, discard unless local</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">local</span><span class="p">.</span><span class="nx">containsTx</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">save</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">save</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
</span><span class="line">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">drop</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">drop</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
</span><span class="line">            <span class="nx">count</span><span class="o">--</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">save</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">heap</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">drop</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-7">替换重复交易(更新旧交易)</h2>

<p>因为交易可以使用<code>account+nonce</code>唯一标识,所以如果发现同一账户下已存在同nonce的交易,则视为是对旧交易的一次更新,此时会使用当前交易替换掉旧交易。该机制常用于用来提升gas值避免旧交易长时间得不到处理。</p>

<h2 id="section-8">提交交易进入交易队列</h2>

<p><code>promoteExecutables()</code>将交易从待处理队列移入<code>pending</code>队列</p>

<ul>
  <li>丢弃过旧的交易,过旧的定义是<code>nonce</code>小于当前账户<code>nonce</code>值的交易</li>
  <li>丢弃低余额(账户余额不足以支持交易gas燃烧)</li>
  <li>丢弃超过账户数量限额的交易</li>
  <li>…</li>
</ul>

<p>在一系列交易控制之后,将交易写入<code>pending</code>队列,此时交易真正可被矿工打包到区块中。</p>

<h2 id="nonce">关于交易nonce</h2>

<p>流程中涉及到<code>nonce</code>的几个地方:</p>

<h4 id="txpoolvalidatetxnoncenonce">TxPool.validateTx()检查当前交易的<code>nonce</code>大于最新区块中账户<code>nonce</code>值</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Ensure the transaction adheres to nonce ordering</span>
</span><span class="line"><span class="k">if</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">currentState</span><span class="p">.</span><span class="nx">GetNonce</span><span class="p">(</span><span class="nx">from</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Nonce</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">ErrNonceTooLow</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="pending">检查<code>pending</code>队列中是否有旧交易需要更新</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="k">if</span> <span class="nx">list</span> <span class="o">:=</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">from</span><span class="p">];</span> <span class="nx">list</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Overlaps</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">   <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>Overlaps()</code>函数即根据<code>account,nonce</code>参数对进行重复检测</p>

<h4 id="pendingnonce">尝试将交易加入<code>pending</code>队列时检查是否需要剔除过期的nonce</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// 检查并剔除小于最新区块的交易</span>
</span><span class="line"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Forward</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">currentState</span><span class="p">.</span><span class="nx">GetNonce</span><span class="p">(</span><span class="nx">addr</span><span class="p">))</span> <span class="p">{</span>
</span><span class="line">   <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="noncependingnonce">从队列中获取所有<code>nonce</code>值小于等于账户<code>pending</code>状态的<code>nonce</code>值</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Ready</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">pendingState</span><span class="p">.</span><span class="nx">GetNonce</span><span class="p">(</span><span class="nx">addr</span><span class="p">))</span> <span class="p">{</span>
</span><span class="line">   <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>另外,</p>

<ul>
  <li>本地节点low gas的交易并不会被丢弃</li>
  <li>如果nonce出现”空洞”,则空洞后的交易将无法打包</li>
</ul>

<h1 id="section-9">关于失败的交易</h1>

<p>有时候我们在使用以太坊时交易(转账)时,会遇到一些令人迷惑的失败交易,比如在imToken上转账失败,然而在etherscan.io上无法查到该交易;而有时候又发现失败的转账能够在以太坊浏览器里成功查看到,说明交易是被正确打包上链了,只是交易本身是失败的交易而已，如下图所示,这是一笔因gas过低而失败的交易:</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/fail-tx.png" alt="fail-tx" /></p>

<p>那么我们深入源码来看看是怎么回事.这里我们只跟踪挖矿过程中的失败交易处理,因为普通交易在还没进入到pending队列时的失败的话,是根本不会打包到区块里的。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">env</span> <span class="o">*</span><span class="nx">Work</span><span class="p">)</span> <span class="nx">commitTransaction</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">bc</span> <span class="o">*</span><span class="nx">core</span><span class="p">.</span><span class="nx">BlockChain</span><span class="p">,</span> <span class="nx">coinbase</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">core</span><span class="p">.</span><span class="nx">GasPool</span><span class="p">)</span> <span class="p">(</span><span class="kt">error</span><span class="p">,</span> <span class="p">[]</span><span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Log</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line">  <span class="c1">// 如果执行交易报错,则回滚账户状态(即不从用户账户扣钱,完全回滚,交易不会打包)</span>
</span><span class="line">  <span class="nx">receipt</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">core</span><span class="p">.</span><span class="nx">ApplyTransaction</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">bc</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">coinbase</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">header</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">env</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">GasUsed</span><span class="p">,</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">env</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">RevertToSnapshot</span><span class="p">(</span><span class="nx">snap</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">err</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">env</span><span class="p">.</span><span class="nx">txs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">txs</span><span class="p">,</span> <span class="nx">tx</span><span class="p">)</span>
</span><span class="line">  <span class="nx">env</span><span class="p">.</span><span class="nx">receipts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">receipts</span><span class="p">,</span> <span class="nx">receipt</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">receipt</span><span class="p">.</span><span class="nx">Logs</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>commitTransaction()</code>就是在”挖矿”中调用的交易执行函数,其实从该函数就可以看出来:如果执行交易报错,则回滚账户状态,那么交易是不会被打包到区块的.</p>

<p>那么我们继续进入<code>ApplyTransaction()</code>看看什么情况下交易会报错,</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">ApplyTransaction</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">params</span><span class="p">.</span><span class="nx">ChainConfig</span><span class="p">,</span> <span class="nx">bc</span> <span class="o">*</span><span class="nx">BlockChain</span><span class="p">,</span> <span class="nx">author</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">GasPool</span><span class="p">,</span> <span class="nx">statedb</span> <span class="o">*</span><span class="nx">state</span><span class="p">.</span><span class="nx">StateDB</span><span class="p">,</span> <span class="nx">header</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">*</span><span class="kd">type</span><span class="err">$</span>
</span><span class="line">  <span class="c1">// 1.参数检查类错误</span>
</span><span class="line">  <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">AsMessage</span><span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">MakeSigner</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">header</span><span class="p">.</span><span class="nx">Number</span><span class="p">))</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line">  <span class="c1">// 2.执行类,稍后再看</span>
</span><span class="line">  <span class="nx">_</span><span class="p">,</span> <span class="nx">gas</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ApplyMessage</span><span class="p">(</span><span class="nx">vmenv</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">gp</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// 3.存储交易收据,注意失败的交易也会创建收据</span>
</span><span class="line">  <span class="nx">receipt</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NewReceipt</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="o">*</span><span class="nx">usedGas</span><span class="p">)</span>
</span><span class="line">  <span class="nx">receipt</span><span class="p">.</span><span class="nx">TxHash</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Hash</span><span class="p">()</span>
</span><span class="line">  <span class="nx">receipt</span><span class="p">.</span><span class="nx">GasUsed</span> <span class="p">=</span> <span class="nx">gas</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>ApplyTransaction()</code>就比较有意思了,由代码可以看出来,如果是参数检查类错误就直接返回错误,到上层后继续返回就相当于回滚了交易。然而该函数的第二步<code>ApplyMessage()</code>实际执行交易返回的后两个值<code>bool,error</code>就是关键所在了:</p>

<p>如果返回<code>error</code>,那么没什么好说的,错误逐层冒泡出去回滚交易;但如果返回<code>bool==false,error==nil</code>,则交易就正确打包了(生成了交易收据打包到区块),但是此时其实交易是执行失败了的,具体我们在进入<code>ApplyMessage()</code>,这个函数最终调用到<code>TransitionDb()</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">unc</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StateTransition</span><span class="p">)</span> <span class="nx">TransitionDb</span><span class="p">()</span> <span class="p">(</span><span class="nx">ret</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">usedGas</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">failed</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line">  <span class="c1">// 1. 该函数根据交易数据检查是否超出基本gas限制,会抛出我们常见的vm.ErrOutOfGas(out of gas),注意此处抛出的错误会使得交易完全回滚</span>
</span><span class="line">  <span class="nx">gas</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">IntrinsicGas</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">contractCreation</span><span class="p">,</span> <span class="nx">homestead</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">useGas</span><span class="p">(</span><span class="nx">gas</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">var</span> <span class="p">(</span>
</span><span class="line">    <span class="nx">evm</span> <span class="p">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">evm</span>
</span><span class="line">    <span class="nx">vmerr</span> <span class="kt">error</span>
</span><span class="line">  <span class="p">)</span>
</span><span class="line">  <span class="c1">// 2.这里如果返回错误(vmerr!=nil)则说明交易执行失败</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">contractCreation</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">ret</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gas</span><span class="p">,</span> <span class="nx">vmerr</span> <span class="p">=</span> <span class="nx">evm</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gas</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
</span><span class="line">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// Increment the nonce for the next transaction</span>
</span><span class="line">    <span class="nx">st</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">SetNonce</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">Address</span><span class="p">(),</span> <span class="nx">st</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">GetNonce</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">Address</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">    <span class="nx">ret</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gas</span><span class="p">,</span> <span class="nx">vmerr</span> <span class="p">=</span> <span class="nx">evm</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">to</span><span class="p">().</span><span class="nx">Address</span><span class="p">(),</span> <span class="nx">st</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gas</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">vmerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 余额不足(&quot;insufficient balance for transfer&quot;)错误也会导致交易完全回滚</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">vmerr</span> <span class="o">==</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">ErrInsufficientBalance</span> <span class="p">{</span>
</span><span class="line">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">vmerr</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// 退回剩余的gas</span>
</span><span class="line">  <span class="nx">st</span><span class="p">.</span><span class="nx">refundGas</span><span class="p">()</span>
</span><span class="line">  <span class="nx">st</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">AddBalance</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">evm</span><span class="p">.</span><span class="nx">Coinbase</span><span class="p">,</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">Mul</span><span class="p">(</span><span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">SetUint64</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">gasUsed</span><span class="p">()),</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gasPrice</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// 3.vmerr不为空将导致交易失败,但仍能正确打包</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">st</span><span class="p">.</span><span class="nx">gasUsed</span><span class="p">(),</span> <span class="nx">vmerr</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在这个函数里可以看出来,如果交易在以太坊交易执行前报错,那么交易可以完全回滚,然而一旦交易在以太坊虚拟机内执行过程中出错,交易终止退出,消耗的gas并不会退还,这个失败的交易也会被打包到区块中.此外,以太坊中多给的gas并不会浪费掉,gas的消耗完全是按需的,多余的gas会正确退还给发起者:<code>st.refundGas()</code>.</p>

<p>综上,对于失败的交易我们能总结出以下几点性质:</p>

<ul>
  <li>失败的交易一旦被执行,就一定会被打包到区块链中,并且执行过程中消耗的gas也不会退还,交易的成功与失败可以使用交易的收据状态进行判断</li>
  <li>失败的交易如果没有打包到区块,那么可能的原因就有很多了,根据交易所处的阶段不同大概有这么几种可能: a.交易gas过低或参数错误根本没有进入到pending队列 b.交易进入pending进行处理,然而在检查gas等参数时报错被丢弃</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入ethereum源码-从区块头看共识挖矿]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/02/24/shen-ru-ethereumyuan-ma-cong-qu-kuai-tou-kan-gong-shi-wa-kuang/"/>
    <updated>2018-02-24T16:09:11+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/02/24/shen-ru-ethereumyuan-ma-cong-qu-kuai-tou-kan-gong-shi-wa-kuang</id>
    <content type="html"><![CDATA[<p>区块是区块链的基本组成单位,而区块头又是区块的核心数据,本文希望从区块头延展开来,看看区块链的挖矿机制。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">区块头的基本数据结构</a></li>
  <li><a href="#section-1">结构信息</a></li>
  <li><a href="#section-2">挖矿基础信息</a></li>
  <li><a href="#section-3">状态信息</a></li>
  <li><a href="#section-4">挖矿难度控制</a></li>
  <li><a href="#pow">PoW参数</a>    <ul>
      <li><a href="#dag">DAG</a></li>
      <li><a href="#hashimoto">hashimoto</a></li>
    </ul>
  </li>
  <li><a href="#section-5">其他</a></li>
  <li><a href="#section-6">参考文献</a></li>
</ul>

<h1 id="section">区块头的基本数据结构</h1>

<p>废话不多说,直接看代码:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/core/types/block.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// Header represents a block header in the Ethereum blockchain.</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">Header</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 1.结构信息</span>
</span><span class="line">    <span class="nx">ParentHash</span>  <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;parentHash&quot;       gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">UncleHash</span>   <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;sha3Uncles&quot;       gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Number</span>      <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>       <span class="s">`json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 2.挖矿基础信息</span>
</span><span class="line">    <span class="nx">Coinbase</span>    <span class="nx">common</span><span class="p">.</span><span class="nx">Address</span> <span class="s">`json:&quot;miner&quot;            gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">GasLimit</span>    <span class="kt">uint64</span>         <span class="s">`json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">GasUsed</span>     <span class="kt">uint64</span>         <span class="s">`json:&quot;gasUsed&quot;          gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 3.状态信息</span>
</span><span class="line">    <span class="nx">Time</span>        <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>       <span class="s">`json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Root</span>        <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">TxHash</span>      <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">ReceiptHash</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;receiptsRoot&quot;     gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Bloom</span>       <span class="nx">Bloom</span>          <span class="s">`json:&quot;logsBloom&quot;        gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 4.挖矿难度控制</span>
</span><span class="line">    <span class="nx">Difficulty</span>  <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span>       <span class="s">`json:&quot;difficulty&quot;       gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 5.PoW参数</span>
</span><span class="line">    <span class="nx">MixDigest</span>   <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span>    <span class="s">`json:&quot;mixHash&quot;          gencodec:&quot;required&quot;`</span>
</span><span class="line">    <span class="nx">Nonce</span>       <span class="nx">BlockNonce</span>     <span class="s">`json:&quot;nonce&quot;            gencodec:&quot;required&quot;`</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 6.其他</span>
</span><span class="line">    <span class="nx">Extra</span>       <span class="p">[]</span><span class="kt">byte</span>         <span class="s">`json:&quot;extraData&quot;        gencodec:&quot;required&quot;`</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>乍一看区块头的字段非常多,别着急,接下来我们逐个分析。按照字段的作用,我们可以将这些字段分成6大类(如代码注释所示),分别控制结构、状态、挖矿等信息,下面我们依次查看.</p>

<blockquote>
  <p>本文引用源码大部分均位于miner/consensus两个包中,代码引用均会给出文件名</p>
</blockquote>

<h1 id="section-1">结构信息</h1>

<p>1.<code>ParentHash</code></p>

<p>简单来说,区块链其实是一个单向链表。那么单向链表中必然存在一个将链表串起来的指针,这个指针在区块链里就是<code>ParentHash</code>.每个新挖出来的区块都包含了父区块的hash值,这样我们就可以从当前区块一直溯源到创世区块,创世区块hash值为<code>0x00</code>.</p>

<p>2.<code>UncleHash</code></p>

<p>类似ParentHash,指向叔区块hash值。</p>

<p>3.<code>Number</code></p>

<p>用于标记当前区块高度,子区块高度一定是父区块+1.</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/blockchain-link.png" alt="blockchain-link" /></p>

<p>构建区块的代码包含在<code>commitNewWork</code>函数中,该函数其实就是挖矿主流程所在位置。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/miner/worker.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">self</span> <span class="o">*</span><span class="nx">worker</span><span class="p">)</span> <span class="nx">commitNewWork</span><span class="p">(){</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="nx">num</span> <span class="o">:=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">Number</span><span class="p">()</span>
</span><span class="line">    <span class="nx">header</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Header</span><span class="p">{</span>
</span><span class="line">        <span class="nx">ParentHash</span><span class="p">:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">Hash</span><span class="p">(),</span>          <span class="c1">// 父区块的hash</span>
</span><span class="line">        <span class="nx">Number</span><span class="p">:</span>     <span class="nx">num</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">num</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Big1</span><span class="p">),</span>  <span class="c1">// 父区块的number+1</span>
</span><span class="line">        <span class="nx">GasLimit</span><span class="p">:</span>   <span class="nx">core</span><span class="p">.</span><span class="nx">CalcGasLimit</span><span class="p">(</span><span class="nx">parent</span><span class="p">),</span>
</span><span class="line">        <span class="nx">Extra</span><span class="p">:</span>      <span class="nx">self</span><span class="p">.</span><span class="nx">extra</span><span class="p">,</span>
</span><span class="line">        <span class="nx">Time</span><span class="p">:</span>       <span class="nx">big</span><span class="p">.</span><span class="nx">NewInt</span><span class="p">(</span><span class="nx">tstamp</span><span class="p">),</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-2">挖矿基础信息</h1>

<p>1.<code>Coinbase</code></p>

<p>区块链中矿工没挖出一个新区块,都会得到两部分奖励收益:挖矿奖励+手续费,那么这个奖励是到哪个账户的,就是这个coinbase帐号,默认通常是矿工本地第一个账户。</p>

<p>2.<code>GasUsed</code></p>

<p>实际使用的gas,每执行一笔交易往该字段上累积gas值,具体代码可查看<code>ethereum/go-ethereum/core/state_processor.go:ApplyTransaction</code>.</p>

<p>3.<code>GasLimit</code></p>

<p>矿工执行交易的上限gas用量,如果执行某个交易时发现gas使用超过这个值则放弃执行后续交易。其数值是基于父区块gas用量来调整,如果<code>parentGasUsed &gt; parentGasLimit * (2/3)</code>,则增大该数值，反之则减小。具体实现可参考下面代码实现。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/core/block_validator.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// CalcGasLimit computes the gas limit of the next block after parent.</span>
</span><span class="line"><span class="c1">// This is miner strategy, not consensus protocol.</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">CalcGasLimit</span><span class="p">(</span><span class="nx">parent</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">uint64</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// contrib = (parentGasUsed * 3 / 2) / 1024</span>
</span><span class="line">    <span class="nx">contrib</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">GasUsed</span><span class="p">()</span> <span class="o">+</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GasUsed</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nx">params</span><span class="p">.</span><span class="nx">GasLimitBoundDivisor</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// decay = parentGasLimit / 1024 -1</span>
</span><span class="line">    <span class="nx">decay</span> <span class="o">:=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GasLimit</span><span class="p">()</span><span class="o">/</span><span class="nx">params</span><span class="p">.</span><span class="nx">GasLimitBoundDivisor</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/*</span>
</span><span class="line"><span class="cm">        strategy: gasLimit of block-to-mine is set based on parent&#39;s</span>
</span><span class="line"><span class="cm">        gasUsed value.  if parentGasUsed &gt; parentGasLimit * (2/3) then we</span>
</span><span class="line"><span class="cm">        increase it, otherwise lower it (or leave it unchanged if it&#39;s right</span>
</span><span class="line"><span class="cm">        at that usage) the amount increased/decreased depends on how far away</span>
</span><span class="line"><span class="cm">        from parentGasLimit * (2/3) parentGasUsed is.</span>
</span><span class="line"><span class="cm">    */</span>
</span><span class="line">    <span class="nx">limit</span> <span class="o">:=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GasLimit</span><span class="p">()</span> <span class="o">-</span> <span class="nx">decay</span> <span class="o">+</span> <span class="nx">contrib</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">limit</span> <span class="p">&lt;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">MinGasLimit</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">limit</span> <span class="p">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">MinGasLimit</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="c1">// however, if we&#39;re now below the target (TargetGasLimit) we increase the</span>
</span><span class="line">    <span class="c1">// limit as much as we can (parentGasLimit / 1024 -1)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">limit</span> <span class="p">&lt;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">TargetGasLimit</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">limit</span> <span class="p">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">GasLimit</span><span class="p">()</span> <span class="o">+</span> <span class="nx">decay</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">limit</span> <span class="p">&gt;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">TargetGasLimit</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">limit</span> <span class="p">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">TargetGasLimit</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">limit</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-3">状态信息</h1>

<p>1.<code>Time</code></p>

<p>新区块的出块时间(按代码描述,严格来说其实是开始挖矿的时间)。</p>

<p>2.<code>Root</code>,<code>TxHash</code>,<code>ReceiptHash</code></p>

<p>这三个hash值对验证区块意义重大.</p>

<p><code>Root</code>代表的区块链当前所有账户的状态,<code>TxHash</code>是本区块所有交易摘要,<code>ReceiptHash</code>是本区块所有收据的摘要。</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/merkle.png" alt="merkle" /></p>

<p>这几个值都是MPT树的root hash值,只要树中任意节点数据有更改，那么这个root hash必然会跟着更改,这就为轻钱包实现提供了可能:不需要下载整个区块的数据,仅使用区块头就可以验证区块的合法性。具体说来,它允许轻客户端轻松地进行并核实以下类型的查询答案:</p>

<p>这笔交易被包含在特定的区块中了么？</p>

<ul>
  <li>
    <p>告诉我这个地址在过去30天中，发出X类型事件的所有实例（例如，一个众筹合约完成了它的目标）</p>
  </li>
  <li>
    <p>目前我的账户余额是多少？</p>
  </li>
  <li>
    <p>这个账户是否存在？</p>
  </li>
  <li>
    <p>假装在这个合约中运行这笔交易，它的输出会是什么？</p>
  </li>
</ul>

<p>第一种是由交易树（transaction tree）来处理的；第三和第四种则是由状态树（state tree）负责处理，第二种则由收据树（receipt tree）处理。计算前四个查询任务是相当简单的。服务器简单地找到对象，获取默克尔分支，并通过分支来回复轻客户端。</p>

<p>第五种查询任务同样也是由状态树处理，但它的计算方式会比较复杂。这里，我们需要构建下我们称之为默克尔状态转变的证明（Merkle state transition proof）。从本质上来讲，这样的证明也就是在说“如果你在根S的状态树上运行交易T，其结果状态树将是根为S’，log为L，输出为O” （“输出”作为存在于以太坊的一种概念，因为每一笔交易都是一个函数调用，它在理论上并不是必要的）。</p>

<p>为了推断这个证明，服务器在本地创建了一个假的区块，将状态设为 S，并假装是一个轻客户端，同时请求这笔交易。也就是说，如果请求这笔交易的过程，需要客户端确定一个账户的余额，这个轻客户端会发出一个余额疑问。如果这个轻客户端需要检查存储在一个特定合约的特定项目，该轻客户端会对此发出针对查询。服务器会正确地“回应”它所有的查询，但服务器也会跟踪它所有发回的数据。然后，服务器会把综合数据发送给客户端。客户端会进行相同的步骤，但会使用它的数据库所提供的证明。如果它的结果和服务器要求的是相同的，那客户端就接受证明。</p>

<blockquote>
  <p>MPT树可以参考文章<a href="http://ethfans.org/posts/Merkle-Patricia-Tree">Merkle树</a></p>
</blockquote>

<p>3.<code>Bloom</code></p>

<p>区块头里的布隆过滤器是用于搜索收据而构建的。</p>

<blockquote>
  <p><a href="https://github.com/cpselvis/zhihu-crawler/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E7%8E%B0">布隆过滤器</a></p>
</blockquote>

<h1 id="section-4">挖矿难度控制</h1>

<p>1.<code>Difficulty</code></p>

<p>以太坊的挖矿难度是动态调整的,它的难度调整仅和父区块和本区块挖矿时间有关。 而该函数实现里根据启动参数目前有三种难度调整方案:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/consensus/ethash/consensus.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">CalcDifficulty</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">params</span><span class="p">.</span><span class="nx">ChainConfig</span><span class="p">,</span> <span class="nx">time</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">parent</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">next</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">Add</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">Number</span><span class="p">,</span> <span class="nx">big1</span><span class="p">)</span>
</span><span class="line">    <span class="k">switch</span> <span class="p">{</span>
</span><span class="line">    <span class="k">case</span> <span class="nx">config</span><span class="p">.</span><span class="nx">IsByzantium</span><span class="p">(</span><span class="nx">next</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">calcDifficultyByzantium</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
</span><span class="line">    <span class="k">case</span> <span class="nx">config</span><span class="p">.</span><span class="nx">IsHomestead</span><span class="p">(</span><span class="nx">next</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">calcDifficultyHomestead</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
</span><span class="line">    <span class="k">default</span><span class="p">:</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">calcDifficultyFrontier</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>每种策略代码这里不具体展开,总的来说难度值的计算是这样的:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/consensus/ethash/consensus.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="err">本区块难度</span> <span class="p">=</span> <span class="err">父区块难度</span> <span class="o">+</span> <span class="err">难度调整值</span> <span class="o">+</span> <span class="err">难度炸弹</span>
</span><span class="line"><span class="err">难度调整值</span> <span class="p">=</span> <span class="nx">f</span><span class="p">(</span><span class="err">父区块难度</span><span class="p">,</span><span class="err">父区块产生时间</span><span class="p">,</span><span class="err">本区块产生时间</span><span class="p">)</span>
</span><span class="line"><span class="err">难度炸弹</span> <span class="p">=</span> <span class="mi">2</span><span class="p">^(</span><span class="err">区块号</span><span class="o">/</span><span class="mi">100000</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>以太坊的区块难度以单个区块为单位进行调整，可以非常迅速的适应算力的变化，正是这种机制，使以太坊在硬分叉出以太坊经典(ETC)以后没有出现比特币分叉出比特币现金(BCC)后的算力“暴击”问题。同时，以太坊的新区块难度在老区块的基础上有限调整的机制也使区块难度不会出现非常大的跳变</p>

<p>从这个公式可以看出,区块难度短期内仅和难度调整值有关(因为难度炸弹只有每100000个区块才会产生跳变),但是当挖矿到5400000区块后,难度值跳变到非常大,这个时候就不再适合挖矿。 </p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth-diff.jpg" alt="eth-diff" /></p>

<h1 id="pow">PoW参数</h1>

<p>接下来的两个参数就和无人不知无人不晓的工作量证明息息相关了,以太坊的工作量证明最终拼的就是谁最先得到这两个参数:<code>MixDigest</code>和<code>Nonce</code>.</p>

<p>目前以太坊线上使用的共识算法是基于PoW的ethash算法,主要实现位于<code>github.com/ethereum/go-ethereum/consensus/ethash</code>包中。</p>

<p>PoW算法的思路都大致是相似的,通过暴力枚举猜测一个nonce值,使得根据这个nonce种子计算出的hash值符合约定的难度,这个难度其实就是要求hash值前缀包含多少个0. </p>

<p>目前以太坊使用的hash是256位,所以将难度折算成前缀0的位数就是:<code>bits0 = (2^256)/difficulty</code>,那么我们的代码不停枚举nonce然后将计算得到的hash值前缀0位数和这个做比较就行了,主逻辑代码如下:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">ethash</span> <span class="o">*</span><span class="nx">Ethash</span><span class="p">)</span> <span class="nx">mine</span><span class="p">(</span><span class="nx">block</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">seed</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">abort</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="nx">found</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// Extract some data from the header</span>
</span><span class="line">    <span class="kd">var</span> <span class="p">(</span>
</span><span class="line">        <span class="nx">header</span>  <span class="p">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Header</span><span class="p">()</span>
</span><span class="line">        <span class="nx">hash</span>    <span class="p">=</span> <span class="nx">header</span><span class="p">.</span><span class="nx">HashNoNonce</span><span class="p">().</span><span class="nx">Bytes</span><span class="p">()</span>
</span><span class="line">        <span class="c1">// 将难度转换得出前缀0的位数</span>
</span><span class="line">        <span class="nx">target</span>  <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">Div</span><span class="p">(</span><span class="nx">maxUint256</span><span class="p">,</span> <span class="nx">header</span><span class="p">.</span><span class="nx">Difficulty</span><span class="p">)</span>
</span><span class="line">        <span class="nx">number</span>  <span class="p">=</span> <span class="nx">header</span><span class="p">.</span><span class="nx">Number</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">()</span>
</span><span class="line">        <span class="nx">dataset</span> <span class="p">=</span> <span class="nx">ethash</span><span class="p">.</span><span class="nx">dataset</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line"><span class="nx">search</span><span class="p">:</span>
</span><span class="line">    <span class="k">for</span> <span class="p">{</span>
</span><span class="line">        <span class="o">...</span>
</span><span class="line">            <span class="c1">// Compute the PoW value of this nonce</span>
</span><span class="line">            <span class="nx">digest</span><span class="p">,</span> <span class="nx">result</span> <span class="o">:=</span> <span class="nx">hashimotoFull</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">dataset</span><span class="p">,</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">SetBytes</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">Cmp</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class="line">                <span class="c1">// Correct nonce found, create a new header with it</span>
</span><span class="line">                <span class="nx">header</span> <span class="p">=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">CopyHeader</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
</span><span class="line">                <span class="nx">header</span><span class="p">.</span><span class="nx">Nonce</span> <span class="p">=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">EncodeNonce</span><span class="p">(</span><span class="nx">nonce</span><span class="p">)</span>
</span><span class="line">                <span class="nx">header</span><span class="p">.</span><span class="nx">MixDigest</span> <span class="p">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">BytesToHash</span><span class="p">(</span><span class="nx">digest</span><span class="p">)</span>
</span><span class="line">                <span class="o">...</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">            <span class="nx">nonce</span><span class="o">++</span>
</span><span class="line">         <span class="o">...</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>该函数首先计算出区块难度对应的前缀0位数<code>target</code>,然后生成PoW依赖的计算数据集<code>dataset = ethash.dataset(number)</code>,最终开始死循环尝试计算<code>digest, result := hashimotoFull(dataset.dataset, hash, nonce)</code>,得到结果后将这两个随机数据赋值到区块头对应字段去。</p>

<p>当这个区块成功挖出后，别的区块很容易验证这个区块的PoW是否有效,就使用同样方法产生计算数据集<code>dataset</code>,然后调用<code>hashimotoLight(和hashimotoFull基本一致)</code>计算出<code>digest</code>和区块头的<code>MixDigest</code>做比较就可以了。</p>

<p>这里我们跳过了两个重要的步骤:</p>

<p>a.依赖数据集<code>dataset</code>的生成实现
b.<code>hashimotoFull/hashimotoLight</code>的具体实现</p>

<p>依赖数据集的生成就要说到以太坊的DAG</p>

<h2 id="dag">DAG</h2>

<p>ethash将DAG（有向非循环图）用于工作量证明算法，这是为每个epoch(<code>epoch := block / epochLength</code>)生成，例如，每3000个区块（125个小时，大约5.2天）。DAG要花很长时间生成。如果客户端只是按需要生成它，那么在找到新epoch第一个区块之前，每个epoch过渡都要等待很长时间。然而，DAG只取决于区块数量，所以可以预先计算来避免在每个epoch过渡过长的等待时间。Geth和ethminer执行自动的DAG生成，每次维持2个DAG以便epoch过渡流畅。挖矿从控制台操控的时候，自动DAG生成会被打开和关闭。</p>

<h2 id="hashimoto">hashimoto</h2>

<blockquote>
  <p>下面的描述摘自<a href="http://blog.csdn.net/teaspring/article/details/78050274">挖矿和共识算法的奥秘</a></p>
</blockquote>

<p>hashimoto()的逻辑比较复杂，包含了多次、多种哈希运算。下面尝试从其中数据结构变化的角度来简单描述之：</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/consensus.png" alt="hashimoto" /></p>

<p>简单介绍一下上图所代表的代码流程：</p>

<ul>
  <li>首先，hashimoto()函数将入参@hash和@nonce合并成一个40 bytes长的数组，取它的SHA-512哈希值取名seed，长度为64 bytes。</li>
  <li>然后，将seed[]转化成以uint32为元素的数组mix[]，注意一个uint32数等于4 bytes，故而seed[]只能转化成16个uint32数，而mix[]数组长度32，所以此时mix[]数组前后各半是等值的。</li>
  <li>接着，lookup()函数登场。用一个循环，不断调用lookup()从外部数据集中取出uint32元素类型数组，向mix[]数组中混入未知的数据。循环的次数可用参数调节，目前设为64次。每次循环中，变化生成参数index，从而使得每次调用lookup()函数取出的数组都各不相同。这里混入数据的方式是一种类似向量“异或”的操作，来自于FNV算法。</li>
  <li>待混淆数据完成后，得到一个基本上面目全非的mix[]，长度为32的uint32数组。这时，将其折叠(压缩)成一个长度缩小成原长1/4的uint32数组，折叠的操作方法还是来自FNV算法。</li>
  <li>最后，将折叠后的mix[]由长度为8的uint32型数组直接转化成一个长度32的byte数组，这就是返回值@digest；同时将之前的seed[]数组与digest合并再取一次SHA-256哈希值，得到的长度32的byte数组，即返回值@result。</li>
</ul>

<p>最终经过一系列多次、多种的哈希运算，hashimoto()返回两个长度均为32的byte数组 - digest[]和result[]。回忆一下ethash.mine()函数中，对于hashimotoFull()的两个返回值，会直接以big.int整型数形式比较result和target；如果符合要求，则将digest取SHA3-256的哈希值(256 bits)，并存于Header.MixDigest中，待以后Ethash.VerifySeal()可以加以验证。</p>

<h1 id="section-5">其他</h1>

<p>1.<code>Extra</code></p>

<h1 id="section-6">参考文献</h1>

<ul>
  <li><a href="http://blog.csdn.net/teaspring/article/details/78050274">挖矿和共识算法的奥秘</a> </li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入ethereum源码-whisper协议解读]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/02/07/shen-ru-ethereumyuan-ma-whisperxie-yi-jie-du/"/>
    <updated>2018-02-07T16:13:02+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/02/07/shen-ru-ethereumyuan-ma-whisperxie-yi-jie-du</id>
    <content type="html"><![CDATA[<p>whisper协议是以太坊DApps之间的通信协议。</p>

<!-- more -->

<h1 id="section">概述</h1>

<p>whisper是完全基于<code>ID</code>的消息系统,它的设计目的是形成一套p2p节点间的异步广播系统。whisper网络上的消息是加密传送的,完全可以暴露在公网进行传输;此外,为了防范<code>DDos</code>攻击,whisper使用了<code>proof-of-work(PoW)</code>工作量证明提高消息发送门槛。</p>

<h1 id="whisper">whisper基础构件</h1>

<p>whisper协议对上层暴露出一套类似于<code>订阅-发布</code>的API模型,节点可以申请自己感兴趣的<code>topic</code>，那么就只会接收到这些<code>topic</code>的消息,无关主题的消息将被丢弃。在这套体系内，有几个基础构件需要说明下:</p>

<h2 id="envelope">Envelope信封</h2>

<p><code>envelope即信封</code>是whisper网络节点传输数据的基本形式。信封包含了加密的数据体和明文的元数据,元数据主要用于基本的消息校验和消息体的解密。</p>

<p>信封是以RLP编码的格式传输:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[ Version, Expiry, TTL, Topic, AESNonce, Data, EnvNonce ]</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>Version</code>:最多4字节(目前仅使用了1字节)，如果信封的<code>Version</code>比本节点当前值高,将无法解密,仅做转发</li>
  <li><code>Expiry</code>:4字节（unix时间戳秒数）,过期时间</li>
  <li><code>TTL</code>:4字节,剩余存活时间秒数</li>
  <li><code>Topic</code>:4字节,信封主题</li>
  <li><code>AESNonce</code>:12字节随机数据,仅在对称加密时有效</li>
  <li><code>Data</code>:消息体</li>
  <li><code>EnvNonce</code>:8字节任意数据(用于PoW计算)</li>
</ul>

<p>如果节点无法解密信封，那么节点对信封内的消息内容一无所知，单这并不影响节点将消息进行转发扩散。</p>

<h2 id="message">Message消息</h2>

<p>信封内的消息体解密后即得到消息内容。</p>

<h2 id="topic">Topic主题</h2>

<p>每个信封上都有一个主题,注意主题可以仅使用部分前缀</p>

<h2 id="filter">Filter过滤器</h2>

<p><code>filter</code>即<code>订阅-发布</code>模型中的订阅者</p>

<h2 id="pow">PoW工作量证明</h2>

<p><code>PoW</code>的存在是为了反垃圾信息以及降低网络负担。计算PoW所付出的代价可以理解为抵扣节点为传播和存储信息锁花费的资源.</p>

<p>在<code>whisperv5</code>中,<code>PoW</code>定义为:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">PoW = (2^BestBit) / (size * TTL)</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>BestBit</code>是hash计算值的前导0个数</li>
  <li><code>size</code>是消息大小</li>
  <li><code>TTL</code></li>
</ul>

<p>具有高<code>PoW</code>的消息具有优先处理权。</p>

<p>whisper节点发送消息需要经过<code>创建消息whisper.NewSentMessage()</code>—-&gt;<code>封装入信封msg.Wrap(msg)</code>—-&gt;<code>shh.Send()</code>,消息的工作量证明就在第二步装入信封的时候进行计算。</p>

<p><code>Warp</code>函数最终调用<code>Seal</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/whisper/whisperv5/envelope.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Envelope</span><span class="p">)</span> <span class="nx">Seal</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">MessageParams</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="kd">var</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">bestBit</span> <span class="kt">int</span> <span class="c1">// target是需要达到的目标前置0位数</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PoW</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// 将消息过期时间调整到工作量计算完成后</span>
</span><span class="line">        <span class="nx">e</span><span class="p">.</span><span class="nx">Expiry</span> <span class="o">+=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">WorkTime</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// 根据公式 PoW = (2^BestBit) / (size * TTL) 从预设的PoW阈值反解出BestBit</span>
</span><span class="line">        <span class="nx">target</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">powToFirstBit</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">PoW</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">target</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">target</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span><span class="line">    <span class="c1">// Keccak256是SHA-3的一种,Keccak已可以抵御最小的复杂度为2n的攻击，其中N为散列的大小。它具有广泛的安全边际。至目前为止，第三方密码分析已经显示出Keccak没有严重的弱点</span>
</span><span class="line">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">Keccak256</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">rlpWithoutNonce</span><span class="p">())</span>
</span><span class="line">    <span class="nb">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="nx">h</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">finish</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">WorkTime</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nx">UnixNano</span><span class="p">()</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">nonce</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">finish</span><span class="p">;</span> <span class="p">{</span>
</span><span class="line">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class="line">            <span class="c1">// 暴力尝试nonce值</span>
</span><span class="line">            <span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">56</span><span class="p">:],</span> <span class="nx">nonce</span><span class="p">)</span>
</span><span class="line">            <span class="nx">d</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nx">SetBytes</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">Keccak256</span><span class="p">(</span><span class="nx">buf</span><span class="p">))</span>
</span><span class="line">            <span class="nx">firstBit</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nx">FirstBitSet</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="nx">firstBit</span> <span class="p">&gt;</span> <span class="nx">bestBit</span> <span class="p">{</span>
</span><span class="line">                <span class="nx">e</span><span class="p">.</span><span class="nx">EnvNonce</span><span class="p">,</span> <span class="nx">bestBit</span> <span class="p">=</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">firstBit</span>
</span><span class="line">                <span class="c1">// 当尝试得到满足条件的EnvNonce,计算完成</span>
</span><span class="line">                <span class="k">if</span> <span class="nx">target</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">bestBit</span> <span class="o">&gt;=</span> <span class="nx">target</span> <span class="p">{</span>
</span><span class="line">                    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line">                <span class="p">}</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">            <span class="nx">nonce</span><span class="o">++</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">target</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">bestBit</span> <span class="p">&lt;</span> <span class="nx">target</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to reach the PoW target, specified pow time (%d seconds) was insufficient&quot;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">WorkTime</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-1">通信流程</h1>

<p>whisper协议的实现位于包<code>github.com/ethereum/go-ethereum/whisper</code>，该包下面有多个版本实现,目前最新协议包是<code>whisperv6</code>.</p>

<h2 id="whisper-main-loop">whisper main loop</h2>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/whisper-main-loop.png" alt="whisper-main-loop" /></p>

<p>whisper节点启动后产生两个分支:</p>

<ul>
  <li>一个分支负责清理<code>shh.envelopes</code>中的过期消息</li>
  <li>另一个分支(proccessQueue)从两个队列取出新接收到的消息,根据消息对应topic投放(Trigger)到对应接收者(filter),从而交付给上层应用进行处理</li>
</ul>

<p>补充说下whisper里两个队列<code>messageQueue,p2pMsgQueue</code>的不同作用,<code>messageQueue</code>接收普通的广播消息,<code>p2pMsgQueue</code>接收点对点的直接消息,可绕过<code>pow</code>和<code>ttl</code>限制.</p>

<h2 id="whisper-protocol">whisper protocol</h2>

<p>whisper协议的具体实现里,代码流程也非常清晰:</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/whisper-peer-loop.png" alt="whisper-peer-loop" /></p>

<p>每个peer连接成功后,产生两个goroutine,进行消息接收和广播:</p>

<ul>
  <li>接收消息协程不断从连接中读取新消息,并且将消息暂存到<code>shh.envelopes</code>中,如果发现是一条未接收过的新消息,则将消息转发到对应的队列<code>(messageQueue,p2pMsgQueue)</code></li>
  <li>广播协程负责将该peer未接收过的消息(本节点认为该peer未接收过,并非peer一定没接收过,p2p网络其他节点可能已经将消息广播到该节点了)投递到该peer</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入ethereum源码-p2p模块节点发现机制]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/"/>
    <updated>2018-01-30T11:40:37+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi</id>
    <content type="html"><![CDATA[<p>ethereum是基于kademlia协议实现其节点自动发现机制,完整整个网络拓扑关系的构建刷新。
<!-- more --></p>

<ul id="markdown-toc">
  <li><a href="#kademlia">Kademlia协议</a></li>
  <li><a href="#kademlia-like">以太坊Kademlia-like协议</a></li>
  <li><a href="#section">源码跟踪以太坊节点发现机制</a>    <ul>
      <li><a href="#refreshloop">1. <code>refreshLoop()</code></a></li>
      <li><a href="#loopreadloop">2. <code>loop()</code>和<code>readLoop()</code></a></li>
    </ul>
  </li>
  <li><a href="#section-1">内网穿透</a></li>
  <li><a href="#section-2">参考文献</a></li>
</ul>

<h1 id="kademlia">Kademlia协议</h1>

<blockquote>
  <p>以下内容摘自维基百科,全文查看参考文献Kademlia</p>
</blockquote>

<p>Kademlia是一种通过分散式杂凑表实现的协议算法，它是由Petar和David为非集中式P2P计算机网络而设计的。Kademlia规定了网络的结构，也规定了通过节点查询进行信息交换的方式。Kademlia网络节点之间使用UDP进行通讯。参与通讯的所有节点形成一张虚拟网（或者叫做覆盖网）。这些节点通过一组数字（或称为节点ID）来进行身份标识。节点ID不仅可以用来做身份标识，还可以用来进行值定位。</p>

<p>Kademlia路由表由多个列表组成，每个列表对应节点ID的一位（例如：假如节点ID共有128位，则节点的路由表将包含128个列表），包含多个条目，条目中包含定位其他节点所必要的一些数据。列表条目中的这些数据通常是由其他节点的IP地址，端口和节点ID组成。每个列表对应于与节点相距特定范围距离的一些节点，节点的第n个列表中所找到的节点的第n位与该节点的第n位肯定不同，而前n-1位相同，这就意味着很容易使用网络中远离该节点的一半节点来填充第一个列表（第一位不同的节点最多有一半），而用网络中四分之一的节点来填充第二个列表（比第一个列表中的那些节点离该节点更近一位），依次类推。如果ID有128个二进制位，则网络中的每个节点按照不同的异或距离把其他所有的节点分成了128类，ID的每一位对应于其中的一类。随着网络中的节点被某节点发现，它们被逐步加入到该节点的相应的列表中，这个过程中包括向节点列表中存信息和从节点列表中取信息的操作，甚至还包括当时协助其他节点寻找相应键对应值的操作。这个过程中发现的所有节点都将被加入到节点的列表之中，因此节点对整个网络的感知是动态的，这使得网络一直保持着频繁地更新，增强了抵御错误和攻击的能力。</p>

<p>在Kademlia相关的论文中，列表也称为K桶，其中K是一个系统变量，如20，每一个K桶是一个最多包含K个条目的列表，也就是说，网络中所有节点的一个列表（对应于某一位，与该节点相距一个特定的距离）最多包含20个节点。随着对应的bit位变低（即对应的异或距离越来越短），K桶包含的可能节点数迅速下降（这是由于K桶对应的异或距离越近，节点数越少），因此，对应于更低bit位的K桶显然包含网络中所有相关部分的节点。由于网络中节点的实际数量远远小于可能ID号的数量，所以对应那些短距离的某些K桶可能一直是空的（如果异或距离只有1，可能的数量就最大只能为1，这个异或距离为1的节点如果没有发现，则对应于异或距离为1的K桶则是空的）。</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/6/63/Dht_example_SVG.svg" alt="kademlia example" /></p>

<p>让我们看上面的那个简单网络，该网络最大可有2^3，即8个关键字和节点，目前共有7个节点加入，每个节点用一个小圈表示（在树的底部）。我们考虑那个用黑圈标注的节点6，它共有3个K桶，节点0，1和2（二进制表示为000，001和010）是第一个K桶的候选节点，节点3目前（二进制表示为011）还没有加入网络，节点4和节点5（二进制表示分别为100和101）是第二个K桶的候选节点，只有节点7（二进制表示为111）是第3个K桶的候选节点。图中，3个K桶都用灰色圈表示，假如K桶的大小（即K值）是2，那么第一个K桶只能包含3个节点中的2个。众所周知，那些长时间在线连接的节点未来长时间在线的可能性更大，基于这种静态统计分布的规律，Kademlia选择把那些长时间在线的节点存入K桶，这一方法增长了未来某一时刻有效节点的数量，同时也提供了更为稳定的网络。当某个K桶已满，而又发现了相应于该桶的新节点的时候，那么，就首先检查K桶中最早访问的节点，假如该节点仍然存活，那么新节点就被安排到一个附属列表中（作为一个替代缓存）.只有当K桶中的某个节点停止响应的时候，替代cache才被使用。换句话说，新发现的节点只有在老的节点消失后才被使用。</p>

<h1 id="kademlia-like">以太坊Kademlia-like协议</h1>

<p>以太坊的kademlia网(简称kad)和标准kad网有部分差异.</p>

<p>下面对照以太坊源码,阐述下kad网里几个概念:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/p2p/discover/table.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">    <span class="nx">alpha</span>      <span class="p">=</span> <span class="mi">3</span>                      <span class="c1">// Kademlia并发参数</span>
</span><span class="line">    <span class="nx">bucketSize</span> <span class="p">=</span> <span class="mi">16</span>                     <span class="c1">// Kademlia K桶大小(可容纳节点数)</span>
</span><span class="line">    <span class="nx">hashBits</span>   <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span><span class="p">{})</span> <span class="o">*</span> <span class="mi">8</span> <span class="c1">// 每个节点ID长度,32*8=256, 32位16进制</span>
</span><span class="line">    <span class="nx">nBuckets</span>   <span class="p">=</span> <span class="nx">hashBits</span> <span class="o">+</span> <span class="mi">1</span>           <span class="c1">// K桶个数</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>α</code>即代码里的<code>alpha</code>,是系统内一个优化参数,控制每次从K桶最多取出节点个数,ethereum取值3</li>
  <li><code>bucketSize</code>,K桶大小,ethereum取16</li>
  <li><code>hashBits</code>,节点长度256位</li>
  <li><code>nBuckets</code>,K桶个数,目前取257</li>
</ul>

<p>以太坊Kad网总共定义了4种消息类型:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/p2p/discover/udp.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">    <span class="nx">pingPacket</span> <span class="p">=</span> <span class="kc">iota</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// ping操作</span>
</span><span class="line">    <span class="nx">pongPacket</span>            <span class="c1">// pong操作</span>
</span><span class="line">
</span><span class="line">    <span class="nx">findnodePacket</span>        <span class="c1">// find node节点查询</span>
</span><span class="line">    <span class="nx">neighborsPacket</span>       <span class="c1">// neighbors邻居回应</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>ping</code>和<code>pong</code>是一对操作,用于检测节点活性,节点收到<code>ping</code>消息后立即回复<code>pong</code>响应:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// 收到ping消息的响应函数</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">ping</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">udp</span><span class="p">,</span> <span class="nx">from</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">,</span> <span class="nx">fromID</span> <span class="nx">NodeID</span><span class="p">,</span> <span class="nx">mac</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 向ping消息发送方回复pong</span>
</span><span class="line">    <span class="nx">t</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">pongPacket</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pong</span><span class="p">{</span>
</span><span class="line">        <span class="nx">To</span><span class="p">:</span>         <span class="nx">makeEndpoint</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">From</span><span class="p">.</span><span class="nx">TCP</span><span class="p">),</span>
</span><span class="line">        <span class="nx">ReplyTok</span><span class="p">:</span>   <span class="nx">mac</span><span class="p">,</span>
</span><span class="line">        <span class="nx">Expiration</span><span class="p">:</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">expiration</span><span class="p">).</span><span class="nx">Unix</span><span class="p">()),</span>
</span><span class="line">    <span class="p">})</span>
</span><span class="line">    <span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">handleReply</span><span class="p">(</span><span class="nx">fromID</span><span class="p">,</span> <span class="nx">pingPacket</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="c1">// 成功完成一次ping-pong,更新K桶节点信息</span>
</span><span class="line">        <span class="k">go</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bond</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">fromID</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">From</span><span class="p">.</span><span class="nx">TCP</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>findnode</code>和<code>neighbors</code>是一对操作.</p>

<p><code>findnode</code>用于查找与某节点相距最近的节点,查找到后以<code>neighbors</code>类型消息回复查找发起者</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// 收到findnode消息的响应函数</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">findnode</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">udp</span><span class="p">,</span> <span class="nx">from</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">,</span> <span class="nx">fromID</span> <span class="nx">NodeID</span><span class="p">,</span> <span class="nx">mac</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="nx">target</span> <span class="o">:=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">Keccak256Hash</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Target</span><span class="p">[:])</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 从本节点路由表里查找于target节点相距最近的bucketSize的节点</span>
</span><span class="line">    <span class="nx">closest</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">bucketSize</span><span class="p">).</span><span class="nx">entries</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">
</span><span class="line">    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">neighbors</span><span class="p">{</span><span class="nx">Expiration</span><span class="p">:</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">expiration</span><span class="p">).</span><span class="nx">Unix</span><span class="p">())}</span>
</span><span class="line">    <span class="c1">// 回复查询发起方</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">closest</span> <span class="p">{</span>
</span><span class="line">        <span class="o">...</span>
</span><span class="line">        <span class="nx">t</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">neighborsPacket</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
</span><span class="line">        <span class="o">...</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section">源码跟踪以太坊节点发现机制</h1>

<p>了解了以太坊的4种基本操作以及kad网络概念,我们就可以来看看节点发现机制怎么流转起来的:</p>

<p>节点发现的代码位于<code>github.com/ethereum/go-ethereum/p2p/discover</code>包。</p>

<p>首先,在节点启动时启动UDP”端口监听”:<code>server.Start() ==&gt; discover.ListenUDP ==&gt; newUDP()</code></p>

<p><code>newUDP()</code>分叉出去三个流程,三个流程均是无限循环:</p>

<ul>
  <li><code>func (tab *Table) refreshLoop()</code></li>
  <li><code>func (t *udp) loop()</code></li>
  <li><code>func (t *udp) readLoop(unhandled chan ReadPacket)</code></li>
</ul>

<h4 id="refreshloop">1. <code>refreshLoop()</code></h4>

<p>该流程每隔1小时或按需刷新K桶,核心逻辑实现位于<code>doRefresh</code>函数:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>github.com/ethereum/go-ethereum/p2p/discover/table.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">tab</span> <span class="o">*</span><span class="nx">Table</span><span class="p">)</span> <span class="nx">doRefresh</span><span class="p">(</span><span class="nx">done</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 和标准Kademlia协议选取最旧的K桶进行刷新不同，以太坊选取一个随机节点ID作为刷新基点</span>
</span><span class="line">    <span class="kd">var</span> <span class="nx">target</span> <span class="nx">NodeID</span>
</span><span class="line">    <span class="nx">rand</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">target</span><span class="p">[:])</span>
</span><span class="line">    <span class="c1">// lookup函数是最kad网最核心函数,查询离target最近一批节点</span>
</span><span class="line">    <span class="nx">result</span> <span class="o">:=</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 如果没找到,则从本地节点数据库加载预配置的种子节点到对应K桶</span>
</span><span class="line">    <span class="nx">seeds</span> <span class="o">:=</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">querySeeds</span><span class="p">(</span><span class="nx">seedCount</span><span class="p">,</span> <span class="nx">seedMaxAge</span><span class="p">)</span>
</span><span class="line">    <span class="nx">seeds</span> <span class="p">=</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">bondall</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="nx">seeds</span><span class="p">,</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">nursery</span><span class="o">...</span><span class="p">))</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 最后,以自身作为目标节点,刷新K桶</span>
</span><span class="line">    <span class="nx">tab</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">tab</span><span class="p">.</span><span class="nx">self</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>tab.lookup</code>函数虽然关键,然而其逻辑其实是很简单的:</p>

<p>a. 查询离target最近一批节点,距离计算即对kad网络XOR(异或)距离计算的实现</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">tab</span> <span class="o">*</span><span class="nx">Table</span><span class="p">)</span> <span class="nx">closest</span><span class="p">(</span><span class="nx">target</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span><span class="p">,</span> <span class="nx">nresults</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">nodesByDistance</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 遍历本地路由节点表</span>
</span><span class="line">    <span class="nx">close</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">nodesByDistance</span><span class="p">{</span><span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">}</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">{</span>
</span><span class="line">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">entries</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">close</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">nresults</span><span class="p">)</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">close</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="c1">// close.push最终调用distcmp进行异或计算</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">distcmp</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="nx">common</span><span class="p">.</span><span class="nx">Hash</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">target</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">da</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">^</span> <span class="nx">target</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span><span class="line">        <span class="nx">db</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">^</span> <span class="nx">target</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">da</span> <span class="p">&gt;</span> <span class="nx">db</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="mi">1</span>
</span><span class="line">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">da</span> <span class="p">&lt;</span> <span class="nx">db</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>b. 迭代上一步查到的所有节点,向这些节点发起<code>findnode</code>操作查询离target节点最近的节点列表,将查询得到的节点进行<code>ping-pong</code>测试,将测试通过的节点落库保存</p>

<p>经过这个流程后,节点的K桶就能够比较均匀地将不同网络节点更新到本地K桶中。</p>

<h4 id="loopreadloop">2. <code>loop()</code>和<code>readLoop()</code></h4>

<p>这两个循环流程放在一起说,它们主要是一个工程实现,将异步调用代码通过channel串接成同步。业务上主要是负责处理<code>ping,pong,findnode,neighbors</code>四个消息类型的收发。</p>

<p>唯一值得稍加阐述的可能只有<code>pending</code>结构:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// pending实现了一种延迟处理逻辑</span>
</span><span class="line"><span class="c1">//</span>
</span><span class="line"><span class="c1">// 它主要有两个作用:</span>
</span><span class="line"><span class="c1">// 1. 提供回调机制,当某一个操作发起异步请求时,就使用pending结构封装一个闭包,当收到异步回复后从pending列表取出这个闭包,执行回调,因此在这个回调里可以完成数据包校验等后处理</span>
</span><span class="line"><span class="c1">// 如findnode操作将更新k桶的操作暂存,再获取到异步回复后执行这个闭包完成k桶更新</span>
</span><span class="line"><span class="c1">// 2. 提供多个回复接收功能,一个RPC请求可能会对应多个回复包,比如findnode对应多个neigbours回复包,此时可以提供多个pending进行逐个包校验</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">pending</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 来源节点</span>
</span><span class="line">    <span class="nx">from</span>  <span class="nx">NodeID</span>
</span><span class="line">    <span class="nx">ptype</span> <span class="kt">byte</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 调用超时丢弃pending结构</span>
</span><span class="line">    <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 回调函数,简单而强大</span>
</span><span class="line">    <span class="nx">callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">done</span> <span class="kt">bool</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">errc</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">error</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>综述,邻居节点发现流程:</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/eth_kad.jpeg" alt="kademlia" /></p>

<p>节点第一次启动读取公共种子节点信息,已本节点ID作为target更新本地K桶,然后每隔一段时间进行节点更新, 刷新K桶流程如下:</p>

<p>a. 随机生成目标节点Id，记为TargetId，从1开始记录发现次数和刷新时间。</p>

<p>b. 在当前节点的K桶里查找与目标节点最近的16个节点</p>

<p>c. 向b中得到的每个节点发送findnode命令,接收到每个节点传回的neighbours节点</p>

<p>d. 对c返回的每个节点进行ping-pong测试然后更新到本地k桶</p>

<p>e. 上述流程均是基于UDP的发现流程,p2p网络会定时随机取k桶中未连接的节点进行TCP连接,在连接好的TCP通道进行通信(tcp连接协程里会自己做心跳维护这个连接)</p>

<h1 id="section-1">内网穿透</h1>

<p>ethereum是基于p2p通信的,所有的操作都有可能涉及到内网穿透,而目前内网穿透最常用的方法是udp打洞,这也是kad网络使用udp作为基础通信协议的原因。</p>

<p>一个简单的udp打通进行p2p通信的例子讲解可以参考<a href="http://qjpcpu.github.io/blog/2018/01/29/shen-ru-ethereumyuan-ma-p2pmo-kuai-ji-chu-jie-gou/">深入ethereum源码-p2p模块基础结构</a>。</p>

<p>然而以太坊里将这部分逻辑全部隐藏,可以在节点初始化函数里看出一点痕迹:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nx">Start</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">addr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ResolveUDPAddr</span><span class="p">(</span><span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">ListenAddr</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ListenUDP</span><span class="p">(</span><span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="nx">realaddr</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">LocalAddr</span><span class="p">().(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">NAT</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">if</span> <span class="p">!</span><span class="nx">realaddr</span><span class="p">.</span><span class="nx">IP</span><span class="p">.</span><span class="nx">IsLoopback</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">                <span class="c1">// 进行内网网端口映射</span>
</span><span class="line">                <span class="k">go</span> <span class="nx">nat</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="nx">srv</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">quit</span><span class="p">,</span> <span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="nx">realaddr</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span> <span class="nx">realaddr</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span> <span class="s">&quot;ethereum discovery&quot;</span><span class="p">)</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">            <span class="c1">// TODO: react to external IP changes over time.</span>
</span><span class="line">            <span class="k">if</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">NAT</span><span class="p">.</span><span class="nx">ExternalIP</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">                <span class="nx">realaddr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span><span class="nx">IP</span><span class="p">:</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">Port</span><span class="p">:</span> <span class="nx">realaddr</span><span class="p">.</span><span class="nx">Port</span><span class="p">}</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>首先，以太坊tcp/udp共用了一个端口,然后使用uPnp协议簇进行内外网端口映射,完成链路打通,从而穿透内网.</p>

<p>具体封装位于<code>nat</code>模块,但具体实现也是使用了三方库<a href="https://github.com/huin/goupnp">goupnp</a>.具体实现是关于uPnP的一个大话题,就不在这里分叉出去了。</p>

<h1 id="section-2">参考文献</h1>

<ul>
  <li><a href="https://zh.wikipedia.org/wiki/Kademlia">Kademlia</a></li>
  <li><a href="http://www.yeolar.com/note/2010/03/21/kademlia/">Kademlia协议原理简介</a></li>
  <li><a href="https://github.com/ethereum/wiki/wiki/Node-discovery-protocol">Node discovery protocol</a></li>
  <li><a href="http://www.8btc.com/etc-p2p">P2P网络及节点发现机制</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入ethereum源码-p2p模块基础结构]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/01/29/shen-ru-ethereumyuan-ma-p2pmo-kuai-ji-chu-jie-gou/"/>
    <updated>2018-01-29T11:19:23+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/01/29/shen-ru-ethereumyuan-ma-p2pmo-kuai-ji-chu-jie-gou</id>
    <content type="html"><![CDATA[<p>(go-ethereum/p2p)包允许您快速方便地将对等网络添加到任何类型的应用程序。p2p包采用模块化结构,包含p2p网络节点通信维护及新节点发现,将网络结构的基础细节封装并向上层屏蔽,并且暴露了简单接口让上层实现子协议,上层应用使用自己的附加子协议扩展p2p非常简单直接.</p>

<p>如果将以太坊的p2p类比做tcp协议,那么p2p暴露出来的子协议就类似http,使得以太坊能够在基础p2p基础上构建出whisper网络。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#peer-to-peer">Peer to peer</a></li>
  <li><a href="#peer">peer接入</a></li>
  <li><a href="#rlp">数据传输格式RLP</a></li>
  <li><a href="#section">总述</a></li>
  <li><a href="#section-1">参考文献</a></li>
</ul>

<h1 id="peer-to-peer">Peer to peer</h1>

<p>在深入了解前,最好先看看基于p2p包怎么实现一个自己子协议,建立对其的直观印象</p>

<blockquote>
  <p>下面示例来基于官方[Peer to peer]wiki文档(官方文档有个小bug, ^_^),详细参考文献</p>
</blockquote>

<p>启动一个p2p节点仅需要对<code>p2p.Server</code>做一些简单配置:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">nodekey</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">GenerateKey</span><span class="p">()</span>
</span><span class="line"><span class="nx">srv</span> <span class="o">:=</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span><span class="line">    <span class="nx">Config</span><span class="p">:</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span><span class="line">        <span class="nx">MaxPeers</span><span class="p">:</span>   <span class="mi">10</span><span class="p">,</span>
</span><span class="line">        <span class="nx">PrivateKey</span><span class="p">:</span> <span class="nx">nodekey</span><span class="p">,</span>
</span><span class="line">        <span class="nx">Name</span><span class="p">:</span>       <span class="s">&quot;my node name&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="nx">ListenAddr</span><span class="p">:</span> <span class="s">&quot;:30300&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="nx">Protocols</span><span class="p">:</span>  <span class="p">[]</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">{},</span>
</span><span class="line">        <span class="nx">NAT</span><span class="p">:</span>        <span class="nx">nat</span><span class="p">.</span><span class="nx">Any</span><span class="p">(),</span>   <span class="c1">// 支持内网穿透</span>
</span><span class="line">        <span class="nx">Logger</span><span class="p">:</span>     <span class="nx">log</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这样启动的节点仅包含了以太坊自身的基础协议:</p>

<p>要实现自己的子协议,就需要拓展<code>Protocols:  []p2p.Protocol{}</code>,实现自己的<code>p2p.Protocol</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">MyProtocol</span><span class="p">()</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">{</span>                                                          <span class="c1">// 1.</span>
</span><span class="line">		<span class="nx">Name</span><span class="p">:</span>    <span class="s">&quot;MyProtocol&quot;</span><span class="p">,</span>                                                    <span class="c1">// 2.</span>
</span><span class="line">		<span class="nx">Version</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                                                               <span class="c1">// 3.</span>
</span><span class="line">		<span class="nx">Length</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span>                                                               <span class="c1">// 4.</span>
</span><span class="line">		<span class="nx">Run</span><span class="p">:</span>     <span class="kd">func</span><span class="p">(</span><span class="nx">peer</span> <span class="o">*</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Peer</span><span class="p">,</span> <span class="nx">ws</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">MsgReadWriter</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">},</span> <span class="c1">// 5.</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>一个子协议即一个<code>p2p.Protocol</code></li>
  <li>子协议名,需要唯一标识该子协议</li>
  <li>协议版本号,当一个子协议有多个版本时,采纳最高版本的协议</li>
  <li>该协议拥有的消息类型个数,因为p2p网络是可扩展的，因此其需要具有能够发送随意个数的信息的能力（需要携带type，在下文中我们能够看到说明）,p2p的handler需要知道应该预留多少空间以用来服务你的协议。这是也是共识信息能够通过message ID到达各个peer并实现协商的保障。我们的协议仅仅支持一种类型</li>
  <li>在你的协议主要的handler中，我们现在故意将其留空。这个peer变量是指代连接到当前节点，其携带了一些peer本身的信息。其ws变量是reader和writer允许你同该peer进行通信，如果信息能够发送到当前节点，则反之也能够从本节点发送到对端peer节点</li>
</ol>

<p>现在让我们将前面留空的handler代码实现，以让它能够同别的peer通信:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">const</span> <span class="nx">messageId</span> <span class="p">=</span> <span class="mi">0</span>   <span class="c1">// 1.</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">Message</span> <span class="kt">string</span>   <span class="c1">// 2.</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">msgHandler</span><span class="p">(</span><span class="nx">peer</span> <span class="o">*</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Peer</span><span class="p">,</span> <span class="nx">ws</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">MsgReadWriter</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="k">for</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">ReadMsg</span><span class="p">()</span>   <span class="c1">// 3.</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>            <span class="c1">// 4.</span>
</span><span class="line">            <span class="k">return</span> <span class="nx">err</span> <span class="c1">// if reading fails return err which will disconnect the peer.</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="kd">var</span> <span class="nx">myMessage</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="nx">Message</span>
</span><span class="line">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myMessage</span><span class="p">)</span> <span class="c1">// 5.</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="c1">// handle decode error</span>
</span><span class="line">            <span class="k">continue</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="k">switch</span> <span class="nx">myMessage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
</span><span class="line">        <span class="k">case</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span>
</span><span class="line">            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">messageId</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span>  <span class="c1">// 6.</span>
</span><span class="line">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">                <span class="k">return</span> <span class="nx">err</span> <span class="c1">// return (and disconnect) error if writing fails.</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">         <span class="k">default</span><span class="p">:</span>
</span><span class="line">             <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;recv:&quot;</span><span class="p">,</span> <span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">         <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>其中有且唯一的已知信息ID；</li>
  <li>将Messages alias 为string类型；</li>
  <li>ReadMsg将一直阻塞等待，直到其收到了一条新的信息，一个错误或者EOF；</li>
  <li>如果在读取流信息的过程当中收到了一个错误，最好的解决实践是将其返回给p2p server进行处理。这种错误通常是对端节点已经断开连接；</li>
  <li>msg包括两个属性和一个decode方法
    <ol>
      <li>Code 包括了信息ID，Code == messageId (i.e.0),取值范围为[0,p2p.Protocol.Length)</li>
      <li>Payload 是信息的内容</li>
      <li>Decode(<ptr>) 是一个工具方法：取得 msg.Payload并将其解码，并将其内容设置到传入的message指针中，如果失败了则返回一个error</ptr></li>
    </ol>
  </li>
  <li>如果解码出来的信息是foo将发回一个NewMessage并用messageId标记信息类型，信息内容是bar；而bar信息在被对端收到之后将被defaultcase捕获。</li>
</ol>

<p>现在，我们将上述的所有部分整合起来，得到下面的p2p样例代码:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/crypto&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/log&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/p2p&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/p2p/discover&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/ethereum/go-ethereum/p2p/nat&quot;</span>
</span><span class="line">	<span class="s">&quot;net&quot;</span>
</span><span class="line">	<span class="s">&quot;os&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">const</span> <span class="nx">messageId</span> <span class="p">=</span> <span class="mi">0</span>
</span><span class="line"><span class="kd">const</span> <span class="nx">messageId1</span> <span class="p">=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Message</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">MyProtocol</span><span class="p">()</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">{</span>
</span><span class="line">		<span class="nx">Name</span><span class="p">:</span>    <span class="s">&quot;MyProtocol&quot;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">Version</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">		<span class="nx">Length</span><span class="p">:</span>  <span class="mi">2</span><span class="p">,</span>
</span><span class="line">		<span class="nx">Run</span><span class="p">:</span>     <span class="nx">msgHandler</span><span class="p">,</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">nodekey</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">GenerateKey</span><span class="p">()</span>
</span><span class="line">	<span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
</span><span class="line">	<span class="nx">logger</span><span class="p">.</span><span class="nx">SetHandler</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">StderrHandler</span><span class="p">)</span>
</span><span class="line">	<span class="nx">srv</span> <span class="o">:=</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span><span class="line">		<span class="nx">Config</span><span class="p">:</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span><span class="line">			<span class="nx">MaxPeers</span><span class="p">:</span>   <span class="mi">10</span><span class="p">,</span>
</span><span class="line">			<span class="nx">PrivateKey</span><span class="p">:</span> <span class="nx">nodekey</span><span class="p">,</span>
</span><span class="line">			<span class="nx">Name</span><span class="p">:</span>       <span class="s">&quot;my node name&quot;</span><span class="p">,</span>
</span><span class="line">			<span class="nx">ListenAddr</span><span class="p">:</span> <span class="s">&quot;:30300&quot;</span><span class="p">,</span>
</span><span class="line">			<span class="nx">Protocols</span><span class="p">:</span>  <span class="p">[]</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">{</span><span class="nx">MyProtocol</span><span class="p">()},</span>
</span><span class="line">			<span class="nx">NAT</span><span class="p">:</span>        <span class="nx">nat</span><span class="p">.</span><span class="nx">Any</span><span class="p">(),</span>
</span><span class="line">			<span class="nx">Logger</span><span class="p">:</span>     <span class="nx">logger</span><span class="p">,</span>
</span><span class="line">		<span class="p">},</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;started..&quot;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">NodeInfo</span><span class="p">())</span>
</span><span class="line">	<span class="k">select</span> <span class="p">{}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">msgHandler</span><span class="p">(</span><span class="nx">peer</span> <span class="o">*</span><span class="nx">p2p</span><span class="p">.</span><span class="nx">Peer</span><span class="p">,</span> <span class="nx">ws</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">MsgReadWriter</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span><span class="nx">peer</span><span class="p">.</span><span class="nx">Name</span><span class="p">(),</span><span class="s">&quot;connected.&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">messageId</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="k">for</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">ReadMsg</span><span class="p">()</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span><span class="nx">peer</span><span class="p">.</span><span class="nx">Name</span><span class="p">(),</span><span class="s">&quot;disconnected&quot;</span><span class="p">)</span>
</span><span class="line">			<span class="k">return</span> <span class="nx">err</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">        <span class="c1">// SendItems writes an RLP with the given code and data elements.</span>
</span><span class="line">        <span class="c1">// For a call such as:</span>
</span><span class="line">        <span class="c1">//</span>
</span><span class="line">        <span class="c1">//    SendItems(w, code, e1, e2, e3)</span>
</span><span class="line">        <span class="c1">//</span>
</span><span class="line">        <span class="c1">// the message payload will be an RLP list containing the items:</span>
</span><span class="line">        <span class="c1">//</span>
</span><span class="line">        <span class="c1">//    [e1, e2, e3]</span>
</span><span class="line">        <span class="c1">// 所以这里收消息应该定义为数组</span>
</span><span class="line">		<span class="kd">var</span> <span class="nx">myMessage</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="nx">Message</span>
</span><span class="line">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">			<span class="c1">// handle decode error</span>
</span><span class="line">			<span class="k">continue</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;code:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span> <span class="s">&quot;receiver at:&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">ReceivedAt</span><span class="p">,</span> <span class="s">&quot;msg:&quot;</span><span class="p">,</span> <span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="k">switch</span> <span class="nx">myMessage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
</span><span class="line">		<span class="k">case</span> <span class="s">&quot;foo&quot;</span><span class="p">:</span>
</span><span class="line">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">p2p</span><span class="p">.</span><span class="nx">SendItems</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">messageId1</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span>
</span><span class="line">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">				<span class="k">return</span> <span class="nx">err</span>
</span><span class="line">			<span class="p">}</span>
</span><span class="line">		<span class="k">default</span><span class="p">:</span>
</span><span class="line">			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;recv:&quot;</span><span class="p">,</span> <span class="nx">myMessage</span><span class="p">)</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="peer">peer接入</h1>

<p>从上面的例子,我们可以看出来实现ethereum是非常便利的,那么下一步,我们可以看看一个节点是怎么处理新peer的接入的?梳理出这个接入过程,也就明白了节点间基本的数据流通方式.</p>

<p>首先,每个节点启动入口都在<code>func (srv *Server) Start() (err error)</code>.该函数调用<code>srv.startListening()</code>在传入的ip地址监听tcp连接:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nx">startListening</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// Launch the TCP listener.</span>
</span><span class="line">    <span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">ListenAddr</span><span class="p">)</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="k">go</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">listenLoop</span><span class="p">()</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 主执行逻辑</span>
</span><span class="line">    <span class="k">go</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">dialer</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当接收到一个新的tcp连接,节点开始检查并初始化peer</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nx">setupConn</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">flags</span> <span class="nx">connFlag</span><span class="p">,</span> <span class="nx">dialDest</span> <span class="o">*</span><span class="nx">discover</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 从这里开始,其实已经开始了ethereum的自有协议,doEncHandshake是RLPX协议的握手方法</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">doEncHandshake</span><span class="p">(</span><span class="nx">srv</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span> <span class="nx">dialDest</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">srv</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">Trace</span><span class="p">(</span><span class="s">&quot;Failed RLPx handshake&quot;</span><span class="p">,</span> <span class="s">&quot;addr&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">(),</span> <span class="s">&quot;conn&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">flags</span><span class="p">,</span> <span class="s">&quot;err&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 两次握手消息代码(handshakeMsg = 0x00)和(discMsg = 0x01)</span>
</span><span class="line">    <span class="nx">phs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">doProtoHandshake</span><span class="p">(</span><span class="nx">srv</span><span class="p">.</span><span class="nx">ourHandshake</span><span class="p">)</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// 握手完毕,将新连接对象*p2p.conn压入server.addpeer</span>
</span><span class="line">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">checkpoint</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">addpeer</span><span class="p">)</span>
</span><span class="line">    <span class="c1">// If the checks completed successfully, runPeer has now been</span>
</span><span class="line">    <span class="c1">// launched by run.</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>下面开始看<code>Start()</code>函数里的节点主逻辑,主逻辑位于<code>Start()</code>末尾的<code>srv.run()</code>,该函数逻辑较复杂,我们现在主要看新peer接入的代码:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nx">run</span><span class="p">(</span><span class="nx">dialstate</span> <span class="nx">dialer</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="o">...</span>
</span><span class="line">      <span class="k">select</span><span class="p">{</span>
</span><span class="line">          <span class="o">...</span>
</span><span class="line">          <span class="k">case</span> <span class="nx">c</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">srv</span><span class="p">.</span><span class="nx">addpeer</span><span class="p">:</span>  <span class="c1">// 在这里取出之前压入addpeer的连接对象conn</span>
</span><span class="line">          <span class="c1">// 执行到这里表明握手完成,并且通过了节点验证</span>
</span><span class="line">          <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">protoHandshakeChecks</span><span class="p">(</span><span class="nx">peers</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span><span class="line">          <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">              <span class="c1">// 创建节点peer对象,传入所有子协议实现,自己实现的子协议就是在这里传入peer的,传入的所以协议通过matchProtocols函数格式化组织</span>
</span><span class="line">              <span class="nx">p</span> <span class="o">:=</span> <span class="nx">newPeer</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Protocols</span><span class="p">)</span>
</span><span class="line">              <span class="o">...</span>
</span><span class="line">              <span class="k">go</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">runPeer</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span><span class="line">          <span class="p">}</span>
</span><span class="line">          <span class="o">...</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">      <span class="o">...</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里补充说一下<code>newPeer()</code>对子协议的一个组织方式:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">matchProtocols</span><span class="p">(</span><span class="nx">protocols</span> <span class="p">[]</span><span class="nx">Protocol</span><span class="p">,</span> <span class="nx">caps</span> <span class="p">[]</span><span class="nx">Cap</span><span class="p">,</span> <span class="nx">rw</span> <span class="nx">MsgReadWriter</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">protoRW</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 按协议(name asc,version asc)排序子协议</span>
</span><span class="line">    <span class="nx">sort</span><span class="p">.</span><span class="nx">Sort</span><span class="p">(</span><span class="nx">capsByNameAndVersion</span><span class="p">(</span><span class="nx">caps</span><span class="p">))</span>
</span><span class="line">    <span class="c1">// 自定义协议偏移</span>
</span><span class="line">    <span class="nx">offset</span> <span class="o">:=</span> <span class="nx">baseProtocolLength</span>
</span><span class="line">    <span class="nx">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">protoRW</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="nx">outer</span><span class="p">:</span>
</span><span class="line">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cap</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">caps</span> <span class="p">{</span>
</span><span class="line">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">proto</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">protocols</span> <span class="p">{</span>
</span><span class="line">            <span class="k">if</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">Name</span> <span class="o">==</span> <span class="nx">cap</span><span class="p">.</span><span class="nx">Name</span> <span class="o">&amp;&amp;</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">Version</span> <span class="o">==</span> <span class="nx">cap</span><span class="p">.</span><span class="nx">Version</span> <span class="p">{</span>
</span><span class="line">                <span class="c1">// If an old protocol version matched, revert it</span>
</span><span class="line">                <span class="k">if</span> <span class="nx">old</span> <span class="o">:=</span> <span class="nx">result</span><span class="p">[</span><span class="nx">cap</span><span class="p">.</span><span class="nx">Name</span><span class="p">];</span> <span class="nx">old</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">                    <span class="nx">offset</span> <span class="o">-=</span> <span class="nx">old</span><span class="p">.</span><span class="nx">Length</span>
</span><span class="line">                <span class="p">}</span>
</span><span class="line">                <span class="c1">// Assign the new match</span>
</span><span class="line">                <span class="nx">result</span><span class="p">[</span><span class="nx">cap</span><span class="p">.</span><span class="nx">Name</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">protoRW</span><span class="p">{</span><span class="nx">Protocol</span><span class="p">:</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">offset</span><span class="p">:</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">in</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Msg</span><span class="p">),</span> <span class="nx">w</span><span class="p">:</span> <span class="nx">rw</span><span class="p">}</span>
</span><span class="line">                <span class="nx">offset</span> <span class="o">+=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">Length</span>
</span><span class="line">
</span><span class="line">                <span class="k">continue</span> <span class="nx">outer</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">result</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>最终每个子协议以<code>name=&gt;protocol</code>的map格式组织起来,然后每个协议根据自身支持消息类型数量<code>Protocol.Length</code>在整个以太坊消息类型轴上占据了<code>[proto.offset,proto.offset+proto.Length)</code>的左闭右开消息类型段,理解这个结构,才好理解最终根据消息类型<code>Msg.Code</code>去找handler的逻辑(<code>func (p *Peer) getProto(code uint64) (*protoRW, error)</code>)。</p>

<p>下面继续看最终peer处理逻辑<code>srv.runPeer</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Peer</span><span class="p">)</span> <span class="nx">run</span><span class="p">()</span> <span class="p">(</span><span class="nx">remoteRequested</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">    <span class="c1">// peer逻辑里最重要两个循环逻辑</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 收取消息循环,核心逻辑是根据消息的代号proto, err := p.getProto(msg.Code),</span>
</span><span class="line">    <span class="c1">// 取得对应的子协议,然后投放到对应协议的读队列proto.in &lt;- msg</span>
</span><span class="line">    <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nx">readLoop</span><span class="p">(</span><span class="nx">readErr</span><span class="p">)</span>
</span><span class="line">    <span class="c1">// 不停发送ping心跳包到远端peer</span>
</span><span class="line">    <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pingLoop</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 在startProtocols里最终调用我们自定义子协议的Run方法proto.Run(p, rw)</span>
</span><span class="line">    <span class="nx">p</span><span class="p">.</span><span class="nx">startProtocols</span><span class="p">(</span><span class="nx">writeStart</span><span class="p">,</span> <span class="nx">writeErr</span><span class="p">)</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="rlp">数据传输格式RLP</h1>

<p>以太坊数据传输都是基于RLP编码,下面文字摘自<a href="http://ethfans.org/posts/415">RLP编码原理</a></p>

<blockquote>
  <p>RLP(Recursive Length Prefix，递归长度前缀)是一种编码算法，用于编码任意的嵌套结构的二进制数据，它是以太坊中数据序列化/反序列化的主要方法，区块、交易等数据结构在持久化时会先经过RLP编码后再存储到数据库中</p>
</blockquote>

<p>定义</p>

<blockquote>
  <p>RLP编码的定义只处理两类数据：一类是字符串（例如字节数组），一类是列表。字符串指的是一串二进制数据，列表是一个嵌套递归的结构，里面可以包含字符串和列表，例如<code>["cat",["puppy","cow"],"horse",[[]],"pig",[""],"sheep"]</code>就是一个复杂的列表。其他类型的数据需要转成以上的两类，转换的规则不是RLP编码定义的，可以根据自己的规则转换，例如struct可以转成列表，int可以转成二进制（属于字符串一类），以太坊中整数都以大端形式存储。</p>
</blockquote>

<p>这部分代码均位于<code>github.com/ethereum/go-ethereum/rlp</code>包中,代码相对独立,我也没深入研究改算法,就不详细说明了。</p>

<h1 id="section">总述</h1>

<p>本文主要梳理了以太坊p2p模块的主流程,描述了核心的peer间数据读写的来龙去脉,从代码里也能够比较容易理解以太坊子协议的概念,理清这个主干流程,以后也就能够从每个细节发散开来,深入细节。</p>

<h1 id="section-1">参考文献</h1>

<ul>
  <li><a href="https://github.com/ethereum/go-ethereum">go-ethereum github地址</a></li>
  <li><a href="https://github.com/ethereum/go-ethereum/wiki/Peer-to-Peer">Peer to Peer</a></li>
  <li><a href="http://blog.csdn.net/teaspring/article/details/78455046">基于p2p的底层通信</a></li>
  <li><a href="https://github.com/ethereum/wiki/wiki/%5B%E4%B8%AD%E6%96%87%5D-RLP">RLP</a></li>
  <li><a href="http://ethfans.org/posts/415">RLP编码原理</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[p2p之UDP打洞]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2018/01/26/p2pzhi-udpda-dong/"/>
    <updated>2018-01-26T22:03:15+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2018/01/26/p2pzhi-udpda-dong</id>
    <content type="html"><![CDATA[<p>当今互联网到处存在着一些中间件(MIddleBoxes)，如NAT和防火墙，导致两个(不在同一内网)中的客户端无法直接通信。 这些问题即便是到了IPV6时代也会存在，因为即使不需要NAT，但还有其他中间件如防火墙阻挡了链接的建立。 目前部署的中间件多都是在C/S架构上设计的，其中相对隐匿的客户机主动向周知的服务端(拥有静态IP地址和DNS名称)发起链接请求。 大多数中间件实现了一种非对称的通讯模型，即内网中的主机可以初始化对外的链接，而外网的主机却不能初始化对内网的链接， 除非经过中间件管理员特殊配置。</p>

<p>在中间件为常见的NAPT的情况下（也是本文主要讨论的），内网中的客户端没有单独的公网IP地址， 而是通过NAPT转换，和其他同一内网用户共享一个公网IP。这种内网主机隐藏在中间件后的不可访问性对于一些客户端软件如浏览器来说 并不是一个问题，因为其只需要初始化对外的链接，从某方面来看反而还对隐私保护有好处。然而在P2P应用中， 内网主机（客户端）需要对另外的终端（Peer）直接建立链接，但是发起者和响应者可能在不同的中间件后面， 两者都没有公网IP地址。而外部对NAT公网IP和端口主动的链接或数据都会因内网未请求被丢弃掉。本文讨论的就是如何跨越NAT实现内网主机直接通讯的问题。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#section">网络模型</a></li>
  <li><a href="#section-1">打洞流程</a></li>
  <li><a href="#section-2">先决条件</a></li>
  <li><a href="#section-3">源码示例</a></li>
  <li><a href="#udptcp">udp打洞转tcp通信</a></li>
  <li><a href="#section-4">参考文献</a></li>
</ul>

<h1 id="section">网络模型</h1>

<p>假设客户端A和客户端B的地址都是内网地址，且在不同的NAT后面。A、B上运行的P2P应用程序和服务器S都使用了UDP端口9982，A和B分别初始化了 与Server的UDP通信，地址映射如图所示:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class=""><span class="line">                        Server S
</span><span class="line">                    207.148.70.129:9981
</span><span class="line">                           |
</span><span class="line">                           |
</span><span class="line">    +----------------------|----------------------+
</span><span class="line">    |                                             |
</span><span class="line">  NAT A                                         NAT B
</span><span class="line">120.27.209.161:6000                            120.26.10.118:3000
</span><span class="line">    |                                             |
</span><span class="line">    |                                             |
</span><span class="line"> Client A                                      Client B
</span><span class="line">  10.0.0.1:9982                                 192.168.0.1:9982</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>现在假设客户端A打算与客户端B直接建立一个UDP通信会话。如果A直接给B的公网地址120.26.10.118:3000发送UDP数据，NAT B将很可能会无视进入的 数据（除非是Full Cone NAT），因为源地址和端口与S不匹配，而最初只与S建立过会话。B往A直接发信息也类似。</p>

<p>假设A开始给B的公网地址发送UDP数据的同时，给服务器S发送一个中继请求，要求B开始给A的公网地址发送UDP信息。A往B的输出信息会导致NAT A打开 一个A的内网地址与与B的外网地址之间的新通讯会话，B往A亦然。一旦新的UDP会话在两个方向都打开之后，客户端A和客户端B就能直接通讯， 而无须再通过引导服务器S了。</p>

<p>UDP打洞技术有许多有用的性质。一旦一个的P2P链接建立，链接的双方都能反过来作为“引导服务器”来帮助其他中间件后的客户端进行打洞， 极大减少了服务器的负载。应用程序不需要知道中间件具体是什么（如果有的话），因为以上的过程在没有中间件或者有多个中间件的情况下 也一样能建立通信链路。</p>

<h1 id="section-1">打洞流程</h1>

<p>假设A现在希望建立一条到B的udp会话，那么这个建立基本流程是:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">1. A,B分别建立到Server S的udp会话,那么Server S此时是知道A,B各自的外网ip+端口
</span><span class="line">2. Server S在和B的udp会话里告诉A的地址(外网ip+端口: 120.27.209.161:6000),同理把B的地址(120.26.10.118:3000)告诉A
</span><span class="line">3. B向A地址(120.27.209.161:6000)发送一个"握手"udp包,打通A-&gt;B的udp链路
</span><span class="line">4. 此时A可以向B(120.26.10.118:3000)发送udp包,A-&gt;B的会话建立成功</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-2">先决条件</h1>

<p>能够完成打洞有几个先决条件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">1. A,B所在的nat网络类型(Full cone, Restricted cone, Port-restricted cone, Symmetric NAT)
</span><span class="line">2. 在一次udp会话期间,nat设备(路由器)会保持内网进程 inner_ip:inner_port &lt;-&gt; share_public_ip:share_port的映射关系,一般根据具体路由器实现,这个映射关系可以维持几分钟到几个小时不等
</span><span class="line">3. 流程中第3步,nat A收到这个握手包后并不会转发给A,因为它发现自己的没有保存过B的地址,认为这是一个来历不明的包而直接丢弃,然而这个包的作用在于在nat B留下了A的记录,使得nat B认为A是可达或者说可通过了,这样当A-&gt;B再发送udp包时就可以真正到达B了。所以这个"握手"包的作用是可以打通A-&gt;B的通路,是必要的</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="section-3">源码示例</h1>

<p>使用三台设备模拟,外网设备207.148.70.129模拟Server S,执行server.go代码:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>server.go </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;log&quot;</span>
</span><span class="line">	<span class="s">&quot;net&quot;</span>
</span><span class="line">	<span class="s">&quot;time&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ListenUDP</span><span class="p">(</span><span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span><span class="nx">IP</span><span class="p">:</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IPv4zero</span><span class="p">,</span> <span class="nx">Port</span><span class="p">:</span> <span class="mi">9981</span><span class="p">})</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="k">return</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;本地地址: &lt;%s&gt; \n&quot;</span><span class="p">,</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">LocalAddr</span><span class="p">().</span><span class="nx">String</span><span class="p">())</span>
</span><span class="line">	<span class="nx">peers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="line">	<span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span class="line">	<span class="k">for</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">n</span><span class="p">,</span> <span class="nx">remoteAddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">ReadFromUDP</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;error during read: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;&lt;%s&gt; %s\n&quot;</span><span class="p">,</span> <span class="nx">remoteAddr</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span><span class="line">		<span class="nx">peers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">peers</span><span class="p">,</span> <span class="o">*</span><span class="nx">remoteAddr</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">peers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;进行UDP打洞,建立 %s &lt;--&gt; %s 的连接\n&quot;</span><span class="p">,</span> <span class="nx">peers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">peers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">String</span><span class="p">())</span>
</span><span class="line">			<span class="nx">listener</span><span class="p">.</span><span class="nx">WriteToUDP</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">peers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">String</span><span class="p">()),</span> <span class="o">&amp;</span><span class="nx">peers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class="line">			<span class="nx">listener</span><span class="p">.</span><span class="nx">WriteToUDP</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">peers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">String</span><span class="p">()),</span> <span class="o">&amp;</span><span class="nx">peers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class="line">			<span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;中转服务器退出,仍不影响peers间通信&quot;</span><span class="p">)</span>
</span><span class="line">			<span class="k">return</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>另外两台分别位于不同内网后的设备,均运行相同代码peer.go:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>peer.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;log&quot;</span>
</span><span class="line">	<span class="s">&quot;net&quot;</span>
</span><span class="line">	<span class="s">&quot;os&quot;</span>
</span><span class="line">	<span class="s">&quot;strconv&quot;</span>
</span><span class="line">	<span class="s">&quot;strings&quot;</span>
</span><span class="line">	<span class="s">&quot;time&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">tag</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line"><span class="kd">const</span> <span class="nx">HAND_SHAKE_MSG</span> <span class="p">=</span> <span class="s">&quot;我是打洞消息&quot;</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="c1">// 当前进程标记字符串,便于显示</span>
</span><span class="line">	<span class="nx">tag</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">	<span class="nx">srcAddr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span><span class="nx">IP</span><span class="p">:</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IPv4zero</span><span class="p">,</span> <span class="nx">Port</span><span class="p">:</span> <span class="mi">9982</span><span class="p">}</span> <span class="c1">// 注意端口必须固定</span>
</span><span class="line">	<span class="nx">dstAddr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span><span class="nx">IP</span><span class="p">:</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ParseIP</span><span class="p">(</span><span class="s">&quot;207.148.70.129&quot;</span><span class="p">),</span> <span class="nx">Port</span><span class="p">:</span> <span class="mi">9981</span><span class="p">}</span>
</span><span class="line">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">DialUDP</span><span class="p">(</span><span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="nx">srcAddr</span><span class="p">,</span> <span class="nx">dstAddr</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;hello, I&#39;m new peer:&quot;</span> <span class="o">+</span> <span class="nx">tag</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span class="line">	<span class="nx">n</span><span class="p">,</span> <span class="nx">remoteAddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">ReadFromUDP</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;error during read: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">	<span class="nx">anotherPeer</span> <span class="o">:=</span> <span class="nx">parseAddr</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">]))</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;local:%s server:%s another:%s\n&quot;</span><span class="p">,</span> <span class="nx">srcAddr</span><span class="p">,</span> <span class="nx">remoteAddr</span><span class="p">,</span> <span class="nx">anotherPeer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</span><span class="line">
</span><span class="line">	<span class="c1">// 开始打洞</span>
</span><span class="line">	<span class="nx">bidirectionHole</span><span class="p">(</span><span class="nx">srcAddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anotherPeer</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">parseAddr</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="nx">port</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span>
</span><span class="line">		<span class="nx">IP</span><span class="p">:</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">ParseIP</span><span class="p">(</span><span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class="line">		<span class="nx">Port</span><span class="p">:</span> <span class="nx">port</span><span class="p">,</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">bidirectionHole</span><span class="p">(</span><span class="nx">srcAddr</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">,</span> <span class="nx">anotherAddr</span> <span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">DialUDP</span><span class="p">(</span><span class="s">&quot;udp&quot;</span><span class="p">,</span> <span class="nx">srcAddr</span><span class="p">,</span> <span class="nx">anotherAddr</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">	<span class="c1">// 向另一个peer发送一条udp消息(对方peer的nat设备会丢弃该消息,非法来源),用意是在自身的nat设备打开一条可进入的通道,这样对方peer就可以发过来udp消息</span>
</span><span class="line">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">HAND_SHAKE_MSG</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;send handshake:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">		<span class="k">for</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span class="line">			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;from [&quot;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">				<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;send msg fail&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">			<span class="p">}</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}()</span>
</span><span class="line">	<span class="k">for</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span class="line">		<span class="nx">n</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">ReadFromUDP</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;error during read: %s\n&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;收到数据:%s\n&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>注意代码仅模拟打洞基础流程,如果读者测试网络情况较差发生udp丢包,可能看不到预期结果,此时简单重启server,peer即可.</p>

<p>完整代码参考<a href="https://github.com/qjpcpu/p2pbyudp">github</a></p>

<h1 id="udptcp">udp打洞转tcp通信</h1>

<p>通常,由于udp打洞实现简单,p2p的实现采用udp打洞较多,然而当通路建立起来后使用tcp进行节点间通信可以获取更好的通信效果。因为udp打洞完成后形成的nat映射是和tcp/udp无关的,所以此时可以转为使用tcp建立连接,达到最终的p2p的tcp通信.由于代码较简单,这里就不给出示例了。</p>

<h1 id="section-4">参考文献</h1>

<ul>
  <li><a href="https://yq.aliyun.com/articles/227421">UDP用打洞技术穿透NAT的原理与实现</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/26796476">P2P通信原理与实现</a></li>
  <li><a href="https://github.com/jtriley/pystun">NAT类型检测工具</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[浅谈元编程]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2017/08/02/qian-tan-yuan-bian-cheng/"/>
    <updated>2017-08-02T17:54:41+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2017/08/02/qian-tan-yuan-bian-cheng</id>
    <content type="html"><![CDATA[<p>为什么会突然想到写这篇文章呢？其实是因为我曾经向一位朋友推荐学习一下ruby/lisp这类支持元编程的语言,尽管可能永远不会在生产环境中用到,但是可以让人学习用另一种思路思考问题,然后友人就要求我解释我学了之后思考问题的角度有何不同,当时确实把我难住了,因为这个问题的确不好描述。</p>

<p>对于这个问题,我思前想后好几周后,我还是决定从理性和感性两个方面,稍微描述一下,什么是元编程?学习了元编程之后你的思考到底可能在什么地方和别人产生差异?</p>

<p>P.S. 鉴于ruby在元编程领域的强大能力,本文将用ruby来辅助我的描述,即便是没有ruby基础,我也会尽量描述清楚不影响理解;至于为什么不用lisp,那是因为它在这行当走得太彻底了,彻底到我觉得自己现阶段没有能力描述清楚
<!-- more --></p>

<h2 id="section">结论放在前面</h2>
<p>虽然我将要尝试向你描述下元编程,但还是有几条规则要写在前面,如果你觉得无法接受这几条规则,那么提早关闭页面比较明智。</p>

<h5 id="section-1">1. 心态放谦卑,无论何时,先尝试去理解而不是拒绝</h5>
<p>##### 2. 元编程并不是黑魔法, 元编程也是编程
##### 3. 和学习游泳一样,如果不亲身去尝试,永远也无法真正理解
##### 4. 即便你花时间精力取弄懂了一两门元编程语言,但你的工作环境可能永远都用不到,冷静两秒钟,确认自己并不是那么功利主义
##### 5. 再次深呼吸,确认自己还是有兴趣了解下去</p>

<h2 id="section-2">元编程的魔力</h2>
<p>元编程的学院解释是:运行时操作程序构件的能力。这个类似于物理公理定义的说法比较令人费解,其实他的意思是这样的,通常,我们的程序写完进行编译链接后,它的运行规则就固定了,很难在运行时再去做任何修改。比如对于C语言来说,一个方法或者函数要执行的逻辑已经固定下来了,无法在不改动代码的情况下修改这个方法的逻辑;或者对于java这种语言也是一样的,一个类拥有的方法和属性是固定的,虽然java拥有了反射的能力(这可以看做已经具备了初步元编程能力),可以在运行时进行自省,但是也无法进一步拓展自身的逻辑和功能。可以看出,这些编程语言里,”程序逻辑”和”数据”是完全分割开来的,数据可以修改变动,而逻辑是冰冷凝固的,它们之间泾渭分明,区分十分明显。 而所谓元编程,就是抹除这种界限的能力。</p>

<h3 id="section-3">改变宇宙公理</h3>
<p>假设我们所处的世界真的是被AI控制,整个人类文明作为一枚电池被<code>Matrix</code>控制(电影《黑客帝国》),而AI构建的<code>Matrix</code>系统也的确是基于人类的数学公理构建起来的,而我们最基础的数学公理不外乎就是<code>1 + 1 = 2</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">puts</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># =&gt; 显而易见输出2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>假如AI的上帝<code>建筑师</code>某一天想更改这个系统升级为<code>Matruix2</code>,这次升级仅仅是想看看更改最简单的宇宙公理让<code>1 + 1 = 3</code>,他想看看这会对人类社会造成什么影响;试想如果<code>建筑师</code>不懂得元编程的能力,那么意味着<code>Matrix2</code>是一次彻底的重构:他必须重建所有数学公理,并且基于这些公理重新构建<code>Matrix</code>,这个工作量想想都觉得可怕。</p>

<p>那如果<code>建筑师</code>懂得元编程,他要做的事情就是给<code>Matrix</code>打个系统补丁,补丁文件内容只有简单几行代码:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Patch</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">+</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span><span class="o">.</span><span class="n">succ</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="no">Fixnum</span><span class="o">.</span><span class="n">prepend</span> <span class="no">Patch</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>这段代码的含义是对所有整数加法添加了一个补丁,每个加法运算都多加1,所以基于加法的公理均自动采纳这项变更。</p>

<p>当<code>Matrix</code>应用这个补丁后,所有系统中加法都会多加1</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">puts</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="c1"># =&gt; 输出为6</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这就是元编程,你可以运用他修改程序逻辑,漆黑的运行时在你面前变得明朗起来了。</p>

<h3 id="section-4">调用链</h3>
<p>如果你觉得改变宇宙公理这个场景太过虚幻,并且你碰巧也没看过黑客帝国(oops,真是不幸,在学习各种编程技巧前我建议您真应该去看下这部电影),那么你肯定会质疑:好像我永远遇不到元编程的应用场景。那么好吧,我来举一个真实世界可能真会遇到的场景:</p>

<p>在当前分布式系统大行其道的今天,可能我们需要将系统每个函数调用时间记录下来,即<code>函数A--&gt;函数B--&gt;函数C--&gt;函数n</code>我们想在每个函数入口和出口打点,这样我们就能够将这个调用栈串联起来</p>

<p>假设说我们的原系统是这样的:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Hello </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="nb">self</span><span class="o">.</span><span class="n">talk</span> <span class="n">to</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">talk</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Talk to </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">hello</span> <span class="s2">&quot;jason&quot;</span>
</span><span class="line"><span class="c1"># 输出为:</span>
</span><span class="line"><span class="c1"># Hello jason</span>
</span><span class="line"><span class="c1"># Talk to jason</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>很简单,我们也可以利用元编程的技术,用打点进出逻辑将所有函数包裹起来即可,也打这么一个补丁:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class="line">  <span class="nb">self</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">mtd</span><span class="o">|</span>
</span><span class="line">   <span class="n">alias_method</span> <span class="s2">&quot;old_</span><span class="si">#{</span><span class="n">mtd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">mtd</span>
</span><span class="line">   <span class="n">define_method</span> <span class="n">mtd</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class="line">     <span class="nb">puts</span> <span class="s2">&quot;==========Enter </span><span class="si">#{</span><span class="n">mtd</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">==========&quot;</span>
</span><span class="line">     <span class="nb">send</span> <span class="s2">&quot;old_</span><span class="si">#{</span><span class="n">mtd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span>
</span><span class="line">     <span class="nb">puts</span> <span class="s2">&quot;==========Leave </span><span class="si">#{</span><span class="n">mtd</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">==========&quot;</span>
</span><span class="line">   <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>再次运行原程序,输出则变成:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">==========</span><span class="no">Enter</span> <span class="n">hello</span><span class="err">@</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0800</span><span class="o">==========</span>
</span><span class="line"><span class="no">Hello</span> <span class="n">jason</span>
</span><span class="line"><span class="o">==========</span><span class="no">Enter</span> <span class="n">talk</span><span class="err">@</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0800</span><span class="o">==========</span>
</span><span class="line"><span class="no">Talk</span> <span class="n">to</span> <span class="n">jason</span>
</span><span class="line"><span class="o">==========</span><span class="no">Leave</span> <span class="n">talk</span><span class="err">@</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0800</span><span class="o">==========</span>
</span><span class="line"><span class="o">==========</span><span class="no">Leave</span> <span class="n">hello</span><span class="err">@</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">02</span> <span class="mi">23</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0800</span><span class="o">==========</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>毫无疑问,不借助元编程的能力,也有各种解决这个问题的办法,但是如果你懂得这项技术,那么你会发现问题可以被解决得如此优雅,不用侵入到原代码的任何逻辑,就可以修改代码逻辑。试想下如果你想修改的逻辑是第三方库的代码, 而你甚至没有他们的源码,此时如果没有元编程的能力,是很难做出逻辑调整的。</p>

<h2 id="section-5">元编程改变了什么</h2>
<p>回到感性的部分,为什么向没有接触过元编程的人那么难以解释这个概念呢?其实正是因为这个概念本身就处于受众知识网络之外,所以当试图使用类比推导来描述时很容易使得这个概念越发让人迷惑。</p>

<p>那么了解这个概念之后,它到底改变了我什么思考角度呢?其实是看问题不再那么理所当然,面临一个问题时亦或者是已经拿到解决方案了,还会反向质疑自己,是否存在一种可能性,这种可能性甚至是超越自身知识范畴的,或者是和自己思维习惯相悖离的,而这种可能性很可能就是更优雅的解决方案。</p>

<p>除了思考的角度,对编码工作本身有什么实质性的作用吗?很遗憾,可能并没有。生产环境中的C,java,golang等等开发,很难用到这项技术,甚至于即便你处在某个非常极客的公司,使用了ruby/lisp作为生产语言,泛滥使用元编程也会直接导致项目的不可维护,导致最终项目leader将元编程作为禁术封印起来。但这些都不应该成为阻碍你了解它的理由,拓宽自身的视野,这更重要。</p>

<h2 id="section-6">写在最后</h2>
<p>最后,我还是以元编程界一个禅语论道结束吧:</p>

<p>编程弟子在跟随元编程大师一年后,终于掌握了所有的元编程能力。秋意微凉,师徒二人于树下盘坐,弟子回想所学,愈发迷惑,问道: 师傅, 我还是不明白,到底什么是元编程?</p>

<p>树上飘落最后一片秋叶,老禅师睁开眼,轻声一叹:孩子,这世上哪有什么元编程,就是编程啊。</p>

<p>弟子顿悟,乃成…</p>

<p>P.S. 你真的不觉得人工智能的基础之一就是元编程吗? 机器学习总结规律,元编程再将这些规律内化,自身改变自身逻辑,这不就是AI进化的基础吗。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[http原理]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2016/03/15/httpyuan-li/"/>
    <updated>2016-03-15T14:10:51+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2016/03/15/httpyuan-li</id>
    <content type="html"><![CDATA[<p>Go语言中处理http请求主要涉及两个对象: <a href="https://golang.org/pkg/net/http/#ServeMux">ServeMux</a>和<a href="https://golang.org/pkg/net/http/#Handler">http.Handler接口</a>。</p>

<p>ServeMux即http请求路由，将http请求分发到注册的对应路由处理方法中。http.Handler及http的路由处理接口，该接口实际上仅包含一个方法<strong>ServeHTTP</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>src/net/http/server.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!-- more -->

<h3 id="section">基本原理</h3>

<p>下面我们创建一个简单的HTTP服务，该服务仅返回一个文本页面:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;net/http&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">TextHandler</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">word</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">th</span> <span class="o">*</span><span class="nx">TextHandler</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;I wanna say: &quot;</span> <span class="o">+</span> <span class="nx">th</span><span class="p">.</span><span class="nx">word</span><span class="p">))</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class="line">	<span class="nx">th</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">TextHandler</span><span class="p">{</span><span class="nx">word</span><span class="p">:</span> <span class="s">&quot;cool&quot;</span><span class="p">}</span>
</span><span class="line">	<span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">th</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Server started...&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>访问<a href="http://localhost:3000">http://localhost:3000</a>，页面返回<code>I wanna say: cool</code>。</p>

<p><code>http.NewServeMux</code>创建出新的路由容器，<code>http.NewServeMux#Handle</code>方法将路由及其处理函数注册到路由容器，ServeMux内部包含一个map结构，用来存取http URL对应的处理器。</p>

<p>而<code>http.ListenAndServe</code>需要指定服务监听地址和一个Handler对象，及方法签名如下:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>src/net/http/server.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="kt">error</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>而ServeMux对象其实也定义了一个ServeHTTP的对象方法，所以ServeMux is a Handler，能够传入ListenAndServe方法启动服务。</p>

<p><strong>综上，使用ServeMux组装路由,再将它作为一个Handler交给http启动服务。当服务接收到一个http请求后，就根据路由中配置的规则选择对应的handler进行处理，实际的处理逻辑则由该handler的ServeHTTP方法实现。</strong></p>

<blockquote>
  <p>路由分发的逻辑具体实现可以查看<a href="https://golang.org/src/net/http/server.go">http包源码</a></p>
</blockquote>

<h3 id="section-1">标准用法</h3>

<h4 id="section-2">1.简化代码</h4>

<p>基本原理中的例子足以展示出golang的http处理原理，由于自定义的handler均必须实现http.Handler接口,这样会导致多余声明代码的产生。所以http包提供了一个帮助方法<code>http.HandlerFunc</code>将方法参数和<code>ServeHTTP</code>相同的方法转换为<code>http.Handler</code>。 </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;net/http&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">saySomething</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">word</span> <span class="o">:=</span> <span class="s">&quot;cool&quot;</span>
</span><span class="line">	<span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;I wanna say: &quot;</span> <span class="o">+</span> <span class="nx">word</span><span class="p">))</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class="line">	<span class="nx">th</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">saySomething</span><span class="p">)</span>
</span><span class="line">	<span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">th</span><span class="p">)</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Server started...&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>实际上，<code>http.HandlerFunc</code>不是一个方法调用，仅仅是一个类型转换。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>源码src/net/http/server.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span>
</span><span class="line"><span class="c1">// ServeHTTP calls f(w, r).</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">f</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>所以，自定义的请求处理函数(<code>saySomething</code>)仅需要保持参数定义和<code>http.Handler</code>接口相同即可，将该自定义函数做类型转换为<code>HandlerFunc</code>即可。另外，由源码可以看出，函数类型<code>HandlerFunc</code>同时也实现了<code>http.Handler</code>，所以能够注册到<code>ServeMux</code>中。</p>

<h4 id="section-3">2.保持封装</h4>

<p>代码看起来缺失简单了一些，然而这样却破坏了逻辑的封装性：<code>saySomething</code>中包含了硬编码的参数<code>word</code>。这可以使用闭包来解决:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;net/http&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">saySomething</span><span class="p">(</span><span class="nx">word</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 闭包装入变量word</span>
</span><span class="line">	<span class="nx">f</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;I wanna say: &quot;</span> <span class="o">+</span> <span class="nx">word</span><span class="p">))</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
</span><span class="line">	<span class="nx">th</span> <span class="o">:=</span> <span class="nx">saySomething</span><span class="p">(</span><span class="s">&quot;cool&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">th</span><span class="p">)</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Server started...&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>http服务中出现了很多名称，命名比较相近，这里汇总解释下:</strong></p>

<ul>
  <li><strong>ServeMux</strong>，路由容器，http服务中的路由规则统一在这里定义，启动服务后路由的分发自然也由其处理</li>
  <li><strong>http.Handler</strong>,请求处理器，每个处理http请求的处理器均需要实现该接口<code>ServeHTTP</code></li>
  <li><strong>http.HandlerFunc</strong>,帮助”方法”(实际是一个函数类型声明),将参数和<code>ServeHTTP</code>相同的普通函数转换为一个<code>http.Handler</code></li>
</ul>

<h3 id="http">http中间件</h3>

<p>golang中http处理流程是这样的:</p>

<pre><code>ServeMux ==&gt;  Middleware Handler ==&gt; Application Handler
</code></pre>

<p><strong>中间件</strong>:</p>

<ul>
  <li>中间件也是一个http.Handler，所以必须实现<code>ServeHTTP</code></li>
  <li>构建完整的中间件调用链，保证覆盖上图的中间件调用关系，并作为handler注册到<code>http.ServeMux</code></li>
</ul>

<p>一个中间件示例:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">exampleMiddleware</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// 中间件逻辑在这里实现</span>
</span><span class="line">    <span class="nx">next</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由这个中间件定义可以看出中间件链的构建方式: 函数嵌套。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">middlewareOne</span><span class="p">(</span><span class="nx">middlewareTwo</span><span class="p">(</span><span class="nx">finalHandler</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>看一个实际的例子:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="s">&quot;log&quot;</span>
</span><span class="line">  <span class="s">&quot;net/http&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">middlewareOne</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Executing middlewareOne&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="nx">next</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Executing middlewareOne again&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">middlewareTwo</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Executing middlewareTwo&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="o">!=</span> <span class="s">&quot;/&quot;</span> <span class="p">{</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">next</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Executing middlewareTwo again&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">final</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Executing finalHandler&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;OK&quot;</span><span class="p">))</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">finalHandler</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">final</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">middlewareOne</span><span class="p">(</span><span class="nx">middlewareTwo</span><span class="p">(</span><span class="nx">finalHandler</span><span class="p">)))</span>
</span><span class="line">  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>访问<a href="http://localhost:3000">http://localhost:3000</a>可以从日志看出中间件调用顺序:</p>

<pre><code>$ go run main.go
2014/10/13 20:27:36 Executing middlewareOne
2014/10/13 20:27:36 Executing middlewareTwo
2014/10/13 20:27:36 Executing finalHandler
2014/10/13 20:27:36 Executing middlewareTwo again
2014/10/13 20:27:36 Executing middlewareOne again
</code></pre>

<h4 id="section-4">中间件链构造方式</h4>

<p>上面例子的中间件链是比较常见的构造方式，然而多少有些可怕。而<a href="https://github.com/justinas/alice">Alice</a>将中间件链的构造简化了许多:</p>

<pre><code>Middleware1(Middleware2(Middleware3(App)))
</code></pre>

<p>转化为</p>

<pre><code>alice.New(Middleware1, Middleware2, Middleware3).Then(AppHandler)
// or 
alice.New(Middleware1, Middleware2, Middleware3).ThenFunc(AppFunc)
</code></pre>

<h3 id="section-5">参考文献</h3>

<p>文中主要内容来自参考文献第一、二条</p>

<ul>
  <li><a href="http://www.alexedwards.net/blog/a-recap-of-request-handling">A Recap of Request Handling in Go</a></li>
  <li><a href="http://www.alexedwards.net/blog/making-and-using-middleware">Making and Using HTTP Middleware</a></li>
  <li><a href="https://golang.org/src/net/http/server.go">net/http</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[task tracer -- 实时任务追踪系统]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2016/02/18/task-tracer/"/>
    <updated>2016-02-18T14:43:27+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2016/02/18/task-tracer</id>
    <content type="html"><![CDATA[<h2 id="section">产生背景</h2>

<p><strong>Task Tracer(以下简称tt)</strong>的产生原因其实是为了解决一个用户体验的缺憾。由于在生产环境中，我们一直使用salt-stack作为任务的发布和执行机构，然而salt使用的Pub/Sub这种模式下有一个遗留缺陷: 就是任务一旦发出，直到它执行结束退出，任务的发起者无法知道任务当前的执行状态,唯一能做的仅仅能够判断该任务是否在running,而不能实时获取其进程输出；其次，当该salt任务执行完成后，需要独立获取其任务标准输出和进程退出状态(exit code)，无法一次性获取其输出和退出状态。salt社区也意识到这个问题，在逐步开发VT模块以求解决，不过这个特性截止到目前仍在实验阶段。</p>

<p>所以，为了消除salt任务执行阶段的黑洞焦虑，我决定开发tt。 虽然tt是为了解决salt的一个问题，但在开发时，我决定将其和salt分离开来，使得tt其实是能够解决这样一类问题: <strong>如果需要实时获取命令执行输出，就可以将命令包裹到tt中执行,从而利用tt Server实时获取其执行输出及结果</strong></p>

<!-- more -->

<p><img src="https://raw.githubusercontent.com/qjpcpu/task-tracer-server/master/snapshots/tt-preview.png" alt="tt preview" /></p>

<h2 id="section-1">工作原理</h2>

<p>tt其实是一个shell命令包裹器，它将要执行的命令以子进程的方式执行起来，实时地将该子进程的输出发送到tt Server，这样用户(api client)就能够从tt Server实时读取到该进程的输出；使用到的技术其实也很简单，就是nodejs+socket.io。
<img src="https://raw.githubusercontent.com/qjpcpu/task-tracer-server/master/snapshots/data-flow.png" alt="tt" /></p>

<p>从这张原理图可以看到，tt的数据流是单向的，也就是说这里的任务发起需要第三方来做，比如salt-stack甚至手动的shell登录后发起。当任务发起后，tt client会吐出一个输出结果查看的url，使用你的浏览器访问该url就可以实时查看任务的输出，另外，相同任务名下执行的所有tt client都会将输出发布出来，均可以查看。</p>

<p>另外，tt是一个实时输出查看跟踪系统，所以不会持久化任务的输出。</p>

<h2 id="try-our-live-demo">Try our live demo</h2>

<h3 id="section-2">1. 配置客户端</h3>

<p>根据你的系统类型(osx/linux)下载客户端可执行文件tt</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line"># for osx
</span><span class="line">wget https://raw.githubusercontent.com/qjpcpu/task-tracer-client/master/dist/tt.darwin -O tt
</span><span class="line"># for linux
</span><span class="line">wget https://raw.githubusercontent.com/qjpcpu/task-tracer-client/master/dist/tt.linux -O tt</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>客户端会读取配置文件<code>$HOME/.tt.conf</code>，将其内容配置为:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">id = natasha
</span><span class="line">token = eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0eXBlIjoiY2xpZW50X3Rva2VuIiwibnMiOiJ0ZXN0IiwiaWF0IjoxNDU1NzgwNDU0LCJleHAiOjE0ODczMzgwNTR9.hk96PzocFTSGogl1evyWa4UGjDpQ4nAWppIMCl6lnlo
</span><span class="line">url = http://tt.single-bit.org</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>同样的方法再配置一台客户端，注意其配置文件中id和另一台不同（可以根据需要配置任意多台客户端,注意其配置文件中id需要各不相同）。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">id = tanya
</span><span class="line">token = eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0eXBlIjoiY2xpZW50X3Rva2VuIiwibnMiOiJ0ZXN0IiwiaWF0IjoxNDU1NzgwNDU0LCJleHAiOjE0ODczMzgwNTR9.hk96PzocFTSGogl1evyWa4UGjDpQ4nAWppIMCl6lnlo
</span><span class="line">url = http://tt.single-bit.org</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">2. 访问任务追踪页面</h3>

<p>打开浏览器访问<a href="http://tt.single-bit.org/?accessToken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0eXBlIjoiYnJvd3Nlcl90b2tlbiIsIm5zIjoidGVzdCIsImlhdCI6MTQ1NTc4MDQ1NCwiZXhwIjoxNDg3MzM4MDU0fQ.AuhXIVNxk5LYoamU2ziSBqvn0tEqyrszAvsCom3OmgI">tt Server live demo</a></p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/task-tracer-server/master/snapshots/live-demo-index.png" alt="live demo index page" /></p>

<p>填入我们需要追踪的任务名称，如: <strong>demo</strong>并确定，进入到任务监听状态。</p>

<h3 id="section-4">3. 执行任务</h3>

<p>在配置好的两台客户端上同时执行命令:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">tt -n demo 'echo "from `head -1 ~/.tt.conf`";sleep 2;echo "sleep for a while";sleep 5;echo done'</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在浏览器上可以看到实时输出: 在<code>tanya</code>和<code>natasha</code>分别输出各自的id，然后等待一会儿后进程执行结束.</p>

<p><img src="https://raw.githubusercontent.com/qjpcpu/task-tracer-server/master/snapshots/live-demo-output.png" alt="live demo output page" /></p>

<p>你也可以在执行过程中在某个客户端上执行<code>kill</code>命令或<code>Ctrl+C</code>终止进程，并查看浏览器实时反馈的结果。</p>

<h2 id="as-a-sevice----tt-server">As a sevice – 搭建自己的tt Server</h2>

<p>如果tt仅仅是作为一个web页面查看机器上的进程输出，那其实也没多大存在意义，关键是对于一个devops来说，它需要能够比较容易地嵌入你的系统工具里。</p>

<h3 id="section-5">1. 系统接口</h3>

<p>ttServer对外提供了若干<a href="http://socket.io/">socket.io</a>事件接口，基于你的需求，可以非常容易地接入到你自己的系统中，这样一来，怎样在UI上展示就完全取决于自己的实现。至于socket.io也有很多语言已经实现了该规范，所以使用起来应该也很简单。</p>

<p>详细接口定义及实现方式请查看<a href="https://github.com/qjpcpu/task-tracer-server">tt Server github文档</a></p>

<h3 id="section-6">2. 客户端安装配置</h3>

<p>tt的客户端安装配置非常简单，仅仅包含一个可执行文件tt和一份简单的ini格式的配置文件,令人愉悦的是该客户端没有环境依赖，不需要安装node等执行环境。</p>

<p>如果下载的二进制文件无法执行，请从源码编译。</p>

<p>具体的客户端安装配置可以查看<a href="https://github.com/qjpcpu/task-tracer-client">tt Client github文档</a></p>

<h2 id="logio">相关系统: log.io</h2>

<p><a href="http://logio.org/">log.io</a>是一个实时日志监控系统，其系统架构和实现方式都和tt非常相似。不过其应用场景是实时的日志采集监控，另外，logio的客户端有node环境依赖，个人觉得有点部署不完美。</p>

<p><img src="http://logio.org/screenshot3.png" alt="log.io" /></p>

<h2 id="github">附录: github地址</h2>

<p><a href="https://github.com/qjpcpu/task-tracer-server">tt Server</a></p>

<p><a href="https://github.com/qjpcpu/task-tracer-client">tt Client</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[gulp js的构建工具]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/09/16/gulp-nodejs-cool-makefile/"/>
    <updated>2015-09-16T21:56:17+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/09/16/gulp-nodejs-cool-makefile</id>
    <content type="html"><![CDATA[<h3 id="section">0. 简介</h3>
<p>gulp是javascript世界的构建工具，它并不是js世界第一个构建工具，但由于它小而快的特点，一出现就快速赶超它的前辈grunt，在npm的下载榜上一直高居前列。</p>

<!-- more -->
<p><img src="https://raw.githubusercontent.com/gulpjs/artwork/master/gulp-2x.png" alt="gulp logo" /></p>

<h3 id="gulp">1. gulp的特性</h3>
<p><strong><code>小</code></strong></p>

<p>gulp的第一个特点应该是小，不仅仅是源码小，更重要的是gulp编写的出的构建代码非常短小明了。这是因为gulp基本上完全是基于流式的构建处理，可以理解为由源码文件流经过一系列的中间加工处理直接将结果灌入到输出文件，没有了中间的临时文件读写，自然就减少了处理代码，出来的构建workflow同样也就十分清理简捷。</p>

<p>gulp构建流程的小固然有使用了流式处理的原因，但更重要的一种设计思路的不同。这里我想聊一下工程上的设计理念，通常我们设计程序的时候，遵守<code>配置优于代码</code>的原则。就是说，一些程序依赖的外置参数，尽量不要硬编码进代码文件里，而是将这些参数放在配置文件中。遵循这条原则可以极大增加工程的可维护性，比如java语言的某些著名框架就严格践行了这条原则，所以工程中就可能出现描述工程信息的各种xml配置文件。然后很多时候宣扬这条规律的书籍都没有将他的缺点，虽然缺点和优点相比有点微不足道，那就是一旦大量抽离程序的配置参数，将导致配置的碎片化，反面教材仍然是java框架里的xml配置泛滥。</p>

<p>所以后来的编程框架如rails开始强调<code>约定优于配置</code>的概念，就是如果大家经验约定这样做(放置配置的方式，命名的方式，搜索的方式等），那么程序工程里就不必显式声明这些规则，即不必要用一大堆配置文件去描述我们大家都约定遵守的东西。这样出来的结果工程上非常干净同时也满足了约定内高维护性。</p>

<p>那么在这里为什么要说这个呢，因为grunt其实可以说是一个基于<code>配置优于代码</code>的构建工具，而且很多其他编程语言的构建工具都是基于这个理念的。这类构建工具在执行大工程的构建时，配置的碎片化非常严重，为了描述构建需要在构建代码里编写大量的元信息片段，甚至于需要分立诸多构建小文件来描述子构建单元，那么维护构建流程本身也变成一件令人头疼的事情。</p>

<p>而gulp可以说某种程度上的回归，将更多的东西又返回到了原始的地方——-代码。gulp的构建文件里配置信息非常少，一个构建task包含的所有信息都在这个task里，你不需要跳到其他文件里查阅这个task的配置信息。是的，程序员喜欢代码，把构建所有的东西都在task这块代码里完成，这样的构建流程自然就很清晰了。所以，gulp非常适合中小型程序的构建，我私自揣度这也是gulp快速流行起来的原因。</p>

<p><strong><code>快</code></strong></p>

<p>gulp的快主要是因为它的核心是<code>流</code>,从源文件的读取到构建结束，整个加工过程都在内存流里完成，上一道工序和下一道加工工序间完全是流与流之间的管道连接，类似shell管道命令的流式操作，免去了大量中间文件的读写，少了文件io，自然快了很多。不过我并没有专门对这个做过benchmark，直观的感受是我重构某个包含数百个coffee文件的构建流程时，从grunt迁移为gulp后整个构建流程节省了大概一半的时间。</p>

<p><strong><code>简单</code></strong></p>

<p>在阅读了gulp的一些资料后，我本来打算花一个下午的时间来学习的，结果10分钟左右就读完了gulp的文档，因为它实在太简单了，总共只有<strong>4个</strong>API.</p>

<h3 id="gulp-1">2. gulp入门</h3>

<p>对于gulp的基础，我不打算在这里讲，因为它的<a href="https://github.com/gulpjs/gulp/tree/master/docs">官方文档</a>非常简单易读，如果想读中文，这里也有<a href="https://github.com/lisposter/gulp-docs-zh-cn">gulp中文文档</a>。花个10分钟读一下，你就可以向身边的小伙伴炫耀： Hi，让我给你展示下一种很cool的构建工具。</p>

<h3 id="gulp-2">3. gulp流</h3>

<p><code>流</code>是gulp重中之重的概念，理解了流才可以玩转gulp。可以看下<a href="https://github.com/substack/stream-handbook">nodejs流</a>深入理解下nodejs流的概念。这里仅简单介绍下gulp中广泛使用的<code>pipe()</code>函数。</p>

<p><code>src.pipe(dest)</code>函数是nodejs的流的一个函数，它的作用非常简单，就是将流进行管道连接，将src可读流和dest可写流连接起来，使得数据从src流入dest。</p>

<p>同时<code>src.pipe(dest)</code>的返回对象也是<code>dest</code>，所以在nodejs很容易看到这种链式编程风格。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">a</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">b</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这段代码等价于</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">a</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span><span class="line"><span class="nx">b</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span><span class="line"><span class="nx">c</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个操作和shell编程的管道非常相似: <code>a | b | c | d</code></p>

<h3 id="gulp-3">4. gulp任务的编写准则</h3>

<p>gulp的核心是流，构建单元是一个个<code>task</code>，那么编写这些task的时候需要注意什么呢？</p>

<p>gulp的task做到了最大限度的并发，那么这些task间的同步就成了问题，怎么样判断一个task完成了以便于可以安全执行另一个依赖task呢,为了正确调度任务，gulp的task设计有三个原则:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="mi">1</span><span class="p">.</span> <span class="err">在任务定义的</span><span class="kd">function</span><span class="err">中返回一个数据流，当该数据流的</span><span class="nx">end</span><span class="err">事件触发时，任务结束</span>
</span><span class="line"><span class="mi">2</span><span class="p">.</span> <span class="err">在任务定义的</span><span class="kd">function</span><span class="err">中返回一个</span><span class="nx">promise</span><span class="err">对象，当该</span><span class="nx">promise</span><span class="err">对象</span><span class="nx">resolve</span><span class="err">时，任务结束</span>
</span><span class="line"><span class="mi">3</span><span class="p">.</span> <span class="err">在任务定义的</span><span class="kd">function</span><span class="err">中传入</span><span class="nx">callback</span><span class="err">变量，当</span><span class="nx">callback</span><span class="p">()</span><span class="err">执行时，任务结束</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当发现task没有按预期执行时，就需要仔细检查是否每个task都遵循了这3条规则。</p>

<p>此外，当需要写出一些高阶的gulp玩法时，不理解并执行这几条规则，就很难办到。另外，可以思考个额外的问题，为什么gulp的task需要有这三条规则? 根据这3条规则，是否都可以猜测出gulp的实现机制呢?</p>

<p>在这里我顺便申明我对学习新东西的一个观点，就是<code>seize the key</code>，学习一种新东西就要理解她的核心。有的人秉持一种观念是说，语言只是工具，学习了一种其他都差不多，当有切换需求要学习新语言or新工具，就草草将以前的经验套上去，完成任务后还以为学会了新语言。所以有时候会看到一些四不像的代码，比如长得像shell的ruby代码，长得像java的python代码，一脸C长相的golang…</p>

<p>那么，怎样一学习新东西就能抓住其核心呢，很简单，多想想<code>why</code>。实际操作起来就几点经验：</p>

<ul>
  <li>如果有作者对这个语言/工具的创作初衷的相关文章，一定要看！</li>
  <li>看这个新东西是为了解决什么问题</li>
  <li>这个语言解决的是什么问题，更重要的是解决的思路或方式是什么！</li>
  <li>如果涉及新的概念或思路，一定要看足够多的文档直到理解这个概念</li>
  <li>如果学习的是新语言，必须<strong>理解</strong>这个语言的<strong>key feature</strong>，了解语言的生态圈，语言的编码规范、构建工具、测试工具、包管理工具，该语言里著名的库/框架，这些框架的设计理念，如果有余力可以看下这些库/框架的源码，告诉自己用这种语言写出的代码也应该是这个水平</li>
</ul>

<p>比如对于gulp:</p>

<ul>
  <li><strong>创作初衷</strong>: 看文档FAQ,作者twitter</li>
  <li><strong>需要解决的问题</strong>: grunt复杂庞大的插件配置</li>
  <li><strong>解决思路</strong>: nodejs流式处理=&gt;什么是nodejs流=&gt;解决什么问题，带来什么问题</li>
</ul>

<p>方方面面的东西了解了之后，你就能真正把控你的新玩意儿，有时候你甚至能预测这个语言或工具的未来动向。</p>

<h3 id="gulp-4">5. 常用gulp插件</h3>

<p>关于gulp的插件，需要的时候去github上找一下基本都能找到，这里提几个可能是通用构建流程里很可能用到的。</p>

<h4 id="run-sequencehttpswwwnpmjscompackagerun-sequence"><a href="https://www.npmjs.com/package/run-sequence">run-sequence</a></h4>

<p>鉴于流程控制对javascript这种纯异步编程的重要性，gulp的异步任务控制需求同样强烈，run-sequence就是为了解决这个问题。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">runSequence</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;run-sequence&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">clean</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-clean&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="c1">// This will run in this order: </span>
</span><span class="line"><span class="c1">// * build-clean </span>
</span><span class="line"><span class="c1">// * build-scripts and build-styles in parallel </span>
</span><span class="line"><span class="c1">// * build-html </span>
</span><span class="line"><span class="c1">// * Finally call the callback function </span>
</span><span class="line"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">runSequence</span><span class="p">(</span><span class="s1">&#39;build-clean&#39;</span><span class="p">,</span>
</span><span class="line">              <span class="p">[</span><span class="s1">&#39;build-scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;build-styles&#39;</span><span class="p">],</span>
</span><span class="line">              <span class="s1">&#39;build-html&#39;</span><span class="p">,</span>
</span><span class="line">              <span class="nx">callback</span><span class="p">);</span>
</span><span class="line"><span class="p">});</span>
</span><span class="line">
</span><span class="line"><span class="c1">// configure build-clean, build-scripts, build-styles, build-html as you </span>
</span><span class="line"><span class="c1">// wish, but make sure they either return a stream or handle the callback </span>
</span><span class="line"><span class="c1">// Example: </span>
</span><span class="line">
</span><span class="line"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build-clean&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">BUILD_DIRECTORY</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">clean</span><span class="p">());</span>
</span><span class="line"><span class="c1">//  ^^^^^^ </span>
</span><span class="line"><span class="c1">//   This is the key here, to make sure tasks run asynchronously! </span>
</span><span class="line"><span class="p">});</span>
</span><span class="line">
</span><span class="line"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build-scripts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">SCRIPTS_SRC</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(...)...</span>
</span><span class="line"><span class="c1">//  ^^^^^^ </span>
</span><span class="line"><span class="c1">//   This is the key here, to make sure tasks run asynchronously! </span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="delhttpswwwnpmjscompackagedel"><a href="https://www.npmjs.com/package/del">del</a></h4>

<p>删除文件，这是个再频繁不过的需求了。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">del</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="nx">del</span><span class="p">([</span><span class="s1">&#39;tmp/*.js&#39;</span><span class="p">,</span> <span class="s1">&#39;!tmp/unicorn.js&#39;</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">paths</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Deleted files/folders:\n&#39;</span><span class="p">,</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">));</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>主要，del函数返回的是一个promise对象。</p>

<h4 id="merge-streamhttpswwwnpmjscompackagemerge-stream"><a href="https://www.npmjs.com/package/merge-stream">merge-stream</a></h4>

<p>当一个task里有多条流时，怎么办? merge-stream就是为了解决流的合并问题的。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">merge</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;merge-stream&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">bootstrap</span> <span class="o">=</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;bootstrap/js/*.js&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/bootstrap&#39;</span><span class="p">));</span>
</span><span class="line">
</span><span class="line">  <span class="kd">var</span> <span class="nx">jquery</span> <span class="o">=</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;jquery.cookie/jquery.cookie.js&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/jquery&#39;</span><span class="p">));</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">bootstrap</span><span class="p">,</span> <span class="nx">jquery</span><span class="p">);</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当<code>bootstrap</code>和<code>jquery</code>这两条流都完成时，合并后的流才算完成。</p>

<h4 id="section-1">用户代码</h4>

<p>还有一种情况，如果task的流处理完成时，我希望执行一些用户代码，比如仅仅打印一些信息，这要怎么做呢? 使用task依赖固然可以完成，但是仅仅因为这个需求就增加一个<code>空</code>task是不是有点杀鸡用牛刀了，如果真正理解了nodejs流和gulp的task规则，其实也很好办:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;cli&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;coffee&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;*.coffee&#39;</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">coffee</span><span class="p">()).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;js/&#39;</span><span class="p">)).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">doSomething</span><span class="p">();</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">cb</span><span class="p">();</span>
</span><span class="line">  <span class="p">});</span>
</span><span class="line">  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>注意task的返回值及task回调cb。</p>

<h3 id="section-2">6. 结束</h3>

<p>gulp是一个很cool的构建工具，学习她，在合适的时候使用她。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[分享你的Angular指令]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/05/27/fen-xiang-ni-de-angularzhi-ling/"/>
    <updated>2015-05-27T17:47:56+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/05/27/fen-xiang-ni-de-angularzhi-ling</id>
    <content type="html"><![CDATA[<h3 id="angular-directive-on-bower">Angular directive on bower</h3>
<p>用Angular做web开发不但听起来是非常炫酷的事情，而且从我实际的开发体验来看，它确实是极大减轻了开发者的痛苦。我可以把精力都花在组织业务逻辑，创建更为流畅和漂亮的UI上，而完全不用去反复沦陷在事件绑定数据更新这些无趣的事情上。此外，angular框架本身依照设计模式上定义出了一套MVC漂亮的实现,了解其controller,server,directive后，写出大型web app已经不是难事了。</p>

<p>Angular中最漂亮的两个组件是service和directive，简单说来，service是逻辑代码的抽象和封装，它将应用中重复使用的逻辑代码抽象为公共服务，便于打造瘦controller；而directive则是对UI组件的抽象，其对directive的封装和接口设计简直刷新了我对前端的认识。</p>

<p>这里我就不准备详细介绍怎么写指令了，google的文档和我之前的博客都可供参考，这里说一下，如果你写出来非常cool的指令，怎么分享给大家呢？答案是bower。</p>

<!--more-->

<h3 id="bower">Bower</h3>
<p><a href="http://bower.io/">Bower</a>是一个js的客户端管理工具，可以称之为客户端的npm，其作者是twitter的几个家伙(<a href="https://github.com/fat">@fat</a>,<a href="https://github.com/maccman">@maccman</a>)。根据你配置的<code>bower.json</code>文件，Bower可以自动查找、下载和安装js库，极大节约开发时间。</p>

<h4 id="section">简单介绍</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>安装使用</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">npm install -g bower
</span><span class="line"><span class="c"># registered package</span>
</span><span class="line">bower install jquery
</span><span class="line"><span class="c"># GitHub shorthand</span>
</span><span class="line">bower install desandro/masonry
</span><span class="line"><span class="c"># Git endpoint</span>
</span><span class="line">bower install git://github.com/user/package.git
</span><span class="line"><span class="c"># URL</span>
</span><span class="line">bower install http://example.com/script.js
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>### 创建一个基于bower的angular指令angular-dropzone
<a href="http://www.dropzonejs.com/">Dropzone</a>是一个漂亮的文件上传组件，下面就演示怎么把它集成为一个angular指令并分享到github。</p>

<h4 id="section-1">1.创建指令工程</h4>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">mkdir angular-dropzone <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$_</span>
</span><span class="line">touch angular-dropzone.js <span class="c">#  写入指令实现</span>
</span><span class="line">bower init <span class="c"># 初始化bower工程</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>回答完一系列问题后，生成的<code>bower.json</code>文件应该类似：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="o">{</span>
</span><span class="line">  name: <span class="s1">&#39;angular-dropzone&#39;</span>,
</span><span class="line">  main: <span class="s1">&#39;angular-dropzone.js&#39;</span>,
</span><span class="line">  version: <span class="s1">&#39;0.0.0&#39;</span>,
</span><span class="line">  authors: <span class="o">[</span>
</span><span class="line">    <span class="s1">&#39;qujianping &lt;qjpcpu@gmail.com&gt;&#39;</span>
</span><span class="line">  <span class="o">]</span>,
</span><span class="line">  description: <span class="s1">&#39;dropzone for angular&#39;</span>,
</span><span class="line">  keywords: <span class="o">[</span>
</span><span class="line">    <span class="s1">&#39;angular&#39;</span>,
</span><span class="line">    <span class="s1">&#39;dropzone&#39;</span>
</span><span class="line">  <span class="o">]</span>,
</span><span class="line">  license: <span class="s1">&#39;MIT&#39;</span>,
</span><span class="line">  ignore: <span class="o">[</span>
</span><span class="line">    <span class="s1">&#39;**/.*&#39;</span>,
</span><span class="line">    <span class="s1">&#39;node_modules&#39;</span>,
</span><span class="line">    <span class="s1">&#39;bower_components&#39;</span>,
</span><span class="line">    <span class="s1">&#39;test&#39;</span>,
</span><span class="line">    <span class="s1">&#39;tests&#39;</span>
</span><span class="line">  <span class="o">]</span>,
</span><span class="line">  dependencies: <span class="o">{</span>
</span><span class="line">    angular: <span class="s1">&#39;~1.3.0&#39;</span>,
</span><span class="line">    dropzone: <span class="s1">&#39;~4.0.1&#39;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-2">2.编辑指令代码</h4>
<p>现在开始编写指令的实现。指令代码最好遵守一定命名规范，如：以github名称作为命名空间。
&lt;div class=&#8217;bogus-wrapper&#8217;&gt;<notextile><figure class="code">&lt;figcaption&gt;<span>angular-dropzone.js</span>&lt;/figcaption&gt;&lt;div class=&#8221;highlight&#8221;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#8221;gutter&#8221;&gt;&lt;pre class=&#8221;line-numbers&#8221;&gt;<span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#8217;code&#8217;&gt;&lt;pre&gt;<code class="javascript"><span class="line"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;qjpcpu.angular-dropzone&#39;</span><span class="p">,</span> <span class="p">[]).</span>
</span><span class="line">  <span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;qjpDropzone&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// implementation goes here</span>
</span><span class="line">  <span class="p">});</span>
</span></code>&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;</figure></notextile>&lt;/div&gt;
具体代码实现可以参考<a href="https://github.com/qjpcpu/angular-dropzone">angular-dropzone</a></p>

<h4 id="section-3">3.发布指令</h4>
<p>编写完成后，就可以推送到github。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">git init .
</span><span class="line">git add bower.json angular-dropzone.js
</span><span class="line">git commit -m <span class="s1">&#39;v0.0.0&#39;</span>
</span><span class="line">git tag v0.0.0
</span><span class="line">git remote add origin git@github.com:qjpcpu/angular-dropzone.git
</span><span class="line">git push -u origin master
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>注意，bower使用git的tag确定版本号。</p>

<h4 id="section-4">4.在你的应用中使用该指令</h4>
<p>现在可以拉取使用你的angular指令了：
&lt;div class=&#8217;bogus-wrapper&#8217;&gt;<notextile><figure class="code">&lt;figcaption&gt;<span></span>&lt;/figcaption&gt;&lt;div class=&#8221;highlight&#8221;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#8221;gutter&#8221;&gt;&lt;pre class=&#8221;line-numbers&#8221;&gt;<span class="line-number">1</span>
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#8217;code&#8217;&gt;&lt;pre&gt;<code class="bash"><span class="line">bower install qjpcpu/angular-dropzone
</span></code>&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;</figure></notextile>&lt;/div&gt;</p>

<p>在<code>index.html</code>文件添加加载的文件:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;bower_components/dropzone/dist/dropzone.css&quot;</span><span class="nt">&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/dropzone/dist/dropzone.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-dropzone/angular-dropzone.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>需要添加模块依赖:
&lt;div class=&#8217;bogus-wrapper&#8217;&gt;<notextile><figure class="code">&lt;figcaption&gt;<span>app.coffee</span>&lt;/figcaption&gt;&lt;div class=&#8221;highlight&#8221;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#8221;gutter&#8221;&gt;&lt;pre class=&#8221;line-numbers&#8221;&gt;<span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#8217;code&#8217;&gt;&lt;pre&gt;<code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s">&quot;my-app&quot;</span><span class="p">,</span> <span class="p">[</span>
</span><span class="line">  <span class="s">&#39;qjpcpu.angular-dropzone&#39;</span>
</span><span class="line"><span class="p">])</span>
</span></code>&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;</figure></notextile>&lt;/div&gt;
这样在html片段里就可以使用指令了,关于该指令具体参数参考<a href="https://github.com/qjpcpu/angular-dropzone">angular-dropzone</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>p.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;div</span> <span class="na">qjp-dropzone</span> <span class="na">class=</span><span class="s">&quot;droppable-area&quot;</span> <span class="na">url=</span><span class="s">&quot;&#39;/url/to-upload&#39;&quot;</span><span class="nt">&gt;</span>
</span><span class="line">	Drop file here
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于后台任务]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/05/27/guan-yu-hou-tai-ren-wu/"/>
    <updated>2015-05-27T17:16:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/05/27/guan-yu-hou-tai-ren-wu</id>
    <content type="html"><![CDATA[<h3 id="sidekiq">关于sidekiq</h3>
<p>在做ruby开发时，通常会遇到耗时操作的处理，sidekiq由于其使用简单，性能强劲，所以常被用来作为Ruby应用的后台任务的执行引擎。不过sidekiq有个令人头疼的问题，就是任务提交到后台异步执行后，对于其状态的监测和管理就成为很大的问题。</p>

<!--more-->

<p>sidekiq的wiki上也贴出了很多相关执行管理工具，sidekiq-promise是个人最喜欢的一个，其异步回调的风格和js的风格非常像，使用起来非常友好。</p>

<h3 id="sidekiq-promise">sidekiq-promise</h3>
<p>这里的例子直接来源于其github的readme:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>demo.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">ProcessWorker</span>
</span><span class="line">  <span class="kp">include</span> <span class="ss">Sidekiq</span><span class="p">:</span><span class="ss">:Promise</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">perform</span> <span class="n">file_to_process</span>
</span><span class="line">    <span class="no">UnzipWorker</span><span class="o">.</span><span class="n">as_promise</span><span class="p">(</span><span class="n">file_to_process</span><span class="p">)</span><span class="o">.</span><span class="n">then</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
</span><span class="line">      <span class="no">MrDarcy</span><span class="o">.</span><span class="n">all_promises</span> <span class="k">do</span>
</span><span class="line">        <span class="n">dir</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class="line">          <span class="no">ImageThumbnailWorker</span><span class="o">.</span><span class="n">as_promise</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span><span class="o">.</span><span class="n">then</span> <span class="k">do</span>
</span><span class="line">      <span class="no">UserNotificationMailer</span><span class="o">.</span><span class="n">all_images_processed</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>简述: UnzipWorker会解压文件，然后将解压得到的每个文件分发给ImageThumbnailWorker去创建压缩图，等待所有压缩完成后再发送通知邮件，非常简洁漂亮。</p>

<ul>
  <li>将worker里的<code>include Sidekiq::Worker</code>替换成<code>include Sidekiq::Promise</code>即可。</li>
  <li>
    <p>如果要获取worker的输出，则调用<code>ProcessWorker.as_promise(arguments)</code>即可，在then block中获取执行结果，这个结果即<code>perform</code>方法的返回值。</p>
  </li>
  <li><code>sidekiq-promise</code>使用了<code>MrDarcy</code>，所以提供了一个很有意思的方法</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">MrDarcy</span><span class="o">.</span><span class="n">all_promises</span> <span class="k">do</span>
</span><span class="line">  <span class="o">[</span><span class="n">promise1</span><span class="p">,</span><span class="n">promise2</span><span class="o">]</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>MrDarcy.all_promises</code>的块会等待其中列表的每一个promise完成。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AngularJs之Isolated Scope]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/05/25/angularjszhi-isolated-scope/"/>
    <updated>2015-05-25T14:12:42+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/05/25/angularjszhi-isolated-scope</id>
    <content type="html"><![CDATA[<h3 id="scopeisolated-scope">分离式scope（Isolated Scope）</h3>
<p>在angularjs指令中问什么需要使用分离式的scope,主要是为了分离指令和执行所在的”环境”,这个环境其实就是指controller的scope和指令自身的scope,使用分离式scope达到隔离各自scope变量，避免变量污染，从而最大程度上达到指令的重用。</p>

<!--more-->

<blockquote>
  <p>注意，下面的示例为了突出重点，使用CoffeeScript展示代码</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>script.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s">&#39;docsIsolateScopeDirective&#39;</span><span class="p">,</span> <span class="p">[]).</span><span class="nx">controller</span><span class="p">(</span><span class="s">&#39;Controller&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span><span class="nf">($scope) -&gt;</span>
</span><span class="line">  <span class="nv">$scope.naomi =</span>
</span><span class="line">    <span class="nv">name: </span><span class="s">&#39;Naomi&#39;</span>
</span><span class="line">    <span class="nv">address: </span><span class="s">&#39;1600 Amphitheatre&#39;</span>
</span><span class="line">  <span class="nv">$scope.igor =</span>
</span><span class="line">    <span class="nv">name: </span><span class="s">&#39;Igor&#39;</span>
</span><span class="line">    <span class="nv">address: </span><span class="s">&#39;123 Somewhere&#39;</span>
</span><span class="line"><span class="p">]).</span><span class="nx">directive</span> <span class="s">&#39;myCustomer&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class="line">  <span class="nv">restrict: </span><span class="s">&#39;E&#39;</span>
</span><span class="line">  <span class="nv">scope: customerInfo: </span><span class="s">&#39;=info&#39;</span>
</span><span class="line">  <span class="nv">template: </span><span class="s">&quot;Name: { {customerInfo.name} } Address: { {customerInfo.address} }&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">&quot;Controller&quot;</span><span class="nt">&gt;</span>
</span><span class="line">  <span class="nt">&lt;my</span><span class="na">-customer</span> <span class="na">info=</span><span class="s">&quot;naomi&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>/my-customer&gt;
</span><span class="line">  <span class="nt">&lt;hr&gt;</span>
</span><span class="line">  <span class="nt">&lt;my</span><span class="na">-customer</span> <span class="na">info=</span><span class="s">&quot;igor&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>/my-customer&gt;
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>输出为</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Name: Naomi Address: 1600 Amphitheatre Name: Igor Address: 123 Somewhere
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由输出可以看出，指令<code>my-customer</code>中的<code>info</code>属性被分别绑定到了外部scope的两个变量<code>naomi</code>和<code>igor</code>，虽然是同一指令，但相互之间没有干扰或污染。这样<code>my-customer</code>指令可以非常漂亮的被重用。</p>

<p>其实，如果不需要特意在指令间共享scope，最好都使用分离式scope来写指令。</p>

<p>另外，指令内属性名如果和绑定的外部属性相同，可以采用简写模式，如这里<code>my-customer</code>的<code>info</code>属性映射到内部也用<code>info</code>引用的化:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>script.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">directive</span> <span class="s">&#39;myCustomer&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class="line">  <span class="nv">restrict: </span><span class="s">&#39;E&#39;</span>
</span><span class="line">  <span class="nv">scope: info: </span><span class="s">&#39;=&#39;</span>
</span><span class="line">  <span class="nv">template: </span><span class="s">&#39;Name: { {customerInfo.name} } Address: { {customerInfo.address} }&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section">@单向绑定</h3>
<p>对于仅仅需要在指令中反应外部scope变量变化的情况下，可以仅使用单向绑定，将controller的变量映射到指令中，一旦在controller中修改变量，指令中可以立即看到变化，然而反过来则不可，即外部scope中看不到指令内部对变量的修改。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>script.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="p">.</span><span class="nx">directive</span> <span class="s">&#39;myDirective, -&gt;</span>
</span><span class="line"><span class="s">  scope: attributeFoo: &#39;</span><span class="nx">@</span><span class="s">&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;my</span><span class="na">-component</span> <span class="na">attribute-foo=</span><span class="s">&quot;{ {foo} }&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>/my-component&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>即，在控制器里修改foo，在<code>my-directive</code>中可以感知到。通常单向绑定对于取字符串值很常见，所以这里的html中使用双花括号插值。因此，单向绑定的官方名称其实是叫属性绑定。</p>

<h3 id="section-1">=双向绑定</h3>
<p>看名称就知道用途了，双向绑定使用<code>=</code>定义，直接看例子:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>script.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="p">.</span><span class="nx">directive</span> <span class="s">&#39;myDirective, -&gt;</span>
</span><span class="line"><span class="s">  scope: bindingFoo: &#39;</span><span class="o">=</span><span class="s">&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-2">&amp;表达式绑定</h3>
<p>或者换个更human的名称，函数绑定，如果需要在指令内调用controler的函数，这就是说我们可以在指令内部定义接口，controller定义具体实现，这样指令就能够变得非常灵活，用在分离式scope中，既避免了变量污染又达到了灵活性，太cool了。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>my-directive.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="p">.</span><span class="nx">directive</span> <span class="s">&#39;myDirective, -&gt;</span>
</span><span class="line"><span class="s">  scope: myHandler: &#39;</span><span class="o">&amp;</span><span class="s">&#39;</span>
</span><span class="line"><span class="s">  template: &#39;</span><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">click</span><span class="o">=</span><span class="s">&quot;myHandler({$count: 123})&quot;</span><span class="o">&gt;&lt;/</span><span class="nx">button</span><span class="o">&gt;</span><span class="s">&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>my-controller.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;MyCtrl&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span><span class="nf">($scope) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.getCounts = </span><span class="nf">(countNum) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Button click count: </span><span class="si">#{</span><span class="nx">countNum</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;my</span><span class="na">-directive</span> <span class="na">my-handler=</span><span class="s">&quot;getCounts($count)&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>/my-directive&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-3">非常重要:函数传参</h4>
<p>对于无参函数的绑定，没什么好说的。但对应上例中的情况，需要把参数从指令中传到外部函数，则需要注意了。</p>

<ul>
  <li>参数必须是hash类型的json对象，即参数是k-v类型的对象，如示例中的<code>{$count: 123}</code></li>
  <li>html中使用指令的地方函数的参数必须和指令中函数传递的参数的key一一对应，即指令中传递的参数的key是<code>$count</code>，那么html中指令绑定的函数接受的参数必须是<code>$count</code>，否则无法接受正确的参数。但是在controller里的函数参数名不必和他们保持一致。</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[高效读取excel]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/05/25/gao-xiao-du-qu-excel/"/>
    <updated>2015-05-25T11:11:02+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/05/25/gao-xiao-du-qu-excel</id>
    <content type="html"><![CDATA[<p>前面介绍ruby写excel文件的一个很cool的gem包<code>axlsx</code>,这里介绍另一个高效读取excel的包<code>creek</code>。</p>

<p>一个读一个写，ruby轻松搞定execel处理。
<!-- more --></p>

<h4 id="section">安装</h4>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">gem install creek
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-1">使用</h4>
<p><code>creek</code>本身的使用非常简单:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>creek_demo.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;creek&#39;</span>
</span><span class="line"><span class="n">creek</span> <span class="o">=</span> <span class="ss">Creek</span><span class="p">:</span><span class="ss">:Book</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;specs/fixtures/sample.xlsx&quot;</span>
</span><span class="line"><span class="n">sheet</span><span class="o">=</span> <span class="n">creek</span><span class="o">.</span><span class="n">sheets</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="c1"># 注:获取行数不能用size方法</span>
</span><span class="line"><span class="nb">puts</span> <span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">count</span> <span class="c1"># =&gt; 100</span>
</span><span class="line">
</span><span class="line"><span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class="line">  <span class="nb">puts</span> <span class="n">row</span> <span class="c1"># =&gt; {&quot;A1&quot;=&gt;&quot;Content 1&quot;, &quot;B1&quot;=&gt;nil, C1&quot;=&gt;nil, &quot;D1&quot;=&gt;&quot;Content 3&quot;}</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">sheet</span><span class="o">.</span><span class="n">rows_with_meta_data</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class="line">  <span class="nb">puts</span> <span class="n">row</span> <span class="c1"># =&gt; {&quot;collapsed&quot;=&gt;&quot;false&quot;, &quot;customFormat&quot;=&gt;&quot;false&quot;, &quot;customHeight&quot;=&gt;&quot;true&quot;, &quot;hidden&quot;=&gt;&quot;false&quot;, &quot;ht&quot;=&gt;&quot;12.1&quot;, &quot;outlineLevel&quot;=&gt;&quot;0&quot;, &quot;r&quot;=&gt;&quot;1&quot;, &quot;cells&quot;=&gt;{&quot;A1&quot;=&gt;&quot;Content 1&quot;, &quot;B1&quot;=&gt;nil, C1&quot;=&gt;nil, &quot;D1&quot;=&gt;&quot;Content 3&quot;}}</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">sheet</span><span class="o">.</span><span class="n">state</span>   <span class="c1"># =&gt; &#39;visible&#39;</span>
</span><span class="line"><span class="n">sheet</span><span class="o">.</span><span class="n">name</span>    <span class="c1"># =&gt; &#39;Sheet1&#39;</span>
</span><span class="line"><span class="n">sheet</span><span class="o">.</span><span class="n">rid</span>     <span class="c1"># =&gt; &#39;rId2&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>#### 性能
读取并遍历一个16M左右17608行的xlsx文件，benchmark:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">--------------- total: 84.040000sec   ----------------
</span><span class="line">  user     system      total        real
</span><span class="line"> 84.920000   0.680000  85.600000 <span class="o">(</span> 86.084133<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>P.S. 无法和其他读取excel的gem做对比，因为试着做对比测试时发现其他gem根本卡在读取操作那不动了。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[脚下的路]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/02/16/jiao-xia-de-lu/"/>
    <updated>2015-02-16T09:22:38+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/02/16/jiao-xia-de-lu</id>
    <content type="html"><![CDATA[<p>本来之前就想写写关于2014年的经历，但一直心里都是满满的负能量，所以一直没有下笔。今天其实也是，和家人闹得不开心，然后愤懑地来公司上班，没想到在路上反而突然想明白了，所以就回顾一下过去的2014，还有现在心里的想法吧。</p>

<p>在<code>life</code>分类下，之前的两篇文字都是非常积极的，我之前耕耘多年，凭着自己的努力进入了百度，我自己其实是非常自豪的。即便进入了百度后，能力也被非常认可。所以在2014上半年，其实我是感觉意气风发的，在工作中，也做出了一些很cool的事情。那时候的我，感觉自己离梦想只有一步之遥，仿佛站在天梯之巅，拨开云层再踏一步，可能我就能出去，去Google朝圣。那是在朋友们眼中，我就是个疯子，什么都可以不要。那时，我是幸福的，虽然在别人眼里，那时的我是一个不负责任，狂热的人。</p>

<p>但是在下半年，我逐渐感受到狂热背后的东西，尽管在百度，也要做很多机械重复的事情，此外更重要的是，我发现自己很孤独，除开工作，我一无所有，独自在上海漂泊，心里非常寂寞。再加上后来家人生病，我选择了离开，回到成都。</p>

<p>在离开百度的那段日子，我的情绪非常低落，每天只吃一点东西。真的，人有时候在失去时才知道珍惜。回到成都小半年里，我常常回忆起临走前一天，在食堂吃过饭后翠姐问我:你不是想去Google吗，你怎么办？ 那时我心里如遭重锤，是啊，有路吗？我沉默了下，算是安慰自己回答她：走一步看一步吧。这种答案，我自己都觉得好难过……</p>

<p><code>people must pay for their choices</code>，每个人必须为他的选择付出代价。</p>

<!-- more -->

<p>回来的好长日子里，我无法适应。逐渐地，我开始怀念在百度的那段日子。这时我才体会到，百度真正优秀的地方，不在于她的大公司地位和光环，在于百度的人，在于那些身上深深烙上了百度刻印而不自知的优秀同学。不论懂的多少，总是怀着一种谦逊求知的态度，对技术和知识的真正渴望，塑造了百度人自己的气质。</p>

<p><code>怀疑和迷茫</code>，占据了我。我不知道自己要干什么，不知道下一步的路在哪里。每天回到家，和家人在一起，其实也挺开心的，上班也能尽情雕琢自己的代码，这不是我以前想要的吗？曾经有人问我毕业后想要什么样的工作，我说能写代码就行。但现在我发现，其实我远远不能满足于这些，我需要舞台，需要一个大的舞台展示自己，希望被听到。</p>

<p>我告诉自己：我是优秀的人，到哪里我都必须要优秀!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rvm和rbenv环境变量冲突导致无法安装gem包]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/01/05/rvmhe-rbenvhuan-jing-bian-liang-chong-tu-dao-zhi-wu-fa-an-zhuang-gembao/"/>
    <updated>2015-01-05T18:11:47+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/01/05/rvmhe-rbenvhuan-jing-bian-liang-chong-tu-dao-zhi-wu-fa-an-zhuang-gembao</id>
    <content type="html"><![CDATA[<h2 id="section">背景</h2>
<p>root环境用rvm安装了ruby，但我需要在用户环境重装ruby，而且个人喜欢用rbenv，这就导致了我安装了rbenv的gem后，没有权限安装gem包。</p>

<!-- more -->

<h2 id="resolve">resolve</h2>
<p>这种情况是rvm强制设置了<code>GEM_HOME</code>导致的，可以<code>gem env</code>查看：</p>

<pre><code>jason@mac:~$ gem env
RubyGems Environment:
  - RUBYGEMS VERSION: 2.0.14
  - RUBY VERSION: 2.0.0 (2014-11-13 patchlevel 598) [x86_64-linux]
  - INSTALLATION DIRECTORY: /usr/local/rvm/gems/ruby-2.0.0-p353
  - RUBY EXECUTABLE: /home/jason/.rbenv/versions/2.0.0-p598/bin/ruby
  - EXECUTABLE DIRECTORY: /usr/local/rvm/gems/ruby-2.0.0-p353/bin
  - RUBYGEMS PLATFORMS:
    - ruby
    - x86_64-linux
  - GEM PATHS:
     - /usr/local/rvm/gems/ruby-2.0.0-p353
     - /home/jason/.rbenv/versions/2.0.0-p598/lib/ruby/gems/2.0.0/
  - GEM CONFIGURATION:
     - :update_sources =&gt; true
     - :verbose =&gt; true
     - :backtrace =&gt; false
     - :bulk_threshold =&gt; 1000
  - REMOTE SOURCES:
     - https://rubygems.org/
</code></pre>

<p>可见GEM PATHS里优先选择了rvm的gem路径，所以需要重设GEM_HOME</p>

<pre><code>export GEM_HOME=$HOME/.rbenv/versions/2.0.0-p598/lib/ruby/gems/2.0.0/
</code></pre>

<p>但是，最好的办法是在~/.bash_profile(centos,ubuntu中是.bashrc)中<code>eval "$(rbenv init -)"</code>前加上：</p>

<pre><code>unset GEM_PATH
unset GEM_HOME
</code></pre>

<p>这样也可以清除rvm的设置，使rbenv的变量被正确设置.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[创建递归菜单]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2015/01/02/chuang-jian-di-gui-cai-dan/"/>
    <updated>2015-01-02T12:44:07+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2015/01/02/chuang-jian-di-gui-cai-dan</id>
    <content type="html"><![CDATA[<p>如果菜单的数据模型是这样的,在angularjs中怎样比较漂亮地递归渲染出所有菜单项呢？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="err">menuItems</span> <span class="err">=</span> <span class="p">[</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;level1&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nt">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;/A&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nt">&quot;menuItems&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;level2&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="nt">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;/A/a1&quot;</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">  <span class="p">},</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;level1&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nt">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;/B&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nt">&quot;menuItems&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;level2&quot;</span><span class="p">,</span>
</span><span class="line">        <span class="nt">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;/B/b1&quot;</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!-- more -->

<h2 id="ng">需要的ng指令</h2>

<h3 id="script">script</h3>

<p>将<code>&lt;script&gt;</code>的内容加载到$templateCache,这样就能够在ngInclude, ngView或指令中使用。<code>&lt;script&gt;</code>的类型必须是<code>text/ng-template</code>，并用<code>id</code>指定id。如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/ng-template&quot;</span> <span class="na">id=</span><span class="s">&quot;tpl-1&quot;</span><span class="nt">&gt;</span>
</span><span class="line">  <span class="nx">Content</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">template</span><span class="p">.</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="nginit">ngInit</h3>
<p>在当前scope内重命名某属性</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;script&gt;</span>
</span><span class="line">  <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;initExample&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span class="line">    <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;ExampleController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">$scope</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]];</span>
</span><span class="line">    <span class="p">}]);</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">&quot;ExampleController&quot;</span><span class="nt">&gt;</span>
</span><span class="line">  <span class="nt">&lt;div</span> <span class="na">ng-repeat=</span><span class="s">&quot;innerList in list&quot;</span> <span class="na">ng-init=</span><span class="s">&quot;outerIndex = $index&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="nt">&lt;div</span> <span class="na">ng-repeat=</span><span class="s">&quot;value in innerList&quot;</span> <span class="na">ng-init=</span><span class="s">&quot;innerIndex = $index&quot;</span><span class="nt">&gt;</span>
</span><span class="line">       <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;example-init&quot;</span><span class="nt">&gt;</span>list[  ][  ] = ;<span class="nt">&lt;/span&gt;</span>
</span><span class="line">    <span class="nt">&lt;/div&gt;</span>
</span><span class="line">  <span class="nt">&lt;/div&gt;</span>
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>输出：</p>

<pre><code>list[ 0 ][ 0 ] = a;
list[ 0 ][ 1 ] = b;
list[ 1 ][ 0 ] = c;
list[ 1 ][ 1 ] = d; 
</code></pre>

<h2 id="section">示例</h2>
<p>下面的示例代码就利用这些指令，将递归的菜单分割成扁平的模板，避免html模板过深的层次。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/ng-template&quot;</span> <span class="na">id=</span><span class="s">&quot;menu-item-link-tpl&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;title&quot;</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/span&gt;			</span>
</span><span class="line">    <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">ng</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="s2">&quot;item.label&quot;</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;</span><span class="err">/span&gt;</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span><span class="line">
</span><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/ng-template&quot;</span> <span class="na">id=</span><span class="s">&quot;menu-items-tpl&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">repeat</span><span class="o">=</span><span class="s2">&quot;item in menuItems&quot;</span><span class="o">&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">include</span><span class="o">=</span><span class="s2">&quot;&#39;menu-item-link-tpl&#39;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/a&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">ng</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="s2">&quot;item.menuItems.length&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">init</span><span class="o">=</span><span class="s2">&quot;subItems = item.menuItems&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">include</span><span class="o">=</span><span class="s2">&quot;&#39;menu-items-recursive-tpl&#39;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/ul&gt;</span>
</span><span class="line">    <span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span><span class="line">
</span><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/ng-template&quot;</span> <span class="na">id=</span><span class="s">&quot;menu-items-recursive-tpl&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">repeat</span><span class="o">=</span><span class="s2">&quot;item in subItems&quot;</span><span class="o">&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">include</span><span class="o">=</span><span class="s2">&quot;&#39;menu-item-link-tpl&#39;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/a&gt;</span>
</span><span class="line">	<span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">ng</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="s2">&quot;item.menuItems.length&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">init</span><span class="o">=</span><span class="s2">&quot;subItems = item.menuItems&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">include</span><span class="o">=</span><span class="s2">&quot;&#39;menu-items-recursive-tpl&#39;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/ul&gt;</span>
</span><span class="line">    <span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span><span class="line">
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">ng-include=</span><span class="s">&quot;&#39;menu-items-tpl&#39;&quot;</span><span class="nt">&gt;</span>
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[angularJS路由框架ui-router]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/12/29/angularjslu-you-kuang-jia-ui-router/"/>
    <updated>2014-12-29T17:32:53+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/12/29/angularjslu-you-kuang-jia-ui-router</id>
    <content type="html"><![CDATA[<h1 id="section">简介</h1>
<p><a href="https://github.com/angular-ui/ui-router">AngularUI Router</a>是AngularJS的路由框架，和默认的<code>$route</code>不同，它将所有路由包装成可划分层级的状态机状态,路由路径在ui-router中不是必须的。由于ui-router的路由状态机是分层级的，所以使用ui-router可以非常方便地创建包含多个嵌入的子模板。</p>

<!-- more -->

<h1 id="demo">Demo</h1>
<p>直接使用<code>ui-router</code>的方式可以参考其github文档，这里以yeoman为例简单展示下ui-router的使用。</p>

<p>在<code>bower.json</code>中加入ui-router依赖包,然后<code>bower install</code>执行安装</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>bower.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;learn-angular&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class="line">    <span class="err">/*省略其他*/</span>
</span><span class="line">    <span class="nt">&quot;angular-ui-router&quot;</span><span class="p">:</span> <span class="s2">&quot;^0.2.13&quot;</span>
</span><span class="line">  <span class="p">},</span>
</span><span class="line"> <span class="err">/*省略其他*/</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在<code>index.html</code>中添加引用：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>app/index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-ui-router/release/angular-ui-router.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>在app.coffee中设置路由：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>app/scripts/app.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="s">&#39;use strict&#39;</span>
</span><span class="line">
</span><span class="line"><span class="nx">angular</span>
</span><span class="line">  <span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s">&#39;learnAngularApp&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span class="line">    <span class="s">&#39;ui.router&#39;</span>    <span class="c1"># 添加模块依赖</span>
</span><span class="line">  <span class="p">])</span>
</span><span class="line">  <span class="p">.</span><span class="nx">run</span> <span class="p">[</span><span class="s">&#39;$rootScope&#39;</span><span class="p">,</span> <span class="s">&#39;$state&#39;</span><span class="p">,</span> <span class="s">&#39;$stateParams&#39;</span><span class="p">,</span> <span class="nf">($rootScope,   $state,   $stateParams) -&gt;</span>
</span><span class="line">    <span class="nv">$rootScope.$state = </span><span class="nx">$state</span>
</span><span class="line">    <span class="nv">$rootScope.$stateParams = </span><span class="nx">$stateParams</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">  <span class="p">.</span><span class="nx">config</span> <span class="nf">($stateProvider,$urlRouterProvider) -&gt;</span>
</span><span class="line">    <span class="nx">$urlRouterProvider</span><span class="p">.</span><span class="nx">otherwise</span> <span class="s">&quot;/&quot;</span>
</span><span class="line">    <span class="nx">$stateProvider</span>
</span><span class="line">      <span class="p">.</span><span class="nx">state</span> <span class="s">&#39;home&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="nv">url: </span><span class="s">&#39;/&#39;</span>                      <span class="c1"># 可见默认路由状态是home</span>
</span><span class="line">        <span class="nv">templateUrl: </span><span class="s">&#39;views/home.html&#39;</span>
</span><span class="line">      <span class="p">.</span><span class="nx">state</span> <span class="s">&#39;state1&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="nv">url: </span><span class="s">&#39;/state1&#39;</span>
</span><span class="line">        <span class="nv">templateUrl: </span><span class="s">&#39;views/state1.html&#39;</span>
</span><span class="line">      <span class="p">.</span><span class="nx">state</span> <span class="s">&#39;state1.list&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="nv">url: </span><span class="s">&#39;/list&#39;</span>
</span><span class="line">        <span class="nv">templateUrl: </span><span class="s">&#39;views/state1.list.html&#39;</span>
</span><span class="line">        <span class="nv">controller: </span><span class="nf">($scope) -&gt;</span>
</span><span class="line">          <span class="nv">$scope.items = </span><span class="p">[</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;List&quot;</span><span class="p">,</span> <span class="s">&quot;Of&quot;</span><span class="p">,</span> <span class="s">&quot;Items&quot;</span><span class="p">]</span>
</span><span class="line">      <span class="p">.</span><span class="nx">state</span> <span class="s">&#39;state2&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="nv">url: </span><span class="s">&#39;/state2&#39;</span>
</span><span class="line">        <span class="nv">templateUrl: </span><span class="s">&#39;views/state2.html&#39;</span>
</span><span class="line">      <span class="p">.</span><span class="nx">state</span> <span class="s">&#39;state2.list&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="nv">url: </span><span class="s">&#39;/list&#39;</span>
</span><span class="line">        <span class="nv">templateUrl: </span><span class="s">&#39;views/state2.list.html&#39;</span>
</span><span class="line">        <span class="nv">controller: </span><span class="nf">($scope) -&gt;</span>
</span><span class="line">          <span class="nv">$scope.things = </span><span class="p">[</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;Set&quot;</span><span class="p">,</span> <span class="s">&quot;Of&quot;</span><span class="p">,</span> <span class="s">&quot;Things&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ui-router最重要的三个服务<code>$state</code>,<code>$stateProvider</code>,<code>$urlRouterProvider</code>。在<code>$stateProvider</code>上配置所有的状态，state方法的第一个参数是状态名，第二个参数是一个hash对象，里面可以配置<code>url</code>,<code>templateUrl</code>,<code>controller</code>等。</p>

<p>注意其中类似<code>state1.list</code>和<code>state1</code>的状态，<code>state1.list</code>是<code>state1</code>的子状态，所以触发<code>state1.list</code>的url是父子状态的联合，即<code>/state1</code>+<code>/list</code> =&gt; <code>/state1/list</code>,所以当浏览器导航到<code>/state1/list</code>（或手动触发<code>$state.go()</code>）时，<code>state1.list.html</code>才被插入父模板渲染。</p>

<p>下图非常清晰反映了ui-router的渲染逻辑：</p>

<ul>
  <li>绿色 = 初始状态</li>
  <li>黄色 = 即时渲染</li>
  <li>蓝色 = 最终状态</li>
</ul>

<p><img src="https://camo.githubusercontent.com/15b1f1780e3a88cc1d6e0055dda298279d66fad7/68747470733a2f2f7261772e6769746875622e636f6d2f77696b692f616e67756c61722d75692f75692d726f757465722f5374617465476f4578616d706c65732e706e67" alt="渲染逻辑" /></p>

<p>主模板index.html:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>app/index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;div&gt;</span>
</span><span class="line">    <span class="nt">&lt;ul&gt;</span>
</span><span class="line">      <span class="nt">&lt;li</span> <span class="na">ui-sref-active=</span><span class="s">&quot;active&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;home&quot;</span><span class="nt">&gt;</span>home<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;li</span> <span class="na">ui-sref-active=</span><span class="s">&quot;active&quot;</span> <span class="nt">&gt;&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;state1&quot;</span><span class="nt">&gt;</span>state1<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;li</span> <span class="na">ui-sref-active=</span><span class="s">&quot;active&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;state2&quot;</span><span class="nt">&gt;</span>state2<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">    <span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">ui-view</span><span class="nt">&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里出现了两个ui-router的指令，<code>ui-sref</code>类似于angularjs的<code>ng-href</code>，只不过后面指定的是路由状态。</p>

<p>另一个指令就是<code>ui-view</code>，ui-router根据激活的状态向该指令中插入子模板。ui-router插入模板的规则是：<code>ui-router会将激活状态的模板插入父状态模板的ui-view处</code>。home状态是根状态，所以<code>app/index.html</code>的<code>ui-view</code>中插入的就是home状态的模板片段<code>app/views/home.html</code>。</p>

<p>其他模板：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- app/views/state1.html --&gt;</span>
</span><span class="line"><span class="nt">&lt;h1&gt;</span>State 1<span class="nt">&lt;/h1&gt;</span>
</span><span class="line"><span class="nt">&lt;hr/&gt;</span>
</span><span class="line"><span class="nt">&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;state1.list&quot;</span><span class="nt">&gt;</span>Show List<span class="nt">&lt;/a&gt;</span>
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">ui-view</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class="line"><span class="c">&lt;!-- app/views/state1.list.html --&gt;</span>
</span><span class="line"><span class="nt">&lt;h3&gt;</span>List of State 1 Items<span class="nt">&lt;/h3&gt;</span>
</span><span class="line"><span class="nt">&lt;ul&gt;</span>
</span><span class="line">  <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">&quot;item in items&quot;</span><span class="nt">&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="c">&lt;!-- app/views/state2.html --&gt;</span>
</span><span class="line"><span class="nt">&lt;h1&gt;</span>State 2<span class="nt">&lt;/h1&gt;</span>
</span><span class="line"><span class="nt">&lt;hr/&gt;</span>
</span><span class="line"><span class="nt">&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;state2.list&quot;</span><span class="nt">&gt;</span>Show List<span class="nt">&lt;/a&gt;</span>
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">ui-view</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class="line"><span class="c">&lt;!-- app/views/state2.list.html --&gt;</span>
</span><span class="line"><span class="nt">&lt;h3&gt;</span>List of State 2 Things<span class="nt">&lt;/h3&gt;</span>
</span><span class="line"><span class="nt">&lt;ul&gt;</span>
</span><span class="line">  <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">&quot;thing in things&quot;</span><span class="nt">&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由上面的规则可以同理推出，当url为<code>/state1/list</code>时，会渲染主模板<code>state1.html</code>，并且会将子模板<code>state1.list.html</code>嵌入<code>state1.html</code>的<code>ui-view</code>中一起渲染出来。cool，路由渲染的灵活性非常高！</p>

<p>另外还有一个常用指令<code>ui-sref-active="classname"</code>,它通常和<code>ui-sref</code>一起使用，含义是当前状态被激活则会在所属html标签上class属性添加classname,如果不再是激活状态则去除classname。</p>

<p>另外，ui-router还支持多模板：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>app/views/index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;body&gt;</span>
</span><span class="line">    <span class="nt">&lt;div</span> <span class="na">ui-view=</span><span class="s">&quot;viewA&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class="line">    <span class="nt">&lt;div</span> <span class="na">ui-view=</span><span class="s">&quot;viewB&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Also a way to navigate --&gt;</span>
</span><span class="line">    <span class="nt">&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;route1&quot;</span><span class="nt">&gt;</span>Route 1<span class="nt">&lt;/a&gt;</span>
</span><span class="line">    <span class="nt">&lt;a</span> <span class="na">ui-sref=</span><span class="s">&quot;route2&quot;</span><span class="nt">&gt;</span>Route 2<span class="nt">&lt;/a&gt;</span>
</span><span class="line"><span class="nt">&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>app/scripts/app.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">myApp</span><span class="p">.</span><span class="nx">config</span> <span class="nf">($stateProvider) -&gt;</span>
</span><span class="line">  <span class="nx">$stateProvider</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nv">url: </span><span class="s">&quot;&quot;</span>
</span><span class="line">    <span class="nv">views:</span>
</span><span class="line">      <span class="nv">viewA:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;index.viewA&quot;</span>
</span><span class="line">      <span class="nv">viewB:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;index.viewB&quot;</span>
</span><span class="line">  <span class="p">).</span><span class="nx">state</span><span class="p">(</span><span class="s">&quot;route1&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nv">url: </span><span class="s">&quot;/route1&quot;</span>
</span><span class="line">    <span class="nv">views:</span>
</span><span class="line">      <span class="nv">viewA:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;route1.viewA&quot;</span>
</span><span class="line">      <span class="nv">viewB:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;route1.viewB&quot;</span>
</span><span class="line">  <span class="p">).</span><span class="nx">state</span> <span class="s">&quot;route2&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nv">url: </span><span class="s">&quot;/route2&quot;</span>
</span><span class="line">    <span class="nv">views:</span>
</span><span class="line">      <span class="nv">viewA:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;route2.viewA&quot;</span>
</span><span class="line">      <span class="nv">viewB:</span>
</span><span class="line">        <span class="nv">template: </span><span class="s">&quot;route2.viewB&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[我的简历]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/12/15/resume/"/>
    <updated>2014-12-15T20:20:58+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/12/15/resume</id>
    <content type="html"><![CDATA[<h4 id="section">联系方式</h4>

<ul>
  <li>
    <p>姓名: JasonQu</p>
  </li>
  <li>
    <p>微信: </p>
  </li>
</ul>

<p><img src="https://raw.githubusercontent.com/qjpcpu/qjpcpu.github.com/master/images/wechat.jpg" alt="qrcode" /></p>

<ul>
  <li>
    <p>详细联系方式: 打开<a href="https://etherscan.io/tx/0x28f313b388b2d9eeb292fe9560409a39c4caa486f72055aab53391d2e471a959">以太坊浏览器</a>点击页面InputData文本框下面”Convert To Utf8”即可看到</p>
  </li>
  <li>
    <p>作品展示: <a href="http://qjpcpu.github.io">点我直接进入博客首页</a>, 或者进入<a href="https://github.com/qjpcpu">我的github</a>查看我的作品及代码风格</p>
  </li>
</ul>

<!-- more -->

<h3 id="section-1">教育经历</h3>

<table>
  <thead>
    <tr>
      <th>时间</th>
      <th>学校</th>
      <th>学位</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2011.9~2014.3</td>
      <td>同济大学</td>
      <td>硕士研究生</td>
    </tr>
    <tr>
      <td>2007.9~2011.7</td>
      <td>同济大学</td>
      <td>本科学士学位</td>
    </tr>
  </tbody>
</table>

<h3 id="section-2">工作履历</h3>

<h4 id="section-3">2018.03 - 至今</h4>

<ul>
  <li>Company: Joysae</li>
  <li>Location: 成都</li>
  <li>Position: 区块链及后端开发</li>
</ul>

<h4 id="section-4">2016.03 - 2018.03</h4>

<ul>
  <li>Company: 咕咚</li>
  <li>Location: 成都</li>
  <li>Position: 电商研发</li>
</ul>

<h4 id="section-5">2014.12 - 2016.03</h4>

<ul>
  <li>
    <p>Company: tap4fun</p>
  </li>
  <li>
    <p>Location: 成都</p>
  </li>
  <li>
    <p>Position: 运维开发</p>
  </li>
</ul>

<h4 id="section-6">2013.12 - 2014.12</h4>

<ul>
  <li>
    <p>Company: 百度</p>
  </li>
  <li>
    <p>Location: 上海</p>
  </li>
  <li>
    <p>Position: 运维开发</p>
  </li>
</ul>

<h4 id="section-7">2013.1 - 2013.8</h4>

<ul>
  <li>
    <p>Company: 惠普(中国)</p>
  </li>
  <li>
    <p>Location: 上海</p>
  </li>
  <li>
    <p>Position: 打印机app开发(实习)</p>
  </li>
</ul>

<h3 id="section-8">项目经验</h3>

<h4 id="panda-earthjoysaehttpspandaearth">1. <a href="https://panda.earth/">Panda Earth(Joysae)</a></h4>

<p><strong>环境及工具:</strong> ethereum,solidity,golang,mysql etc.</p>

<p><strong>项目描述:</strong> Panda Earth是基于以太坊的ERC721 Dapp,作为区块链开发，完成智能合约开发，及其后端中心化服务开发.在项目开发中，解决交易可靠性提交等多个技术难题，同时完成多个工具库并开源到github供其他以太坊开发者使用.</p>

<h4 id="magic-boxjoysaehttpsethmagicboxneocitiesorg">2. <a href="https://ethmagicbox.neocities.org/">Magic Box(Joysae)</a></h4>

<p><strong>环境及工具:</strong> ethereum,solidity,golang,mysql,cayley,web3js etc.</p>

<p><strong>项目描述:</strong> 此项目为自发的个人兴趣项目，前后端及其区块链均个人独立完成;主要将基于以太坊的有趣的想法实现集成到一个工具箱，比如，以太备注，交易取消，资金网络等等.</p>

<h4 id="section-9">3. 咕咚电商(咕咚)</h4>

<p><strong>环境及工具:</strong> linux,golang,mysql,redis</p>

<p><strong>项目描述:</strong> 作为咕咚电商核心研发,搭建完成咕咚电商平台,提供咕咚用户购买运动相关商品及赛事奖牌的功能</p>

<ol>
  <li>商品系统,重构并优化商品系统,组织起sku-spu逻辑概念,简化库存设计,优化性能</li>
  <li>订单系统,拆分并简化订单系统,保证系统的扩展性</li>
  <li>发货系统,发货系统支持自由仓储及多个三方仓储,提升发货效率至1天</li>
  <li>促销系统,大规模重构促销系统,使得从产品到研发易于支持新的促销逻辑,目前支持团购、秒杀、套餐等多种促销模式</li>
  <li>秒杀系统,完成秒杀系统开发,有处理大规模并发流量经验</li>
</ol>

<h4 id="web">4. Web网关(咕咚)</h4>

<p><strong>环境及工具:</strong> linux,golang,redis</p>

<p><strong>项目描述:</strong> 独立设计完成咕咚H5网关webmiddleware,为咕咚h5请求提供的统一session管理,同时实现流控,服务自动降级,频控等安全策略</p>

<h4 id="ioptap4fun">5. 智能运维系统iOP(tap4fun)</h4>

<p><strong>环境及工具:</strong> linux, ruby on rails, mongodb, angularJs, coffee-script</p>

<p><strong>项目描述:</strong>  系统为了完成运维自动化，提升运维效率，主要包含了以下几大功能:</p>

<ol>
  <li>自动部署: 运维同学在iOP中编辑部署模板，配置好部署针对的目标机器，需要执行的命令及每个命令脚本的执行顺序，提交后iOP按照配置自动完成代码从产品库到线上的发布变更</li>
  <li>流程管理: iOP内部抽象完成出一套工作流引擎<a href="https://github.com/qjpcpu/taskflow-mongoid">TaskFlow</a>，该引擎的执行步骤可重用可配置，驱动整个iOP的工单数据流</li>
  <li>机器操作: 底层封装aws及阿里云，屏蔽其细节，统一对运维提供开服/关服/开关机等机器操作</li>
  <li>镜像备份: 根据配置自动备份机器实例，完成灾备</li>
  <li>权限管理: 所有用户根据自己角色决定了资源的可见性和可操作性，同时和线上机器登录权限保持同步</li>
  <li>配置: 其他运维元数据的配置管理</li>
</ol>

<h4 id="tap4fungithubhttpsgithubcomqjpcpuwechatnotifier">6. 微信消息平台(tap4fun)<a href="https://github.com/qjpcpu/WeChatNotifier">github地址</a></h4>

<p><strong>环境及工具:</strong> linux, nodejs, requirejs, gulp, coffee-script, leveldb</p>

<p><strong>项目描述:</strong> 为企业内部提供消息推送服务及单点登录</p>

<ol>
  <li>消息推送: 利用该平台，企业各内部系统可以利用微信向员工推送消息</li>
  <li>消息响应: 内部系统可以被动响应消息，从而达到将微信作为交互平台的目的</li>
  <li>单点登录: 企业内部系统可以利用微信消息平台作为单点登录,有效解决中小型企业的登录安全性及便利性</li>
</ol>

<h4 id="tap4fun">7. 统一认证系统(tap4fun)</h4>

<p><strong>环境及工具:</strong> linux, ruby on rails, mongodb</p>

<p><strong>项目描述:</strong> 使用google Oauth2完成内部员工单点登录认证</p>

<h4 id="section-10">8. 流式监控系统(百度)</h4>

<p><strong>环境及工具:</strong> linux, ruby, mysql, emacs, sinatra</p>

<p><strong>项目描述:</strong> 监控流式计算系统当前的任务处理情况,并能自动定位故障。前端使用sinatra框架完成,使用了ajax和coffeescript等技术,后端任务用ruby+bash完成,数据存储在项目前期后期分别选用了mongodb和mysql</p>

<h4 id="section-11">9. 机器管理系统(百度)</h4>

<p><strong>环境及工具:</strong> linux, ruby, mysql, emacs</p>

<p><strong>项目描述:</strong> 管理机器池的机器自动安装,环境自动初始化,机器数量千台以上。首先,自动检测机器是否故障,如果有故障则自动完成送修,送修完成自动挂回。如无故障则进行机器重装,安装各种初始化环境等 。系统前端采用rails编写,后端混合ruby和bash,数据交互使用mysql数据库,自动操作利用状态机设计完成</p>

<h4 id="githubhttpsgithubcomqjpcpujreport">10. 快速报表开发框架(百度)<a href="https://github.com/qjpcpu/jreport">github地址</a></h4>

<p><strong>环境及工具:</strong> linux, ruby , emacs</p>

<p><strong>项目描述:</strong>  一套快速报表开发框架,基于该框架最快可以在10分钟内开发出一套邮件报表,是一套针对报表专门设计开发的类rails框架</p>

<h4 id="golanggithubhttpsgithubcomqjpcpusexy-ssh">11. 基于golang的批量工具(百度)<a href="https://github.com/qjpcpu/sexy-ssh">github地址</a></h4>

<p><strong>环境及工具:</strong> linux, golang</p>

<p><strong>项目描述:</strong> 基于ssh协议的批量操作工具,功能强大部署简单。 能完成批量任务执行及文件复制,任务执行能力强,使用go语言开发完成</p>

<h4 id="app">12. 打印机app(惠普中国)</h4>

<p><strong>环境及工具:</strong> windows, java, serverlet, jsp</p>

<p><strong>项目描述:</strong> 惠普打印机无线打印app。无须电脑,打印机上直接浏览网盘文件进行预览及打印</p>

<h3 id="section-12">技能概览</h3>

<h4 id="section-13">编程语言</h4>

<ul>
  <li>区块链; 精通以太坊，熟悉合约开发及整个生态工具链,熟悉其他区块链技术</li>
  <li>golang; 精通go语言</li>
  <li>ruby; 精通ruby,5年+经验</li>
  <li>solidity; 熟练使用开发Dapp,了解solidity开发各种安全细节</li>
  <li>coffee-script; 熟悉coffee，能熟练用来开发前端页面或后端node程序</li>
  <li>shell; 2年以上linux运维，能熟练使用shell管理linux</li>
  <li>java/C#/C/Python; 基本了解</li>
</ul>

<h4 id="section-14">操作系统</h4>

<ul>
  <li>2年以上linux运维经验, 长期linux使用经验</li>
  <li>自己编译过linux系统，并翻译过LFS，译本见<a href="https://github.com/qjpcpu/LFS">Linux from scratch</a></li>
</ul>

<h4 id="section-15">数据库</h4>

<ul>
  <li>有基于mongodb, mysql开发经验</li>
</ul>

<h4 id="web-1">web开发</h4>

<ul>
  <li>熟悉ruby及js的web开发技术</li>
  <li>熟悉前端新技术angularJS</li>
</ul>

<h4 id="section-16">服务器开发</h4>

<ul>
  <li>熟练利用ruby/golang进行服务端开发</li>
</ul>

<h3 id="section-17">自我评价</h3>

<ul>
  <li>好奇心，对新技术有极强的热情和好奇心，热爱拥抱新的技术动向</li>
  <li>自我激励，一旦认定目标，会投入100%精力完成</li>
  <li>崇拜Google</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[新建angular项目]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/11/25/xin-jian-angularxiang-mu/"/>
    <updated>2014-11-25T10:54:31+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/11/25/xin-jian-angularxiang-mu</id>
    <content type="html"><![CDATA[<h2 id="section">需要的工具</h2>

<ul>
  <li><a href="http://bower.io/">bower</a> 前端包管理器</li>
  <li><a href="http://gruntjs.com/">grunt</a> javascript的makefile工具</li>
  <li><a href="http://yeoman.io/">yeoman</a>  webapp的流行脚手架</li>
  <li><a href="http://karma-runner.github.io/0.12/index.html">karma</a> 测试套件</li>
</ul>

<p>这里我使用了yeoman的一个angularJS的生成器<a href="https://github.com/yeoman/generator-angular">yo</a>，方便生成需要的全部零部件</p>

<!-- more -->

<h2 id="section-1">新建工程</h2>

<p>我们要建立的angularjs工程的项目名称叫<code>MyAngularApp</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">mkdir MyAngularApp
</span><span class="line"><span class="nb">cd </span>MyAngularApp
</span><span class="line"><span class="c"># 这里我习惯用coffee来写代码，如果直接用javascript可以去掉后面的参数--coffee</span>
</span><span class="line">yo angular --coffee
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>生成的目录结构如下：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">MyAngularApp
</span><span class="line">├── Gruntfile.js
</span><span class="line">├── README.md
</span><span class="line">├── app
</span><span class="line">│   ├── 404.html
</span><span class="line">│   ├── favicon.ico
</span><span class="line">│   ├── images
</span><span class="line">│   ├── index.html
</span><span class="line">│   ├── robots.txt
</span><span class="line">│   ├── scripts
</span><span class="line">│   ├── styles
</span><span class="line">│   └── views
</span><span class="line">├── bower.json
</span><span class="line">├── bower_components
</span><span class="line">│   ├── angular
</span><span class="line">│   ├── angular-animate
</span><span class="line">│   └── ......
</span><span class="line">├── node_modules
</span><span class="line">│   ├── coffee-script
</span><span class="line">│   └── ......
</span><span class="line">├── package.json
</span><span class="line">└── <span class="nb">test</span>
</span><span class="line">    ├── karma.conf.coffee
</span><span class="line">    └── spec
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>其中，<code>Gruntfile.js</code>是grunt的makefile文件，里面定义了各种编译任务，如常用的<code>grunt serve</code>和<code>grunt build</code>。</p>

<p><code>app</code>目录是主要的工作目录，下面的<code>scripts</code>目录放置所有的controller，<code>styles</code>放置各种css文件，<code>views</code>放置视图模板；也可以在<code>app</code>下防止自己的资源文件夹如<code>vendor</code>目录，放置第三方库。</p>

<p><code>bower.json</code>中定义了需要安装的库，功能类似于ruby的Gemfile文件，在工程根目录执行<code>bower install</code>安装依赖。所有的依赖库都会被安装到<code>bower_components</code>目录中。</p>

<p><code>node_modules</code>是项目工具如coffee或者grunt的依赖工具。</p>

<p><code>package.json</code>是grunt的依赖工具。</p>

<p><code>test</code>是测试文件所在。</p>

<h2 id="indexhtml">index.html</h2>

<p>yo的常用操作可以参考其github文档。这里需要补充说一下的是<code>app/index.html</code>文件，该文件是angular项目的起始文件。注意其中类似下面这样的语句：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- build:css({.tmp,app}) styles/main.css --&gt;</span>
</span><span class="line"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;styles/main.css&quot;</span><span class="nt">&gt;</span>
</span><span class="line"><span class="c">&lt;!-- endbuild --&gt;</span>
</span><span class="line">
</span><span class="line"><span class="c">&lt;!-- build:js(.) scripts/vendor.js --&gt;</span>
</span><span class="line"><span class="c">&lt;!-- bower:js --&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular/angular.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-animate/angular-animate.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-cookies/angular-cookies.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-resource/angular-resource.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-route/angular-route.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-sanitize/angular-sanitize.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;bower_components/angular-touch/angular-touch.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="c">&lt;!-- endbower --&gt;</span>
</span><span class="line"><span class="c">&lt;!-- endbuild --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>要注意的是<code>&lt;!-- build:css(DIRECTORY) OUT_FILE --&gt;</code>和<code>&lt;!-- build:js(DIRECTORY) OUTFILE --&gt;</code>，它们并不是普通的html注释，而是grunt的指令。</p>

<p>比如第一段，grunt会将<code>build:css</code>到<code>endbuild</code>之间的css文件找到，查找路径是<code>build:css(DIRECTORY)</code>中的目录加上<code>link</code>标签里的<code>href</code>指定的文件路径所在文件，即<code>.tmp/styles/main.css</code>和<code>app/styles/main.css</code>,然后grunt将它们合并压缩为一个css文件<code>styles/main.css</code>，这个文件被生成在输入目录，通常是<code>dist/styles/main.css</code>。</p>

<p>类似的，下面的js编译将当前目录<code>.</code>下指定的<code>bower_components</code>下的一些js合并压缩后变成<code>dist/scripts/vendor.js</code>。</p>

<p>所以，自己引入的一些第三方库怎么弄也就清楚了：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- build:css(app) assets/css/vendor.css --&gt;</span>
</span><span class="line"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;assets/css/animate.min.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;assets/plugins/gritter/css/jquery.gritter.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line"><span class="c">&lt;!-- endbuild --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="grunt">grunt</h2>

<p>最后说一下grunt的任务，如果在app目录有个<code>assets/img</code>目录，里面放了一些图片，希望执行<code>grunt build</code>后将这些资源复制到输出目录，那么可以对<code>Gruntfile.js</code>做简单修改，如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// Copies remaining files to places other tasks can use</span>
</span><span class="line"><span class="nx">copy</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">dist</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">files</span><span class="o">:</span> <span class="p">[{</span>
</span><span class="line">      <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">      <span class="nx">dot</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">      <span class="nx">cwd</span><span class="o">:</span> <span class="s1">&#39;&lt;%= yeoman.app %&gt;&#39;</span><span class="p">,</span>
</span><span class="line">      <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;&lt;%= yeoman.dist %&gt;&#39;</span><span class="p">,</span>
</span><span class="line">      <span class="nx">src</span><span class="o">:</span> <span class="p">[</span>
</span><span class="line">        <span class="s1">&#39;*.{ico,png,txt}&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s1">&#39;.htaccess&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s1">&#39;*.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s1">&#39;views/{,*/}*.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s1">&#39;images/{,*/}*.{webp}&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="s1">&#39;assets/{,img/*.*,fonts/*.*}&#39;</span><span class="p">,</span>   <span class="c1">//这里添加了一行,也可以直接复制整个文件夹 &#39;assets/**&#39;</span>
</span><span class="line">        <span class="s1">&#39;fonts/{,*/}*.*&#39;</span>
</span><span class="line">      <span class="p">]</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[tmux]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/09/08/tmux/"/>
    <updated>2014-09-08T00:37:23+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/09/08/tmux</id>
    <content type="html"><![CDATA[<h3 id="section">基本操作</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">tmux new -s SESSION_NAME  <span class="c"># 新建会话</span>
</span><span class="line">tmux new -s SESSION_NAME -d <span class="c"># 新建会话并放入后台</span>
</span><span class="line">tmux ls <span class="c"># 列出所有会话</span>
</span><span class="line">tmux attach -t SESSION_NAME <span class="c"># 进入某会话</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!--more-->

<h3 id="section-1">命令列表</h3>

<p>默认情况下，tmux的前导命令开关是<code>Ctrl+b</code>，按了<code>Ctrl+b</code>后再按下面的命令，即执行相应操作：</p>

<h4 id="section-2">会话类</h4>

<table>
  <thead>
    <tr>
      <th>键位</th>
      <th>操作描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>?</td>
      <td>显示所有快捷键，按q退出</td>
    </tr>
    <tr>
      <td><strong>d</strong></td>
      <td><strong>脱离当前会话；这样可以暂时返回Shell界面，输入tmux attach能够重新进入之前的会话</strong></td>
    </tr>
    <tr>
      <td>D</td>
      <td>选择要脱离的会话；在同时开启了多个会话时使用</td>
    </tr>
    <tr>
      <td><strong>s</strong></td>
      <td><strong>选择并切换会话；在同时开启了多个会话时使用</strong></td>
    </tr>
    <tr>
      <td>:</td>
      <td>进入命令行模式；此时可以输入支持的命令，例如kill-server可以关闭服务器</td>
    </tr>
    <tr>
      <td>[</td>
      <td>进入复制模式；此时的操作与vi/emacs相同，按q/Esc退出</td>
    </tr>
  </tbody>
</table>

<h4 id="section-3">窗口类</h4>

<table>
  <thead>
    <tr>
      <th>键位</th>
      <th>操作描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>c</strong></td>
      <td><strong>创建新窗口</strong></td>
    </tr>
    <tr>
      <td><strong>&amp;</strong></td>
      <td><strong>关闭当前窗口</strong></td>
    </tr>
    <tr>
      <td><strong>数字键</strong></td>
      <td><strong>切换至指定窗口</strong></td>
    </tr>
    <tr>
      <td>p</td>
      <td>切换至上一窗口</td>
    </tr>
    <tr>
      <td>n</td>
      <td>切换至下一窗口</td>
    </tr>
    <tr>
      <td>l</td>
      <td>在前后两个窗口间互相切换</td>
    </tr>
    <tr>
      <td><strong>w</strong></td>
      <td><strong>通过窗口列表切换窗口</strong></td>
    </tr>
    <tr>
      <td><strong>,</strong></td>
      <td><strong>重命名当前窗口；这样便于识别</strong></td>
    </tr>
    <tr>
      <td><strong>.</strong></td>
      <td><strong>修改当前窗口编号；相当于窗口重新排序</strong></td>
    </tr>
    <tr>
      <td>!</td>
      <td>将当前面板置于新窗口；即新建一个窗口，其中仅包含当前面板</td>
    </tr>
  </tbody>
</table>

<h4 id="section-4">面板类</h4>

<table>
  <thead>
    <tr>
      <th>键位</th>
      <th>操作描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>”</strong></td>
      <td><strong>将当前面板平分为上下两块</strong></td>
    </tr>
    <tr>
      <td><strong>%</strong></td>
      <td><strong>将当前面板平分为左右两块</strong></td>
    </tr>
    <tr>
      <td><strong>x</strong></td>
      <td><strong>关闭当前面板</strong></td>
    </tr>
    <tr>
      <td><strong>o</strong></td>
      <td><strong>在当前窗口中选择下一面板</strong></td>
    </tr>
    <tr>
      <td>q</td>
      <td>显示面板编号</td>
    </tr>
  </tbody>
</table>

<h3 id="section-5">其他</h3>

<p>如果不想使用默认tmux server，或者同一用户想起多个tmux实例，可以使用<code>-S</code>参数指定不同的unix socket：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">tmux -S /path/to/another/unix/socket-file
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在tmux里使用zsh有时会导致窗口名称会不断变化，这需要修改下<code>~/.zshrc</code>文件：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">DISABLE_AUTO_TITLE</span><span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-6">可编程</h4>

<p>tmux最强大的地方还在于他的可编程性，用<code>tmux list-commands</code>可以看到tmux所有支持的命令。以我自己常执行的一个脚本为例，我开机后常常需要启动一系列服务便于开发, 但当我不开发时开电脑又不需要启动，所以放到开机自启动脚本里是不合适的，所以这里用tmux来批量起最合适了：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/zsh</span>
</span><span class="line"><span class="c"># start tmux</span>
</span><span class="line"><span class="nv">session</span><span class="o">=</span>MAC
</span><span class="line">tmux new -s <span class="s2">&quot;$session&quot;</span> -d
</span><span class="line">tmux rename-window -t <span class="s2">&quot;$session:0&quot;</span> daemon
</span><span class="line"><span class="c"># start redis-server</span>
</span><span class="line">tmux send -t <span class="s2">&quot;$session:daemon&quot;</span> <span class="s1">&#39;redis-server&#39;</span> Enter
</span><span class="line">tmux split-window -h -t <span class="s2">&quot;$session:daemon&quot;</span>
</span><span class="line"><span class="c"># start mongo</span>
</span><span class="line">tmux send -t <span class="s2">&quot;$session:daemon&quot;</span> <span class="s1">&#39;mongod --dbpath /Users/jason/local/var/mongodb-data&#39;</span> Enter
</span><span class="line"><span class="c"># start nginx</span>
</span><span class="line">tmux split-window  -t <span class="s2">&quot;$session:daemon&quot;</span> <span class="s1">&#39;/Users/jason/local/nginx/sbin/nginx&#39;</span>
</span><span class="line">tmux <span class="k">select</span>-pane -L -t <span class="s2">&quot;$session:daemon&quot;</span>
</span><span class="line">tmux split-window -t <span class="s2">&quot;$session:daemon&quot;</span>
</span><span class="line"><span class="c"># start firefox with pentadactyl</span>
</span><span class="line">tmux send -t <span class="s2">&quot;$session:daemon&quot;</span> <span class="s1">&#39;/Applications/Firefox.app/Contents/MacOS/firefox -pentadactyl +u NONE&#39;</span> Enter
</span><span class="line">tmux <span class="k">select</span>-pane -R -t <span class="s2">&quot;$session:daemon&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c"># for develop project</span>
</span><span class="line">tmux neww -a -n dev -t <span class="s2">&quot;$session&quot;</span>
</span><span class="line">tmux send -t <span class="s2">&quot;$session:dev&quot;</span> <span class="s1">&#39;cd /Users/jason/repository/backend&#39;</span> Enter
</span><span class="line">tmux split-window -t <span class="s2">&quot;$session:dev&quot;</span>
</span><span class="line">tmux send -t <span class="s2">&quot;$session:dev&quot;</span> <span class="s1">&#39;cd /Users/jason/repository/frontend&#39;</span> Enter
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个脚本启动一个名为<code>MAC</code>的tmux session，并新建了两个窗口，在第一个窗口里开了4个面板，分别启动了nginx, redis, mongo， firefox。其中，开启窗口/面板时同时执行命令，该窗口/面板会在命令执行结束后自动关闭，所以第一个窗口最后实际只有3个面板；第二个窗口启动并切换到我正则开发的工程。</p>

<p>具体命令的使用可以参照该示例和man手册理解。</p>

<p>enjoy tmux!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识hadoop及map-reduce]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/09/03/chu-shi-hadoopji-map-reduce/"/>
    <updated>2014-09-03T20:40:36+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/09/03/chu-shi-hadoopji-map-reduce</id>
    <content type="html"><![CDATA[<h2 id="hadoop">搭建hadoop环境</h2>

<p>hadoop环境搭建具体可以参考<a href="http://hadoop.apache.org/docs/r1.2.1/single_node_setup.html">官方文档</a>。</p>

<h2 id="maven">搭建配置maven</h2>

<p>map-reduce任务支持多种语言，但对java支持是最好的，所以这里说一下怎么搭建java的编译环境。</p>

<p>首先编译安装maven，并将<code>MAVEN_HOME/bin</code>加入PATH环境变量，这样就可以直接使用<code>mvn</code>命令了。这里说一下怎么利用maven编译生成我们后续示例中的jar包。</p>

<h3 id="maven-1">1. 使用maven新建一个工程</h3>

<p>下面的命令创建一个包含java类<code>org.myorg.WordCount</code>的工程<code>WordCount</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">mvn archetype:create -DgroupId<span class="o">=</span>org.myorg -DartifactId<span class="o">=</span>WordCount
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!--more-->

<p>工程结构如图：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">WordCount
</span><span class="line">├── pom.xml
</span><span class="line">└── src
</span><span class="line">    ├── main
</span><span class="line">    │   └── java
</span><span class="line">    │       └── org
</span><span class="line">    │           └── myorg
</span><span class="line">    │               └── App.java
</span><span class="line">    └── <span class="nb">test</span>
</span><span class="line">        └── java
</span><span class="line">            └── org
</span><span class="line">                └── myorg
</span><span class="line">                    └── AppTest.java
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>将<code>WordCount/src/main/java/org/myorg/App.java</code>重命名为<code>WordCount/src/main/java/org/myorg/WordCount.java</code>，并将示例代码复制进去，代码的细节稍后再看。</p>

<p>由于java类中依赖于hadoop的java包，所以在maven的配置文件<code>pom.xml</code>标签对<code>&lt;dependencies/&gt;</code>内添加java类文件里引用的依赖：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>WordCount/pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">  <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">  <span class="nt">&lt;artifactId&gt;</span>hadoop-mapreduce-client-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">  <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">  <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">  <span class="nt">&lt;artifactId&gt;</span>hadoop-common<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">  <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">  <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">  <span class="nt">&lt;artifactId&gt;</span>hadoop-mapreduce-client-common<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">  <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">  <span class="nt">&lt;groupId&gt;</span>org.apache.hadoop<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">  <span class="nt">&lt;artifactId&gt;</span>hadoop-mapreduce-client-jobclient<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">  <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="jar">2.编译生成jar包</h3>

<p>在WordCount根目录下执行：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">mvn package
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>就生成了我们需要的<code>WordCount/target/WordCount-1.0-SNAPSHOT.jar</code>文件。</p>

<h2 id="wordcount">执行示例程序WordCount</h2>

<p>示例程序是一个单词计数程序，输入文件有两个：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">file01</span>
</span><span class="line"><span class="o">=======================</span>
</span><span class="line">Hello World Bye World
</span><span class="line">
</span><span class="line"><span class="nv">file02</span>
</span><span class="line"><span class="o">=======================</span>
</span><span class="line">Hello Hadoop Goodbye Hadoop
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>### 1.上传数据文件</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#创建目录</span>
</span><span class="line">hdfs dfs -mkdir /user
</span><span class="line">hdfs dfs -mkdir /user/hadoop
</span><span class="line"><span class="c">#上传文件</span>
</span><span class="line">hdfs dfs -put file01 /user/hadoop/input
</span><span class="line">hdfs dfs -put file02 /user/hadoop/input
</span><span class="line"><span class="c">#查看文件是否上传上去了</span>
</span><span class="line">hdfs dfs -ls /user/hadoop/input
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="map-reduce">2.提交并执行map-reduce任务</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">hadoop jar WordCount-1.0-SNAPSHOT.jar org.myorg.WordCount /user/hadoop/input /user/hadoop/output
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section">3.获取结果</h3>

<p>当任务执行完毕在输出目录会生成_SUCCESS文件：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">hdfs dfs -ls /user/hadoop/output
</span><span class="line"><span class="c">#输出是：</span>
</span><span class="line">-rw-r--r--   1 hadoop supergroup          0 2014-09-03 20:20 /user/hadoop/output/_SUCCESS
</span><span class="line">-rw-r--r--   1 hadoop supergroup         41 2014-09-03 20:20 /user/hadoop/output/part-00000
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>查看结果：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">hdfs dfs -cat /user/hadoop/output/part-00000
</span><span class="line"><span class="c">#输出：</span>
</span><span class="line">Bye	1
</span><span class="line">Goodbye	1
</span><span class="line">Hadoop	2
</span><span class="line">Hello	2
</span><span class="line">World	2
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="map-reduce-1">Map-Reduce</h2>

<p>回过头来再看执行map-reduce的这个java类<code>WordCount.java</code>，该类包含了两个静态内部类<code>Map</code>和<code>Reduce</code>，都继承了<code>MapReduceBase</code>基类，并各自实现了<code>Mapper</code>和<code>Reducer</code>接口。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>WordCount/src/main/java/org/myorg/WordCount.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">myorg</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.fs.Path</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.conf.*</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.io.*</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.mapred.*</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.hadoop.util.*</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordCount</span> <span class="o">{</span>
</span><span class="line"><span class="c1">//执行map操作的静态类</span>
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Map</span> <span class="kd">extends</span> <span class="n">MapReduceBase</span> <span class="kd">implements</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">LongWritable</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class="line">	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">IntWritable</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntWritable</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class="line">	<span class="kd">private</span> <span class="n">Text</span> <span class="n">word</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Text</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">map</span><span class="o">(</span><span class="n">LongWritable</span> <span class="n">key</span><span class="o">,</span> <span class="n">Text</span> <span class="n">value</span><span class="o">,</span> <span class="n">OutputCollector</span><span class="o">&lt;</span><span class="n">Text</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">&gt;</span> <span class="n">output</span><span class="o">,</span> <span class="n">Reporter</span> <span class="n">reporter</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class="line">	    <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class="line">	    <span class="n">StringTokenizer</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
</span><span class="line">	    <span class="k">while</span> <span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">hasMoreTokens</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">		<span class="n">word</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">());</span>
</span><span class="line">		<span class="c1">//OutputCollector以单词本身为键，出现次数为键值进行计数，这里每出现一次计数1</span>
</span><span class="line">		<span class="n">output</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">one</span><span class="o">);</span>
</span><span class="line">	    <span class="o">}</span>
</span><span class="line">	<span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="c1">//执行reduce操作的静态类</span>
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Reduce</span> <span class="kd">extends</span> <span class="n">MapReduceBase</span> <span class="kd">implements</span> <span class="n">Reducer</span><span class="o">&lt;</span><span class="n">Text</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class="line">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Text</span> <span class="n">key</span><span class="o">,</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">IntWritable</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">,</span> <span class="n">OutputCollector</span><span class="o">&lt;</span><span class="n">Text</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">&gt;</span> <span class="n">output</span><span class="o">,</span> <span class="n">Reporter</span> <span class="n">reporter</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class="line">	    <span class="c1">//map后的结果是同一个key对应一个value的列表，所以这里遍历values迭代器，累加所有值，即得到每个单词计数值</span>
</span><span class="line">	    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">	    <span class="k">while</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">		<span class="n">sum</span> <span class="o">+=</span> <span class="n">values</span><span class="o">.</span><span class="na">next</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">	    <span class="o">}</span>
</span><span class="line">	    <span class="n">output</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="n">IntWritable</span><span class="o">(</span><span class="n">sum</span><span class="o">));</span>
</span><span class="line">	<span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">	<span class="n">JobConf</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobConf</span><span class="o">(</span><span class="n">WordCount</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setJobName</span><span class="o">(</span><span class="s">&quot;wordcount&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setOutputKeyClass</span><span class="o">(</span><span class="n">Text</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setOutputValueClass</span><span class="o">(</span><span class="n">IntWritable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setMapperClass</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setCombinerClass</span><span class="o">(</span><span class="n">Reduce</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setReducerClass</span><span class="o">(</span><span class="n">Reduce</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setInputFormat</span><span class="o">(</span><span class="n">TextInputFormat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">	<span class="n">conf</span><span class="o">.</span><span class="na">setOutputFormat</span><span class="o">(</span><span class="n">TextOutputFormat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">	<span class="n">FileInputFormat</span><span class="o">.</span><span class="na">setInputPaths</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
</span><span class="line">	<span class="n">FileOutputFormat</span><span class="o">.</span><span class="na">setOutputPath</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
</span><span class="line">
</span><span class="line">	<span class="n">JobClient</span><span class="o">.</span><span class="na">runJob</span><span class="o">(</span><span class="n">conf</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>Mapper</code>接口是一个泛型接口,该接口4个参数分别指定了map方法的<code>输入键值，输入值，输出键值，输出值</code>类型。 类似的<code>Reducer</code>接口也是个泛型接口，它的前两个参数和map的后两个参数类型对应，从而也间接决定了后两个参数的类型。</p>

<p>简而言之，map的过程是把一行行的输入变成：</p>

<p>key1 =&gt; val1</p>

<p>key2 =&gt; val2</p>

<p>key3 =&gt; val1</p>

<p>而reduce的输入是排序过后map的输出：</p>

<p>key1 =&gt; [val1,val…..]</p>

<p>key2 =&gt; [val2,val…..]</p>

<p>…</p>

<p>reduce的操作就是把这个输入合并成我们想要的东西。</p>

<p>最后，<code>WordCount</code>类的<code>main</code>方法里设置输入输出，然后执行任务。</p>

<h2 id="streamingmap-reduce">以streaming方式执行map-reduce任务</h2>

<p>通常来说，简单的map-reduce任务还是用脚本来写比较快，比如ruby,python或者linux shell，这里使用bash来重写一次这个单词计数。</p>

<h3 id="map">1. map程序</h3>

<p>hadoop的streaming是流式处理，即上一操作的输入作为下一操作的输出，基本可以等价用管道来看：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">cat data-file | mapper.sh | sort | reducer.sh
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>输入输出都是走的标准输入输出，所以改写的map程序非常简单：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>map.sh map操作</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line">awk <span class="s1">&#39;{for(i=1;i&lt;=NF;i++) print $i&quot; 1&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="reduce">2. reduce程序</h3>

<p>类似的重写reduce：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>reduce.sh  reduce操作</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line">awk <span class="s1">&#39;{arr[$1]+=1}END{for(k in arr) print k&quot; &quot;arr[k]}&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="streaming">3. 提交streaming任务</h3>

<p>提交streaming类型的任务需要指定一个额外的jar包<code>$HADOOP_HOME/share/hadoop/tools/lib/hadoop-streaming-2.4.1.jar</code>，还要在命令里指出map和recude的脚本</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">hadoop jar <span class="nv">$HADOOP_HOME</span>/share/hadoop/tools/lib/hadoop-streaming-2.4.1.jar  -input <span class="s1">&#39;/user/hadoop/input/*&#39;</span> -output <span class="s1">&#39;/user/hadoop/output1&#39;</span> -mapper map.sh -reducer reduce.sh
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>任务执行的结果和之前是一致的：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">hdfs dfs -cat /user/hadoop/output1/part-00000
</span><span class="line"><span class="c">#输出:</span>
</span><span class="line">Hadoop 2
</span><span class="line">Goodbye 1
</span><span class="line">Bye 1
</span><span class="line">Hello 2
</span><span class="line">World 2
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用octopress搭建github pages]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/08/31/shi-yong-octopressda-jian-github-pages/"/>
    <updated>2014-08-31T17:36:06+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/08/31/shi-yong-octopressda-jian-github-pages</id>
    <content type="html"><![CDATA[<h2 id="gitruby">安装git,ruby</h2>
<p>略</p>

<h2 id="octopress">安装octopress并搭建博客</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">git clone git://github.com/imathis/octopress.git octopress
</span><span class="line"><span class="nb">cd </span>octopress
</span><span class="line">bundle install
</span><span class="line">rake install
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!-- more -->

<p>初始化博客</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rake setup_github_pages
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>编辑<code>_config.yml</code>写入博客名和其他信息</p>

<p>开始书写博客：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rake new_page<span class="o">[</span><span class="s2">&quot;About&quot;</span><span class="o">]</span>    <span class="c"># 添加博客页</span>
</span><span class="line">rake new_post<span class="o">[</span><span class="s2">&quot;First Post!&quot;</span><span class="o">]</span>  <span class="c"># 新建一篇文章</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>发布到github</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>deploy.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rake generate      <span class="c"># 生成页面</span>
</span><span class="line"><span class="c">#rake preview       # 如果需要在本地预览生成的结果，预览页http://localhost:4000</span>
</span><span class="line">rake deploy        <span class="c">#发布到github</span>
</span><span class="line"><span class="c"># 发布到github的pages在master分支，还要保存源的source分支</span>
</span><span class="line">git add .
</span><span class="line">git commit -m <span class="s1">&#39;Added About page and first post!&#39;</span>
</span><span class="line">git push origin <span class="nb">source</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section">在另外机器编辑博客</h2>

<p>如果更换了电脑，在新机器上编辑写博客，不需要重新搭建一遍：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>get_my_blog.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">git clone git@github.com:username/username.github.com.git
</span><span class="line"><span class="nb">cd </span>username.github.com
</span><span class="line">git checkout <span class="nb">source</span>
</span><span class="line">mkdir _deploy
</span><span class="line"><span class="nb">cd </span>_deploy
</span><span class="line">git init
</span><span class="line">git remote add origin git@github.com:username/username.github.com.git
</span><span class="line">git pull origin master
</span><span class="line"><span class="nb">cd</span> ..
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mysql常用命令]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/08/21/mysqlchang-yong-ming-ling/"/>
    <updated>2014-08-21T11:05:13+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/08/21/mysqlchang-yong-ming-ling</id>
    <content type="html"><![CDATA[<h3 id="mysql">1.远程链接mysql</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">mysql -h主机地址 -u用户名 －p用户密码 －P 端口号
</span><span class="line">grant all on *.* to ‘用户名’@’主机地址’ identified by ‘密码’
</span><span class="line">grant select on 数据库.* to 用户名@登录主机 identified by \"密码\"</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section">2.修改密码</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">mysqladmin -u用户名 -p旧密码 password 新密码</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-1">3.显示数据库列表。</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show databases</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-2">4.显示库中的数据表</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show tables</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">5.显示数据表的结构</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">describe 表名</span></code></pre></td></tr></table></div></figure></notextile></div>

<!--more-->
<p>### 6.建库</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">create database 库名</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-4">7.建表</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">create table 表名 (字段设定列表)
</span><span class="line">CREATE TABLE MYTABLE (name VARCHAR(20), sex CHAR(1))</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-5">8.删库和删表</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">drop database 库名
</span><span class="line">drop table 表名</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-6">9.将表中记录清空</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">delete from 表名
</span><span class="line">truncate table 表名</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-7">10.显示表中的记录</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">select * from 表名
</span><span class="line">select * from 表名</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-8">11.插入表</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Insert into 表名 values（字段各值）</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-9">12.更新表</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Update 表名 set 字段 = 值 where </span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-10">13.导入</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">数据传入命令 load data local infile "文件名" into table 表名
</span><span class="line">Source sql文件
</span><span class="line">./mysqlimport -u root -p123456 &lt; sql文件</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-11">14.导出</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Select * from 表名 into outfile ‘文件名’
</span><span class="line">./mysqldump –opt –database 库名 &gt; sql文件
</span><span class="line">./mysqldump –opt 库名 表名 &gt; sql文件</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-12">15.改名</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Alter table 表名 rename 新表名
</span><span class="line">Alter database 库名 rename 新库名</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-13">16.查看服务器运行状态</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show status</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>该命令将显示出一长列状态变量及其对应的值，其中包括：被中止访问的用户数量，被中止的连接数量，尝试连接的次数，并发连接数量最大值，以及其他许多有用的信息。</p>

<h3 id="grant-">17.显示一个用户的权限，显示结果类似于grant 命令</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show grants for user_name</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-14">18.显示表的索引</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show index from table_name</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-15">19.显示一些系统特定资源的信息，例如，正在运行的线程数量</h3>
<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show status</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-16">20.显示系统变量的名称和值</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show variables</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-17">21.显示系统中正在运行的所有进程，也就是当前正在执行的查询。大多数用户可以查看</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show processlist</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>他们自己的进程，但是如果他们拥有process权限，就可以查看所有人的进程，包括密码</p>

<h3 id="database">22.显示当前使用或者指定的database中的每个表的信息。信息包括表类型和表的最新更新时间</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show table status</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-18">23.显示服务器所支持的不同权限</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show privileges</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="create-database-">24.显示create database 语句是否能够创建指定的数据库</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show create database database_name</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="create-database--1">25.显示create database 语句是否能够创建指定的数据库</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show create table table_name</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="innodb">26.显示innoDB存储引擎的状态</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show innodb status</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="bdb">27.显示BDB存储引擎的日志</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show logs</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-19">28.显示最后一个执行的语句所产生的错误、警告和通知</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show warnings</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-20">29.只显示最后一个执行语句所产生的错误</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">show errors</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[golang远程调用]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/08/15/golangyuan-cheng-diao-yong/"/>
    <updated>2014-08-15T20:22:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/08/15/golangyuan-cheng-diao-yong</id>
    <content type="html"><![CDATA[<p>go语言的远程调用包<code>net/rpc</code>非常简单，而且由于go不支持动态链接，如果想要获得程序的动态性，那么就只好依赖于远程调用。</p>

<!-- more -->

<h3 id="section">服务端</h3>

<p>首先定义服务契约：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>contract.go  服务契约定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">contract</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;fmt&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Args</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">Name</span> <span class="kt">string</span>
</span><span class="line">    <span class="nx">Age</span>  <span class="kt">int</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Sign</span> <span class="kt">int</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Sign</span><span class="p">)</span> <span class="nx">Content</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="o">*</span><span class="nx">reply</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s is %v years old.&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Age</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>契约的定义规则很简单：服务函数必须满足 <code>func (t *T) MethodName(argType T1, replyType *T2) error</code>的形式，方法的第一个参数是服务接收的传入参数，第二个引用参数是返回值。契约服务的接收者可以随意定义，如此处的<code>Sign</code>，没有特别的用处。</p>

<p>然后看看服务端怎么注册服务：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go 服务端</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;contract&quot;</span>
</span><span class="line">    <span class="s">&quot;log&quot;</span>
</span><span class="line">    <span class="s">&quot;net&quot;</span>
</span><span class="line">    <span class="s">&quot;net/http&quot;</span>
</span><span class="line">    <span class="s">&quot;net/rpc&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">ct</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">Sign</span><span class="p">)</span>
</span><span class="line">    <span class="nx">rpc</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">ct</span><span class="p">)</span>
</span><span class="line">    <span class="nx">rpc</span><span class="p">.</span><span class="nx">HandleHTTP</span><span class="p">()</span>
</span><span class="line">    <span class="nx">l</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8843&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;listen error:&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">http</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-1">客户端</h3>

<p>在很多其他语言中，实现远程调用的契约，必须共享一套契约代码，比如android的远程调用，必须将服务端定义的契约编译成<code>.class</code>文件然后提供给客户端使用，否则同一个服务类是无法在客户端和服务端对应起来的。</p>

<p>但是，go是不需要的，至于为什么后面再讲。</p>

<p>回头想想也是，既然不支持动态链接，客户端怎么使用契约文件编译结果呢？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go 客户端</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;fmt&quot;</span>
</span><span class="line">    <span class="s">&quot;log&quot;</span>
</span><span class="line">    <span class="s">&quot;net/rpc&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">sync_invoke</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">DialHTTP</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8843&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;dialing:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">Name</span> <span class="kt">string</span>
</span><span class="line">        <span class="nx">Age</span>  <span class="kt">int</span>
</span><span class="line">    <span class="p">}{</span><span class="s">&quot;jack&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">}</span>
</span><span class="line">    <span class="kd">var</span> <span class="nx">reply</span> <span class="kt">string</span>
</span><span class="line">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="s">&quot;Sign.Content&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;error:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">reply</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">async_invoke</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">DialHTTP</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:8843&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;dialing:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">Name</span> <span class="kt">string</span>
</span><span class="line">        <span class="nx">Age</span>  <span class="kt">int</span>
</span><span class="line">        <span class="nx">Sex</span> <span class="kt">string</span>
</span><span class="line">    <span class="p">}{</span><span class="s">&quot;jack&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span><span class="s">&quot;male&quot;</span><span class="p">}</span>
</span><span class="line">    <span class="kd">var</span> <span class="nx">reply</span> <span class="kt">string</span>
</span><span class="line">    <span class="nx">future</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="s">&quot;Sign.Content&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class="line">    <span class="c1">// wait for call end</span>
</span><span class="line">    <span class="nx">futureResult</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">future</span><span class="p">.</span><span class="nx">Done</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">futureResult</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;error:&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">futureResult</span><span class="p">.</span><span class="nx">Reply</span><span class="p">.(</span><span class="o">*</span><span class="kt">string</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="o">*</span><span class="nx">c</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">sync_invoke</span><span class="p">()</span>
</span><span class="line">    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;get sync result:&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span><span class="line">    <span class="nx">c</span> <span class="p">=</span> <span class="nx">async_invoke</span><span class="p">()</span>
</span><span class="line">    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;get async result:&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>输出结果：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.go 客户端</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">get</span> <span class="nx">sync</span> <span class="nx">result</span><span class="p">:</span> <span class="nx">jack</span> <span class="nx">is</span> <span class="mi">23</span> <span class="nx">years</span> <span class="nx">old</span><span class="p">.</span>
</span><span class="line"><span class="nx">get</span> <span class="nx">async</span> <span class="nx">result</span><span class="p">:</span> <span class="nx">jack</span> <span class="nx">is</span> <span class="mi">23</span> <span class="nx">years</span> <span class="nx">old</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>go同时提供了同步和异步调用远程服务两种选择。代码自解释性很强，故无须赘述了。</p>

<p><strong>注意</strong>细节的同学可能发现了，上面异步调用部分的代码传递的参数结构体args和服务端定义的参数Args并不一致，那是因为go的远程调用默认采用encoding/gob编码和解码，它是一种类似与json的数据分享方式，但更加结构化，关于gob的详情可以google，这里不细说。由于使用gob，使得go的rpc可以接受<code>相似</code>结构，而不强求服务端和客户端服务参数完全一致。</p>

<p>简单来说，两个结构的<strong>导出成员</strong>完全一致，或者其中一个缺失一部分，或者其中一个多出一部分都算是相似结构。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[js异步回调与闭包]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/08/14/jsyi-bu-hui-diao-yu-bi-bao/"/>
    <updated>2014-08-14T00:20:20+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/08/14/jsyi-bu-hui-diao-yu-bi-bao</id>
    <content type="html"><![CDATA[<p>很多地方讲解<code>CoffeeScript/JavaScript</code>都用了这么一个例子：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>example.coffee  异步回调中的陷阱</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="coffee-script"><span class="line"><span class="nv">chars = </span><span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">]</span>
</span><span class="line"><span class="k">for</span> <span class="nx">ch</span> <span class="k">in</span> <span class="nx">chars</span>
</span><span class="line">  <span class="nx">setTimeout</span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class="line">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">ch</span>
</span><span class="line">  <span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!--more-->

<p>这个结果会输出<code>C C C</code>而不是<code>A B C</code>，为什么会这样是因为js的异步机制，在普通代码执行完毕后才会处理事件，而在处理时间打印console时<code>ch</code>已经是<code>C</code>了，所以三个回调都会打印<code>C</code>。</p>

<p>给出的改进版本也很直观：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>example-v2.coffee 恰当控制闭包环境中的变量</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="coffee-script"><span class="line"><span class="nv">chars = </span><span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">]</span>
</span><span class="line"><span class="k">for</span> <span class="nx">ch</span> <span class="k">in</span> <span class="nx">chars</span>
</span><span class="line">  <span class="nx">do</span> <span class="nf">(ch) -&gt;</span>
</span><span class="line">    <span class="nx">setTimeout</span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class="line">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">ch</span>
</span><span class="line">    <span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>为啥这样改呢，其实原因严格来说和闭包有关系。</p>

<p>在第一个版本里，我们用了一个匿名函数把变量ch作为环境放入闭包，但是注意这个变量的作用域在for循环所在的整个范围内可见，闭包复制了这个变量的引用，所以当匿名函数实际调用时，变量的值已经被改变，导致得不到想要的输出。</p>

<p>而第二个版本将ch以函数参数的形式复制到了闭包内，这个匿名函数里的ch作用域仅在这个闭包匿名函数小环境内，外部for循环仅改变外部的ch，所以复制到闭包内的ch是不变的；不信可以把do后面函数改成无参的，结果肯定还是打印三个C。</p>

<p>这个问题其实在别的语言同样存在，只不过其他语言很大部分都同步执行闭包，导致看不出差别，实际上是一样的，看下面的go语言示例：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>example.go golang的闭包示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;time&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">example</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span>
</span><span class="line">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span class="line">		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span><span class="line">	<span class="p">}()</span>
</span><span class="line">	<span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">example</span><span class="p">()</span>
</span><span class="line">	<span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>输出会是1而不是0.</p>

<p>所以记住一句话，使用闭包，要注意它包裹起来的环境。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[struct tags]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/07/12/struct-tags/"/>
    <updated>2014-07-12T00:07:11+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/07/12/struct-tags</id>
    <content type="html"><![CDATA[<h3 id="section">结构体标签</h3>

<p>在定义结构时，可以为struct定义一个标签，这个标签是作为结构体字段的一个附加属性，主要是反射包会使用到这个属性。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;fmt&quot;</span>
</span><span class="line">	<span class="s">&quot;reflect&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">	<span class="kd">type</span> <span class="nx">S</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">F</span> <span class="kt">string</span> <span class="s">`species:&quot;gopher&quot; color:&quot;blue&quot;`</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line">
</span><span class="line">	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">S</span><span class="p">{}</span>
</span><span class="line">	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span><span class="line">	<span class="nx">field</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">field</span><span class="p">.</span><span class="nx">Tag</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">),</span> <span class="nx">field</span><span class="p">.</span><span class="nx">Tag</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;species&quot;</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>输出结果</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">blue gopher
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>结构体<code>S</code>的<code>F</code>成员具有两个属性<code>species</code>和<code>color</code>，其属性的值分别为<code>blue</code>和<code>gopher</code>。如果不使用反射去取这个属性，在定义时写不写属性都是无所谓的。</p>

<!--more-->

<p>在go中，tag的定义是有规定的：</p>

<blockquote>
  <p>By convention, tag strings are a concatenation of optionally space-separated key:”value” pairs. Each key is a non-empty string consisting of non-control characters other than space (U+0020 ‘ ‘), quote (U+0022 ‘”’), and colon (U+003A ‘:’). Each value is quoted using U+0022 ‘”’ characters and Go string literal syntax.</p>
</blockquote>

<p>即：按照go的默认约定，tag以<code>key:value</code>的形式定义，多个<code>key:value</code>以空格分割，<code>key</code>不能是控制字符单引号、双引号和冒号，<code>value</code>需要用引号引起来。 </p>

<p>当然，也可以不遵守这个约定，因为具体怎么使用tag还是按照开发者自己的意愿来的。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[你不知道的Go]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/06/23/ni-bu-zhi-dao-de-go/"/>
    <updated>2014-06-23T14:37:47+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/06/23/ni-bu-zhi-dao-de-go</id>
    <content type="html"><![CDATA[<!-- more -->

<h3 id="section">1.匿名结构</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">var</span> <span class="nx">person</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">name</span>      <span class="kt">string</span>
</span><span class="line">    <span class="nx">age</span> <span class="kt">int</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">=</span><span class="s">&quot;jack&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>声明时初始化：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">st</span> <span class="o">:=</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">name</span> <span class="kt">string</span>
</span><span class="line">	<span class="nx">age</span>  <span class="kt">int</span>
</span><span class="line"><span class="p">}{</span>
</span><span class="line">	<span class="s">&quot;Jack&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="mi">12</span><span class="p">,</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-1">2.抢占式调度器</h3>

<blockquote>
  <p>In prior releases, a goroutine that was looping forever could starve out other goroutines on the same thread, a serious problem when GOMAXPROCS provided only one user thread. In Go 1.2, this is partially addressed: The scheduler is invoked occasionally upon entry to a function. This means that any loop that includes a (non-inlined) function call can be pre-empted, allowing other goroutines to run on the same thread.</p>
</blockquote>

<p>从golang1.2起，携程调度器为抢占式的，但抢占发生在每次进入函数前，所以，如果循环内的函数被编译器优化成了inline function，那么自然不会发生调度。</p>

<h3 id="slice">3.清空slice</h3>

<p>清空slice并保留内存空间</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">}</span>
</span><span class="line"><span class="nx">a</span> <span class="p">=</span> <span class="nx">a</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span> <span class="c1">// [] 0 5</span>
</span><span class="line"><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>  <span class="c1">// [A,B]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[信任关系建立]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/05/21/xin-ren-guan-xi-jian-li/"/>
    <updated>2014-05-21T14:58:28+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/05/21/xin-ren-guan-xi-jian-li</id>
    <content type="html"><![CDATA[<h3 id="host1host2">建立host1到host2的信任关系</h3>

<h4 id="arsa">如果A的rsa文件不存在可以这样建立</h4>

<p>首先在<code>host1</code>上：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>create_rsa.sh   </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">ssh-keygen -t rsa -N <span class="s2">&quot;&quot;</span> -f ~/.ssh/id_rsa
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section">添加信任关系</h4>

<p>在<code>host2</code>上，将<code>host1</code>的<code>~/.ssh/id_rsa.pub</code>文件内容<code>追加</code>到<code>host2</code>的<code>authorized_keys</code>文件中</p>

<h4 id="fingerprint">避免第一次连接出现添加fingerprint的询问</h4>

<p>在<code>host1</code>上执行：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">ssh-keyscan host2 &gt;&gt; ~/.ssh/known_hosts
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!--more-->

<p>下面是一个示例脚本，在一个中控机上（能同时访问a和b）建立a到b的信任关系：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>relation_a2b</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line"><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -lt 2 <span class="o">]</span>;<span class="k">then</span>
</span><span class="line"><span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Usage: relation_a2b host1 host2&quot;</span>
</span><span class="line">        <span class="nb">exit </span>1
</span><span class="line"><span class="k">fi</span>
</span><span class="line"><span class="nv">from</span><span class="o">=</span><span class="nv">$1</span>
</span><span class="line"><span class="nv">to</span><span class="o">=</span><span class="nv">$2</span>
</span><span class="line"><span class="nv">key</span><span class="o">=</span><span class="sb">`</span>ssh <span class="nv">$from</span> <span class="s2">&quot;ssh-keyscan -t rsa $to &gt;&gt; ~/.ssh/known_hosts 2&gt;/dev/null &amp;&amp; cat ~/.ssh/id_rsa.pub&quot;</span><span class="sb">`</span>
</span><span class="line">ssh <span class="nv">$to</span> <span class="s2">&quot;echo $key &gt;&gt; ~/.ssh/authorized_keys&quot;</span>
</span><span class="line"><span class="nb">echo</span> <span class="s2">&quot;$from --&gt; $to [OK]&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>使用方法</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">relation_a2b host1 host2
</span></code></pre></td></tr></table></div></figure></notextile></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[命令行参数]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/05/02/ming-ling-xing-can-shu/"/>
    <updated>2014-05-02T01:14:33+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/05/02/ming-ling-xing-can-shu</id>
    <content type="html"><![CDATA[<p>阅读docker源码第一个文件<code>DOCKER/docker/docker.go</code>，这是docker的主函数所在的地方。简单来说，这个文件的代码就做了一件事：解析命令行参数，然后根据命令行参数再分流到各种子过程的调用。</p>

<!-- more -->

<h3 id="flag">flag</h3>

<p>go语言默认使用flag包来做命令行参数解析，对于这个包的使用可以参考官方文档的说明。但归结起来，使用这个包大概有三个步骤：</p>

<ol>
  <li>使用<code>flag.XXX</code>函数定义参数名及保存参数的变量</li>
  <li>调用<code>flag.Parse()</code>进行参数的解析，解析结果被保存在定义的各个变量里</li>
  <li>读取这些变量值</li>
</ol>

<p>但docker里定义参数的函数和标准库不太一样，docker的flag可以使用参数名数组来定义参数。比如在标准flag库里定义一个显示版本号的参数：</p>

<pre><code>flVersion = flag.Bool("v", false, "Print version information and quit")
</code></pre>

<p>但在docker里是这样定义的：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>docker/docker.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">flVersion</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="s">&quot;-version&quot;</span><span class="p">},</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;Print version information and quit&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>所以即可以使用<code>docker -v</code>也可以使用<code>docker --version</code>来显示版本号。</p>

<h3 id="docker">docker的实现</h3>

<p>docker在这里玩了个小trick，首先它重写了标准库的flag，并将包名由<code>flag</code>改成<code>mflag</code>，然后这样导入包：</p>

<pre><code>import flag "github.com/dotcloud/docker/pkg/mflag"
</code></pre>

<p>所以在docker里造成直接使用flag的假象。</p>

<p>那么，docker是怎样实现多多参数名的支持的？</p>

<p>首先，mflag将<code>Flag</code>的结构体定义参数名<code>Name</code>修改成数组形式<code>Names</code>：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>pkg/mflag/flag.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Flag</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">Names</span>    <span class="p">[]</span><span class="kt">string</span> <span class="c1">// name as it appears on command line</span>
</span><span class="line">    <span class="nx">Usage</span>    <span class="kt">string</span>   <span class="c1">// help message</span>
</span><span class="line">    <span class="nx">Value</span>    <span class="nx">Value</span>    <span class="c1">// value as set</span>
</span><span class="line">    <span class="nx">DefValue</span> <span class="kt">string</span>   <span class="c1">// default value (as text); for usage message</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后还利用了flag标准库本身的特性，在同一个变量上可以绑定多个参数名:</p>

<pre><code>var de string
flag.String(&amp;de,"a","","argument")
flag.String(&amp;de,"b","","argument")
</code></pre>

<p>即可以用<code>cmd -a val</code>也可以用<code>cmd -b val</code>来调用，变量de的值都会被绑定为<code>val</code>。</p>

<p>除此之外，docker的<code>mflag</code>包还多定义了一种“隐藏参数”：以<code>#</code>开头来定义参数名：</p>

<pre><code>flag.Bool([]string{"#iptables", "-iptables"}, true, "Enable Docker's addition of iptables rules")
</code></pre>

<p>即，使用<code>-iptables</code>和<code>--iptables</code>都是有效的，但是在显示<code>Usage</code>时仅显示<code>--iptables</code>参数的使用说明，这是docker在不断升级更新时，所采用的一种兼容策略吧，允许旧参数的使用并给出警告，但以无帮助信息的方式不推荐旧参数。</p>

<p>实际实现也很简单，就是在帮助函数里去除对旧参数的说明：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>pkg/mflag/flag.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">FlagSet</span><span class="p">)</span> <span class="nx">PrintDefaults</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">f</span><span class="p">.</span><span class="nx">VisitAll</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">flag</span> <span class="o">*</span><span class="nx">Flag</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">format</span> <span class="o">:=</span> <span class="s">&quot;  -%s=%s: %s\n&quot;</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">stringValue</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span><span class="line">            <span class="c1">// put quotes on the value</span>
</span><span class="line">            <span class="nx">format</span> <span class="p">=</span> <span class="s">&quot;  -%s=%q: %s\n&quot;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="nx">names</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
</span><span class="line">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">name</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Names</span> <span class="p">{</span>
</span><span class="line">            <span class="k">if</span> <span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span> <span class="p">{</span>
</span><span class="line">                <span class="nx">names</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">names</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">names</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class="line">            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">out</span><span class="p">(),</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">names</span><span class="p">,</span> <span class="s">&quot;, -&quot;</span><span class="p">),</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">DefValue</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Usage</span><span class="p">)</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在10-12行，如果参数名定义时以<code>#</code>开头则不打印参数帮助。</p>

<p>好吧，参数解析源码其实和标准库大部分都是一样的，看到不一样的地方就行了，今天就到这里吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sort]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/04/15/sort/"/>
    <updated>2014-04-15T20:57:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/04/15/sort</id>
    <content type="html"><![CDATA[<h3 id="sort">sort排序常用参数</h3>

<p>-n : 按照数值排序</p>

<p>-u : 过滤重复的行</p>

<p>-r : 降序排序，默认升序</p>

<p>-t : 指定分段符号</p>

<p>-k : 按照第几个字段(1…)排序</p>

<p>默认sort是按照字符排序的。</p>

<h3 id="sort-1">sort临时目录</h3>

<p>默认情况下sort使用<code>/tmp</code>作为临时文件存放目录，如果根分区很小，可能造成分区磁盘飙升，为避免这种情况可以使用<code>-T</code>参数来指定sort的临时目录：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">sort -T /path/to/tmp_directory
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="sort-2">sort不为人知的一个深坑</h3>

<p>默认情况下，sort将排序对象作为字符串进行排序，并且声称按照ANSII字母顺序进行排序，实际上，如果系统的<code>LC_ALL</code>环境变量为空的话，sort的排序并不一定是按字母顺序进行排序的，这会导致sort的下游依赖程序运行得不稳定，所以，如果要确保sort正确排序，需要正确设置环境变量：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nb">export </span><span class="nv">LC_ALL</span><span class="o">=</span>C
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>为什么这样设置，可以<code>man sort</code>看一下它的warning部分的说明。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[server load]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/27/server-load/"/>
    <updated>2014-03-27T09:39:14+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/27/server-load</id>
    <content type="html"><![CDATA[<h3 id="section">先看几个处理器</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">grep -c <span class="s1">&#39;model name&#39;</span> /proc/cpuinfo
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>比如结果是4</p>

<h3 id="top">top查看系统整体情况</h3>

<p>执行<code>top</code>命令查看系统负载情况：
1. 关注<code>load average</code>系统负载的当前，5分钟前，15分钟前负载，最好小于cpu个数
2. 第二行显示系统进程概况
3. 第四行us用户占用cpu，sy系统占用cpu，ni，id空闲比例，wa io等待，hi，si swap交换
4. 最后是内存情况和交换分区</p>

<h3 id="iostatio">iostat检查io情况</h3>

<p><code>iostat -x</code>，需要关注await即io等待时间，单位ms，一般要小于5ms； %util是io处理时间除以总时间，代表io繁忙度，大于70%需要注意。</p>

<!--more-->

<h3 id="vmstat">vmstat查看系统概况</h3>

<pre><code>procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
 1  0 409548 3317764  56864 39709176    0    0    12    29    0     0  4  1 96  0
</code></pre>

<p>主要看r和b，代表当前执行进程和阻塞进程，当r长期大于cpu个数需要注意，还有阻塞进程过多也需要注意</p>

<h3 id="pspstree">ps和pstree查看进程</h3>

<p>查看线程个数可以用<code>cat /proc/PID/status|grep Threads</code>，另外对于ps，可以这样查看具体线程</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">ps -mp PID -o THREAD,tid,time
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>如：</p>

<pre><code>USER     %CPU PRI SCNT WCHAN  USER SYSTEM   TID     TIME
work      1.8   -    - -         -      -     - 15:08:33
work      0.0  14    - -         -      - 11750 00:00:00
work      0.0  23    - -         -      - 11751 00:00:14
work      0.0  23    - -         -      - 11760 00:03:36
</code></pre>

<p>关注%CPU占用cpu情况，TID是线程id，TIME是占用cpu的时间长。</p>

<p>对于java进程可以用来调试程序：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c"># tid 转为16进制</span>
</span><span class="line"><span class="nb">printf</span> <span class="s2">&quot;%x\n&quot;</span> tid
</span><span class="line">jstack PID | grep tid -A 50
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>### 怎么启动这个程序的</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">pmap PID
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[linux下查看线程数]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/25/linuxxia-cha-kan-xian-cheng-shu/"/>
    <updated>2014-03-25T08:53:55+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/25/linuxxia-cha-kan-xian-cheng-shu</id>
    <content type="html"><![CDATA[<h3 id="cat-procpidstatus">1. cat /proc/${pid}/status</h3>
<p>### 2. ps -mp &lt;PID&gt;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[route]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/14/route/"/>
    <updated>2014-03-14T00:03:30+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/14/route</id>
    <content type="html"><![CDATA[<p>算是记录一个教训吧。</p>

<p>下午我的机器突然不能上外网，尝试内网和别的机器互访都没有问题，就是访问外网显示<code>connect: Network is unreachable</code>，<code>nslookup</code>查看DNS解析也没有问题，就是没想到网络不能到达很有可能是没有路由信息，最后朋友指点发现没有默认网关(<code>route -n</code>)，外网ip没得路由规则走，添加默认网关后ok：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">route add default gw 10.46.148.1
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>提醒自己以后把学到的东西利用起来！</p>

<!--more-->
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ls遍历空目录处理]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/12/lsbian-li-kong-mu-lu-chu-li/"/>
    <updated>2014-03-12T23:18:02+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/12/lsbian-li-kong-mu-lu-chu-li</id>
    <content type="html"><![CDATA[<p>先说说原因：<code>for</code>循环是利用空格做分隔符，所以可以这样打印句子中的单词：</p>

<pre><code>centence="Linux is cool"
for word in $centence;do
	echo $word
done
</code></pre>

<p>有时用ls命令遍历目录会遇到空目录：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="k">for </span>d in <span class="k">$(</span>ls<span class="k">)</span>;<span class="k">do</span>
</span><span class="line"><span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;$d&quot;</span>
</span><span class="line"><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>处理办法是：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">ls -1 | <span class="k">while </span><span class="nb">read </span>d
</span><span class="line"><span class="k">do</span>
</span><span class="line"><span class="k">	</span><span class="nb">echo</span> <span class="s2">&quot;$d&quot;</span>
</span><span class="line"><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[date命令]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/12/dateming-ling/"/>
    <updated>2014-03-12T23:03:56+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/12/dateming-ling</id>
    <content type="html"><![CDATA[<p>首先看看常用的格式字符串</p>

<pre><code> %Y 年
 %m 月
 %d 日
 %H 时
 %M 分
 %S 秒
 %s 时间戳(秒)
</code></pre>

<p><strong>date命令常用操作</strong></p>

<p>获取当前时间</p>

<pre><code>date +%Y-%m-%d    # 2014-02-21
</code></pre>

<!--more-->

<p>几天前(后)，几月前(后)，几年前(后)</p>

<pre><code>date -d "1 day ago"  "+%Y-%m-%d %H:%M:%S"  #一天前的当前时间 2014-02-20 11:11:31
date -d "2 days ago"  # 或者date-d "-2 days"
date -d "-8 months"
date -d "+2 years" # 两年后
</code></pre>

<p>多少分钟，小时前（后）</p>

<pre><code>date -d "-5 minutes"  "+%Y-%m-%d %H:%M:%S"  #5分钟前
date -d "5 minutes"  "%H:%M:%S"  #5分钟后
</code></pre>

<p>时间戳和日期互转，常用于计算</p>

<pre><code>date -d "2014-02-20 11:11:31" +%s  #获取某时间的时间戳
date +%s   #返回当前时间戳1392954893
date -d @1392954893 "+%Y-%m-%d %H:%M:%S"  #将时间戳转换为时间
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[stat命令与文件时间]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/12/statming-ling-yu-wen-jian-shi-jian/"/>
    <updated>2014-03-12T15:04:54+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/12/statming-ling-yu-wen-jian-shi-jian</id>
    <content type="html"><![CDATA[<h3 id="stat">stat命令</h3>

<p>stat命令常用来获取文件三个时间<code>access time</code>,<code>modify time</code>和<code>change time</code></p>

<pre><code>$ stat access.log
  File: `access.log'
  Size: 1559877779	Blocks: 3049624    IO Block: 4096   regular file
Device: ca20h/51744d	Inode: 16269326    Links: 1
Access: (0644/-rw-r--r--)  Uid: (  500/    work)   Gid: (  500/    work)
Access: 2014-03-09 21:58:33.000000000 +0800
Modify: 2014-03-07 08:17:36.000000000 +0800
Change: 2014-03-07 08:17:36.000000000 +0800
</code></pre>

<p>通常可以使用<code>-c</code>参数直接获取三个时间</p>

<pre><code>$ stat -c %x access.log   #获取access time
2014-03-09 21:58:33.000000000 +0800
$ stat -c %y access.log  #获取modify time
2014-03-07 08:17:36.000000000 +0800
$ stat -c %z access.log #获取change time
2014-03-07 08:17:36.000000000 +0800
</code></pre>

<!--more-->

<h3 id="section">三个时间</h3>

<p><code>access time</code>对应文件访问时间，只要有读操作就会更新这个时间。</p>

<p><code>change time</code>对应文件元信息，比如文件重命名会更新该时间。</p>

<p><code>modify time</code>对应文件内容修改时间，只要修改文件内容就会更新该时间，由于内容改变实际也改变文件元数据，所以写操作也更新<code>change time</code>。</p>

<p>注意：对于文件夹来说，对文件夹下的文件增删，重命名，等操作，会修改文件夹<code>change time</code>和<code>modify time</code>，因为文件名实际是作为目录文件的内容存在的。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[shell数组]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/10/shellshu-zu/"/>
    <updated>2014-03-10T00:22:25+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/10/shellshu-zu</id>
    <content type="html"><![CDATA[<h3 id="section">数组定义</h3>

<p>定义数组需要用括号把元素包裹起来。</p>

<pre><code>colors=(red green blue black white)
# 打印整个数组
echo ${colors[*]}  # red green blue black white
echo ${colors[@]}  # red green blue black white
</code></pre>

<!--more-->

<h3 id="section-1">基本操作</h3>

<pre><code># 有两种方法获取数组长度
echo ${#colors[@]}    # 5
echo ${#colors[*]}    # 5
</code></pre>

<p>遍历数组</p>

<pre><code>for e in ${colors[*]};do
	echo $e
done
</code></pre>

<p>或</p>

<pre><code>for((i=0;i&lt;${#colors[*]};i++));do
	echo ${colors[i]}
done
</code></pre>

<p>读写数组</p>

<pre><code>echo ${colors[0]}    # red
colors[0]=RED
echo ${colors[0]}    # RED
</code></pre>

<p>移除元素</p>

<pre><code>unset colors[1]
echo ${colors[*]}    # red blue black white
echo ${#colors[*]}   # 4
</code></pre>

<h3 id="section-2">切片</h3>

<p>切片不影响原数组</p>

<pre><code>echo ${colors[*]:1:3}    # green blue black
# 获取切片得到的新数组
c=(${colors[*]:1:3})
echo ${c[*]}             # green blue black
</code></pre>

<h3 id="section-3">替换</h3>

<p>替换也不影响原数组</p>

<pre><code>echo ${colors[*]/e/E}    # rEd grEen bluE black whitE
</code></pre>

<h3 id="section-4">字符串转换为数组</h3>

<p>使用<code>()</code>操作符和<code>IFS</code>指定分隔符</p>

<pre><code>IFS=";"
str="a;b;c;d;e"
arr=($str)
echo ${arr[*]}  # a b c d e
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[compile ruby from source]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/07/compile-ruby-from-source/"/>
    <updated>2014-03-07T15:35:02+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/07/compile-ruby-from-source</id>
    <content type="html"><![CDATA[<h3 id="section">下载需要的软件包</h3>

<ul>
  <li><a href="http://www.openssl.org/source/">openssl</a></li>
  <li><a href="http://pyyaml.org/wiki/PyYAML">yaml</a></li>
  <li><a href="https://www.ruby-lang.org">ruby</a></li>
  <li><a href="http://sqlite.org/2014/sqlite-autoconf-3080301.tar.gz">sqlite3</a>(可选)</li>
  <li><a href="http://pkgconfig.freedesktop.org/releases/pkg-config-0.28.tar.gz">pkg-config</a>(可选)</li>
</ul>

<!--more-->

<p>假设需要安装的ruby目录为<code>/path/to/ruby_dir</code></p>

<pre><code>export RUBY_DEST=/path/to/ruby_dir
</code></pre>

<h3 id="openssl">编译openssl</h3>

<pre><code>./config --prefix=$RUBY_DEST  shared
make 
make install
</code></pre>

<h3 id="libyaml">编译libyaml</h3>

<pre><code>./configure --prefix=$RUBY_DEST
make
make install
</code></pre>

<h3 id="pkg-configrubyunknown-keyword-url-in-rubydesttmppc">编译pkg-config(如果版本过低需要安装，否则编译ruby会报错<code>Unknown keyword 'URL' in '.$RUBY_DEST.tmp.pc'</code>)</h3>

<pre><code>./configure --prefix=$RUBY_DEST         \
            --with-internal-glib  \
            --disable-host-tool
</code></pre>

<p>如果报错：</p>

<pre><code>gthread-posix.c: In function `g_system_thread_set_name':
gthread-posix.c:1175: error: `PR_SET_NAME' undeclared (first use in this function)
gthread-posix.c:1175: error: (Each undeclared identifier is reported only once
gthread-posix.c:1175: error: for each function it appears in.)
</code></pre>

<p>就需要在pkg源码目录下glib/glib/gthread.c添加：</p>

<pre><code>#define PR_SET_NAME    15               /* Set process name */
#define PR_GET_NAME    16               /* Get process name */
</code></pre>

<p>然后再继续编译</p>

<pre><code>make &amp;&amp; make install
</code></pre>

<h3 id="ruby">编译ruby</h3>

<p>先导入环境变量,否则ruby找不到ssl的链接目录</p>

<pre><code>export LD_LIBRARY_PATH=$RUBY_DEST/lib
export C_INCLUDE_PATH=$RUBY_DEST/include
</code></pre>

<p>开始编译ruby</p>

<pre><code>./configure --prefix=$RUBY_DEST --with-opt-dir=$RUBY_DEST
make
make install
</code></pre>

<h3 id="sqlite3">编译sqlite3(可选)</h3>

<h3 id="section-1">测试</h3>

<pre><code>$RUBY_DEST/bin/ruby -v #打印版本号，说明安装成功
export PATH=$PATH:$RUBY_DEST/bin
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[curl]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/03/05/curl/"/>
    <updated>2014-03-05T23:29:56+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/03/05/curl</id>
    <content type="html"><![CDATA[<h3 id="section">基本用法</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl http://www.google.com
</span><span class="line">curl --proxy http://proxy.com:8888 http://ww.google.com <span class="c">#使用代理</span>
</span><span class="line">curl http://user:password@example.org/  <span class="c">#http验证</span>
</span><span class="line">curl -u user:password http://example.org/ <span class="c">#http验证</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>获取响应头</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -i http://example.com  <span class="c">#在返回结果中包含响应头 </span>
</span><span class="line">curl -IL http://example.com  <span class="c">#仅返回响应头</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!--more-->

<h3 id="rest">REST请求</h3>

<p><strong>GET</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl http://www.google.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>POST</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl --data <span class="s2">&quot;birthyear=1905&amp;press=%20OK%20&quot;</span>  http://www.example.com/when.cgi
</span><span class="line"><span class="c">#or</span>
</span><span class="line">curl --data-urlencode <span class="s2">&quot;name=I am Daniel&quot;</span> http://www.example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>PUT</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl --upload-file uploadfile http://www.example.com/receive.cgi <span class="c">#upload a file</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>DELETE</strong></p>

<p>实际上，可以用<code>curl -X http_method</code>指定包括GET,POST,PUT内的任意方法</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -X DELETE http://example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="header">header</h3>

<p>使用-H或–header指定请求头部</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> http:/example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="cookie">Cookie</h3>

<p><code>-b,--cookie</code>选项告诉<code>curl</code>使用已有的cookie，可以是键值对也可以是文件</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -b <span class="s2">&quot;name=value&quot;</span> http://host
</span><span class="line">curl -b cookie.txt http://host.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>-c,--cookie-jar</code>选项告诉<code>curl</code>将新的cookie保存在文件中</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -c new.txt http://example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="https">HTTPS</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl https://example.com
</span><span class="line">curl --cert mycert.pem https://example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[列出目录结构]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/27/lie-chu-mu-lu-jie-gou/"/>
    <updated>2014-02-27T20:52:50+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/27/lie-chu-mu-lu-jie-gou</id>
    <content type="html"><![CDATA[<h3 id="tree">最简单美观的方法tree</h3>

<p>tree命令是专门用来罗列目录结构的，输出树形结果，很漂亮。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>tree demo
</span><span class="line">demo
</span><span class="line">├── Gemfile
</span><span class="line">├── boot.rb
</span><span class="line">├── collectors
</span><span class="line">├── config
</span><span class="line">│   └── mail_config.rb
</span><span class="line">├── controllers
</span><span class="line">├── db
</span><span class="line">│   ├── connection.rb
</span><span class="line">│   ├── database.yml
</span><span class="line">│   └── migrate
</span><span class="line">├── helpers
</span><span class="line">├── models
</span><span class="line">├── rakefile
</span><span class="line">└── views
</span><span class="line">
</span><span class="line">8 directories, 6 files
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!--more-->

<h3 id="find">折衷的方法find</h3>

<p>如果没有权限在机器上安装tree命令，find命令也是一种折衷的选择。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>find demo -type f -o -type d
</span><span class="line">demo
</span><span class="line">demo/boot.rb
</span><span class="line">demo/collectors
</span><span class="line">demo/config
</span><span class="line">demo/config/.gitkeep
</span><span class="line">demo/config/mail_config.rb
</span><span class="line">demo/controllers
</span><span class="line">demo/db
</span><span class="line">demo/db/connection.rb
</span><span class="line">demo/db/database.yml
</span><span class="line">demo/db/migrate
</span><span class="line">demo/db/migrate/.gitkeep
</span><span class="line">demo/Gemfile
</span><span class="line">demo/helpers
</span><span class="line">demo/helpers/.gitkeep
</span><span class="line">demo/models
</span><span class="line">demo/rakefile
</span><span class="line">demo/views
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>虽然没有tree命令那么直观，但却有另一个好处，便于使用管道进一步操作。</p>

<h3 id="ls">仅仅是一种选择ls</h3>

<p>ls命令也可以罗列出目录结构，但这个仅供娱乐了。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>ls -R demo
</span><span class="line">Gemfile		collectors	controllers	helpers		rakefile
</span><span class="line">boot.rb		config		db		models		views
</span><span class="line">
</span><span class="line">demo/collectors:
</span><span class="line">
</span><span class="line">demo/config:
</span><span class="line">mail_config.rb
</span><span class="line">
</span><span class="line">demo/controllers:
</span><span class="line">
</span><span class="line">demo/db:
</span><span class="line">connection.rb	database.yml	migrate
</span><span class="line">
</span><span class="line">demo/db/migrate:
</span><span class="line">
</span><span class="line">demo/helpers:
</span><span class="line">
</span><span class="line">demo/models:
</span><span class="line">
</span><span class="line">demo/views:
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="shell">利用shell自己来实现</h3>

<p>在无法安装软件的情况下，自己写一个tree命令吧，至少基本的bash是可以用的。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>tree.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line">
</span><span class="line">n_char<span class="o">(){</span>
</span><span class="line">	<span class="nv">ch</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class="line">	<span class="nv">cnt</span><span class="o">=</span><span class="nv">$2</span>
</span><span class="line">	<span class="k">for</span><span class="o">((</span><span class="nv">i</span><span class="o">=</span>0;i&lt;<span class="nv">$cnt</span>;i++<span class="o">))</span>;<span class="k">do</span>
</span><span class="line"><span class="k">		</span><span class="nv">string</span><span class="o">=</span><span class="s2">&quot;${ch}____$string&quot;</span>
</span><span class="line">	<span class="k">done</span>
</span><span class="line"><span class="k">	</span><span class="nb">echo</span> <span class="nv">$string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">dive_into<span class="o">(){</span>
</span><span class="line">	<span class="nb">trap</span> <span class="s1">&#39;exit&#39;</span> INT
</span><span class="line">	ls -1a <span class="s2">&quot;$1&quot;</span> | <span class="k">while </span><span class="nb">read </span>f
</span><span class="line">	<span class="k">do</span>
</span><span class="line"><span class="k">		if</span> <span class="o">[</span> <span class="s2">&quot;$f&quot;</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$f&quot;</span> <span class="o">==</span> <span class="s2">&quot;..&quot;</span> <span class="o">]</span>;<span class="k">then</span>
</span><span class="line"><span class="k">			continue</span>
</span><span class="line"><span class="k">		fi</span>
</span><span class="line"><span class="k">		if</span> <span class="o">[</span> <span class="s2">&quot;$4&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${f:0:1}&quot;</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">]</span>;<span class="k">then</span>
</span><span class="line"><span class="k">			continue</span>
</span><span class="line"><span class="k">		fi</span>
</span><span class="line"><span class="k">		</span><span class="nv">pre</span><span class="o">=</span><span class="k">$(</span>n_char <span class="s1">&#39;|&#39;</span> <span class="nv">$2</span><span class="k">)</span>
</span><span class="line">		<span class="nv">line</span><span class="o">=</span><span class="s2">&quot;${pre//_/ }|-- ${f}&quot;</span>
</span><span class="line">		<span class="o">[[</span> -L <span class="s2">&quot;$1/$f&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">line</span><span class="o">=</span><span class="s2">&quot;${line} -&gt; `readlink &quot;</span><span class="nv">$1</span>/<span class="nv">$f</span><span class="s2">&quot;`&quot;</span>
</span><span class="line">		<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$5&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span>;<span class="k">then</span>
</span><span class="line"><span class="k">			</span><span class="nv">s</span><span class="o">=</span><span class="sb">`</span>du -sh <span class="s2">&quot;$1/$f&quot;</span>|awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span><span class="line">			<span class="nv">line</span><span class="o">=</span><span class="s2">&quot;${line} [$s]&quot;</span>
</span><span class="line">		<span class="k">fi</span>
</span><span class="line"><span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;$line&quot;</span>
</span><span class="line">		<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;$1/${f}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> ! -L <span class="s2">&quot;$1/$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="k">$((</span><span class="nv">$2</span><span class="o">+</span><span class="m">1</span><span class="k">))</span> -lt <span class="nv">$3</span> <span class="o">]</span>;<span class="k">then</span>
</span><span class="line"><span class="k">			</span>dive_into <span class="s2">&quot;$1/$f&quot;</span> <span class="k">$((</span><span class="nv">$2</span><span class="o">+</span><span class="m">1</span><span class="k">))</span> <span class="nv">$3</span> <span class="nv">$4</span> <span class="nv">$5</span>
</span><span class="line">		<span class="k">fi</span>
</span><span class="line"><span class="k">	done</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">while </span><span class="nb">getopts</span> <span class="s2">&quot;d:l:ahs&quot;</span> args
</span><span class="line"><span class="k">do</span>
</span><span class="line"><span class="k">	case</span> <span class="nv">$args</span> in
</span><span class="line">	l<span class="o">)</span> <span class="nv">level</span><span class="o">=</span><span class="nv">$OPTARG</span>
</span><span class="line">	;;
</span><span class="line">	d<span class="o">)</span> <span class="nv">dir</span><span class="o">=</span><span class="s2">&quot;$OPTARG&quot;</span>
</span><span class="line">	;;
</span><span class="line">	a<span class="o">)</span> <span class="nv">all</span><span class="o">=</span>1
</span><span class="line">	;;
</span><span class="line">	s<span class="o">)</span> <span class="nv">size</span><span class="o">=</span>1
</span><span class="line">	;;
</span><span class="line">	h<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Must specify directoy with -d&quot;</span>
</span><span class="line">	   <span class="nb">echo</span> <span class="s2">&quot;Usage: tree.sh -d directory &quot;</span>
</span><span class="line">	   <span class="nb">echo</span> <span class="s2">&quot;-l maxdepth, the tree depth&quot;</span>
</span><span class="line">	   <span class="nb">echo</span> <span class="s2">&quot;-s, print file size&quot;</span>
</span><span class="line">	   <span class="nb">echo</span> <span class="s2">&quot;-a, print with hidden files&quot;</span>
</span><span class="line">	   <span class="nb">exit </span>1
</span><span class="line">	;;
</span><span class="line">	?<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;No such argument&quot;</span>
</span><span class="line">	   <span class="nb">exit </span>1
</span><span class="line">	;;
</span><span class="line">	<span class="k">esac</span>
</span><span class="line"><span class="k">done</span>
</span><span class="line">
</span><span class="line"><span class="o">[[</span> -z <span class="s2">&quot;$dir&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span>
</span><span class="line">	<span class="nb">echo</span> <span class="s2">&quot;Must specify directory with -d&quot;</span>
</span><span class="line">	<span class="nb">exit </span>1
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="o">[[</span> -z <span class="s2">&quot;$level&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">level</span><span class="o">=</span>100
</span><span class="line"><span class="o">[[</span> -z <span class="s2">&quot;$all&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">all</span><span class="o">=</span>0
</span><span class="line"><span class="o">[[</span> -z <span class="s2">&quot;$size&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">size</span><span class="o">=</span>0
</span><span class="line">
</span><span class="line"><span class="nb">echo</span> <span class="s2">&quot;$dir&quot;</span>
</span><span class="line">dive_into <span class="s2">&quot;$dir&quot;</span>  0 <span class="nv">$level</span> <span class="nv">$all</span> <span class="nv">$size</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>试试看好用不：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">tree.sh -h
</span><span class="line">Must specify directoy with -d
</span><span class="line">Usage: tree.sh -d directory
</span><span class="line">-l maxdepth, the tree depth
</span><span class="line">-s, print file size
</span><span class="line">-a, print with hidden files
</span><span class="line">
</span><span class="line">tree.sh -d .
</span><span class="line">.
</span><span class="line">|-- dir
</span><span class="line">|    |-- file
</span><span class="line">|    |-- g.css
</span><span class="line">|    |-- sub
</span><span class="line">|    |    |-- sfile
</span><span class="line">|-- g -&gt; dir/g.css
</span><span class="line">|-- ldir -&gt; dir/
</span><span class="line">|-- m.html -&gt; o.html
</span><span class="line">|-- o.html
</span><span class="line">|-- s.html
</span><span class="line">|-- tree.sh
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[find命令]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/27/findming-ling/"/>
    <updated>2014-02-27T20:10:37+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/27/findming-ling</id>
    <content type="html"><![CDATA[<h3 id="find">find的基本语法</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">find PATH OPTIONS <span class="o">[</span>-exec COMMANDD <span class="o">{}</span> <span class="se">\;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>find</code>命令可以使用多个OPTION，不同OPTION之间默认是<code>and</code>关系，除了<code>and</code>关系还有<code>not</code>和<code>or</code>关系，如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">find / -name <span class="s1">&#39;n1&#39;</span> -type f  <span class="c">#查找/目录下名称为n1且为普通文件的文件</span>
</span><span class="line">find / -name <span class="s1">&#39;n1&#39;</span> -o -name <span class="s1">&#39;n2&#39;</span> <span class="c">#查找名称为n1或n2的文件</span>
</span><span class="line">find / ! -name <span class="s1">&#39;n1&#39;</span>  <span class="c"># 查找名称不为n1的文件</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当使用的OPTION很多时，可以将OPTIONS括起来增加可读性，注意括号需要用<code>\</code>来转义，同时<code>\(</code>和<code>\)</code>两边都需要有空格：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">find / <span class="se">\(</span> -name <span class="s1">&#39;n1&#39;</span> -o -name <span class="s1">&#39;n2&#39;</span> <span class="se">\)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!--more-->

<h3 id="findoption">find命令常用的OPTION</h3>

<ul>
  <li>-name  按名称查找，支持通配符*,?,[]</li>
  <li>-user  按用户名查找</li>
  <li>-empty  查找空文件(目录)</li>
  <li>-perm  查找对应权限的文件，权限表示的三位数字形式如777</li>
  <li>-type 按类型查找，类型可为<code>b</code>块设备，<code>c</code>字符设备，<code>p</code>管道，<code>f</code>普通文件，<code>l</code>链接文件，<code>s</code>socket文件</li>
  <li>-print  打印结果</li>
  <li>-regex 按正则表达式查找，注意该正则匹配属于完全匹配，即如果要查找<code>dir</code>目录下的文件<code>file_23</code>应该用正则表达式<code>.*file_[0-9]+</code>，用<code>file_[0-9]+</code>是匹配不到的，<code>find dir -regex '.*file_[0-9]+</code>是用完整结果即<code>dir/file_23</code>来做和<code>-regex</code>完全匹配的</li>
  <li>-maxdepth n  find的最大目录层级查找深度，最小为1</li>
  <li>-mindepth n find的最小目录查找深度</li>
</ul>

<p>按时间查找的参数：</p>

<ul>
  <li>-amin n  查找n分钟以前被访问（access）的文件</li>
  <li>-atime n  查找n天前被访问的文件</li>
  <li>-cmin n  查找n分钟前文件元信息被修改（change）的文件</li>
  <li>-ctime n  查找n天前文件元信息被修改过的文件</li>
  <li>-mmin n  查找n分钟前内容被修改的文件</li>
  <li>-mtime n 查找n天前内容被修改的文件</li>
</ul>

<h3 id="exec">exec</h3>

<p>find命令最后的exec表示对找到的文件执行什么命令，其中<code>{}</code>代表找到的文件，注意<code>{}</code>和<code>\;</code>间有空格。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用expect实现自动登录]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/25/shi-yong-expectshi-xian-zi-dong-deng-lu/"/>
    <updated>2014-02-25T20:13:57+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/25/shi-yong-expectshi-xian-zi-dong-deng-lu</id>
    <content type="html"><![CDATA[<p>网上有很多类似的文章，但很多都是先写expect脚本再从bash里调用expect脚本，
我希望直接在bash脚本里使用expect命令来实现自动登录。</p>

<h3 id="expect">利用expect命令实现自动登录并执行命令</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line">expect -c <span class="s1">&#39;</span>
</span><span class="line"><span class="s1">spawn ssh USER@HOST &quot;commands&quot;</span>
</span><span class="line"><span class="s1">expect {</span>
</span><span class="line"><span class="s1">&quot;*(yes/no)?&quot; { send &quot;yes\r&quot;;exp_continue }</span>
</span><span class="line"><span class="s1">&quot;*assword:&quot; { send &quot;PASSWORD\r&quot; }</span>
</span><span class="line"><span class="s1">}</span>
</span><span class="line"><span class="s1">expect eof</span>
</span><span class="line"><span class="s1">&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>关于expect的命令在网上有很多资料，这里不在赘述。下面讲讲怎么在bash和expect传递变量。</p>

<!--more-->

<h3 id="section">获取登录名及登录密码</h3>

<p>从bash中获取变量无非就是获取登录主机及密码，提高代码移植性。这里利用bash的Here document实现。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line"><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;USER@HOST&quot;</span>
</span><span class="line"><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;PASSWORD&quot;</span>
</span><span class="line"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;command_list&quot;</span>
</span><span class="line">
</span><span class="line">expect <span class="s">&lt;&lt;EOF </span>
</span><span class="line"><span class="s">spawn ssh $host &quot;$cmd&quot;</span>
</span><span class="line"><span class="s">expect {</span>
</span><span class="line"><span class="s">&quot;*(yes/no)?&quot; { send &quot;yes\r&quot;;exp_continue }</span>
</span><span class="line"><span class="s">&quot;*assword:&quot; { send &quot;$password\r&quot; }</span>
</span><span class="line"><span class="s">}</span>
</span><span class="line"><span class="s">expect eof</span>
</span><span class="line"><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>bash会自动解析here document中的变量，个人认为这种方式比使用expect的set命令更简便。</p>

<h3 id="section-1">获取登录执行命令结果</h3>

<p>如果希望保持登录，去掉上面代码的<code>ssh</code>后的命令列表并且将<code>expect eof</code>改成<code>interact</code>即可。</p>

<p>但通常我们只是登录到某台机器并执行命令后就返回，同时希望获得命令执行的结果。但上面的代码会混合登录时的部分输出，所以这里可以使用管道过滤一下。</p>

<p>下面的代码展示的怎样获取并输出远程主机的真正命令输出，同时也是一个在here document后接管道操作的例子：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c">#!/bin/bash</span>
</span><span class="line"><span class="nv">host</span><span class="o">=</span><span class="s2">&quot;USER@HOST&quot;</span>
</span><span class="line"><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;PASSWORD&quot;</span>
</span><span class="line"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;command_list&quot;</span>
</span><span class="line">
</span><span class="line"><span class="o">(</span>expect <span class="s">&lt;&lt;EOF </span>
</span><span class="line"><span class="s">spawn ssh $host &quot;$cmd&quot;</span>
</span><span class="line"><span class="s">expect {</span>
</span><span class="line"><span class="s">&quot;*(yes/no)?&quot; { send &quot;yes\r&quot;;exp_continue }</span>
</span><span class="line"><span class="s">&quot;*assword:&quot; { send &quot;$password\r&quot; }</span>
</span><span class="line"><span class="s">}</span>
</span><span class="line"><span class="s">expect eof</span>
</span><span class="line"><span class="s">EOF</span>
</span><span class="line"><span class="o">)</span> | awk <span class="s1">&#39;BEGIN{find=0}</span>
</span><span class="line"><span class="s1">{</span>
</span><span class="line"><span class="s1">	if(find){print $0;next}</span>
</span><span class="line"><span class="s1">	if($0 ~ /[pP]assword:/){ find=1 }</span>
</span><span class="line"><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这就是在bash中调用expect自动登录的完整代码了。</p>

<p>P.S. 在here document后接管道操作的几种方法：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c"># 1</span>
</span><span class="line">cat <span class="s">&lt;&lt;EOF | sh</span>
</span><span class="line"><span class="s">echo 1</span>
</span><span class="line"><span class="s">EOF</span>
</span><span class="line"><span class="c"># 2</span>
</span><span class="line"><span class="o">(</span>cat <span class="s">&lt;&lt;EOF</span>
</span><span class="line"><span class="s">echo 1</span>
</span><span class="line"><span class="s">EOF</span>
</span><span class="line"><span class="o">)</span> | sh
</span><span class="line"><span class="c"># 3</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">cat<span class="s">&lt;&lt;EOF</span>
</span><span class="line"><span class="s">echo 1</span>
</span><span class="line"><span class="s">EOF</span>
</span><span class="line"><span class="o">}</span> | sh
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[linux日常维护]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/21/linuxri-chang-wei-hu/"/>
    <updated>2014-02-21T22:58:13+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/21/linuxri-chang-wei-hu</id>
    <content type="html"><![CDATA[<h3 id="cron">某些用户cron任务失败</h3>

<p>有时某些普通用户的crontab任务会失败，这可能是由于crond执行普通用户的任务时，是以非登录shell的形式切换到普通用户来执行的，所以可能缺失了某些环境变量。</p>

<p>解决办法是在crontab任务前先执行<code>source /home/username/.bash_profile</code>，后面再接用户自己的任务命令即可。</p>

<p>ps.<code>/etc/profile</code>,<code>~/.bash_profile</code>,<code>~/.bashrc</code>三个脚本的区别：</p>

<ul>
  <li>/etc/profile     #系统级初始化脚本，会被登录shell执行</li>
  <li>~/.bash_profile  #用户配置，会被登录shell执行，非登录shell不执行</li>
  <li>~/.bashrc        #非登录shell执行，但通常~/.bash_profile都会在代码里调用~/.bashrc，所以登录shell也执行它</li>
</ul>

<!--more-->
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sendmail发邮件中文乱码]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/19/sendmailfa-you-jian-zhong-wen-luan-ma/"/>
    <updated>2014-02-19T23:23:15+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/19/sendmailfa-you-jian-zhong-wen-luan-ma</id>
    <content type="html"><![CDATA[<p>如果这是要使用sendmail命令发送的邮件file内容：</p>

<pre><code>Subject:标题
TO:to@example.com
From:from@example
Content-Type:text/html
&lt;html&gt;
	&lt;body&gt;
		邮件内容
	&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h3 id="section">解决内容乱码</h3>

<p>内容乱码比较好解决，首先内容先使用utf-8编码，然后在修改邮件的<code>Content-Type</code>为：</p>

<pre><code>Content-Type:text/html;charset=UTF-8
</code></pre>

<h3 id="section-1">解决标题乱码</h3>

<p>需要利用base64编码标题内容，例如，如果UTF-8编码的字符串<code>标题</code>进行base64编码后的内容为<code>5qCH6aKY</code>,则邮件标题为：</p>

<pre><code>Subject:=?UTF-8?B?5qCH6aKY?=
</code></pre>

<p>即邮件标题<code>Subject:</code>后字符串格式为：”<code>=?UTF-8?B?</code><em>base64编码的utf-8字串</em><code>?=</code>”</p>

<h3 id="section-2">发送邮件</h3>

<p>最后发送文件可以正确显示：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">cat file | sendmail -t
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(四)——条件格式化]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-si-tiao-jian-ge-shi-hua/"/>
    <updated>2014-02-15T00:47:04+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-si-tiao-jian-ge-shi-hua</id>
    <content type="html"><![CDATA[<h3 id="section">定义格式化操作</h3>

<p>条件格式化风格定义也是使用格式化定义语句add_style，不同的是必须将type指定为:dxf。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># define the style for conditional formatting</span>
</span><span class="line"><span class="n">profitable</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">add_style</span><span class="p">(</span> <span class="ss">:fg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FF428751&quot;</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:dxf</span> <span class="p">)</span>
</span><span class="line"><span class="n">unprofitable</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">add_style</span><span class="p">(</span> <span class="ss">:fg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FF0000&quot;</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:dxf</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>条件格式化有四种类型cellIs，colorScale，dataBar，iconSet。</p>

<!-- more -->

<h3 id="cellis">cellIs</h3>

<p>cellIs条件格式化使用得较为普遍，即对满足条件的单元格更改字体颜色，字体大小，背景色等等。</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=0cc20173b8a1cd1101b672258929b9c1/d000baa1cd11728bb30e6961cafcc3cec3fd2c56.jpg?referer=3c8b0130af4bd1135dda82028c4c&amp;x=.jpg" alt="image" /></p>

<p>对于B列，如果数值大于100000表示盈利，则更改字体颜色；对于亏损的，则在C列中将百分比小于100%的赤字显示。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">book</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Cell Is&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ws</span><span class="o">|</span>
</span><span class="line"><span class="c1"># 产生20行数据</span>
</span><span class="line"><span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Previous Year Quarterly Profits (JPY)&quot;</span><span class="o">]</span>
</span><span class="line"><span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Quarter&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;% of Total&quot;</span><span class="o">]</span>
</span><span class="line"><span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class="line"><span class="n">rows</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class="line"><span class="n">offset</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">rows</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line"> <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Q</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="o">*</span><span class="p">((</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)),</span> <span class="s2">&quot;=100*B</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">/SUM(B3:B</span><span class="si">#{</span><span class="n">rows</span><span class="o">+</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span><span class="o">=&gt;[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="n">percent</span><span class="o">]</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="c1"># 格式化条件&gt;100000</span>
</span><span class="line"><span class="n">ws</span><span class="o">.</span><span class="n">add_conditional_formatting</span><span class="p">(</span><span class="s2">&quot;B3:B100&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:cellIs</span><span class="p">,</span> <span class="ss">:operator</span> <span class="o">=&gt;</span> <span class="ss">:greaterThan</span><span class="p">,</span> <span class="ss">:formula</span> <span class="o">=&gt;</span> <span class="s2">&quot;100000&quot;</span><span class="p">,</span> <span class="ss">:dxfId</span> <span class="o">=&gt;</span> <span class="n">profitable</span><span class="p">,</span> <span class="ss">:priority</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span>
</span><span class="line"><span class="c1"># 格式化条件0.00%&lt;x&lt;100%</span>
</span><span class="line"><span class="n">ws</span><span class="o">.</span><span class="n">add_conditional_formatting</span><span class="p">(</span><span class="s2">&quot;C3:C100&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:cellIs</span><span class="p">,</span> <span class="ss">:operator</span> <span class="o">=&gt;</span> <span class="ss">:between</span><span class="p">,</span> <span class="ss">:formula</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;0.00%&quot;</span><span class="p">,</span><span class="s2">&quot;100.00%&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:dxfId</span> <span class="o">=&gt;</span> <span class="n">unprofitable</span><span class="p">,</span> <span class="ss">:priority</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">})</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>add_conditional_formatting方法指定条件格式化，类型type是cellIs，条件由operator和formula共同指定，dxfId就是我们上面定义的格式化操作，priority优先级数值越小，优先级越高。</p>

<h3 id="colorscale">colorScale</h3>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=3d1d3870938fa0ec7bc7640816ac28d3/f603918fa0ec08fa0ef0e9e45bee3d6d54fbda85.jpg?referer=6b56cc4859b5c9ea3be437d3269b&amp;x=.jpg" alt="image" /></p>

<p>colorScale是以颜色渐变的方式来格式化表格。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">book</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Color Scale&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ws</span><span class="o">|</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Previous Year Quarterly Profits (JPY)&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Quarter&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;% of Total&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class="line">  <span class="n">rows</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class="line">  <span class="n">offset</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">rows</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">    <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Q</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="o">*</span><span class="p">((</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)),</span> <span class="s2">&quot;=100*B</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">/SUM(B3:B</span><span class="si">#{</span><span class="n">rows</span><span class="o">+</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span><span class="o">=&gt;[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="n">percent</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="n">color_scale</span> <span class="o">=</span> <span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:ColorScale</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_conditional_formatting</span><span class="p">(</span><span class="s2">&quot;B3:B100&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:colorScale</span><span class="p">,</span> <span class="ss">:operator</span> <span class="o">=&gt;</span> <span class="ss">:greaterThan</span><span class="p">,</span> <span class="ss">:formula</span> <span class="o">=&gt;</span> <span class="s2">&quot;100000&quot;</span><span class="p">,</span> <span class="ss">:dxfId</span> <span class="o">=&gt;</span> <span class="n">profitable</span><span class="p">,</span> <span class="ss">:priority</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:color_scale</span> <span class="o">=&gt;</span> <span class="n">color_scale</span> <span class="p">})</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>大于100000的单元格颜色越来越深，而小于的单元格越来越浅。</p>

<h3 id="databar">dataBar</h3>

<p>dataBar格式化能够在单元格中同时显示数值和一个柱形图，非常直观漂亮。</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=435a969d3f6d55fbc1c676235d193e77/58ee3d6d55fbb2fb26dba2514d4a20a44723dc85.jpg?referer=b0f4797338f33a87c77a342a1c9b&amp;x=.jpg" alt="image" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">book</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Data Bar&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ws</span><span class="o">|</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Previous Year Quarterly Profits (JPY)&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Quarter&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;% of Total&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class="line">  <span class="n">rows</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class="line">  <span class="n">offset</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">rows</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">    <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Q</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="o">*</span><span class="p">((</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)),</span> <span class="s2">&quot;=100*B</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">/SUM(B3:B</span><span class="si">#{</span><span class="n">rows</span><span class="o">+</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span><span class="o">=&gt;[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="n">percent</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="n">data_bar</span> <span class="o">=</span> <span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:DataBar</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_conditional_formatting</span><span class="p">(</span><span class="s2">&quot;B3:B100&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:dataBar</span><span class="p">,</span> <span class="ss">:dxfId</span> <span class="o">=&gt;</span> <span class="n">profitable</span><span class="p">,</span> <span class="ss">:priority</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:data_bar</span> <span class="o">=&gt;</span> <span class="n">data_bar</span> <span class="p">})</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="iconset">iconSet</h3>

<p>iconSet方式是对于满足条件和不满足条件的单元格分别使用不同的图标。</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=c718e589e4cd7b89ed6c3a863f1f339a/34fae6cd7b899e511cacdf5740a7d933c8950d56.jpg?referer=a0046022fa1986181850dab46b4d&amp;x=.jpg" alt="image" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">book</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Icon Set&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ws</span><span class="o">|</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Previous Year Quarterly Profits (JPY)&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Quarter&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;% of Total&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class="line">  <span class="n">rows</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class="line">  <span class="n">offset</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">rows</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">    <span class="n">ws</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;Q</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="o">*</span><span class="p">((</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="p">)),</span> <span class="s2">&quot;=100*B</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">/SUM(B3:B</span><span class="si">#{</span><span class="n">rows</span><span class="o">+</span><span class="n">offset</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span><span class="o">=&gt;[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="n">percent</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="n">icon_set</span> <span class="o">=</span> <span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:IconSet</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="n">ws</span><span class="o">.</span><span class="n">add_conditional_formatting</span><span class="p">(</span><span class="s2">&quot;B3:B100&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:iconSet</span><span class="p">,</span> <span class="ss">:dxfId</span> <span class="o">=&gt;</span> <span class="n">profitable</span><span class="p">,</span> <span class="ss">:priority</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:icon_set</span> <span class="o">=&gt;</span> <span class="n">icon_set</span> <span class="p">})</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(三)创建图表]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-san-chuang-jian-tu-biao/"/>
    <updated>2014-02-15T00:42:48+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-san-chuang-jian-tu-biao</id>
    <content type="html"><![CDATA[<h3 id="section">饼图</h3>

<p>axlsx创建饼状图非常简单，上图：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4ccd2d6c4334970a4373102aa5f1a0f5/fc1f4134970a304ec10145b9d3c8a786c9175c56.jpg?referer=ddc5668e5066d016270eab189c4c&amp;x=.jpg" alt="image" /></p>

<!-- more -->

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">wb</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Pie Chart&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;First&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">,</span> <span class="s2">&quot;Third&quot;</span><span class="p">,</span> <span class="s2">&quot;Fourth&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_chart</span><span class="p">(</span><span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Pie3DChart</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="ss">:end_at</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span><span class="o">=&gt;</span> <span class="s1">&#39;dark corner here&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">chart</span><span class="o">|</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">add_series</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A2:D2&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:labels</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A1:D1&quot;</span><span class="o">]</span>    <span class="c1">#数据点序列及其名称</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_val</span> <span class="o">=</span> <span class="kp">true</span>       <span class="c1">#是否在饼状图中显示数值</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_percent</span> <span class="o">=</span> <span class="kp">true</span>    <span class="c1">#是否在饼状图中显示所占百分比</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">d_lbl_pos</span> <span class="o">=</span> <span class="ss">:outEnd</span>    <span class="c1">#图例位于图标外部</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_leader_lines</span> <span class="o">=</span> <span class="kp">true</span>  <span class="c1">#是否显示数据和数值间的指示线</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在add_chart方法中，第一个参数指定图标的类型Aslsx::Pie3DChart，而start_at和end_at分别指定图表的左上角单元格和右下角+1单元格，注意图中饼图的右下角单元格是E15即[4,14]，而end_at是[5,15]，所以称为右下角+1单元格，此外注意和excel编号不同，这里单元格序号是从0开始的。</p>

<ul>
  <li>chart.add_series方法是创建图表的主要方法，用来添加点序列的值及其名称。</li>
  <li>chart.d_lbls是Data Lables的缩写，顾名思义就是数据标签。</li>
</ul>

<p>饼图中每块扇形的颜色是自动生成的，如果想要手动指定也是可以的：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">chart</span><span class="o">.</span><span class="n">add_series</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A2:D2&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:labels</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;A1:D1&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:colors</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;FF0000&#39;</span><span class="p">,</span> <span class="s1">&#39;00FF00&#39;</span><span class="p">,</span> <span class="s1">&#39;0000FF&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-1">折线图</h3>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=7fd401bba586c9170c03523cf90601f2/d0c8a786c9177f3e8d17194e72cf3bc79f3d5656.jpg?referer=7d35047437fae6cd55a39e51924c&amp;x=.jpg" alt="image" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">wb</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Line Chart&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
</span><span class="line"> <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span><span class="s1">&#39;l4&#39;</span><span class="o">]</span>
</span><span class="line"> <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;=sum(A2:C2)&#39;</span><span class="o">]</span>
</span><span class="line"> <span class="n">sheet</span><span class="o">.</span><span class="n">add_chart</span><span class="p">(</span><span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Line3DChart</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="ss">:end_at</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;Chart&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">chart</span><span class="o">|</span>
</span><span class="line">   <span class="n">chart</span><span class="o">.</span><span class="n">add_series</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A2:D2&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:labels</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A1:D1&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;bob&#39;</span>
</span><span class="line">   <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_val</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">   <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_cat_name</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">   <span class="n">chart</span><span class="o">.</span><span class="n">catAxis</span><span class="o">.</span><span class="n">tick_lbl_pos</span> <span class="o">=</span> <span class="ss">:none</span>   <span class="c1">#不在横轴上显示坐标</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>chart.d_lbls.show_val表示显示数值，而chart.d_lbls.show_cat_name表示显示每个数值的名称。</p>

<h3 id="section-2">柱形图</h3>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4cc5e74b1d30e924cba49c347c331f3b/29381f30e924b899e2cc837b6c061d950b7bf685.jpg?referer=473e18b979cb0a46dc35bf09329b&amp;x=.jpg" alt="image" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">wb</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bar Chart&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;A Simple Bar Chart&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;First&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">,</span> <span class="s2">&quot;Third&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_chart</span><span class="p">(</span><span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Bar3DChart</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;A4&quot;</span><span class="p">,</span> <span class="ss">:end_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;F17&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">chart</span><span class="o">|</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">add_series</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A3:C3&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:labels</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A2:C2&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A1&quot;</span><span class="o">]</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">valAxis</span><span class="o">.</span><span class="n">label_rotation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">45</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">catAxis</span><span class="o">.</span><span class="n">label_rotation</span> <span class="o">=</span> <span class="mi">45</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">d_lbl_pos</span> <span class="o">=</span> <span class="ss">:outEnd</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_val</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">catAxis</span><span class="o">.</span><span class="n">tick_lbl_pos</span> <span class="o">=</span> <span class="ss">:none</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_chart</span><span class="p">(</span><span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Bar3DChart</span><span class="p">,</span> <span class="ss">:barDir</span> <span class="o">=&gt;</span> <span class="ss">:col</span><span class="p">,</span><span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;A17&quot;</span><span class="p">,</span> <span class="ss">:end_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;F30&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">chart</span><span class="o">|</span> <span class="c1">#barDir指定方向:bar或:col</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">add_series</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A3:C3&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:labels</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A2:C2&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">sheet</span><span class="o">[</span><span class="s2">&quot;A1&quot;</span><span class="o">]</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">valAxis</span><span class="o">.</span><span class="n">label_rotation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">45</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">catAxis</span><span class="o">.</span><span class="n">label_rotation</span> <span class="o">=</span> <span class="mi">45</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">d_lbl_pos</span> <span class="o">=</span> <span class="ss">:outEnd</span>
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">d_lbls</span><span class="o">.</span><span class="n">show_val</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">
</span><span class="line">    <span class="n">chart</span><span class="o">.</span><span class="n">catAxis</span><span class="o">.</span><span class="n">tick_lbl_pos</span> <span class="o">=</span> <span class="ss">:none</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里的图表位置start_at和end_at使用了和上面不同的方式，直接使用单元格名称如A4，F17，但end_at仍然是右下角单元格+1。其他代码的自解释性很强，无须赘述了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(二)格式化为美观的表格]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-er-ge-shi-hua-wei-mei-guan-de-biao-ge/"/>
    <updated>2014-02-15T00:38:10+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-er-ge-shi-hua-wei-mei-guan-de-biao-ge</id>
    <content type="html"><![CDATA[<h3 id="section">基础知识</h3>

<p>axlsx的格式化使用Aslsx::Styles类来处理，通常使用Axlsx::Styles#add_style 帮助方法来添加格式，该方法定义：</p>

<pre><code>(Integer) add_style(options = {})
</code></pre>

<!-- more -->

<p>所有的格式设置操作都在options这个hash中指定，该hash的键名非常好记，下面是常见的键值列表：</p>

<pre><code>Options Hash (options):
fg_color (String) — 字体颜色，如：FFFF0000
sz (Integer) — 字体大小
b (Boolean) — 是否粗体
i (Boolean) — 是否斜体
u (Boolean) — 是否加下划线
strike (Boolean) — 是否加删除线
shadow (Boolean) — 是否加阴影
charset (Integer) — 字符集，可选的字符集列表：
0   ANSI_CHARSET
1   DEFAULT_CHARSET
2   SYMBOL_CHARSET
77  MAC_CHARSET
128 SHIFTJIS_CHARSET
129 HANGUL_CHARSET
130 JOHAB_CHARSET
134 GB2312_CHARSET
136 CHINESEBIG5_CHARSET
161 GREEK_CHARSET
162 TURKISH_CHARSET
163 VIETNAMESE_CHARSET
177 HEBREW_CHARSET
178 ARABIC_CHARSET
186 BALTIC_CHARSET
204 RUSSIAN_CHARSET
222 THAI_CHARSET
238 EASTEUROPE_CHARSET
255 OEM_CHARSET


family (Integer) — 字体，可选字体：
0 Not applicable.
1 Roman
2 Swiss
3 Modern
4 Script
5 Decorative
6..14 Reserved for future use


font_name (String) — 字体名称
num_fmt (Integer) — 数字格式：可选格式：
1 0
2 0.00
3 #,##0
4 #,##0.00
5 $#,##0_);($#,##0)
6 $#,##0_);[Red]($#,##0)
7 $#,##0.00_);($#,##0.00)
8 $#,##0.00_);[Red]($#,##0.00)
9 0%
10 0.00%
11 0.00E+00
12 # ?/?
13 # ??/??
14 m/d/yyyy
15 d-mmm-yy
16 d-mmm
17 mmm-yy
18 h:mm AM/PM
19 h:mm:ss AM/PM
20 h:mm
21 h:mm:ss
22 m/d/yyyy h:mm
37 #,##0_);(#,##0)
38 #,##0_);[Red](#,##0)
39 #,##0.00_);(#,##0.00)
40 #,##0.00_);[Red](#,##0.00)
45 mm:ss
46 [h]:mm:ss
47 mm:ss.0
48 ##0.0E+0
49 @


format_code (String) — 自定义格式如'yyyy-mm-dd'，如果设置了该值，则num_fmt将被忽略.
border (Integer|Hash) — 边框样式.
bg_color (String) — 单元格背景色
hidden (Boolean) — 是否隐藏单元格
locked (Boolean) — 是否锁定单元格
type (Symbol) — 风格类型，可选的类型有[:dxf, :xf]. :xf事默认类型
alignment (Hash) — 对齐.该hash的包括：
horizontal (Symbol)，该键对应的值包括有：
:general
:left
:center
:right
:fill
:justify
:centerContinuous
:distributed
vertical (Symbol)，该键对应的值有：
:top
:center
:bottom
:justify
:distributed
textRotation (Integer)
wrapText (Boolean)
indent (Integer)
relativeIndent (Integer)
justifyLastLine (Boolean)
shrinkToFit (Boolean)
readingOrder (Integer)
</code></pre>

<h3 id="section-1">格式化报表示例</h3>

<p>格式化报表是以单元格为单位执行的，通常在添加行的时候，在add_row第二个hash参数里指定：</p>

<pre><code>sheet.add_row ['a', "b"], :style =&gt; [nil, header] #header是创建好的style
#or
sheet.add_row ["a', "b"], :style =&gt; header
</code></pre>

<p>如果style是一个列表，那么列表里每一个格式对应于行内每个单元格，也可以像第二行代码那样为整行指定同一种格式。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=9b79859e2c738bd4c021b23491b0f6eb/4bed2e738bd4b31cc6cc6ef885d6277f9f2ff885.jpg?referer=f3368c656f224f4a0e8e4723389b&amp;x=.jpg" alt="image" /></p>

<p>下面是创建如图报表的部分代码：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;axlsx&#39;</span>
</span><span class="line">
</span><span class="line"><span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Package</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class="line">  <span class="nb">p</span><span class="o">.</span><span class="n">workbook</span> <span class="k">do</span> <span class="o">|</span><span class="n">wb</span><span class="o">|</span>
</span><span class="line">    <span class="n">styles</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">styles</span>
</span><span class="line">    <span class="n">header</span>     <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:bg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FFFF33&quot;</span><span class="p">,</span><span class="ss">:fg_color</span><span class="o">=&gt;</span><span class="s2">&quot;0033CC&quot;</span><span class="p">,</span> <span class="ss">:sz</span> <span class="o">=&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:alignment</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:horizontal</span> <span class="o">=&gt;</span> <span class="ss">:center</span><span class="p">}</span>
</span><span class="line">    <span class="n">tbl_header</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:bg_color</span><span class="o">=&gt;</span><span class="s2">&quot;99FF33&quot;</span><span class="p">,</span><span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:alignment</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:horizontal</span> <span class="o">=&gt;</span> <span class="ss">:center</span> <span class="p">}</span>
</span><span class="line">    <span class="n">ind_header</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:bg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FFDFDEDF&quot;</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:alignment</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:indent</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}</span>
</span><span class="line">    <span class="n">col_header</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:bg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FFDFDEDF&quot;</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:alignment</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:horizontal</span> <span class="o">=&gt;</span> <span class="ss">:center</span> <span class="p">}</span>
</span><span class="line">    <span class="n">label</span>      <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:alignment</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:indent</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="line">    <span class="n">money</span>      <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:num_fmt</span> <span class="o">=&gt;</span> <span class="mi">5</span>
</span><span class="line">    <span class="n">t_label</span>    <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:bg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FFDFDEDF&quot;</span>
</span><span class="line">    <span class="n">t_money</span>    <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">add_style</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:num_fmt</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:bg_color</span> <span class="o">=&gt;</span> <span class="s2">&quot;FFDFDEDF&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="n">wb</span><span class="o">.</span><span class="n">add_worksheet</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span>               <span class="c1">#添加空行</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;College Budget&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">header</span><span class="o">]</span>        <span class="c1">#标题，大字体居中</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;What&#39;s coming in this month.&quot;</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;How am I doing&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="n">tbl_header</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;Item&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;Item&quot;</span><span class="p">,</span> <span class="s2">&quot;Amount&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">ind_header</span><span class="p">,</span> <span class="n">col_header</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">ind_header</span><span class="p">,</span> <span class="n">col_header</span><span class="o">]</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;Estimated monthly net income&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;Monthly income&quot;</span><span class="p">,</span> <span class="s2">&quot;=C9&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:style</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">money</span><span class="o">]</span>
</span><span class="line">      <span class="c1">#省略部分代码</span>
</span><span class="line">      <span class="sx">%w(B4:C4 E4:F4 B11:C11 E11:F11 B2:F2)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">range</span><span class="o">|</span> <span class="n">sheet</span><span class="o">.</span><span class="n">merge_cells</span><span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">}</span>
</span><span class="line">      <span class="n">sheet</span><span class="o">.</span><span class="n">column_widths</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">2</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="nb">p</span><span class="o">.</span><span class="n">use_shared_strings</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">  <span class="nb">p</span><span class="o">.</span><span class="n">serialize</span> <span class="s1">&#39;styles.xlsx&#39;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(一)安装及入门]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-yi-an-zhuang-ji-ru-men/"/>
    <updated>2014-02-15T00:34:19+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-yi-an-zhuang-ji-ru-men</id>
    <content type="html"><![CDATA[<h3 id="section">安装</h3>

<p>axlsx是一个基于ruby的Office Open XML Spreadsheet报表生成工具，下图是它生成的一个报表截图</p>

<p><img src="https://raw.github.com/randym/axlsx/master/examples/sample.png" alt="axlsx" /></p>

<!-- more -->

<p>安装axlsx和安装其他gem一样：</p>

<pre><code>$ gem install axlsx
</code></pre>

<h3 id="section-1">创建第一个报表</h3>

<p>axlsx使用的对象和office文档使用的对象完全一样，workbook代表一个文档，worksheet代表一张表，row和cell代表行和单元格，基本上所有的对象顾名思义即可，而不需要了解文档ECMA规范。</p>

<p>比如要创建一张如图所示的报表：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=0b461ccc6e81800a6ae5890b810e42c7/cdbf6c81800a19d86620614631fa828ba61e4656.jpg?referer=5d8a74b17f1ed21b20de1bd5a24c&amp;x=.jpg" alt="image" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;axlsx&#39;</span>
</span><span class="line">
</span><span class="line"><span class="nb">p</span> <span class="o">=</span> <span class="ss">Axlsx</span><span class="p">:</span><span class="ss">:Package</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">wb</span> <span class="o">=</span> <span class="nb">p</span><span class="o">.</span><span class="n">workbook</span>
</span><span class="line">
</span><span class="line"><span class="n">wb</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Basic Worksheet&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">sheet</span><span class="o">|</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s2">&quot;First Column&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">,</span> <span class="s2">&quot;Third&quot;</span><span class="p">,</span><span class="s2">&quot;Total&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="s2">&quot;=SUM(A2:C2)&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">add_row</span> <span class="o">[</span><span class="s1">&#39;This is a very very long sentence.&#39;</span><span class="o">]</span>
</span><span class="line">  <span class="n">sheet</span><span class="o">.</span><span class="n">merge_cells</span> <span class="s2">&quot;A3:D3&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">serialize</span> <span class="s1">&#39;basic.xlsx&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>代码非常简单明了，创建worksheet，再一行行添加数据，在添加第二行数据时甚至使用了一个求和函数，所以我们使用过的Excel的知识完全可以直接拿过来使用，甚至对于较长的内容可以合并单元格，但这里没有居中显示所以还不够美观，美观的事情可以格式化来解决，不过这是下一篇的内容了。</p>

<p>最后一行是将报表序列化到xlsx格式的文件，该文件可以用MSOffice直接打开查看。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一步一步搭建mysql主从同步]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/yi-bu-yi-bu-da-jian-mysqlzhu-cong-tong-bu/"/>
    <updated>2014-02-15T00:24:49+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/yi-bu-yi-bu-da-jian-mysqlzhu-cong-tong-bu</id>
    <content type="html"><![CDATA[<h3 id="mysql">下载mysql数据库</h3>

<pre><code>$ wget http://cdn.mysql.com/Downloads/MySQL-5.1/mysql-5.1.73.tar.gz
tar vzxf mysql-5.1.73.tar.gz
</code></pre>

<!-- more -->

<h3 id="section">编译安装</h3>

<p>最好专门创建一个用户mysql来安装数据库。</p>

<pre><code>MYSQL_BASEDIR=$HOME/mysql
cd mysql-5.1.73
./configure 
--prefix=${MYSQL_BASEDIR} 
--with-charset=utf8 
--with-extra-charsets=gbk,utf8,ascii,big5,latin1,binary 
--with-unix-socket-path=${MYSQL_BASEDIR}/tmp/mysql.sock 
--with-mysqld-user=mysql     #以哪个用户执行mysqld进程
make
make install
</code></pre>

<h3 id="section-1">初始化数据库</h3>

<p>复制必要的配置文件和启停脚本</p>

<pre><code>cd ${MYSQL_BASEDIR}
mkdir etc log tmp var
cp share/mysql/my-medium.cnf  etc/my.cnf
cp share/mysql/mysql.server  bin/
</code></pre>

<h3 id="section-2">修改配置文件</h3>

<pre><code>vim etc/my.cnf
</code></pre>

<p>在[mysqld]下添加配置项：</p>

<pre><code>basedir= ${MYSQL_BASEDIR}   # ${MYSQL_BASEDIR}是你的mysql安装目录
datadir = ${MYSQL_BASEDIR}/var   # mysql数据路径
tmpdir = ${MYSQL_BASEDIR}/tmp   # 临时文件路径
slave-load-tmpdir = ${MYSQL_BASEDIR}/tmp   # 从服务器同步LOAD DATA INFILE语句时创建临时文件的目录名
port = 3306   # 如果修改port，[mysqld] 和 [client]下的port都要修改
pid-file = ${MYSQL_BASEDIR}/var/mysql.pid  # mysqld PID文件位置
#以下为可选
socket = ${MYSQL_BASEDIR}/tmp/mysql.sock  # 用于指定本地连接的Unix套接字文件位置，[mysqld] 和 [client]下的port都要修改
#skip-name-resolve   # 是否仅使用ip验证客户端
#skip-symbolic-links  #忽略MyISAM表的数据及索引文件连接到另一个目录下
max_connect_errors = 10000
max_connections = 500
wait-timeout = 30
</code></pre>

<p>启动数据库</p>

<pre><code>$ ./bin/mysql_install_db  #安装数据库文件
$ ./bin/mysql.server start    #出现下面这行说数据库启动ok了
Starting MySQL.                                            [  OK  ]
</code></pre>

<h3 id="mysql-1">配置mysql用户</h3>

<p>使用./bin目录下的mysql命令可以登录到数据库，登录后删除匿名用户并且为root设置密码：</p>

<pre><code>$ mysql -u root
&gt; delete from mysql.user where user='';
&gt; UPDATE mysql.user SET Password = PASSWORD('password') WHERE user='root';
</code></pre>

<p>按照以上同样的步骤再搭建一个mysql，注意，如果在同一主机搭建多个mysql实例，那么就需要将端口改成不同才行。</p>

<p>下面开始配置主从同步。</p>

<p>首先在主库新建专门用于同步的数据库账号mysqlsync</p>

<pre><code>&gt; GRANT REPLICATION SLAVE ON *.* TO 'mysqlsync'@'%' IDENTIFIED BY 'password';
</code></pre>

<h3 id="section-3">主库配置</h3>

<p>所有的配置项还是在my.cnf中的[mysqld]下添加。</p>

<p>首先server-id作为MySQL服务器的标识，具有相关联上下游同步系统需具有全局唯一性。主库我们将server-id配置为1。其他主库需要添加的配置有：</p>

<pre><code>server-id=1
# 同步过程中需要忽略的表，支持正则表达式。全库同步时，必须屏蔽mysql系统库和test测试库。
replicate-wild-ignore-table = mysql.%
replicate-wild-ignore-table = test.%
# 需要同步的表，多个表需多次指定，这里我们使用全库同步,方便点
# replicate-do-table = database.table
log-bin = mysql-bin  #二进制日志，强制开启
log-bin-index = mysql-bin.index  # 记录二进制日志索引文件
relay-log-index = relay-log.index # 记录中继日志索引文件
</code></pre>

<h3 id="section-4">从库配置</h3>

<pre><code>server-id=2
read-only # 在从库开启该选项，避免在从库上进行写操作，导致主从数据不一致（不过对super权限无效哦）
skip-slave-start # 在从库开启该选项，启动数据库后，需手动开启同步进程
relay-log = mysql-relay #中继日志，从库开启
relay-log-index = relay-log.index
log-bin = mysql-bin
log-bin-index = mysql-bin.index
replicate-wild-ignore-table = mysql.%
replicate-wild-ignore-table = test.%
</code></pre>

<h3 id="section-5">同步设置</h3>

<p>启动主数据库，并查看主库状态：</p>

<pre><code>$ ./bin/mysql.server start
$ mysql -u root -p
mysql&gt; show master status;
</code></pre>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=21e536be79899e517c8e3a11729ca80e/e7cd7b899e510fb31b3b92d4db33c895d1430c56.jpg?referer=a44e286a8418367af49e4aed6c4d&amp;x=.jpg" alt="image" /></p>

<p>记下来log文件名和位置，这里是“mysql-bin.000005”和”106“。</p>

<p>然后启动从库，</p>

<pre><code>$ ./bin/mysql.server start
$ mysql -u root -p
mysql&gt; change master to master_host='your_host',master_port=3307,master_user='mysqlsync',master_password='pasword',master_log_file='mysql-bin.000005',master_log_pos=106;
mysql&gt; startslave;  #启动从库
mysql&gt; show slave status\G;
</code></pre>

<p>最后一条sql命令得到如图结果：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=a307b4b80846f21fcd345e56c61f1a5d/7acb0a46f21fbe091fae395769600c338644ad85.jpg?referer=781a5e5095dda144831e58820b9b&amp;x=.jpg" alt="image" /></p>

<p>其中Slave_IO_Running和Slave_SQL_Running是yes就对了。</p>

<p>最后，可以验证一下，在主库修改记录，从库可以看到同步过来的变化。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在rails外单独使用ActiveRecord]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/zai-railswai-dan-du-shi-yong-activerecord/"/>
    <updated>2014-02-15T00:20:50+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/zai-railswai-dan-du-shi-yong-activerecord</id>
    <content type="html"><![CDATA[<!-- more -->

<h3 id="activerecord">单独使用ActiveRecord</h3>

<p>需要在应用根目录demo/下的app.rb文件中写入：</p>

<pre><code>require 'active_record'  
require 'sqlite3'  
  
ActiveRecord::Base.establish_connection(  
    :adapter=&gt;'sqlite3',  
    :database=&gt;'data.sqlite3',  
    :pool=&gt;5,  
    :timeout=&gt;5000  
    )  
  
class CreateUsers &lt; ActiveRecord::Migration  
  def change  
    create_table :users do |t|  
      t.string :name  
      t.integer :age  
    end 
  end  
end  

CreateUsers.new.change
  
class User &lt; ActiveRecord::Base  
end  

User.create name:"Jack",age:12
</code></pre>

<p>首先，使用ActiveRecord::Base.establish_connection建立连接，然后定义数据表迁移，再使迁移生效建立数据表，最后就可以像在rails中一样定义model，然后正常使用ActiveRecord了。</p>

<p>代码可以正常工作了，但可以做的工作还有很多，因为这段代码实在是不美观。</p>

<h3 id="section">像样的结构</h3>

<p>大杂烩式的代码文件总是不美的，上面代码中包含了数据库连接，表创建，model定义和实际的应用代码四部分，这么多功能各异的部件还是分开好。首先创建demo/db目录，在这个目录下放置所有数据库连接的定义；创建demo/models目录，在下面放置model定义文件。demo/app.rb文件位置不变。</p>

<h3 id="model">model定义</h3>

<p>model定义文件demo/user.rb的内容就是将上面的user类定义复制过来即可。</p>

<pre><code>class User &lt; ActiveRecord::Base
end
</code></pre>

<h3 id="activerecord-1">ActiveRecord配置</h3>

<p>新建demo/db/connection.rb文件，该文件里设置数据库连接：</p>

<pre><code>require 'active_record'
require 'yaml'

dbconfig = YAML::load(File.open('db/database.yml'))
ActiveRecord::Base.establish_connection(dbconfig)
</code></pre>

<p>这里模仿rails使用了yaml来配置连接，该文件也在demo/db目录下，内容为：</p>

<pre><code>adapter: sqlite3
database: data.sqlite3
pool: 5
timeout: 5000
</code></pre>

<p>现在的demo/app.rb清爽多了：</p>

<pre><code>require File.expand_path('../db/connection',__FILE__)
Dir[File.expand_path('../models',__FILE__)+'/*.rb'].each{|f| require f }

User.create name:"Jack",age:12
</code></pre>

<h3 id="section-1">数据表迁移</h3>

<p>现在还有一个问题，我也想像rails中那样利用rake来迁移数据表定义。参考我前一篇博客Rake就可以轻松写出数据迁移的rakefile。在demo/根目录下创建rakefile文件：</p>

<pre><code>require 'active_record'
require 'yaml'
require 'logger'

task :default =&gt; :migrate

task :migrate =&gt; :environment do
  ActiveRecord::Migrator.migrate('db/migrate', ENV["VERSION"] ? ENV["VERSION"].to_i : nil )
end

task :environment do
  ActiveRecord::Base.establish_connection(YAML::load(File.open('db/database.yml')))
  ActiveRecord::Base.logger = Logger.new(File.open('db/database.log', 'a'))
end
</code></pre>

<p>只要在终端中执行rake命令就可能完成数据迁移：</p>

<pre><code>$ rake
==  CreateUsers: migrating ====================================================
-- create_table(:users)
   -&gt; 0.0020s
==  CreateUsers: migrated (0.0040s) ===========================================
</code></pre>

<p>实际上现在还无法得出这样的输出，因为还没有编写迁移代码文件。那么迁移文件写在哪儿呢？在demo/db/migrate/目录中专门用来放置数据迁移代码，比如现在我们在该目录下新建一个迁移文件001_create_users.rb，写入迁移代码：</p>

<pre><code>class CreateUsers &lt; ActiveRecord::Migration  
  def change  
    create_table :users do |t|  
      t.string :name  
      t.integer :age  
    end 
  end  
end  
</code></pre>

<p>现在执行rake命令才能得出上面给出的正确输出。</p>

<p>最后给出示例应用的最终目录结构：</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=8350422bd309b3deefbfe46dfc841dbc/9358d109b3de9c8204461ccc6e81800a19d84356.jpg?referer=16e32c709045d688fa158794ad4c&amp;x=.jpg" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rspec]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/rspec/"/>
    <updated>2014-02-15T00:14:29+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/rspec</id>
    <content type="html"><![CDATA[<h2 id="rspec">RSpec断言规则</h2>

<p>RSpec有一些常见的断言规则。Ruby的断言方法是以问号结尾并且返回true或false的方法，常见的如： empty?   nil?    instance_of? 等。在spec中的断言很简单，就是should be_去掉问号的断言方法。如：</p>

<pre><code>[].should be_empty =&gt; [].empty? #passes
[].should_not be_empty =&gt; [].empty? #fails
</code></pre>

<!-- more -->

<p>除了用”be_“来前缀断言方法，也可以用”be_a_“和”be_an_“前缀，使得代码读起来更加自然：</p>

<pre><code>"a string".should be_an_instance_of(String) =&gt;"a string".instance_of?(String)#passes
3.should be_a_kind_of(Fixnum) =&gt; 3.kind_of?(Numeric) #passes
3.should be_a_kind_of(Numeric) =&gt; 3.kind_of?(Numeric) #passes
3.should be_an_instance_of(Fixnum) =&gt; 3.instance_of?(Fixnum) #passes 
3.should_not be_instance_of(Numeric) =&gt; 3.instance_of?(Numeric) #fails
</code></pre>

<p>Rspec也会为诸如“has_key?”之类的断言创建匹配器，要使用该特性，在断言对象上使用 should have_key(:key) 就可以了，rspec会自动在对象上调用has_key?(:key)。如：</p>

<pre><code>{:a =&gt; "A"}.should have_key(:a) =&gt; {:a =&gt; "A"}.has_key?(:a) #passes
{:a =&gt; "A"}.should have_key(:b) =&gt; {:a =&gt; "A"}.has_key?(:b) #fails
</code></pre>

<p>还有一些常见的断言方法如： be  be_close  change  eql  have  be_true  be_false be_nil include raise_error respond_to throw_symbol   等等</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rack based application]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/rack-based-application/"/>
    <updated>2014-02-15T00:04:13+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/rack-based-application</id>
    <content type="html"><![CDATA[<h3 id="rack">1.什么是rack</h3>

<p>rack是基于ruby的web服务器接口，它将http协议以非常简单的方式包裹起来，为web服务器和应用提供一致性的接口。rack被用于几乎所有的ruby web应用开发框架中。这是维基百科上给出的一个基于rack的ruby应用：</p>

<pre><code>app = lambda do |env|
  body = "Hello, World!"
  [200, {"Content-Type" =&gt; "text/plain", "Content-Length" =&gt; body.length.to_s}, [body]]
end
 
run app
</code></pre>

<p>重点是第三行，一个基于rack的ruby应用只需要一个包含call方法的对象，在调用call方法后该对象会返回形如第三行的一个列表，该列表包含三个元素：第一个元素是这次http请求的返回状态码200，第二个元素是一个返回的http响应headers的hash表，第三个元素是http响应体的列表，所以该列表的形式为：</p>

<pre><code>[ status_code, headers, body ]
</code></pre>

<!-- more -->

<h3 id="rack-based-application">2.一个简单的rack-based-application</h3>

<p>编写一个最简单的rack based application，ok，需要一个能响应call方法的对象，在该对象上调用call方法能返回[ status_code, headers, body ]列表。在文件夹rack_based下新建simple.ru文件，*.ru被称为rakcup文件，rack使用该文件来启动rack应用。该文件内容为：</p>

<pre><code>run lambda { |env| [200,{'Content-Type'=&gt;'text/plain'},['OK']]}
</code></pre>

<p>That’s all.这个基于rack的应用已经编写完成了，在terminal中键入下面命令即可启动这个应用了：</p>

<pre><code>rackup rack_based/simple.ru
</code></pre>

<blockquote>
  <p>注：rack默认的rackup文件名是<code>config.ru</code>，使用该文件名在同级目录启动应用直接执行<code>rackup</code>即可启动应用。</p>
</blockquote>

<p>rack使用默认的内置WEBrick服务器，用rackup命令在端口9292启动该应用：</p>

<pre><code>JasondeMacBook-Pro:Projects jason$ rackup rack_based/simple.ru 
Thin web server (v1.6.1 codename Death Proof)
Maximum connections set to 1024
Listening on 0.0.0.0:9292, CTRL+C to stop
</code></pre>

<p>在浏览器中访问http://localhost:9292 即可看到页面显示“OK”，说明应用正常工作了。</p>

<p>Rails也是基于rack的框架，rails的rackup配置文件是位于应用根目录下的config.ru：</p>

<pre><code># This file is used by Rack-based servers to start the application.

require ::File.expand_path('../config/environment',  __FILE__)
run Rails.application
</code></pre>

<p>另外，call方法还带有一个env参数，该参数是一个hash表，包含了请求所有的环境信息，rack应用可以根据env信息给予不同的响应，如下面将simple.ru略作修改，使得它可以返回所有的请求信息：</p>

<pre><code>module Simple
	class Application
		def self.call(env)
			[200,{'Content-Type'=&gt;'text/plain'},[env.to_s]]
		end
	end
end
run Simple::Application
</code></pre>

<p>启动该应用，则可以看到结果：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class=""><span class="line">{
</span><span class="line">"GATEWAY_INTERFACE"=&gt;"CGI/1.1",
</span><span class="line">"PATH_INFO"=&gt;"/",
</span><span class="line">"QUERY_STRING"=&gt;"",
</span><span class="line">"REMOTE_ADDR"=&gt;"127.0.0.1",
</span><span class="line">"REMOTE_HOST"=&gt;"localhost",
</span><span class="line">"REQUEST_METHOD"=&gt;"GET",
</span><span class="line">"REQUEST_URI"=&gt;"http://localhost:9292/",
</span><span class="line">"SCRIPT_NAME"=&gt;"",
</span><span class="line">"SERVER_NAME"=&gt;"localhost",
</span><span class="line">"SERVER_PORT"=&gt;"9292",
</span><span class="line">"SERVER_PROTOCOL"=&gt;"HTTP/1.1",
</span><span class="line">...........
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="middleware">3.middleware</h3>

<p>这是一个rack应用的请求栈：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=70915c2796eef01f491418c0d0c5e818/8d5494eef01f3a29e9eb308d9b25bc315c607c56.jpg?referer=639819647d3e6709e71770cfbc4c&amp;x=.jpg" alt="image" /></p>

<p>浏览器发出http请求到web Server，web server 再将请求转交给rack，rack负责将请求转交给应用程序栈。在应用栈中，请求经过一层层的中间层middleware后，最好才传达给rack应用，譬如rails的应用的controller最后来处理请求，当rack应用处理完请求后，又逐层返回，最后由rack上交给web server完成响应。注意，并非每次请求都需要完成从上到下的全部栈层次，比如请求一个存在的静态文件，就可能直接由处理静态文件的middleware发送文件，而根本不会将请求传递到rack应用controller中去。</p>

<p>由这张图可以看出来，rack是web server和应用之间的桥梁，或者说适配器。另外，rack应用处在请求栈的最后一层，web请求经过了无数的middleware后才真正到达应用这里。middleware所起的作用和java struts中的拦截器概念非常相似，它们都负责将请求逐层包裹最后递交给应用的是一个非常友好的请求包，使得应用可以更方便地处理逻辑。</p>

<p>下面就来创建一个自定义的middleware，该middleware可以将请求网页内所有&lt;h1&gt;标记内的内容的e改写成大写的X。</p>

<p>首先新建一个rails app，在新建完成后，实用下面命令可以查看rails已经使用的middleware：</p>

<pre><code>rake middleware

use Rack::Sendfile
use ActionDispatch::Static
......
use Rack::Head
use Rack::ConditionalGet
use Rack::ETag
run Demo::Application.routes
</code></pre>

<p>现在在应用的lib目录下新建文件link_jumbler.rb，文件app/lib/link_jumbler.rb的内容：</p>

<pre><code>require 'nokogiri'

class LinkJumbler
	def initialize(app,letters)
		@app=app
		@letters=letters
	end

	def call(env)
		status, headers, response = @app.call(env)
		body=Nokogiri::HTML(response.body)
		body.css("h1").each do |a|
			@letters.each do |f,r|
				a.content=a.content.gsub f.to_s,r.to_s
			end
		end

		[status,headers,[body.to_s]]
	end
end
</code></pre>

<p>首先，在initialize方法中，接受了两个参数，一个是app参数，它会在各个middleware中传递，需要对它调用call方法。另一个参数letters是我们这个middleware需要的参数，这个参数来源是挂载middleware时产生的。不同middleware的传递的这个参数不同，也可能根本没有这个额外的参数。在call方法中，先对@app调用了call方法获得了一个rack风格的响应结果，这里利用nokogiri解析结果，并做出修改，最后返回结果。在java struts中有个前拦截器和后拦截器，从这里也可以看出middleware也可以有相同的功能，比如这里就是对结果作处理，属于一个后处理的middleware。</p>

<p>然后将这个middleware添加到该应用的middleware栈中（看到letters哪儿来的了吧），在app/config/application.rb中添加
<code>config.middleware.use LinkJumbler,{"e"=&gt;"X"}</code>
添加完成后app/config/application.rb文件内容为：</p>

<pre><code>require File.expand_path('../boot', __FILE__)

require 'rails/all'
require File.expand_path('../../lib/link_jumbler', __FILE__)

Bundler.require(:default, Rails.env)

module Demo
  class Application &lt; Rails::Application
    config.middleware.use LinkJumbler,{"e"=&gt;"X"}
  end
end
</code></pre>

<p>再次执行rake middleware命令，可以看到LinkJumbler被添加到最后一层middleware：</p>

<pre><code>use Rack::Sendfile
use ActionDispatch::Static
......
use Rack::Head
use Rack::ConditionalGet
use Rack::ETag
use LinkJumbler
run Demo::Application.routes
</code></pre>

<blockquote>
  <p>实际上，rails只是利用自己的一套tricky的把戏自动添加了这个middleware，在其他rack based application中，比如sinatra，在config.ru文件里的<code>run xxx</code>方法前加上<code>use LinkJumbler</code>语句即完成添加middleware.</p>
</blockquote>

<p>启动该rails应用，可以看到和标准rails欢迎界面的区别了吗？</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=513d3845adc379317968862cdbffc678/f636afc379310a559ad424b7b54543a983261084.jpg?referer=65c5a1751f950a7b2c227af4509b&amp;x=.jpg" alt="image" /></p>

<h3 id="section">4. 其他</h3>

<ul>
  <li>rack based application(比如sinatra)可能会依赖于一个环境变量<code>RACK_ENV</code>，取值<code>production,development,test</code></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识jruby之在tomcat上部署jruby-on-rails]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-zai-tomcatshang-bu-shu-jruby-on-rails/"/>
    <updated>2014-02-14T23:58:44+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-zai-tomcatshang-bu-shu-jruby-on-rails</id>
    <content type="html"><![CDATA[<h3 id="prerequesite">1. prerequesite</h3>

<p>假定部署的sever上已经安装好了Java环境和mysql数据库（因为这里我将以mysql为例）。并且，这里为了和前面几篇博文保持一致，还是在windows上进行部署，实际在linux上部署的节奏也差不多了，即便遇到问题，google is ready for you.</p>

<!-- more -->

<h3 id="apache-tomcat">2. 安装配置Apache Tomcat</h3>

<p>首先，在Apache Tomcat网站上下载tomcat压缩包，目前的版本是7.0。下载完成后解压缩，如解压到C:\，解压缩后目录结构如图：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=c5fe07e6d343ad4ba22e46c5b2392b92/c995d143ad4bd1136f3d4d7158afa40f4afb0584.jpg?referer=97197c6f8501a18ba9fc267f639b&amp;x=.jpg" alt="image" /></p>

<p>进入其中bin目录，并以管理员身份运行startup.bat批处理文件启动tomcat，tomcat默认端口为8080，所以，在浏览器中访问http://localhost:8080 ，如果出现图示页面说明tomcat安装配置正确。</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=79626b7c49fbfbedd859367a48cb860b/a50f4bfbfbedab642082b783f536afc378311e84.jpg?referer=24c5e74b1d30e92496b3a8015a9b&amp;x=.jpg" alt="image" /></p>

<h3 id="jruby">3. 下载安装jruby</h3>

<p>安装jruby在前一篇博文讲解较细，这里不再赘述。</p>

<p>安装必要的JDBC。</p>

<pre><code>jruby -S gem install activerecord-jdbcmysql-adapter -v 1.3.0.beta2
</code></pre>

<p>如果要将jruby on rails工程打包为war发布到tomcat上，就必须要用到warbler Gem：</p>

<pre><code>jruby -S gem install warbler
</code></pre>

<h3 id="jruby-on-rails">4. 打包jruby on rails工程</h3>

<p>首先确认database.yml文件production环境配置正确：</p>

<pre><code>production:
  adapter: mysql
  encoding: utf8
  reconnect: false
  database: demo_production
  username: user
  password: password
  host: localhost
  port: 3306
</code></pre>

<p>配置正确的production数据库，及其用户密码。</p>

<p>在数据库中创建production数据库demo_production，并且赋予用户user对该数据库的完全权限。</p>

<p>然后开始打包工程，在rails app根目录下执行：</p>

<pre><code>jruby -S warble
</code></pre>

<p>该命令会在工程根目录下生成一个war文件，如demo.war，该war会将必要的gem打包进去，使得我们能够像普通java工程war文件那样部署到tomcat中。</p>

<h3 id="war">5. 部署war</h3>

<p>将该war复制到tomcat的webapps目录下，等待大约几秒钟，tomcat会自动释放文件完成部署。</p>

<p>最后一步，进入tomcat释放的文件夹demo中，生成数据库schema：</p>

<pre><code>C:\apache-tomcat-7.0.35\webapps\demo&gt;jruby -S rake db:migrate RAILS_ENV="production"
</code></pre>

<p>现在可以访问http://localhost:8080/demo ，可以看到rails app的首页了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识jruby之安装配置jrubyonrails]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-an-zhuang-pei-zhi-jrubyonrails/"/>
    <updated>2014-02-14T23:49:23+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-an-zhuang-pei-zhi-jrubyonrails</id>
    <content type="html"><![CDATA[<h3 id="prerequesite">1. prerequesite</h3>

<p>假设你已经安装好了jruby，并且使用的jdk最好是1.7。</p>

<h3 id="rails">2. 安装rails</h3>

<p>安装rails4.0.0：</p>

<pre><code>C:\&gt;jruby -S gem install rails -V
</code></pre>

<p>查看安装的rails版本：</p>

<pre><code>C:\&gt;jruby -S rails -v
Rails 4.0.0
</code></pre>

<!-- more -->

<h3 id="rails-apps">3. 新建一个rails Apps</h3>

<pre><code>C:\&gt;jruby -S rails new demo
</code></pre>

<p>并且取消bundle install，因为使用默认安装的ActiveRecord-JDBC-adapter的master分支版本目前，会导致执行rake db:migrate命令时发生wrong number of arguments calling exec_insert (5 for 3) error错误，所以，修改gemfile使用它的1.3.0.beta2版本（这个步骤是现在的权宜之计，以后肯定不必这么麻烦了。后注：此问题目前已修复)：</p>

<p>如果使用的是sqlite数据库，则将：</p>

<pre><code>gem 'activerecord-jdbcsqlite3-adapter'
</code></pre>

<p>改为：</p>

<pre><code>gem 'activerecord-jdbcsqlite3-adapter', '1.3.0.beta2'
</code></pre>

<p>如果使用的mysql数据库，则将：</p>

<pre><code>gem 'activerecord-jdbcmysql-adapter'
</code></pre>

<p>改为：</p>

<pre><code>gem 'activerecord-jdbcmysql-adapter','1.3.0.beta2'
</code></pre>

<p>然后再进行 jruby -S bundle install 安装gem。</p>

<p>如果使用sqlite数据库，默认配置即可，如果使用mysql数据库，则修改database.yml，以development
环境为例，这里的username，password，host，port按照具体情况进行具体配置：</p>

<pre><code>development:
  adapter: mysql
  encoding: utf8
  reconnect: false
  database: demo_development
  username: user
  password: user_password
  host: localhost
  port: 3306
</code></pre>

<p>最后，启动rails app：</p>

<pre><code>C:\DEMO&gt;jruby -S rails s
</code></pre>

<p>然而此时又出错了：</p>

<pre><code>OpenSSL::Cipher::CipherError: Illegal key size: possibly you need to install Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for your JRE
</code></pre>

<p>要求安装JCE，到Oracle 官网上下载一个UnlimitedJCEPolicyJDK7.zip文件，解压缩后包含两个jar文件：local_policy.jar和US_export_policy.jar。将这两个文件替换$JAVA_HOME/jre/lib/security目录下两个同名文件，如，在我的电脑是就是替换C:\Program Files\Java\jdk1.7.0_25\jre\lib\security目录下两个文件。替换后，重启电脑。</p>

<p>此时，再jruby -S rails s启动app则可以正确运行了。</p>

<h3 id="java">4. 配置java类路径</h3>

<p>如果需要在rails中使用java外部类，则需要配置一下$CLASSPATH，首先，假设我们将需要的java类都放在rails_root/lib/java文件夹下。那么就在environment.rb文件中require File.expand_path(‘../
application’, __FILE__)后添加代码：</p>

<pre><code>require 'java'
$CLASSPATH &lt;&lt; File.join(Rails.root, 'lib','java')
</code></pre>

<p>这样，如果在该目录下有一个编译好的java类example.MyClass在rails中就可以像这样使用该类：</p>

<pre><code>mc=Java::example.MyClass.new
</code></pre>

<p>如果还使用了外部jar，则还要添加引用jar的代码，同样在environment.rb文件中添加：</p>

<pre><code>Dir.glob(File.join(Rails.root, 'lib','java',"**","*.jar")).each do |jar| 
	$CLASSPATH &lt;&lt; jar
end
</code></pre>

<p>所以最终environment.rb文件看起来是这样的：</p>

<blockquote>
  <p>environment.rb</p>
</blockquote>

<pre><code># Load the rails application
require File.expand_path('../application',__FILE__)
requrie 'java'
$CLASSPATH&lt;&lt;File.join(Rails.root,'lib','java')
Dir.glob(File.join(Rails.root,'lib','java','**','*.jar)).each do |jar|
	$CLASSPATH &lt;&lt; jar
end

Demo::Application.initialize!
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在一组方法中共享变量]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/zai-yi-zu-fang-fa-zhong-gong-xiang-bian-liang/"/>
    <updated>2014-02-14T23:46:19+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/zai-yi-zu-fang-fa-zhong-gong-xiang-bian-liang</id>
    <content type="html"><![CDATA[<pre><code>lambda{
	shared=10
	Kernel.send :define_method, :counter do
		shared+=1
	end
	Kernel.send :define_method, :show do
		shared
	end
}.call

show #=&gt;10
3.times{counter}
show #=&gt;13
</code></pre>

<!-- more -->
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 在javascript中使用ruby对象]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-zai-javascriptzhong-shi-yong-rubydui-xiang/"/>
    <updated>2014-02-14T23:40:15+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-zai-javascriptzhong-shi-yong-rubydui-xiang</id>
    <content type="html"><![CDATA[<h3 id="javascriptruby">1.在javascript中使用ruby简单对象</h3>

<p>如，需要将ruby对象转换成javascript的简单变量：</p>

<pre><code>&lt;%= javascript_tag do %&gt;
  url = '&lt;%= j products_url %&gt;';
&lt;% end %&gt;
</code></pre>

<p>此时的&lt;%=  %&gt;是由引号包裹的。rails的j方法是为了正确地转义ruby对象从而嵌入javascript中。</p>

<!-- more -->

<h3 id="javascriptruby-1">2.在javascript中使用ruby复杂对象</h3>

<p>公共桥梁显然是json，但要正确地转义json就需要raw方法：</p>

<pre><code>&lt;%= javascript_tag do %&gt;
  products = &lt;%= raw Product.limit(10).to_json %&gt;
&lt;% end %&gt;
</code></pre>

<p>此时&lt;%= %&gt;无引号包裹。</p>

<h3 id="gon-gem">3.Gon gem</h3>

<p>如果有大量的ruby对象需要在javascript中使用，这种方法就不好了。Gon就是为了解决这个问题。</p>

<p>首先在gemfile中添加gon：</p>

<pre><code>gem 'gon'
</code></pre>

<p>然后在/app/views/layouts/application.html.erb文件中包含gon：</p>

<pre><code>&lt;head&gt;
  &lt;title&gt;Store&lt;/title&gt;
  &lt;%= include_gon %&gt;
  &lt;%= stylesheet_link_tag    "application", media: "all" %&gt;
  &lt;%= javascript_include_tag "application" %&gt;
  &lt;%= csrf_meta_tag %&gt;
&lt;/head&gt;
</code></pre>

<p>然后在controller中就可以以这种形式为javascript对象赋值：</p>

<pre><code>gon.variable_name = variable_value
# or new syntax
gon.push({
  :user_id =&gt; 1,
  :user_role =&gt; "admin"
})
gon.push(any_object) # any_object with respond_to? :each_pair
</code></pre>

<p>例如：</p>

<pre><code>class ProductsController &lt; ApplicationController
	def index
		gon.products = Product.limit(10)
	end
end
</code></pre>

<p>在js中获取变量的方法：</p>

<pre><code>gon.variable_name
</code></pre>

<p>即：</p>

<pre><code>go.products
</code></pre>

<h3 id="section">参考文献</h3>

<ul>
  <li><a href="https://github.com/gazay/gon">gon</a></li>
  <li><a href="http://railscasts.com/episodes/324-passing-data-to-javascript?view=asciicast">Passing data to javascript</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails URL路由]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-urllu-you/"/>
    <updated>2014-02-14T23:26:35+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-urllu-you</id>
    <content type="html"><![CDATA[<p>rails URL路由的最权威文档当然是其官方站点Rails routing from the outside in，我这里只提几个文档中常用的要点。</p>

<h3 id="crub">1.CRUB</h3>

<p>由resources建立的资源，是rails中最常见的路由方式，不用多说。</p>

<pre><code>resources :photos
</code></pre>

<!-- more -->

<h3 id="section">2.单例资源</h3>

<p>单例资源也比较常用，官方文档上举的例子很形象也很常见，用户user需要拥有一个profile资源，而每个用户必然只有一个profile，所以如果生成类似/profiles/:id的URL显然是不美观的，此时就需要单例资源，单例资源的生成使用的是单数形式方法resource：</p>

<pre><code>resource :profile
</code></pre>

<p>该语句生成的路由如下：</p>

<pre><code>     profile POST   /profile(.:format)      profiles#create
 new_profile GET    /profile/new(.:format)  profiles#new
edit_profile GET    /profile/edit(.:format) profiles#edit
             GET    /profile(.:format)      profiles#show
             PATCH  /profile(.:format)      profiles#update
             PUT    /profile(.:format)      profiles#update
             DELETE /profile(.:format)      profiles#destroy
</code></pre>

<h3 id="section-1">3.嵌入的路由</h3>

<p>适用于某种资源必须依赖于另一种资源才有意义，比如某些comment必然在针对的event下存在，所以comment就必须依赖于event。</p>

<pre><code>resources :events do
    resources :comments
end &lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;figure class='code'&gt;&lt;div class="highlight"&gt;&lt;table&gt;&lt;tr&gt;&lt;td class="gutter"&gt;&lt;pre class="line-numbers"&gt;&lt;span class='line-number'&gt;1&lt;/span&gt; &lt;span class='line-number'&gt;2&lt;/span&gt; &lt;span class='line-number'&gt;3&lt;/span&gt; &lt;span class='line-number'&gt;4&lt;/span&gt; &lt;span class='line-number'&gt;5&lt;/span&gt; &lt;span class='line-number'&gt;6&lt;/span&gt; &lt;span class='line-number'&gt;7&lt;/span&gt; &lt;span class='line-number'&gt;8&lt;/span&gt; &lt;span class='line-number'&gt;9&lt;/span&gt; &lt;span class='line-number'&gt;10&lt;/span&gt; &lt;span class='line-number'&gt;11&lt;/span&gt; &lt;span class='line-number'&gt;12&lt;/span&gt; &lt;span class='line-number'&gt;13&lt;/span&gt; &lt;span class='line-number'&gt;14&lt;/span&gt; &lt;span class='line-number'&gt;15&lt;/span&gt;
</code></pre>
<p>&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#8217;code&#8217;&gt;&lt;pre&gt;<code class=""><span class="line">events_comments GET    /events/comments(.:format)          comments#index
</span><span class="line">                POST   /events/comments(.:format)          comments#create
</span><span class="line"> new_events_comment GET    /events/comments/new(.:format)      comments#new
</span><span class="line">edit_events_comment GET    /events/comments/:id/edit(.:format) comments#edit
</span><span class="line"> events_comment GET    /events/comments/:id(.:format)      comments#show
</span><span class="line">                PATCH  /events/comments/:id(.:format)      comments#update
</span><span class="line">                PUT    /events/comments/:id(.:format)      comments#update
</span><span class="line">                DELETE /events/comments/:id(.:format)      comments#destroy
</span><span class="line">         events POST   /events(.:format)                   events#create
</span><span class="line">     new_events GET    /events/new(.:format)               events#new
</span><span class="line">    edit_events GET    /events/edit(.:format)              events#edit
</span><span class="line">                GET    /events(.:format)                   events#show
</span><span class="line">                PATCH  /events(.:format)                   events#update
</span><span class="line">                PUT    /events(.:format)                   events#update
</span><span class="line">                DELETE /events(.:format)                   events#destroy</span></code>&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;</p>

<p>对应的也自动生成了诸如event_comment_path之类的url 帮助方法。对于嵌入式资源，官方建议不要超过两层。最简单的理由，路由层次过深，除了增加逻辑的复杂度外，也得不到任何好处。</p>

<h3 id="namespacescope">4.namespace和scope路由</h3>

<p>以下规则同时适用于resources和controller。</p>

<p>比如，如果想要在特定的命名空间(admin)下访问某个资源(post)，这时就可以利用namespace。</p>

<pre><code>namespace :admin do
  resources :posts
end
</code></pre>

<p>此时，处理该路由的controller是Admin::PostsController，体现在rails工程中是在controller文件夹下的admin文件夹下的posts_controller.rb文件。而产生的路由全部以/admin开头：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">admin_posts GET    /admin/posts(.:format)          admin/posts#index
</span><span class="line">            POST   /admin/posts(.:format)          admin/posts#create
</span><span class="line"> new_admin_post GET    /admin/posts/new(.:format)      admin/posts#new
</span><span class="line">edit_admin_post GET    /admin/posts/:id/edit(.:format) admin/posts#edit
</span><span class="line"> admin_post GET    /admin/posts/:id(.:format)      admin/posts#show
</span><span class="line">            PATCH  /admin/posts/:id(.:format)      admin/posts#update
</span><span class="line">            PUT    /admin/posts/:id(.:format)      admin/posts#update
</span><span class="line">            DELETE /admin/posts/:id(.:format)      admin/posts#destroy</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>一言以蔽之，由namespace产生的资源路由，controller和url都由该namespace作“前缀”。</p>

<p>如果需要让资源路由没有前缀，而又希望该路由url被某个模块下的controller受理，那么就需要使用
scope。</p>

<pre><code>scope module: 'admin' do
  resources :posts
end
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">posts GET    /posts(.:format)          admin/posts#index
</span><span class="line">      POST   /posts(.:format)          admin/posts#create
</span><span class="line"> new_post GET    /posts/new(.:format)      admin/posts#new
</span><span class="line">edit_post GET    /posts/:id/edit(.:format) admin/posts#edit
</span><span class="line"> post GET    /posts/:id(.:format)      admin/posts#show
</span><span class="line">      PATCH  /posts/:id(.:format)      admin/posts#update
</span><span class="line">      PUT    /posts/:id(.:format)      admin/posts#update
</span><span class="line">      DELETE /posts/:id(.:format)      admin/posts#destroy</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由rake routes输出可以看出，路由url没有了admin前缀，而posts资源都由admin模块下的Admin::PostsController受理。</p>

<p>一言以蔽之，带module的scope产生的资源路由，路由url无“前缀”，controller以module指定模块为“前缀”。</p>

<p>反过来，如果希望给资源附加一个前缀，而由普通controller受理该url，则需要另一种形式的scope：</p>

<pre><code>scope '/admin' do
  resources :posts
end
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">   posts GET    /admin/posts(.:format)          posts#index
</span><span class="line">          POST   /admin/posts(.:format)          posts#create
</span><span class="line"> new_post GET    /admin/posts/new(.:format)      posts#new
</span><span class="line">edit_post GET    /admin/posts/:id/edit(.:format) posts#edit
</span><span class="line">     post GET    /admin/posts/:id(.:format)      posts#show
</span><span class="line">          PATCH  /admin/posts/:id(.:format)      posts#update
</span><span class="line">          PUT    /admin/posts/:id(.:format)      posts#update
</span><span class="line">          DELETE /admin/posts/:id(.:format)      posts#destroy</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>此时，资源posts每个url都附加了/admin为前缀，而受理这些url的是PostsController。</p>

<p>一言以蔽之，这种形式的scope产生的资源路由，路由url有“前缀”，controller无“前缀”。</p>

<p>另外，这种形式的路由还有一种简写：</p>

<pre><code>resources :posts, path: '/admin/posts'
</code></pre>

<p>该简写和使用scope产生的结果完全一样。不过，path还有另外的用途，如果保持controller及url helper不变，仅仅希望为url路由中的资源改个名称，这时path就派上用场了：</p>

<pre><code>resources :posts, path: '/articles'
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">posts GET    /articles(.:format)          posts#index
</span><span class="line">      POST   /articles(.:format)          posts#create
</span><span class="line"> new_post GET    /articles/new(.:format)      posts#new
</span><span class="line">edit_post GET    /articles/:id/edit(.:format) posts#edit
</span><span class="line"> post GET    /articles/:id(.:format)      posts#show
</span><span class="line">      PATCH  /articles/:id(.:format)      posts#update
</span><span class="line">      PUT    /articles/:id(.:format)      posts#update
</span><span class="line">      DELETE /articles/:id(.:format)      posts#destroy</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="restful">5.新增RESTful动词</h3>

<p>以下规则同样适用于resources和controller。</p>

<pre><code>resources :photos do
  get 'preview', on: :member
end
</code></pre>

<p>该语句为某个特定photo新增了一个preview动作，该动作是一个get请求，默认photos_controller中存在一个preview方法处理该动作。</p>

<p>类似的，如果需要为photos集合新增一个动词，只需要将语句中member改成collection即可。</p>

<p>如果，需要为特定photo增加多个动词preview1和preview2，改成下面的形式即可，甚至可以指定
controller中处理该请求的方法，以及自定义url helper：</p>

<pre><code>resources :photos do
  member do
    get 'preview1'=&gt;:pre1, as:"p1"
    get 'preview2'=&gt;:pre2, as:"p2"
  end
end
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">  p1_photo GET    /photos/:id/preview1(.:format) photos#pre1
</span><span class="line">  p2_photo GET    /photos/:id/preview2(.:format) photos#pre2</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="resourceful">6.非resourceful路由</h3>

<h4 id="section-2">使用参数：</h4>

<pre><code>controller :photos do
  get 'check/:id',:to=&gt;:check
end
</code></pre>

<p>产生的路由输出如下：</p>

<pre><code>GET /check/:id(.:format) photos#check
</code></pre>

<p>在执行该get请求如/check/23，后photos_controller的check方法受理该请求，并在params中将参数设置为23。</p>

<h4 id="section-3">限制参数格式：</h4>

<pre><code>get 'photos/:id', to: 'photos#show', constraints: { id: /[A-Z]\d{5}/ }
</code></pre>

<p>该路由规则能接受/photos/A12345却不能接受/photos/893。</p>

<h4 id="section-4">指定请求的默认类型：</h4>

<pre><code>get 'articles/:id', to: 'articles#show', defaults: { format: 'xml' } 若get请求/articles/2，该路由规则会自动将params的params[:format]置为"xml"。
</code></pre>

<p>该方法仅仅是在请求未指定format时指定默认类型，如果需要某个controller仅接受某些格式的请求如xml和json，则可以在该controller类定义中添加如下代码，这在书写api时常常用到：</p>

<pre><code>respond_to :json, :xml
</code></pre>

<h4 id="controller">更换资源的controller：</h4>

<p>如果不希望为某个资源使用默认的controller，则：</p>

<pre><code>resources :photos, controller: 'images'
</code></pre>

<p>此时photos资源的所有请求都由images_controller受理，而photos的路由url和url helper都不变。</p>

<h4 id="section-5">限制资源的默认动作：</h4>

<p>如果仅希望使用资源的部分动作，如仅使用资源photos的index和show动作：</p>

<pre><code>resources :photos, only: [:index, :show]
</code></pre>

<p>或者使用除了destroy动作外的所有默认动作：</p>

<pre><code>resources :photos, except: :destroy 还可以使用:all（所有默认动作），:none（没有默认动作）：

resources :photos, :only=&gt;:none
</code></pre>

<h4 id="newediturl">为new和edit的url路由改名：</h4>

<pre><code>resources :photos, path_names: { new: 'make', edit: 'change' }
</code></pre>

<p>产生的新路由为：</p>

<pre><code>/photos/make
/photos/1/change
</code></pre>

<p>而此时受理该路由的方法仍为new和edit，即controller中的方法并未改名。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 填充数据库初始数据]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-tian-chong-shu-ju-ku-chu-shi-shu-ju/"/>
    <updated>2014-02-14T23:21:46+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-tian-chong-shu-ju-ku-chu-shi-shu-ju</id>
    <content type="html"><![CDATA[<!-- more -->

<p>利用db/seeds.rb文件将数据库的initial data填入即可，该文件位于rails环境中，可以访问railsApp中任何类和方法。如，填充product表的初始数据：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>seeds.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">	<span class="no">Product</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="ss">:&quot;Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="ss">&quot;</span><span class="p">,</span><span class="ss">description</span><span class="p">:</span><span class="s2">&quot;A product&quot;</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>使用rake命令填充数据：</p>

<pre><code>rake db:seed
</code></pre>

<p>或者从头调用所有migration创建空的数据库并自动seed填充数据库：</p>

<pre><code>rake db:setup
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 配置使用jquery-file-upload  step by step]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-pei-zhi-shi-yong-jquery-file-upload-step-by-step/"/>
    <updated>2014-02-14T23:11:06+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-pei-zhi-shi-yong-jquery-file-upload-step-by-step</id>
    <content type="html"><![CDATA[<p>一步步安装使用jquery-file-upload</p>

<!-- more -->

<h3 id="gem">1.安装Gem</h3>

<p>在gemfile中添加jquery-fileupload-rails和paperclip的gem：</p>

<pre><code>gem "jquery-fileupload-rails"
gem 'paperclip'
</code></pre>

<h3 id="appassetsapplicationjs">2.在app/assets/application.js添加</h3>

<pre><code>//= require jquery-fileupload
</code></pre>

<h3 id="appassetsstylesheetsapplicationcss">3.在app/assets/stylesheets/application.css添加</h3>

<pre><code>*= require jquery.fileupload-ui
</code></pre>

<h3 id="picture">4.创建Picture数据表</h3>

<pre><code>rails g model Picture avatar:attachment
rake db:migrate
</code></pre>

<p>pictures表的avatar属性代表上传的文件对象。</p>

<p>修改picture.rb的内容：</p>

<pre><code>class Picture &lt; ActiveRecord::Base
	has_attached_file :avatar
	
	include Rails.application.routes.url_helpers
	
	def to_json_picture
		{
			'name'=&gt;read_attribute(:avatar_file_name),
			'size'=&gt;read_attribute(:avatar_file_size),
			'url'=&gt;avatar.url(:original),
			'delete_url'=&gt;picture_path(self),
			'delete_type'=&gt;'DELETE'
		}
	end
end
</code></pre>

<p>在model中，使用类方法has_attached_file指明文件对象是avatar，并且定义了to_json_picture方法，该方法将picture对象转换成一个hash，在jquery-fileupload和server的交互中被转变为json数据。</p>

<h3 id="view">5.创建view</h3>

<p>只需要创建一个上传界面index.html.erb，自定义你自己的view时，仅需要将form_for Picture.new和f.file_field :avatar修改为自己model即可，其他内容都可以直接copy-paste。</p>

<p><a href="https://gist.github.com/qjpcpu/9017226">源码地址</a></p>

<h3 id="controller">6.创建controller</h3>

<pre><code>rails g controller pictures index create destroy
</code></pre>

<p>-</p>

<pre><code>class PicturesController &lt; ApplicationController
  def index
    @pictures = Picture.all

    respond_to do |format|
      format.html # index.html.erb
      format.json { render json: @pictures.map{|picuture| picuture.to_json_picture } }
    end
  end

  # POST /picture
  # POST /picture.json
  def create
    @picture = Picture.new(params[:picture])

    respond_to do |format|
      if @picture.save
        format.html {
          render :json =&gt; [@picture.to_json_picture].to_json,
          :content_type =&gt; 'text/html',
          :layout =&gt; false
        }
        format.json { render json: {files: [@picture.to_json_picture]}, status: :created, location: @picture }
      else
        format.html { render action: "new" }
        format.json { render json: @picture.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /picture/1
  # DELETE /picture/1.json
  def destroy
    @picture = Picture.find(params[:id])
    @picture.destroy

    respond_to do |format|
      format.html { redirect_to picture_url }
      format.json { head :no_content }
    end
  end
end
</code></pre>

<h3 id="section">7.效果图</h3>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=794ee559c45c1038207ecec7822ae22e/342ac65c103853436bec62629113b07eca808856.jpg?referer=457c5546e7dde711bec576c6e84c&amp;x=.jpg" alt="image" /></p>

<p>这就是最终结果了，如果想要达到jqeury-fileupload Demo中漂亮的结果，如下图，就需要使用Twitter-bootstrap或者自己写写CSS了。</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=ff26dca4932397ddd279980169b9c38a/0dd7912397dda144372a89f1b0b7d0a20cf48656.jpg?referer=354f23adb68f8c54bac4f01fe24c&amp;x=.jpg" alt="image" /></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails Eagerloading]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-eagerloading/"/>
    <updated>2014-02-14T23:05:33+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-eagerloading</id>
    <content type="html"><![CDATA[<p>若存在如下Post model：</p>

<pre><code>class Post &lt; ActiveRecord::Base
	belongs_to :author
	has_many :comments
end
</code></pre>

<p>使用下面的循环加载数据时产生了N+1查询问题：</p>

<pre><code>Post.all.each do |post|
  puts "Post:            " + post.title
  puts "Written by:      " + post.author.name
  puts "Last comment on: " + post.comments.first.created_on
end
</code></pre>

<!-- more -->

<p>首先，解决author获取问题：</p>

<pre><code>Post.includes(:author).each do |post|
</code></pre>

<p>然后解决comments加载：</p>

<pre><code>Post.includes(:author, :comments).each do |post|
</code></pre>

<p>带条件的eager loading：</p>

<pre><code>Post.includes([:author, :comments]).where(['comments.approved = ?', true]).all
</code></pre>

<p>多态关系的eager laoding</p>

<pre><code>class Address &lt; ActiveRecord::Base
	belongs_to :addressable, :polymorphic=&gt;true
end
Address.includes(:addressable)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 创建数据库索引]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-chuang-jian-shu-ju-ku-suo-yin/"/>
    <updated>2014-02-14T23:01:32+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-chuang-jian-shu-ju-ku-suo-yin</id>
    <content type="html"><![CDATA[<p>以经典的customer-order为例</p>

<h3 id="section">1. 在创建数据表时直接创建索引</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rails g model customer
</span><span class="line">rails g model order customer:references
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>查看order的migration文件，rails自动为我们添加了index：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">CreateOrders</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">change</span>
</span><span class="line">		<span class="n">create_table</span> <span class="ss">:orders</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class="line">				<span class="n">t</span><span class="o">.</span><span class="n">refercences</span> <span class="ss">:customer</span>
</span><span class="line">				<span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">		<span class="n">add_index</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:customer_id</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<!-- more -->

<h3 id="section-1">2. 手动附加索引</h3>

<p>此时创建数据表是以普通字段创建的外键</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rails g model customer
</span><span class="line">rails g model order customer_id:integer
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果需要创建索引，就需要手动新建一个migration来添加索引：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">rails g migration add_customer_id_index_to_orders
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>修改migration文件，手动添加index</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">AddCustomerIdIndexToOrders</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">change</span>
</span><span class="line">		<span class="n">add_index</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:customer_id</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="many-to-manyindex">3. many-to-many关系中添加index</h3>

<p>以man-address为例，直接创建中间表并不会自动添加索引，所以需要在中间表内手动添加索引：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">AddAddressesMenTable</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">change</span>
</span><span class="line">		<span class="n">create_table</span> <span class="ss">:address_men</span><span class="p">,</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class="line">			<span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
</span><span class="line">			<span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:man</span><span class="p">,</span><span class="ss">:null</span><span class="o">=&gt;</span><span class="kp">false</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">		<span class="n">add_index</span> <span class="ss">:addresses_men</span><span class="p">,</span><span class="o">[</span><span class="ss">:address_id</span><span class="p">,</span><span class="ss">:man_id</span><span class="o">]</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-2">4. 建议</h3>

<p>所有的外键最好都添加索引。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails使用devise验证用户]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-deviseyan-zheng-yong-hu/"/>
    <updated>2014-02-14T22:46:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-deviseyan-zheng-yong-hu</id>
    <content type="html"><![CDATA[<h3 id="devise">安装配置devise</h3>

<p>在gemfile中添加一行：</p>

<pre><code>gem 'devise'
</code></pre>

<p>执行bundle install后，需要安装devise到工程：</p>

<pre><code>rails generate devise:install
</code></pre>

<p>创建验证用户model，通常用user，也可以使用其他名称：</p>

<pre><code>rails generate devise user
rake db:migrate
</code></pre>

<!-- more -->

<p>查看models文件夹下devise创建了user.rb文件：</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=f2f25a60612762d0843ea4ba90d779c7/8b13632762d0f703ca91709f0afa513d2697c556.jpg?referer=7e3304592a34349b2d115bb5234c&amp;x=.jpg" alt="image" /></p>

<p>devise方法来自Devise gem，其中默认启用了database_authenticatable,registerable等模块，注释部分列出了其他模块默认未启用，根据devise文档按需要使能。</p>

<p>attr_accessible定义的属性可以被create, update_attributes使用，未在这里定义的属性会引发这两个方法的 mass-assignment异常。</p>

<p>查看路由文件 routes.rb，devise gem在创建model时在路由文件中添加了： <code>devise_for :users</code></p>

<p>执行rake routes可以看到devise创建的url：</p>

<p><img src="http://g.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4a985b9df21f3a295ec8d5cba91ecd0c/95eef01f3a292df526325656be315c6035a87384.jpg?referer=0fdbb04d6509c93d5ee53ac7bd9a&amp;x=.jpg" alt="image" /></p>

<p>注意devise gem提供的账户注销和用户退出登陆都是默认使用的DELETE方法，该url设计常导致编码出错，但它确是遵循了RESTful规范，留意下即可。</p>

<p>在需要的页面上添加注册、登陆的代码（我添加在application.html.erb中yield语句上方）：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6ae4814e249759ee4e5060ce82c0322b/503d269759ee3d6d37e5628841166d224f4ade56.jpg?referer=77d0e6a0d739b60014d93a871a4c&amp;x=.jpg" alt="image" /></p>

<p>rails server启动服务器，即可查看注册登陆页面：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=e7392f8d9b25bc312f5d019d6ee4fc8c/e1fe9925bc315c60fe6491ac8fb1cb1348547784.jpg?referer=ba03f4b49d3df8dcff2abba1b19a&amp;x=.jpg" alt="image" /></p>

<h3 id="devisemethod">devise提供的常用method</h3>

<pre><code>* authenticate_user!，验证用户是否登陆，常用于before_filter: `before_filter :authenticate_user!`. 另，如果你创建的devise model叫admin，那么该方法就是authenticate_admin!，以下方法同理。这又是ruby玩的一个小把戏了。
* user_signed_in?，当前是否有登陆用户
* current_user， 获取当前登陆用户
* user_session, 用户session，类似于session，也是一个hash表，可以用来保存用户特有的数据
* after_sign_in_path_for和after_sign_out_path_for方法指定用户登入/登出后的跳转url.
</code></pre>

<h3 id="views">自定义views</h3>

<p>devise gem提供了足够功能的用户验证，但是由上图可见，其自带的view未免太过简单。如果需要自定义视图，就需要将devise默认的view拷贝到rails工程：</p>

<pre><code>rails generate devise:views
</code></pre>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=ff4c4851700e0cf3a4f74efe3a7d8322/9922720e0cf3d7ca14d5da35f01fbe096b63a956.jpg?referer=fc0d600dc880653822fd9123174c&amp;x=.jpg" alt="image" /></p>

<p>该命令将devise的views复制到工程目录app/views下，分类为多个文件夹。修改需要的view模板就能够改变对应界面。</p>

<h3 id="controller">自定义controller</h3>

<ul>
  <li>
    <p>如果需要自定义controller，如Devise::SessionController：</p>

    <pre><code>  class Admins::SessionsController &lt; Devise::SessionsController
  end
</code></pre>
  </li>
  <li>
    <p>在路由文件routes.rb中更新配置，告诉devise使用新的controller</p>

    <pre><code>  devise_for :users, :controllers =&gt; { :sessions =&gt; "admins/sessions" }
</code></pre>
  </li>
  <li>
    <p>更新了controller后，在app/views/devise/sessions下的views不会再被使用，所以，还需要将这部分views复制到app/views/admins/sessions下，或者在该目录下建立新的views。</p>
  </li>
</ul>

<h3 id="section">邮件确认</h3>

<p>如果需要更安全一点的注册验证，可以使用邮件确认方式。</p>

<p>首先，修改user.rb文件，启用devise的confirmable模块：</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=7f58226cbc096b6385195e553c08f679/f31fbe096b63f6241e7edc408544ebf81a4ca356.jpg?referer=e2c37137af3459829c9dd0a20d4c&amp;x=.jpg" alt="image" /></p>

<p>在数据表users中新加字段：</p>

<pre><code>rails g migration add_confirmable_fields_to_users
</code></pre>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=117edc408544ebf86971643ae9c2a617/0d338744ebf81a4c2b11098ad52a6059252da656.jpg?referer=aabcdc8733adcbef58234b36024c&amp;x=.jpg" alt="image" /></p>

<p>新用户是以邮件的方式确认，所以，需要更改rails的环境配置。rails的环境配置位于config/environments/xxx.rb文件，xx代表develepment/test/production，三个文件的配置选项都十分类似，下面以production环境为例，打开config/environments/production.rb，在最后的end前添加：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=464e1e2bcebf6c81f3372ced8c05c008/d058ccbf6c81800ac314734db33533fa838b4784.jpg?referer=0ef348e7a6c27d1efc310ff4a19a&amp;x=.jpg" alt="image" /></p>

<p>配置邮件帐户，在production时rails建议使用邮件服务如Mandrill，这里为了简单，使用gmail帐户示例。</p>

<p>在改文件中继续添加smtp配置，新添加的内容最终如下：</p>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=5cf27e4631fa828bd5239de6cd243009/b03533fa828ba61e481f326c4334970a314e5984.jpg?referer=fb19621ddfc451daafe138dba79a&amp;x=.jpg" alt="image" /></p>

<p>最后，修改devise.rb文件</p>

<pre><code>config.mailer_sender = "replyme@126.com" 
</code></pre>

<p>现在，当新用户new@test.com注册后，它会收到一封确认邮件，邮件from: your_gmail_username@gmail.com, to: new@test.com, reply_to: replyme@126.com，邮件包含一个链接，指向用户激活地址。用户点击该链接激活帐户后才能登陆网站。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby线程]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rubyxian-cheng/"/>
    <updated>2014-02-14T22:35:53+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rubyxian-cheng</id>
    <content type="html"><![CDATA[<h3 id="section">1. 创建线程</h3>

<pre><code>	Thread.new do
		3.times do 
			sleep 3
			puts "Thread #{Thread.current.object_id} running..."
		end
	end
</code></pre>

<p>ruby使用在Thread.new创建线程，线程创建后立即返回，线程也同时开始执行。ruby线程可以在创建块中使用外部变量，也可以使用本地变量，值变量在线程内部保存的是本地副本，而引用变量保存的是一个本地引用。</p>

<pre><code>class Book
	attr_accessor :name
end
num = 0
count = 0
book = Book.new
book.name = 'ybur'
puts "main Thread=#{num} count=#{count} book=#{book.name}"

t.Thread.new(num,book) do |n,b|
	n+=1
	count+=1
	b.name.reverse!
	puts "new Thread:num=#{n} count=#{count} book=#{b.name}"
end
t.join
puts "main Thread:num=#{num} count=#{count} book=#{book.name}"
#=&gt;main Thread:num=0 count=0 book=ybur
#=&gt;new Thread:num=1 count=1 book=ruby
#=&gt;main Thread:num=0 count=1 book=ruby
</code></pre>

<!-- more -->

<p>新线程中保存num的副本，在线程中更改num并不影响外部num值，而新线程对book的修改会直接影响外部book，在新线程中也可打破作用域直接访问外部count并作出修改。</p>

<p>常用方法</p>

<pre><code>Thread.current #获取当前线程
Thread.list #所有线程列表
Thread#status #线程状态
Thread#alive?
Thread#stop?
Thread#join
</code></pre>

<p>线程可以将某些信息放在自身的hash表中，让别的线程访问。使用Thread#value（阻塞方法）访问线程执行最后一行代码的结果：</p>

<pre><code>t=Thread.new(1,10) do |a,b|
	sleep 3
	Thread.current['plus_result']=a+b
	"thread result:#{a+b}"
end
t.join
puts "1+10=#{t['plus_result']}"
puts "#{t.value}"
#=&gt; 1+10=11
#=&gt; thread result:11
</code></pre>

<h3 id="mutex">2. Mutex</h3>

<p>来自ruby-doc的例子</p>

<pre><code>require 'thread'
mutex=Mutex.new
count1=count2=0
difference=0
counter=Thread.new do
	loop do
		mutex.synchronize do
			count1+=1
			count2+=1
		end
	end
end
spy=Thread.new do
	loop do
		mutex.synchronize do
			difference+=(count1-count2).abs
		end
	end
end
sleep 1
mutex.lock
#=&gt; count1 &gt;&gt; 21192
#=&gt; count2 &gt;&gt; 21192
#=&gt; difference &gt;&gt;0
</code></pre>

<h3 id="condition-variables">3. Condition Variables</h3>

<p>来自ruby-doc</p>

<pre><code>require 'thread'
mutext=Mutex.new
cv=ConditionVariable.new
a=Thread.new {
	mutex.synchronize {
		puts "A:I have critical section, but will wait for cv"
		cv.wait mutex
		puts "A:I have critical section again! I rule!"
	}
}
puts "(Later, back at the ranch...)"
b=Thread.new {
	mutex.synchronize {
		puts "B: Now I am critical, but am done with cv"
		cv.signal
		puts "B: I am still critical, finishing up"
	}
}
a.join
b.join

produces:
A:I have critical section, but will wait for cv(Later, back at the ranch...)
B: Now I am critical,but am done with cv
B:I am still critical, finishing up
A: I have critical section again! I Rule!
</code></pre>

<p>在进入临界区并在cv上等待时，会释放该互斥锁mutex，从而才能让别的线程进入临界区，不至于发生死锁。</p>

<h3 id="queue">4. Queue</h3>

<p>ruby的Queue和java的BlockingQueue十分类似。当Queue为空时，执行pop操作会导致线程挂起等待。</p>

<pre><code>require 'thread'
queue=Queue.new
producer=Thread.new do 
	5.times do |i|
		sleep 4
		queue &lt;&lt; i # operator &lt;&lt; is alias of push
		puts "#{i} produced"
	end
end
consumer=Thread.new do 
	5.times do |i|
		value=queue.pop
		sleep 2
		puts "consumed #{value}"
	end
end
</code></pre>

<p>ruby还提供了一个SizedQueue，当达到队列最大长度后，执行push操作时也会导致线程挂起。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails ActiveRecord数据库关系1:n]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-n/"/>
    <updated>2014-02-14T22:05:20+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-n</id>
    <content type="html"><![CDATA[<p>如图所示，在demo数据库中有customers和orders两张表。一个customer有多个order，一个order属于一个customer，是一个1:n关系。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=12b2395769600c33f479decd2a772032/f7246b600c3387449229d53f530fd9f9d62aa081.jpg?referer=20537dc4d2a20cf41f87caef009f&amp;x=.jpg" alt="1:n" /></p>

<ol>
  <li>
    <p>建立数据表</p>

    <pre><code> $ rails g model customer name:string
 $ rails g model order customer_id:integer order_date:datetime
 $ rails g model rake db:migrate
</code></pre>
  </li>
</ol>

<!-- more -->

<ol>
  <li>修改model，添加关系</li>
</ol>

<p>在这个1:n关系中，orders拥有外键customer_id，所以需要在order.rb中添加belongs_to关系，相对应在customer.rb中添加has_many关系。注意rails的约定，用rails g命令创建model时使用单数形式（首字母大小写无所谓），得到的数据库的表名是小写的复数形式，model的类名是驼峰形式的单数形式，model文件名是小写单数形式。</p>

<p>类似1:1关系，同样添加inverse_of和dependent选项。此处dependent选项的多了一个delete_all，即:dependent=&gt;:delete_all，表示移除customer时会删除其order的所有数据库记录，但不调用这些order的destroy方法销毁对象。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>customer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:inverse_of</span> <span class="o">=&gt;</span> <span class="ss">:customer</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>order.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">belongs_to</span> <span class="ss">:customer</span><span class="p">,</span> <span class="ss">:inverse_of</span> <span class="o">=&gt;</span> <span class="ss">:orders</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>操作关系</li>
</ol>

<p>1：n关系中，在belongs_to关系端添加的方法和1：1中类似，不再赘述。在has_many端添加了如下方法：</p>

<pre><code>collection(force_reload=false)
collection&lt;&lt;(object, ...)
collection.delete(object,...)
collection = objects
collection_singular_ids
collection_singular_ids = ids
collection.clear
collection.empty?
collection.size
collection.find(...)
collection.where(...)
collection.exists?(...)
collection.build(attributes={},...)
collection.create(attributes={})
</code></pre>

<p>使用举例：</p>

<pre><code>c = Customer.first
order_list = c.orders #获取customer c的所有orders
c.orders.delete order_list.first #解除关系
c.orders.clear #清空当前customer的所有order
ar = c.order_ids # =&gt; [1,2,3,4,9,12]
c.orders &lt;&lt; Order.create( order_date:DateTime.now ) #自动保存关系到数据库
c.orders.create(order_date:DateTime.now) #和上一行等同
c.orders.build(order_date:DateTime.now) #需要手动保存该order对象
c.orders.size #获取orders的数量
c.orders.find 6 # 找到customer的orders中id为6的order
c.orders.where :order_date=&gt;DateTime.now
c.orders.where("id &gt; ?",6)
c.orders.empty?
</code></pre>

<ol>
  <li>特殊的1：n关系——自引用关联</li>
</ol>

<p>如，一个Employee拥有多个下属，同时也拥有一个主管，这就是一个自引用关系表。</p>

<pre><code>$ rails g model employee name:string manager_id:integer
$ rake db:migrate
</code></pre>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>employee.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">:class_name</span><span class="o">=&gt;</span><span class="s1">&#39;Employee&#39;</span><span class="p">,</span> <span class="ss">:forgeign_key</span><span class="o">=&gt;</span><span class="s1">&#39;manager_id&#39;</span>
</span><span class="line">	<span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">:class_name</span><span class="o">=&gt;</span><span class="s1">&#39;Employee&#39;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>建立好model后，和普通1：n关系使用方法并无二致：</p>

<pre><code>manger = Emloyee.where(manager_id:nil).first
manager.subordinates.each do |s|
	puts s.name
end
</code></pre>

<ol>
  <li>特殊的1：n关系——多态关系</li>
</ol>

<p>多态关系(polymorphic)可以看作是一种特殊的1：n关系。考虑一种情况，Emplyee和Picture是1：n的关系，Product和Picture也是1：n的关系，Company和Picture也是1：n的关系，这样，在Picture的model中就需要添加许多的belongs_to关系，这些belongs_to的功能是非常类似的，多态关系就是为了解决这类重复。</p>

<p>以Picture,Employee,Product为例，首先创建数据表。</p>

<pre><code>$ rails g model picture name:string owner_id:integer owner_type:string
$ rails g model employee
$ rails g model product
</code></pre>

<p>注意在创建pictures时，将所有拥有Picture的model称为owner（也可以取别的名称，如RailsGuide上取名为imageable，个人觉得称为owner更形象），并创建了owner_id和owner_type两个字段，分别表示拥有者model的id和类型。</p>

<p>修改model：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>product.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_many</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">:as</span><span class="o">=&gt;</span><span class="ss">:owner</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>employee.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">:as</span><span class="o">=&gt;</span><span class="ss">:owner</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>picture.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="no">Base</span>
</span><span class="line">	<span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>所有拥有picture的model中，都在其has_many关系中添加了选项:as=&gt;:owner，而picture的model中belongs_to关系添加了:polymorphic=&gt;true选项。这样，如果以后还有新的model和picture是1:n的关系，那么在其中写入has_many :pictures,:as=&gt;:owner即可，不必修改Picture的model及其数据表。</p>

<p>关系的使用：</p>

<pre><code>p1=Picture.create name:'picture-1'
p2=Picture.create name:'picture-2'
e=Employee.create
pro=Product.create
e.pictures&lt;&lt;p1
pro.pictures&lt;&lt;p2

p1.owner.class.name # =&gt; 'Employee'
p2.owner.class.name # =&gt; 'Product'
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails ActiveRecord数据库关系n:n]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-n-n/"/>
    <updated>2014-02-14T21:50:54+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-n-n</id>
    <content type="html"><![CDATA[<p>如图所示，在demo数据库中有assemblies和parts两张表。一个assembly有多个part，一个part也拥有多个assembly，是一个n:n关系。</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=85dca9420855b31998f982707392f31b/78310a55b319ebc49d5a93da8026cffc1e171656.jpg?referer=378ada0800087bf424fb62d9524d&amp;x=.jpg" alt="n-n" /></p>

<!-- more -->

<ol>
  <li>建立数据表</li>
</ol>

<p>由于n:n的关系是以中间表的形式表达的，所以需要创建图示中的三张表assemlies, parts和中间表assemlies_part。</p>

<pre><code>$ rails g model assembly name:string
$ rails g model part part_number:string
$ rails g migration CreateAssembliesAndParts 
</code></pre>

<p>编辑db/migrate/目录下新建的xxxx_create_assemblies_and_parts.rb文件，在该文件中定义中间表：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>20130609063804_create_assemblies_and_parts.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">change</span>
</span><span class="line">		<span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:id</span><span class="o">=&gt;</span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class="line">			<span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:assembly_id</span>
</span><span class="line">			<span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:part_id</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>注意，该表包含n:n的两端表的主键，且自身不使用主键，故:id=&gt;false。</p>

<p>另外，该中间表的表名是“assemblies_part“，以中间的下划线连接两张表，并且按照字母顺序小在前字母顺序大的在后排列，如果创建”part_assemlies“表，则rails可能找不到该中间表。</p>

<p>实际上，rails是以string的”&lt;“操作来比较单词的，所以，如果不确定哪个表在前哪个在后，可以使用该操作符确定一下再创建表。比如有两张表”devil_x“和”devilx”（为什么会有人取这么奇怪的表名呢），那就需要自己来确认一下中间表的表名：</p>

<pre><code>irb(main):002:0&gt; 'devil_x'&lt;'devilx'
=&gt; true
</code></pre>

<p>所以，中间表的表名应该是“devil_x_devilx”。</p>

<p>最后，确认创建数据表：</p>

<pre><code>$ rake db:migrate
</code></pre>

<ol>
  <li>修改model，添加关系</li>
</ol>

<p>在关系的两端都需要添加has_and_belongs_to_many。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>assembly.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>part.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">	<span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>操作关系</li>
</ol>

<p>在n:n关系的两端都添加了如下方法：</p>

<pre><code>collection(force_reload=false)
collection&lt;&lt;(object, ...)
collection.delete(object, ...)
collection = objects
collection_singular_ids
collection_singular_ids = ids
collection.clear
collection.empty?
collection.size
collection.find(...)
collection.where(...)
collection.exists?(...)
collection.build(attributes = {})
collection.create(attributes = {})
</code></pre>

<p>可以看到，添加的方法和has_many关系添加的方法相同，所以就不再重复介绍使用方法。</p>

<ol>
  <li>特殊多对多关系，多态</li>
</ol>

<p>还是以Picture,Employee,Product为例,Picture和Employee,Product都是多对多的关系，首先创建数据表。</p>

<pre><code>$ rails g model picture
$ rails g model picture_box  box_id:integer box_type:string picture_id:integer
$ rails g model employee
$ rails g model product
</code></pre>

<p>修改model：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>product.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">   <span class="n">has_many</span> <span class="ss">:picture_boxes</span><span class="p">,</span> <span class="ss">:as</span><span class="o">=&gt;</span><span class="ss">:box</span>
</span><span class="line">   <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span><span class="ss">through</span><span class="p">:</span> <span class="ss">:picture_boxes</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>employee.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">   <span class="n">has_many</span> <span class="ss">:picture_boxes</span><span class="p">,</span> <span class="ss">:as</span><span class="o">=&gt;</span><span class="ss">:box</span>
</span><span class="line">   <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span><span class="ss">through</span><span class="p">:</span> <span class="ss">:picture_boxes</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>picture.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="no">Base</span>
</span><span class="line">	<span class="n">has_many</span> <span class="ss">:picture_boxes</span>
</span><span class="line">    <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span><span class="ss">through</span><span class="p">:</span> <span class="ss">:picture_boxes</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:box</span><span class="p">,</span> <span class="n">source_type</span><span class="p">:</span> <span class="s1">&#39;Product&#39;</span>
</span><span class="line">    <span class="n">has_many</span> <span class="ss">:employee</span><span class="p">,</span><span class="ss">through</span><span class="p">:</span> <span class="ss">:picture_boxes</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:box</span><span class="p">,</span> <span class="n">source_type</span><span class="p">:</span> <span class="s1">&#39;Employee&#39;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>picture_box.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">PictureBox</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="no">Base</span>
</span><span class="line">	<span class="n">belongs_to</span> <span class="ss">:box</span><span class="p">,</span> <span class="ss">:polymorphic</span><span class="o">=&gt;</span><span class="kp">true</span>
</span><span class="line">    <span class="n">belongs_to</span> <span class="ss">:picture</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>所有拥有picture的model中，都在其has_many关系中添加了选项:as=&gt;:box，而picture的model中has_many关系添加了:polymorphic=&gt;true选项。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails ActiveRecord数据库关系1:1]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-1/"/>
    <updated>2014-02-14T21:25:17+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-1</id>
    <content type="html"><![CDATA[<p>如图所示，在demo数据库中有suppliers和accounts两张表。一个supplier有一个account，一个account属于一个supplier，是一个1:1关系。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=e9efbd7d0ef3d7ca08f63f73c224cf34/730e0cf3d7ca7bcb7b8b3d6cbc096b63f724a885.jpg?referer=c1b305f367380cd7bf0996dd089b&amp;x=.jpg" alt="1-1" /></p>

<!-- more -->

<ol>
  <li>
    <p>建立数据表</p>

    <pre><code>  $ rails g model supplier name:string
  $ rails g model account supplier_id:integer account_number:string
  $ rake db:migrate
</code></pre>
  </li>
  <li>
    <p>修改model，添加关系</p>
  </li>
</ol>

<p>在这个1:1关系中，accounts拥有外键supplier_id，所以需要在account.rb中添加belongs_to关系，相对应在supplier.rb中添加has_one关系。注意rails的约定，用rails g命令创建model时使用单数形式（首字母大小写无所谓），得到的数据库的表名是小写的复数形式，model的类名是驼峰形式的单数形式，model文件名是小写单数形式。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>account.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>supplier.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">    <span class="n">has_one</span> <span class="ss">:account</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>对于1:1关系，有几个常用的可选项：</p>

<p>:dependent: 对于has_one关系的一方（supplier)，可以添加:dependent选项为destroy, delete,nullify，destroy表示删除supplier会同时删除它拥有的account(包括内存对象和数据库记录)，delete表示删除supplier会删除拥有account的数据库记录但不调用其destroy销毁内存对象，nullify表示删除supplier会解除和account的关系，即仅将其拥有account中的外键置为NULL。</p>

<p>:inverse_of: 该选项成对出现，保证一对关系中的数据同步，避免出现下面的情况：</p>

<pre><code>s=Supplier.first
a=s.account
s.name==a.supplier.name #=&gt;true
s.name="new_name"
s.name==a.supplier.name #=&gt;false
</code></pre>

<p>所以，再次修改model：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>account.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">:inverse_of</span><span class="o">=&gt;</span><span class="ss">:account</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>supplier.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">    <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">:dependent</span><span class="o">=&gt;</span><span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:inverse_of</span><span class="o">=&gt;</span><span class="ss">:supplier</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>关系操作</li>
</ol>

<p>在建立1:1关系后，关系的两端都自动添加了如下方法来创建关系：</p>

<pre><code>association(force_reload = false)
association = (associate)
build_association(attributes = {})
create_association(attributes = {})
</code></pre>

<p>即，在rails中可以这样使用：</p>

<pre><code>s = Supplier.first
a = s.account #获取关系
s.account = Account.find(11) #创建关系
#仅仅创建关系，这个acc并没有被保存
acc = s.build_account(account_number:"1234")
#这个新的acc被创建并保存
acc = s.create_account(account_number:"4589")
</code></pre>

<p>需要注意的是，对于association=()方法，在1:1关系的两端的工作是不一样的。</p>

<pre><code>#关系被自动保存到数据库
@supplier.account = @account
#关系保存在内存，除非现实调用save，否则关系不会保存到数据库
@account.supplier = @supplier #并未保存关系
@account.save #保存了二者的关系
</code></pre>

<p>这个问题对于1：n关系也同样存在，在1的一方建立关系会自动保存，在多的一方建立关系不会自动保存。对于什么时候应该使用save方法，什么时候不必使用，有一个好记的规则，如果model包含外键，那么在该model上调用association=()建立的关系需要save（如上例的account），反过来如果model不包含外键，则不需要（如上例的supplier）。</p>

<p>解除关系：</p>

<pre><code>@supplier.account = nil
@supplier.account.delete
</code></pre>

<p>在本例中，上述两种办法都可以解除关系，并且会删除account对象。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go学习笔记-类型与接口]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-lei-xing-yu-jie-kou/"/>
    <updated>2014-02-14T18:27:36+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-lei-xing-yu-jie-kou</id>
    <content type="html"><![CDATA[<p>如果说go语言的其他内容看起来和c/c++语言没什么太大的区别，那么它的接口设计一定会让人大吃一惊，是的，有时它真的让我产生我使用的是一种动态语言的幻觉。</p>

<!-- more -->

<h3 id="section">结构类型</h3>

<p>这里，还是和C语言很像的，定义结构：</p>

<pre><code>type Man struct {
     name string
     age int
}
</code></pre>

<p>声明结构变量及初始化：</p>

<pre><code>var m Man   //声明Man变量
m := new(Man)  //声明一个Man指针
m := Man{name:"jack",age:12} //声明并初始化 
m := Man{"jack",12}  //声明并初始化
</code></pre>

<h3 id="section-1">方法</h3>

<p>go语言为结构定义的函数称为方法，和面向对象的叫法是一样的。go语言的方法定义看起来非常前卫，方法即消息，所以方法定义先是说明方法(消息)接收者，然后是方法名及其参数。</p>

<pre><code>func (m *Man) Introduce() bool {
    fmt.Println("name: ",m.name)
    return true
}
</code></pre>

<p>调用方法使用了”.”符号：</p>

<pre><code>m := Man{"Jack",12}
ok := m.Introduce()
</code></pre>

<p>利用结构的方法，我们甚至还能像ruby一样，为系统中预定类型打个猴子补丁，添加新的方法，只不过手段稍微曲线了一点，比如，下面代码为字符串(不是string类型)添加一个chomp方法来去掉字符串最后一个换行符：</p>

<pre><code>package main
import (
	"fmt"
	"strings"
)

type MyString string
func (str MyString) chomp() string {
	return strings.TrimRight(string(str),"\n")
}
func main() {
	str := "Hello world!\n"
	ms := MyString(str)
	fmt.Println(ms.chomp())   //输出 Hello world!
}
</code></pre>

<h3 id="section-2">方法代理</h3>

<p>其实google把这个特性叫做嵌入类型(Embedded type)，如果类型A包含一个类型B，通常在其他语言里我们称之为 A  has-a B，但在go里我们称之为A是一个B，这是因为B成为了A的成员，那么我们可以视为A也就拥有了B的功能，那么它也就是一个B了。那么方法代理的作用是什么呢？顾名思义，我们可以在A上直接调用B的方法，就好像A.B.b_method一样，举个例子：在 matrix里，neo是救世主，所以他具有（包含）了救世主的能力，所以我们直接发送fly的消息给neo，neo肯定是可以飞的，同样neo的前几代救世主可能不叫neo但我们直接告诉他fly，他们都是可以飞的，所以利用方法代理的确简捷直当：</p>

<pre><code>package main
import "fmt"
func main() {
	n := new(Neo)
	n.Fly()  //输出：The One can fly!
}

type Neo struct{
	TheOne
}
type TheOne struct{}

func (o *TheOne) Fly(){
	fmt.Println("The One can fly!")
}
</code></pre>

<p>在ruby语言中，有许多做这种方法代理的代码，而go语言的嵌入类型的表征和该特性竟是如此神似，嘿嘿</p>

<p>另外，大家觉得这个嵌入类型和OOP的继承很像，为什么不叫继承而叫方法代理呢？实际情况就是， Neo做的仅仅是将消息转发给TheOne，就算二者有相同的成员，但fly方法也只能看到TheOne的成员变量，所以叫方法代理更合适，大家可以写代码验证下。</p>

<h3 id="go-style-duck-type">go style duck-type</h3>

<p>go风格的鸭子类型。个人觉得这是go语言里最cool的地方了，在静态语言里将动态语言的鸭子类型实现得如此风骚。go语言的接口就是为此而生的。</p>

<p>接口定义：</p>

<pre><code>type Duck interface {
     run()
     height() int
     gaga(word string)
}
</code></pre>

<p>Duck接口中仅包含了一系列的方法声明。</p>

<p>然后在方法参数中我们可以这样使用：</p>

<pre><code>func DuckRun(d Duck){
    d.run()
}
</code></pre>

<p>那么是不是我们需要去完成多个Duck接口的实现呢？NO。那样岂不是和java一样了。go语言的interface的唯一用处其实是为了满足编译器（唉，多少有点无奈），这样编译器在DuckRun函数入口会检查传递进来的对象是否含有Duck接口所包含的三个方法，如果符合定义，则通过编译。这样不就是鸭子类型吗？仅检查是否包含这些方法，而不管是否是某种类型，所以说go style的鸭子类型是很了不起的。</p>

<p>举个例子，人是有say说话的方法的，但其实对于某个需要say方法的函数中，我们可以给它传递一个地球对象，尽管地球什么话也不会说：</p>

<pre><code>package main
import "fmt"
func main() {
     m := Man{name:"Jack"}
	 m.say()
	 e := new(Earch)
	 SaySth(e)
	 SaySth(&amp;m)  //say()方法的接收者是一个指针变量，所以这里要用&amp;取地址
}
func SaySth(obj Object){
	obj.say()
}
type Object interface{
	say()
}
type Man struct{
	name string
}
type Earch struct{}

func (m *Man) say(){
	fmt.Println("Man says: I'm ",m.name)
}

func (e *Earch) say(){
	//do nothing
}
</code></pre>

<h3 id="section-3">空接口及类型</h3>

<p>空interface(interface{})不包含任何的method,正因为如此,所有的类型都实现了空interface。空interface对于描述起不到任何的作用(因为它不包含任何的method),但是空interface在我们需要存储任意
类型的数值的时候相当 有用,因为它可以存储任意类型的数值。它有点类似于C语言的void*类型。</p>

<pre><code>// 定义a为空接口
var a interface{}
var i int = 5
s := "Hello world"
// a可以存储任意类型的数值 a=i,a=s
</code></pre>

<p>一个函数把interface{}作为参数,那么他可以接受任意类型的值作为参数,如果一个函数返回interface{},那么也 就可以返回任意类型的值。</p>

<p>我们知道interface的变量里面可以存储任意类型的数值(该类型实现了interface)。那么我们怎么反向知道这个变量 里面实际保存了的是哪个类型的对象呢?可以使用Comma-ok断言</p>

<pre><code>value, ok = element.(T)
</code></pre>

<p>这里value就是变 量的值,ok是一个bool类型,element是interface变量,T是断言的类型。</p>

<p>如果element里面确实存储了T类型的数值,那么ok返回true,否则返回false。</p>

<p>此外，关于go语言中类型处理的要求更多时，就需要使用反射。Go语言实现了反射,所谓反射就是动态运行时的状态。我们一般用到的包是reflect包。使用reflect一般分成三步,下面简要的讲解一下:要去反射是一个类型的值(这些值都实现了空interface),首先需 要把它转化成reflect对象(reflect.Type或者reflect.Value,根据不同的情况调用不同的函数)。这两种获取方式如 下:</p>

<pre><code>t := reflect.TypeOf(i) //得到类型的元数据,通过t我们能获取类型定义里面的所有元素
v := reflect.ValueOf(i) //得到实际的值,通过v我们获取存储在里面的值,还可以去改变值
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go学习笔记-go routine]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-go-routine/"/>
    <updated>2014-02-14T18:23:38+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-go-routine</id>
    <content type="html"><![CDATA[<h2 id="go-routine-indeed">Go routine indeed</h2>

<blockquote>
  <p>本段结论引用自：goroutine背后的系统知识，让我了解为什么goroutine这么轻量级，以及其优势劣势。</p>
</blockquote>

<p>Go语言通过goroutine提供了目前为止所有(我所了解的)语言里对于并发编程的最清晰最直接的支持，Go语言的文档里对其特性也描述的非常全面甚至超过了，在这里，基于我们上面的系统知识介绍，列举一下goroutine的特性，算是小结：</p>

<p>(1) goroutine是Go语言运行库的功能，不是操作系统提供的功能，goroutine不是用线程实现的。具体可参见Go语言源码里的pkg/runtime/proc.c</p>

<p>(2) goroutine就是一段代码，一个函数入口，以及在堆上为其分配的一个堆栈。所以它非常廉价，我们可以很轻松的创建上万个goroutine，但它们并不是被操作系统所调度执行</p>

<p>(3) 除了被系统调用阻塞的线程外，Go运行库最多会启动$GOMAXPROCS个线程来运行goroutine</p>

<p>(4) goroutine是协作式调度的，如果goroutine会执行很长时间，而且不是通过等待读取或写入channel的数据来同步的话，就需要主动调用Gosched()来让出CPU</p>

<p>(5) 和所有其他并发框架里的协程一样，goroutine里所谓“无锁”的优点只在单线程下有效，如果$GOMAXPROCS &gt; 1并且协程间需要通信，Go运行库会负责加锁保护数据，这也是为什么sieve.go这样的例子在多CPU多线程时反而更慢的原因</p>

<p>(6) Web等服务端程序要处理的请求从本质上来讲是并行处理的问题，每个请求基本独立，互不依赖，几乎没有数据交互，这不是一个并发编程的模型，而并发编程框架只是解决了其语义表述的复杂性，并不是从根本上提高处理的效率，也许是并发连接和并发编程的英文都是concurrent吧，很容易产生“并发编程框架和coroutine可以高效处理大量并发连接”的误解。</p>

<p>(7) Go语言运行库封装了异步IO，所以可以写出貌似并发数很多的服务端，可即使我们通过调整$GOMAXPROCS来充分利用多核CPU并行处理，其效率也不如我们利用IO事件驱动设计的、按照事务类型划分好合适比例的线程池。在响应时间上，协作式调度是硬伤。</p>

<p>(8) goroutine最大的价值是其实现了并发协程和实际并行执行的线程的映射以及动态扩展，随着其运行库的不断发展和完善，其性能一定会越来越好，尤其是在CPU核数越来越多的未来，终有一天我们会为了代码的简洁和可维护性而放弃那一点点性能的差别。</p>

<!-- more -->

<h3 id="go-routine">启动一个go routine</h3>

<p>go关键字+函数名即可启动一个go routine:</p>

<pre><code>package main
import (
	"fmt"
	"time"
)
func p() {
     for i := 0; i &lt; 100; i++ {
           fmt.Println(i)
		   time.Sleep(time.Second * 1)
	   } 
}
func main() {
     go p()
     var input string
     fmt.Scanln(&amp;input)
	 fmt.Println("End")
}
</code></pre>

<h3 id="goroutinechannel">goroutine通信：Channel</h3>

<p>go routine使用channel来进行routine间的通信：</p>

<pre><code>package main
import (
	"fmt"
	"time"
	"math/rand"
)
func sell(c chan int) {
	for {
	num := &lt;- c
	fmt.Println("Sell ",num," bread")
}
}
func produce(c chan int){
	for {
	num := rand.Intn(10)
	t := time.Duration(num)
	fmt.Println("Product ",num," bread")
	c &lt;- num
	time.Sleep(time.Second* t)
	}
}
func main() {
	var c chan int = make(chan int)
     go sell(c)
	 go produce(c)
     var input string
     fmt.Scanln(&amp;input)
	 fmt.Println("End")
}
//输出结果：
Product  1  bread
Sell  1  bread
Product  7  bread
Sell  7  bread
Product  7  bread
Sell  7  bread
Product  9  bread
Sell  9  bread
</code></pre>

<p>默认channel是双向的，在函数入口也可以定义为单向：</p>

<pre><code>func sell(c &lt;-chan int)  //只能从通道取出
func produce(c chan&lt;- int) //通道只能放入
</code></pre>

<p>select语句用于在多个channel中选择已经ready的通道，如：</p>

<pre><code>select {
case msg1 := &lt;- c1:
     fmt.Println("Message 1", msg1)
case msg2 := &lt;- c2:
     fmt.Println("Message 2", msg2)
case &lt;- time.After(time.Second):
     fmt.Println("timeout")
default:
     fmt.Println("nothing ready")
}
</code></pre>

<p>time.After会在指定时间后创建一个匿名通道，用来进行等待超时。如果所有channel都没有准备妥当，则立即执行default块。</p>

<p>在make channel时指定第二个参数可以创建一个缓冲通道，类似其他高级语言中的定长队列：</p>

<pre><code>c := make(chan int, 1)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go学习笔记-函数和包]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-han-shu-he-bao/"/>
    <updated>2014-02-14T18:15:26+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/goxue-xi-bi-ji-han-shu-he-bao</id>
    <content type="html"><![CDATA[<h3 id="section">函数定义</h3>

<p>go语言中使用func关键字定义函数，如main函数的定义：</p>

<pre><code>func main() {
	 fmt.Println("main function")
}
</code></pre>

<p>定义一个具有参数和返回值的函数：</p>

<pre><code>func sum(a int,b int) int {
	return a+b
}
</code></pre>

<!-- more -->

<h3 id="section-1">多值返回</h3>

<p>go语言的函数可以有多个返回值，它是真正的多值返回，这个特性让ruby之父都有些艳羡呢（ruby的多值实际上是返回的列表）。</p>

<pre><code>func sum(a int,b int) (int,bool){
	s := a+b
	t := true
	return s,t
}
</code></pre>

<p>调用函数时，可以这样获取多个值：</p>

<pre><code>m,n := sum(1,2)
//如果，不需要全部的返回值，可以用_来替代
m,_ := sum(1,2)
</code></pre>

<p>多值返回还有一个很cool的特性，如果返回值使用了命名参数，那么函数最后可以直接使用空的return语句，go函数会自动寻找匹配返回值的变量返回：</p>

<pre><code>func sum(a int,b int) (s int,t bool){
	s = a+b
	t = true
	return 
}
</code></pre>

<h3 id="section-2">闭包</h3>

<p>go语言另一个很cool的特性就是它支持了闭包，虽然这在众多的动态语言中已经被玩坏了，不过go语言明确对它提出了支持，这仍旧是令人十分激动的。</p>

<pre><code>func main() {
     x := 0
     increment := func() int {
           x++
return x }
     fmt.Println(increment())
     fmt.Println(increment())
}
</code></pre>

<h3 id="defer">defer</h3>

<p>go语言的defer延迟执行是一个很有意思的特性，它将defer后的函数推迟到退出函数的最后一刻才执行：</p>

<pre><code>func main() {
    defer second()
	first() 
}
</code></pre>

<p>main函数里执行的真正顺序是first()，然后才是 second()，defer保证其后的函数会最后执行，甚至在发生运行时异常后，也会保证执行。</p>

<pre><code>package main
import "fmt"
func main() {
     defer func() {
           str := recover()
           fmt.Println(str)
     }()
     panic("PANIC")
}
</code></pre>

<h3 id="section-3">指针</h3>

<p>go的指针和c语言的指针用法非常类似，不再赘述。另外go还提供了另一种创建指针的方式，new关键字，它返回对应类型的地址：</p>

<pre><code>func one(xPtr *int) {
     *xPtr = 1
}
func main() {
     xPtr := new(int)
     one(xPtr)
     fmt.Println(*xPtr) // x is 1
}
</code></pre>

<h3 id="go">go保留函数</h3>

<blockquote>
  <p>本节内容来自：Go Web编程</p>
</blockquote>

<blockquote>
  <p>Go里面有两个保留的函数:init函数(能够应用于所有的package)和main函数(只能应用于package main)。 这两个函数在定义时不能有任何的参数和返回值。虽然一个package里面可以写任意多个init函数,但这无论是对 于可读性还是以后的可维护性来说,我们都强烈建议用户在一个package中每个文件只写一个init函数。</p>

  <p>Go程序会自动调用init()和main(),所以你不需要在任何地方调用这两个函数。每个package中的init函数都是可选的,但package main就必须包含一个main函数。</p>

  <p>程序的初始化和执行都起始于main包。如果main包还导入了其它的包,那么就会在编译时将它们依次导入。有时一 个包会被多个包同时导入,那么它只会被导入一次(例如很多包可能都会用到fmt包,但它只会被导入一次,因为没 有必要导入多次)。</p>
</blockquote>

<h4 id="section-4">包的引入</h4>

<p>我们在写Go代码的时候经常用到import这个命令用来导入包文件,而我们经常看到的方式参考如下:</p>

<pre><code>import(
   "fmt"
)
</code></pre>

<p>然后我们代码里面可以通过如下的方式调用</p>

<pre><code>fmt.Println("hello world")
</code></pre>

<p>上面这个fmt是Go语言的标准库,其实是去goroot下去加载该模块,当然Go的import还支持如下两种方式来加载自己写的模块:</p>

<ol>
  <li>
    <p>相对路径</p>

    <pre><code> import “./model”   //当前文件同一目录的model目录,但是不建议这种方式来import
</code></pre>
  </li>
  <li>
    <p>绝对路径</p>

    <pre><code> import “shorturl/model”   //加载$GOPATH/src/shorturl/model模块
</code></pre>
  </li>
</ol>

<p>上面展示了一些import常用的几种方式,但是还有一些特殊的import,让很多新手很费解,下面我们来一一讲解一下 到底是怎么一回事</p>

<ol>
  <li>点操作</li>
</ol>

<p>我们有时候会看到如下的方式导入包</p>

<pre><code>import(
   . "fmt"
)
</code></pre>

<p>这个点操作的含义就是这个包导入之后在你调用这个包的函数时,你可以省略前缀的包名,也就是前面你调用的<code>fmt.Println("hello world")</code>可以省略的写成<code>Println("hello world")</code></p>

<ol>
  <li>别名操作</li>
</ol>

<p>别名操作顾名思义我们可以把包命名成另一个我们用起来容易记忆的名字</p>

<pre><code>import(
   f "fmt"
)
</code></pre>

<p>别名操作的话调用包函数时前缀变成了我们的前缀,即 f.Println(“hello world”)</p>

<ol>
  <li>_操作</li>
</ol>

<p>这个操作经常是让很多人费解的一个操作符,请看下面这个import</p>

<pre><code>import (
     "database/sql"
     _ "github.com/ziutek/mymysql/godrv"
)
</code></pre>

<p>_操作其实是引入该包,而不直接使用包里面的函数,而是调用了该包里面的init函数</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[shell字符串处理]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/shellzi-fu-chuan-chu-li/"/>
    <updated>2014-02-14T18:10:30+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/shellzi-fu-chuan-chu-li</id>
    <content type="html"><![CDATA[<h3 id="section">1.获取字符串长度</h3>

<pre><code>${#string}
</code></pre>

<p>-</p>

<pre><code>[jason@localhost ~]$ str="hello,world"
[jason@localhost ~]$ echo ${#str}
11
</code></pre>

<h3 id="section-1">2.获取子串</h3>

<pre><code>${string:position}
${string:position:length}
$(string:(-postion)) 如果使用负数，表示从右开始计数，注意负数必须使用括号 -

[jason@localhost ~]$ str=ABCDEFGHIJKLMN
[jason@localhost ~]$ echo ${str:1}
BCDEFGHIJKLMN
[jason@localhost ~]$ echo ${str:1:2}
BC
[jason@localhost ~]$ echo ${str:(-2)}
MN
</code></pre>

<!-- more -->

<h3 id="section-2">3.子串切除</h3>

<pre><code>${string#substring} 从左向右切除最短匹配的子串
${stirng##substring} 从左向右切除最长匹配的子串
${string%substring} 从右向左切除最短匹配的子串
${stirng%%substring} 
</code></pre>

<h3 id="section-3">4.字符串正则提取</h3>

<pre><code>echo $string | grep -oE "regexpression"

#awk的match方法利用RSTART和RLENGTH分别保存匹配的起点(从1开始)和匹配到的长度,RSTART同时也是match方法的返回值，如果没找到则RSTART==0,RLENGHT==-1
echo $string | awk '{ match($0,"reg"); print substr($0,RSTART,RLENGTH)}'
</code></pre>

<p>-</p>

<pre><code>[jason@localhost ~]$ str="I am 12 years old"
[jason@localhost ~]$ echo $str | grep -Eo '[0-9]+'
12
[jason@localhost ~]$ str="I am 12 years old"
[jason@localhost ~]$ echo $str | awk '{ if(match($0,"[0-9]+")){ print substr($0,RSTART,RLENGTH) } }'
12
</code></pre>

<h3 id="section-4">5.字符串正则替换</h3>

<pre><code>echo $string | sed -r 's/regexpr/replacement' -

[jason@localhost ~]$ str="I am 12 years old" 
[jason@localhost ~]$ echo $str | sed -r  "s/ am/'m/"
I'm 12 years old
</code></pre>

<h3 id="section-5">6.分割字符串</h3>

<pre><code>awk
</code></pre>

<p>-</p>

<pre><code>[jason@localhost ~]$ str="I_am_12_years_old, and you?"
[jason@localhost ~]$ echo $str | awk -F '_' '{print $3}'
12
[jason@localhost ~]$ echo $str | awk  '{split($1,a,"_");print a[3]}'
12
</code></pre>

<h3 id="section-6">7. 获取索引</h3>

<pre><code>awk '{print match($0,"substring")}'
</code></pre>

<p>-</p>

<pre><code>[jason@localhost ~]$ str="I_am_12_years_old, and you?"
[jason@localhost ~]$ echo $str | awk '{print match($0,"[0-9]+")}'
6
</code></pre>

<p>注意这个索引是从1开始的</p>

<h3 id="sed">8.sed分组</h3>

<p>sed的分组是很好玩的，在替换模式中，“&amp;”代表前面匹配的全部字符串，而反斜杠加数字表示分组。</p>

<pre><code>[jason@localhost ~]$ str="name:jack;age:12"
[jason@localhost ~]$ echo $str | sed -r 's/name:[^;]+/[&amp;]/'
[name:jack];age:12
[jason@localhost ~]$ echo $str | sed -r 's/name:([^;]+)/--\1--/'
--jack--;age:12
</code></pre>

<h3 id="awk">9.awk专题</h3>

<p><strong>常用字符串处理函数</strong></p>

<pre><code>sub(reg,replacement,string)
gsub(reg,replacement,string)
</code></pre>

<p>将string中匹配正则表达式reg的字符串（全部）替换为replacement</p>

<pre><code>[jason@localhost ~]$ str="name:jack;age:12"
[jason@localhost ~]$ echo $str | awk '{gsub(/a/,"A",$0);print $0}'      
nAme:jAck;Age:12
</code></pre>

<p>-</p>

<pre><code>index(substring,string) #返回子字符串substring在字符串string中的位置
length(string) #获取字符串的长度
match(string,reg) #获取匹配reg得到的子串在字符串中的位置
split(string,array,separator) #将字符串按分隔符separator分割到array数组中，返回值为数组长度
sprintf("format",expression) #和c语言的sprintf类似
printf("format",expression) #和c语言的printf类似
substr(string,position,length)  #获取子字符串
tolower(string)
toupper(string)
</code></pre>

<p><strong>awk的常见控制语法</strong></p>

<pre><code>exit #退出awk执行
next #跳转到命令块首，并开始下一行数据读入
NF #列数
NR #行号
FS #分隔符
FILENAME #文件名
</code></pre>

<p><strong>定义函数</strong></p>

<p>在awk中还可以定义函数：</p>

<pre><code>awk 'function sum(a,b){
	print "Computing..."
	return a+b
}BEGIN{ print sum(1,2) }' -
#写个二分搜索
awk 'function bsearch(element,arr,low,high){
	while(low&lt;=high){
		mid=int((low+high)/2)
		if(arr[mid]==element)
			return mid
		else if(arr[mid]&lt;element)
			low=mid+1
		else
			high=mid-1
	}
	return -1
}
BEGIN{ arr[1]="a";arr[2]="b";print bsearch("a",arr,1,2)}' -
</code></pre>

<p><strong>给awk传递shell变量值</strong></p>

<p>方法一：<code>awk '{action}' name1=val1 name2=val2 file</code>，变量值无法在<code>BEGIN</code>中获得</p>

<pre><code>$ var="SHELL"
$ awk 'BEGIN{print a}{print a}END{print a}' a=$var file
#输出

SHELL
</code></pre>

<p>方法二：<code>awk -v name=value '{action}' file</code>，变量在三种块中都可以获得</p>

<pre><code>$ var="SHELL"
$ awk -v a=$var 'BEGIN{print a}{print a}END{print a}' file
#输出
SHELL
SHELL
SHELL
</code></pre>

<p>P.S.awk获取环境变量</p>

<pre><code>$ awk 'BEGIN{print ENVIRON["LANG"]}' -
en_US
</code></pre>

<p>P.S.给awk传递数组，可以先将数组转化为字符串再作为参数传递，在awk内部再用<code>split</code>函数还原为数组</p>

<p><strong>awk中调用shell命令</strong></p>

<p>awk中调用shell命令，使用<code>system()</code>函数，被引号括起来的内容会直接发送给shell，而没有括起来的部分被当做awk当中的变量替换</p>

<pre><code>$ awk 'BEGIN{a="AWK";system("echo "a)}' -
AWK
</code></pre>

<p>如果在awk中调用系统命令且希望获取命令的输出可以这样，例如要执行<code>echo</code>命令：</p>

<pre><code>$ awk 'BEGIN{cmd="echo hello"; cmd|getline x; print x}' -
hello
</code></pre>

<p>最好是将命令先写到变量如cmd，然后再管道到getline，否则有时可能获取不到输出。</p>

<p><strong>awk的正则表达式</strong></p>

<p>awk中支持的正则表达式是ERES,它包含下列特殊符号：</p>

<ul>
  <li><strong>+</strong>, 指定如果一个或多个字符或扩展正则表达式的具体值（在 +（加号）前）在这个字符串中，则字符串匹配。</li>
  <li><strong>?</strong>,	指定如果零个或一个字符或扩展正则表达式的具体值（在 ?（问号）之前）在字符串中，则字符串匹配</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>**</td>
          <td>**	, 指定如果以</td>
          <td>（垂直线）隔开的字符串的任何一个在字符串中，则字符串匹配。</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li><strong>( )</strong>,	在正则表达式中将字符串组合在一起。</li>
  <li><strong>{m}</strong>,	指定如果正好有 m 个模式的具体值位于字符串中，则字符串匹配。</li>
  <li><strong>{m,}</strong>,	指定如果至少 m 个模式的具体值在字符串中，则字符串匹配</li>
  <li><strong>{m, n}</strong>, 	指定如果 m 和 n 之间（包含的 m 和 n）个模式的具体值在字符串中（其中m &lt;= n），则字符串匹配。</li>
  <li><strong>[String]</strong>,	指定正则表达式与方括号内 String 变量指定的任何字符匹配。</li>
  <li><strong>[^ String]</strong>,	在 [ ]（方括号）和在指定字符串开头的 ^ (插入记号) 指明正则表达式与方括号内的任何字符不匹配。</li>
  <li><strong>~,!~</strong>,	表示指定变量与正则表达式匹配（代字号）或不匹配（代字号、感叹号）的条件语句。</li>
  <li><strong>^</strong>,	指定字段或记录的开头。</li>
  <li><strong>$</strong>,	指定字段或记录的末尾。</li>
  <li><strong>.</strong>, （句号）	表示除了在空白末尾的终端换行字符以外的任何一个字符。</li>
  <li><strong>*</strong>（星号）	表示零个或更多的任意字符。</li>
  <li><strong>\</strong> (反斜杠)	转义字符</li>
</ul>

<p>对竖线符号<code>|</code>补充两句：</p>

<pre><code>#匹配的内容是good或bad，是将两个整体来匹配
good|bad
#匹配的内容是以d结尾的单词，该单词要么以goo开头要么以ba开头
(goo|ba)d
</code></pre>

<p>上面两种竖线匹配结果是一样的，但是匹配的方式不一样，<code>()</code>改变了<code>|</code>的作用域，有时可能导致匹配错误，需要注意。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[code snippets]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/code-snippets/"/>
    <updated>2014-02-14T18:08:28+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/code-snippets</id>
    <content type="html"><![CDATA[<h3 id="rubyutf-8">ruby文件utf-8编码</h3>

<pre><code># -*- coding: UTF-8 -*-
</code></pre>

<h3 id="ssh">退出ssh登录后继续执行命令</h3>

<p>如果long_run_cmd是一个长时间执行的命令，而我们又想在退出ssh后不至于中断该命令：</p>

<pre><code>nohup long_run_cmd &amp;
</code></pre>

<!-- more -->

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rake-ruby's make]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rake-rubys-make/"/>
    <updated>2014-02-14T17:49:14+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rake-rubys-make</id>
    <content type="html"><![CDATA[<p>Rake，顾名思义，就是Ruby的Make工具。</p>

<h2 id="rake">Rake的特性</h2>

<p>Rakefile就是rake版本的makefile文件，它使用的就是标准的ruby语法。不需要编辑XML文件，也不需要记忆古怪的makefile语法。</p>

<ul>
  <li>可以定义任务（task），并为任务定义依赖。</li>
  <li>rake支持利用规则模式来合成隐式任务。</li>
  <li>灵活的文件列表，可以像列表一样操作。</li>
  <li>预置的库使得编写rakefile变得更加简单。</li>
  <li>支持并行执行多个任务。</li>
</ul>

<p>所以说，rakefile文件没有特殊的格式，仅仅是一个包含ruby代码的文件，不过，仍然有一些关于rakefile的约定，遵循这些约定，使得rake能够更好地处理任务和行为。</p>

<!-- more -->

<h2 id="task">任务(Task)</h2>

<p>Task是rakefile的最重要组成部分。task拥有自己的名称（通常使用符号或字符串命名），一个依赖列表，以及一系列动作（在task的块中定义）。</p>

<h3 id="section">简单任务</h3>

<p>使用task方法定义任务。task方法接受单个参数作为任务名称。</p>

<pre><code>task :name
</code></pre>

<h3 id="section-1">依赖任务</h3>

<p>依赖以列表的形式紧跟任务名。</p>

<pre><code>task :name =&gt; [:prereq1, :prereq2]
</code></pre>

<h3 id="section-2">任务动作</h3>

<p>在task方法块中定义动作，块中可以使用任意ruby代码。块中的Ruby代码也可以使用块的参数引用任务对象本身。</p>

<pre><code>task :name =&gt; [:prereq1, :prereq2] do |t|
  # actions (may reference t)
end
</code></pre>

<h3 id="section-3">任务的多次定义</h3>

<p>一个任务可以被多次定义。每次定义都能增加新的规定到已经存在的任务。该特性使得可以在不同的rakefile文件中定义的任务组合成一个完整任务。例如，下面的任务定义和上面的代码定义了完全相同的任务。</p>

<pre><code>task :name
task :name =&gt; [:prereq1]
task :name =&gt; [:prereq2]
task :name do |t|
  # actions
end
</code></pre>

<h3 id="file-task">文件任务File Task</h3>

<p>实际情况中可能遇到在文件中创建其他文件的情况。如果文件已经存在，文件任务就会跳过该文件。使用方法file（而不是task）可以定义文件任务，此外文件任务名通常使用字符串而不是符号来定义。下面的任务会创建一个可执行程序prog，它依赖于另两个文件a.o和b.o（创建a.o和b.o的任务未写出）。</p>

<pre><code>file "prog" =&gt; ["a.o", "b.o"] do |t|
  sh "cc -o #{t.name} #{t.prerequisites.join(' ')}"
end
</code></pre>

<h3 id="directory-task">目录任务Directory Task</h3>

<p>创建目录也是很常见的任务，这是由directory方法来完成的，它是使用文件任务创建目录的一个快捷方式。如：</p>

<pre><code>directory "testdata/examples/doc"
</code></pre>

<p>等价于：</p>

<pre><code>file "testdata"              do |t| mkdir t.name end
file "testdata/examples"     do |t| mkdir t.name end
file "testdata/examples/doc" do |t| mkdir t.name end
</code></pre>

<p>目录任务并不接受依赖和动作定义。但是，可以在定义完成后追加依赖或动作。如：</p>

<pre><code>directory "testdata"
file "testdata" =&gt; ["otherdata"]
file "testdata" do
  cp Dir["standard_data/*.data"], "testdata"
end
</code></pre>

<h3 id="task-with-parallel-prerequisites">并行依赖任务Task with Parallel Prerequisites</h3>

<p>Rake可以让依赖任务并行执行：</p>

<pre><code>multitask :copy_files =&gt; [:copy_src, :copy_doc, :copy_bin] do
  puts "All Copies Complete"
end
</code></pre>

<p>copy_files是一个普通任务，它的动作在所有依赖任务完成后才会执行。但copy_src, copy_doc, copy_bin这三个依赖任务会并行执行，它们各自在自己的ruby线程中执行。如果这三个任务还依赖于某个共同任务pre_for_copy，那么只有当pre_for_copy任务完成后这个三个任务才开始并行执行。</p>

<p>另外，Rake内部的数据结构是线程安全的，所以当执行并行任务时不必考虑同步。但如果使用了某些用户自定义的数据，就可能需要考虑线程安全的问题了。</p>

<h3 id="section-4">带参数的任务</h3>

<p>直接传递参数给需要的任务。如，有个release任务需要版本号作为参数：</p>

<pre><code>rake release[0.8.2]
</code></pre>

<p>版本号字符串0.8.2就会传递给release任务。多个参数可以以逗号分隔的列表的形式传递给任务：</p>

<pre><code>rake name[john,doe]
</code></pre>

<p>注意，rake任务名及其参数是以单个命令行参数传递给rake的，即中间不允许有空格。如果任务名和参数包含空格，就必须进行使用引号：</p>

<pre><code>rake "name[billy bob, smith]"
</code></pre>

<h3 id="section-5">任务参数和环境参数</h3>

<p>任务参数也可以从环境参数获得。如：</p>

<pre><code>rake release[0.8.2]
</code></pre>

<p>也可以写成：</p>

<pre><code>RELEASE_VERSION=0.8.2 rake release
</code></pre>

<p>或：</p>

<pre><code>rake release RELEASE_VERSION=0.8.2
</code></pre>

<p>注意：</p>

<ul>
  <li>环境参数名要么完全匹配任务定义中的参数，要么和参数全部大写匹配；</li>
  <li>rake命令中声明使用的环境参数不影响系统中的环境变量。</li>
</ul>

<h3 id="section-6">带参数任务的定义</h3>

<p>必须声明接收参数的任务才能接受参数。定义带参数的任务十分简单：</p>

<pre><code>task :name, [:first_name, :last_name]
</code></pre>

<p>name是任务名，后面的列表是name任务需要接收的参数。利用task块的第二个参数可以在动作中访问传递来的参数：</p>

<pre><code>task :name, [:first_name, :last_name] do |t, args|
  puts "First name is #{args.first_name}"
  puts "Last  name is #{args.last_name}"
end
</code></pre>

<p>块中的t总是绑定为当前任务对象，第二个参数args就是传递进来的参数对象。如果传递了额外的参数，则多余的参数会被忽略；如果缺少参数，那么任务首先会从环境变量中获取，如果没有找到则将参数赋值为nil。</p>

<p>也可以为参数指定默认值：</p>

<pre><code>task :name, [:first_name, :last_name] do |t, args|
  args.with_defaults(:first_name =&gt; "John", :last_name =&gt; "Dough")
  puts "First name is #{args.first_name}"
  puts "Last  name is #{args.last_name}"
end
</code></pre>

<h3 id="section-7">任务接受参数并包含依赖任务</h3>

<p>如果任务需要接受参数，并且还依赖于其他任务，则可以这样定义：</p>

<pre><code>task :name, [:first_name, :last_name] =&gt; [:pre_name] do |t, args|
  args.with_defaults(:first_name =&gt; "John", :last_name =&gt; "Dough")
  puts "First name is #{args.first_name}"
  puts "Last  name is #{args.last_name}"
end
</code></pre>

<h3 id="section-8">接收额外参数的任务</h3>

<pre><code>task :email, [:message] do |t, args|
  mail = Mail.new(args.message)
  recipients = args.extras
  recipients.each do |target|
    mail.send_to(recipents)
  end
end
</code></pre>

<p>此外，可以使用to_a方法将所有参数按顺序转换为列表，包括命名参数和额外参数。</p>

<h3 id="section-9">以编程方式访问任务</h3>

<p>有时我们需要在rakefile中操作任务本身，使用Rake::Task的:[ ]操作符查找任务。例如，:doit任务打印“DONE”，而:dont任务会查找doit任务并且清除其所有依赖和动作。</p>

<pre><code>task :doit do
  puts "DONE"
end

task :dont do
  Rake::Task[:doit].clear
end
</code></pre>

<p>执行任务：</p>

<pre><code>$ rake doit
(in /Users/jim/working/git/rake/x)
DONE
$ rake dont doit
(in /Users/jim/working/git/rake/x)
$
</code></pre>

<p>编程方式处理任务再一次使用了元编程的能力，所以，小心使用该魔法。</p>

<h2 id="section-10">规则</h2>

<p>如果一个文件依赖于别的任务，但却没有为它定义文件任务，rake会尝试查找rakefile定义的规则去合成一个任务。</p>

<p>若我们要调用任务”mycode.o”，但却没有为它定义文件任务，但rakefile文件却含有如下的规则：</p>

<pre><code>rule '.o' =&gt; ['.c'] do |t|
  sh "cc #{t.source} -c -o #{t.name}"
end
</code></pre>

<p>该规则会合成所有以“.o”结尾的方法。它依赖于以“.c”结尾的源文件。如果rake能找到一个名为”mycode.c”的文件，它就会创建一个任务将mycode.c编译为mycode.o。如果mycode.c文件不存在，rake会递归尝试合成其他规则。</p>

<p>如果任务是由规则合成而来的，那么任务的source属性就被设置为匹配的源文件，这样在规则的动作中就可硬
引用该源文件了。</p>

<h3 id="section-11">高级规则</h3>

<p>规则模式支持正则表达式。此外，   proc块可以用来计算源文件的名称。下面的规则定义和上面的规则是等价的：</p>

<pre><code>rule( /\.o$/ =&gt; [
  proc {|task_name| task_name.sub(/\.[^.]+$/, '.c') }
]) do |t|
  sh "cc #{t.source} -c -o #{t.name}"
end
</code></pre>

<p>下面的任务用于java的编译：</p>

<pre><code>rule '.class' =&gt; [
  proc { |tn| tn.sub(/\.class$/, '.java').sub(/^classes\//, 'src/') }
] do |t|
  java_compile(t.source, t.name)
end
</code></pre>

<p>注意：java_compile是一个假想的调用java编译器的方法。</p>

<h2 id="section-12">注释</h2>

<p>在rakefile中同样可以使用ruby的标准注释（以#开头），但如果希望使用rake -T来显示任务描述，就需要
使用desc命令来描述任务。如：</p>

<pre><code>desc "Create a distribution package"
task :package =&gt; [ ... ] do ... end
</code></pre>

<p>rake -T（或者rake -tasks）会列出所有带描述的任务。如果使用desc来描述任务，就能非常方便的看到rakefile的主要任务。注：-T参数只能列出带desc的任务，如果想列出所有任务，需要使用-P或-prereqs。</p>

<h2 id="section-13">命名空间</h2>

<p>命名空间是用来解决大程序rakefile可能发生的命名冲突问题。</p>

<pre><code>namespace "main" do
  task :build do
    # Build the main program
  end
end

namespace "samples" do
  task :build do
    # Build the sample programs
  end
end

task :build =&gt; ["main:build", "samples:build"]
</code></pre>

<p>使用 命名空间:任务名 来引用任务，如“main:build”。但注意，在task定义内部获取的任务名是不带命名空间的。</p>

<h3 id="section-14">文件任务</h3>

<p>文件任务和目录任务是不使用命名空间的，因为他们代表真实文件系统中的文件，所以是不会冲突的，故而将他们放置在命名空间中是没有意义的。</p>

<h3 id="section-15">命名空间解析</h3>

<p>当查找任务时，首先在当前命名空间寻找，如果失败则到父命名空间寻找。</p>

<p>“rake”是隐式定义的命名空间，它指代顶级命名空间。</p>

<p>如果一个任务名以“^”打头，那么命名解析会从父级命名空间开始解析。允许使用多个“^”符号。</p>

<pre><code>task :run

namespace "one" do
  task :run

  namespace "two" do
    task :run

    # :run            =&gt; "one:two:run"
    # "two:run"       =&gt; "one:two:run"
    # "one:two:run"   =&gt; "one:two:run"
    # "one:run"       =&gt; "one:run"
    # "^run"          =&gt; "one:run"
    # "^^run"         =&gt; "rake:run" (the top level task)
    # "rake:run"      =&gt; "rake:run" (the top level task)
  end

  # :run       =&gt; "one:run"
  # "two:run"  =&gt; "one:two:run"
  # "^run"     =&gt; "rake:run"
end

# :run           =&gt; "rake:run"
# "one:run"      =&gt; "one:run"
# "one:two:run"  =&gt; "one:two:run"
</code></pre>

<h3 id="filelist">文件列表FileList</h3>

<p>文件列表基本等同于字符串列表，但建议使用文件列表。下面是创建文件列表的示例：</p>

<pre><code>fl = FileList['file1.rb', file2.rb']
</code></pre>

<p>使用通配符：</p>

<pre><code>fl = FileList['*.rb']
</code></pre>

<h3 id="doend-">do/end和{ }</h3>

<p>建议在任务定义时使用do/end，不要使用{ }。</p>

<h3 id="rakefile">Rakefile路径</h3>

<p>当在终端键入rake命令时，rake会在当前目录下查找rakefile，如果没有则在父目录查找直到找到为止。</p>

<h3 id="rakefile-1">多个rakefile</h3>

<p>并不是所有任务都要在一个单独的rakefile文件中定义，额外的任务可以在应用根目录下的rakelib文件夹中定义，额外的rakefile以”.rake”结尾。rails应用的额外rakefile就放置在lib/tasks目录中。</p>

<p>附：如果不在rails环境中使用分离的子rake文件，则可以在根目录的rakefile中这样引用子目录tasks中的子rakefile：</p>

<pre><code>Dir.glob('tasks/*.rake').each { |r| import r }
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[天道酬勤-在追逐梦想的路上]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/tian-dao-chou-qin-zai-zhui-zhu-meng-xiang-de-lu-shang/"/>
    <updated>2014-02-14T17:43:24+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/tian-dao-chou-qin-zai-zhui-zhu-meng-xiang-de-lu-shang</id>
    <content type="html"><![CDATA[<p>还记得大概一年前，也是在CSDN博客上读过一篇文章，拜读某个大牛描述了他为心仪的公司准备的过程，当时觉得很受触动，于是在博客下留言自勉，还记得他回复的话说：跨专业，更要提早准备。而现在，作为一个机械专业的学生，一路过关斩将拿到百度offer，除了激动之余，我能清晰的感觉到，自己的梦想画卷才刚刚展开。</p>

<!-- more -->

<p>说起来，我一开始完全没想到自己会干上IT这一行。大学学的是机械，但老实说，我对机械一点都没兴趣，中国应试教育的结果就是，我能高分考入大学，但却完全不知道自己想做什么，未来，仍然是一片迷茫。在大二的时候，学了C++编程的课程，但也没能勾起对编程的爱好。回想起来，我很庆幸自己没有读计算机专业，否则以中国老师的讲课方式，我现在应当是极度厌恶计算机的。不过我有一个好习惯，喜欢读书。记得有一个下午，我闲来无事去书店，抓起了一本Java的书，是个韩国人写的，随手翻翻竟然比国字教材将得有趣多了。就是这本书，唤醒了我对编程的热爱。</p>

<p>从那以后，我就不停读了很多计算机类的书籍，但都是完全凭着爱好去看的，没有任何人给我指导，零零散散不成体系，比起计算机系的学生基础比较薄弱，而且各类知识也没能构成网络。不过好的一点就是，我完全自主去深入，虽然走了很多弯路，但自始至终都保留了一份完整的兴趣，所以，这又是上天给我的偏爱。</p>

<p>在读完本科时，我已经完全沉迷进计算机的世界里。那时我决定去考计算机研究生，于是把计算机系所有的基础课程都学习了一遍。后来虽然放弃了，但我却借这个机会，将计算机里的基础课程全部深入了一遍，至少达到了研究生考试的水平，所以，不得不说，上天帮助了我不少啊。说到我为什么放弃考研，主要因为两个原因。第一，我极度厌恶政治，所以，我从5月份开始复习到10月份放弃考研，数据结构这类书都翻了两三遍了，但政治却碰也没碰，最后放弃考研，很大部分是我翻开政治书就想自残；第二，我遇到了可以算是我的贵人的老师（话说回来，高中也有一个老师也改变了我的命运，也是难得的贵人），在机械学院有一位老师同样沉迷于计算机，在linux界还颇有名气。所以我争取了保研资格，成为他的学生。在争取成为他的学生的过程中，过程还是比较曲折的，但我就不一一细表了。但是，就是在导师的教导下，我的编程能力得到了质的飞跃。可以说，之前我对计算机程序设计就如同是在森林茂密的树丛里转悠，一直没有意识到见木不见林的可怕，但是他不停引导我爬到高山上，将程序世界里的名山一一指点给我，这时，我觉得自己突然明白了编程的意义，同时也在山顶看到了自己的方向。所以，我的研究生导师在我的梦想道路上是极为重要的一个人，看起来放弃考研而继续留在机械是个失败，其实，我仍然非常感恩，这次上天仍然眷顾了我。</p>

<p>在研究生阶段，我不再迷茫，对于编程对于人生我都有了非常清晰的认识和规划，知道了自己是什么样的人，此时再去看外面的世界，什么事情应该争取什么事情应该舍弃，就再明白不过了。这个时候我开始涉猎大量的程序设计艺术类的书籍，更加注重思考的过程，阅读的深度也逐渐增加，对编程里面的为什么也挖掘得更多了。回过头来还是得感谢我的导师，没有他的首肯，我是买不了那么多好书的。</p>

<p>后来在师兄的帮助下，我进入了一家有名的IT外企实习，说起来，真的很多人帮助了很多。在这段经历中幸运的是，我没有像其他人那样实习打打酱油，感谢主管的信任，我直接接手了开发类的工作。这段实习经历使我受益良多，也认识的很多牛人。</p>

<p>最后，在找工作时，我拿到了想要的offer，如果要分享什么笔经面经，我真的没什么好说的。所有的努力都在平时，在面试过程中，我仅仅是把自己原原本本展示出来而已。最后通过了，说明自己的能力还是被认可的。但是他们给了我这次展示的机会，没有像MS在简历阶段因为专业就剔除我们这些非计算机专业的，我还是很感激的。</p>

<p>总的来说，我觉得自己整个求索的过程都是非常幸运的，一路上遇到了那么多人在非常关键的时刻都指引和帮助了我，所以我多少有点诚惶诚恐，不敢有些许辜负。但是还有最重要的一个人，我的宝贝，她一直支持我相信我，我在一无所有的时候（虽然现在也是，但是现在有自信）将梦想的蓝图描绘给她看时，她就比我自己还有笃信，所以，不能让她的相信落空。</p>

<p>好了，如果非要在文章最后分享点什么的话，那我就说说自己的一些感悟吧。人一定要会自省，佛语观心以观天下，知道自己想要什么知道自己能做什么，没有目标的人生是惨淡的，尤其是男人，要懂得聆听内心的声音，它决定了人生的方向和高度。</p>

<p>过去的都过去了，丢弃过去的包袱，现在是一个新的开始，一切，也才刚刚开始。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby之周期性任务]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rubyzhi-zhou-qi-xing-ren-wu/"/>
    <updated>2014-02-14T17:38:41+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rubyzhi-zhou-qi-xing-ren-wu</id>
    <content type="html"><![CDATA[<h3 id="section">1.前言</h3>

<p>无论是用ruby做系统管理，还是用rails做web开发，都可能遇到周期性任务，它们按照一定时间周期（1小时，2天……）持续地触发。在ruby中，我认为一次性任务使用sidekiq来完成是非常方便的，而周期性的任务就需要用到whenever，sidetiq，clockwork等等gem了。</p>

<!-- more -->

<h3 id="whenever">2.whenever</h3>

<p>首先，whenever是基于linux的cron服务的，所以，在windows平台上没有直接的方法使用该gem。whenever严格来说应该算一个cron的翻译器，将ruby代码翻译为cron脚本，从而将周期性任务转交给cron实际去完成。对于精通cron的shell程序员来说可能不值一提，但对rubyist却不是。首先，我们可以使用ruby语言来书写任务代码，在ruby层面上控制代码，避免了和一些shell脚本的切换；另外，cron命令很强大，但我总是记不住它的命令参数，为了避免一遍一遍去man它的手册，还是ruby语法比较亲民。</p>

<p>首先，安装whenever：</p>

<pre><code>$ gem install whenever
</code></pre>

<p>然后切换到任务编写文件夹project下，保证该文件夹下有一个config文件夹。如果是在rails项目中建立
whenever任务，则config文件夹已经存在了。</p>

<pre><code>$ cd /project
$ wheneverize .
</code></pre>

<p>whenverize命令会在config文件夹下创建schedule.rb文件，我们的任务代码需要在该文件中定义。下面的是schedule.rb文件示例：</p>

<pre><code>every 3.hours do
  runner "MyModel.some_process"
  rake "my:rake:task"
  command "/usr/bin/my_great_command"
end

every 1.day, :at =&gt; '4:30 am' do
  runner "MyModel.task_to_run_at_four_thirty_in_the_morning"
end

every :hour do # 常用的简写有： :hour, :day, :month, :year, :reboot
  runner "SomeModel.ladeeda"
end

every :sunday, :at =&gt; '12pm' do # 你可以使用星期几或周末或工作日： :weekend, :weekday
  runner "Task.do_something_great"
end

every '0 0 27-31 * *' do
  command "echo 'you can use raw cron syntax too'"
end

# run this task only on servers with the :app role in Capistrano
# see Capistrano roles section below
every :day, :at =&gt; '12:20am', :roles =&gt; [:app] do
  rake "app_server:task"
end
</code></pre>

<p>如示例代码，whenever默认定义了三种任务类型：runner, rake, command，我们也可以定义自己的任务，比如，下面的代码定义了脱离rails环境，独立执行ruby代码的类型：</p>

<pre><code>job_type :ruby, "cd :path &amp;&amp; /usr/bin/ruby ':task'.rb"

every :hour do
  ruby 'have_a_rest'
end
</code></pre>

<p>该示例描述了：每个小时会执行一次当前文件夹下的have_a_rest.rb脚本。
下面看看怎么将任务写入cron服务。</p>

<pre><code>$ whenever   #不带参数的whenever会显示转换程cron任务的代码，不写入cron任务表
$ whenever -w #写入cron任务表，开始执行
$ whenever -c #取消任务
</code></pre>

<p>如果要查看cron任务表，也可以使用linux的命令列出所有cron任务：</p>

<pre><code>$ crontab -l
</code></pre>

<h3 id="sidetiq">3.sidetiq</h3>

<p>sidetiq是sidekiq的亲兄弟，如果在rails项目中使用sidekiq来处理后台任务，那么就用sidetiq来交付周期性任务也显得比较自然。</p>

<p>安装sidetiq：</p>

<pre><code>$ [sudo] gem install sidetiq
</code></pre>

<p>定义周期性任务：</p>

<pre><code>class MyWorker
  include Sidekiq::Worker
  include Sidetiq::Schedulable

  recurrence { daily }

  def perform
    # do stuff ...
  end
end
</code></pre>

<p>sidetiq和sidekiq一样，依赖于redis消息来处理消息。当rails项目启动后，这些周期性任务会自动加载执行。</p>

<h3 id="sidetiq-cron">3.1 sidetiq-cron</h3>

<p>现在可以使用sidetiq-cron，和sidekiq配合更紧密，使用更加简单。</p>

<p><a href="https://github.com/ondrejbartas/sidekiq-cron">sidetiq-cron</a></p>

<h3 id="clockwork">4.clockwork</h3>

<p>clockwork和sidetiq一样，也不必依赖于cron，可以适应”跨平台“要求。下面是代码示例(clock.rb)：</p>

<pre><code>require 'clockwork'
include Clockwork

handler do |job|
  puts "Running #{job}"
end

every(10.seconds, 'frequent.job')
every(3.minutes, 'less.frequent.job')
every(1.hour, 'hourly.job')

every(1.day, 'midnight.job', :at =&gt; '00:00')
</code></pre>

<p>启动任务：</p>

<pre><code>$ clockwork clock.rb
Starting clock for 4 events: [ frequent.job less.frequent.job hourly.job midnight.job ]
Triggering frequent.job
</code></pre>

<p>如果要带上rails环境，就在任务文件加入：</p>

<pre><code>require './config/boot'
require './config/environment'
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[学算法并非和语言无关]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/xue-suan-fa-bing-fei-he-yu-yan-wu-guan/"/>
    <updated>2014-02-14T17:35:43+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/xue-suan-fa-bing-fei-he-yu-yan-wu-guan</id>
    <content type="html"><![CDATA[<h3 id="section">1. 写在前面</h3>

<p>算法这个东西，本来不是什么特别复杂的东西，就是为了解决某个问题提出的一个解决方案，说白了，就是一种思路。基本上，所有的算法书上都默认选用了伪代码来表达算法，因为这样可以脱离具体的语言，让算法学习者能够直面算法的本质，理解算法的核心，然后使用自己常用的语言来重新表达，写出能够运行的代码。实际上，在我接触到ruby这类高表达力的语言前，我也这么认为。虽然我能够理解很多算法的核心本质，但往往在实际用C或者java来实现时，总是被一些数组索引等细枝末节的问题所折磨，我通常会告诉自己，嗷，我还没有深刻领悟它，再去看看算法图述和伪码。</p>

<p>但是，今天我想说，我错了。也许，有的语言能够更好地表述算法，表述算法的好的语言应该能够以最接近人类语言的方式表达出来，而且基本就能够运行出结果。</p>

<!-- more -->

<h3 id="section-1">2. 基本快速排序</h3>

<p>下面是关于快速排序的official描述：
快速排序使用分治法（Divide and conquer）策略来把一个串行（list）分为两个子串行（sub-lists）。</p>

<p>步骤为：</p>

<p>从数列中挑出一个元素，称为 “基准”（pivot），
重新排序数列，所有元素比基准值小的摆放在基准前面，所有元素比基准值大的摆在基准的后面（相同的数可以到任一边）。在这个分区退出之后，该基准就处于数列的中间位置。这个称为分区（partition）操作。
递归地（recursive）把小于基准值元素的子数列和大于基准值元素的子数列排序。</p>

<p>简单地说就是，按数组中某个元素为标准，将数组分为大于该数和不大于该数两个组，然后递归地分别处理这两个组，知道所有元素有序。</p>

<p>那么，我们看看算法导论是怎么用伪码来表述该算法的：</p>

<pre><code>QUICKSORT(A,p,r)
  if p&lt;r
    then q &lt;- PARTITION(A,p,r)
      QUICKSORT(A,p,q-1)
      QUICKSORT(A,q+1,r)

PARTITION(A,p,r)
  x&lt;-A[r]
  i &lt;- p-1
  for j &lt;- p to r-1
    do if A[j]&lt;=x
      then i &lt;- i+1
        exchange A[i] &lt;-&gt; A[j]
  exchange A[i+1] &lt;-&gt; A[r]
  return i+1
</code></pre>

<p>看看吧，不算空行一共14行代码，这甚至还没有包括没有实现的辅助函数exchange呢。反正看算法导论时，我看到这样一堆伪代码时，我都要先去喝杯水，然后深吸一口气，告诉自己，好吧一口气读完吧。</p>

<p>接着，我希望用我爱的ruby重新实现一遍：</p>

<pre><code>def qs(list)
	if list.size&lt;=1
		list
	else
		left,right=list[0..-2].partition{|x| x&lt;=list.last}
		qs(left)+[list.last]+qs(right)
	end
end
</code></pre>

<p>总共8行代码，实际上还可以缩减到5行（可以参考维基百科的ruby实现）。几乎比伪代码节约了一半长度，而且算法表述非常清晰。更重要的是，这是一段可以直接运行的代码，这不是很鼓舞人心吗？</p>

<pre><code>irb(main):056:0&gt; list=[9, 4, 6, 3, 7, 11, 5, 6]
=&gt; [9, 4, 6, 3, 7, 11, 5, 6]
irb(main):066:0&gt; qs list
=&gt; [3, 4, 5, 6, 6, 7, 9, 11]
</code></pre>

<p>最终，如果真的希望使用这段代码，那么就在ruby特有语言基础上再走一步，当然这步和算法表述无关了，只是为了在ruby中更为漂亮地使用该实现。</p>

<pre><code>class Array
	def quick_sort
		if self.size&lt;=1
			self
		else
			left,right=self[0..-2].partition{|x| x&lt;=self.last}
			left.quick_sort+[self.last]+right.quick_sort
		end
	end
end
</code></pre>

<p>使用示例：</p>

<pre><code>irb(main):069:0&gt; list.quick_sort
=&gt; [3, 4, 5, 6, 6, 7, 9, 11]
</code></pre>

<h3 id="ue">3. 关于UE的一点感悟</h3>

<p>是的，用户体验。各种和计算机打交道的语言也要有好的用户体验，程序员就是编程语言的用户。有时候程序bug很多，真的有可能是语言不好。各种算法书上的伪码真的很让人恶心，所以，伪码也并不简捷。我相信，最终，计算机编程语言会进化到一种，那就是人类语言，那时，就再也没有程序员了，或者，所有人都是程序员。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[状态转移]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/zhuang-tai-zhuan-yi/"/>
    <updated>2014-02-14T17:30:39+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/zhuang-tai-zhuan-yi</id>
    <content type="html"><![CDATA[<h3 id="section">0. 引言</h3>

<p>昨天遇到一个问题，就是关于对象状态转移的问题，我姑且这样命名吧。简要描述一下就是：对于一个人，他有进食，帮助他人，恋爱等功能，但是这些功能是有先后顺序的，对于刚出生的人，他要先学会进食，然后随着他的成长，他逐渐学会帮助他人，在这个过程中他学会了爱与被爱，当他遇到一个合适的女孩，他就坠入了爱河。整个过程反映到程序上就是，必须按照下面的顺序调用方法：</p>

<pre><code>man=Human.new
man.feed
man.fall_in_love   # Error
man.help_people
man.fall_in_love
</code></pre>

<p>如果你调用某个功能时没有完成前面的事情，就像上面的例子这样，一个人尚未学会帮助他人的人，我们是不希望他去恋爱的，这样一个不懂得互助互爱的人怎么可能珍惜自己的爱人呢？</p>

<p>所以，对象状态转移就是：某个对象随着状态转移获得调用新方法的能力或权限，未达到某个状态前无法调用该状态下的方法。</p>

<!-- more -->

<h3 id="section-1">1. 目标</h3>

<p>仔细想想，其实这类问题出现还是比较普遍的，比如一个浏览器处理类，它必须要在登陆操作后才允许执行修改个人信息。所以，有必要为了这类问题思考一个解决方法。那么，首先要明确的是，我想要怎样实现这样一个功能。为每个类去实现一个这样的状态转移显然不是ruby way。所以，我觉得对于我自己，我希望这样处理一下我的Human类之后，我就能像引言中那样直接使用状态转移提供的功能：</p>

<pre><code>class Human
	include State
	def feed
		puts"feed myself"
	end
	def protect_env
		puts "protect environment"
	end
	def help_people
		puts "help other people"
	end
	def fall_in_love
		puts "love someone"
	end
	define_chain :feed,[:protect_env,:help_people],:fall_in_love
end
</code></pre>

<p>如代码所示，我希望在我使用的类中包含一个State模块，然后用define_chain定义一个方法链，那么方法链中的方法，必须要在前一个方法调用过之后才可以被调用，否则就会抛出异常。另外，在定义方法链的define_chain中，我希望可以包含列表，列表中的方法需要至少被调用一种才能执行方法链的后续调用。</p>

<p>好吧，这样看起来，似乎是像模像样的ruby解决方法了，那么，下面就看看如何来实现这个State模块。</p>

<h3 id="section-2">2. 环绕别名</h3>

<p>首先，我们肯定需要在define_chain方法上做文章。该方法实际完成状态转移方法链的定义，那么问题的关键是：我知道了这一串方法，怎么样保证在调用下一个方法前，明确上一个方法是否被调用了呢？很显然，我们需要一个变量来保存状态，在每次调用方法前检查是否能够调用当前方法，如果能够，则在调用完成之后更新状态。那么怎么做呢？总不能要求编写Human类的程序员在每个方法调用前先检查一下状态，在调用完成后再更新状态吧，那显然是会被鄙视的。实际上，作为一个ruby程序员，每个人都需要会一点点魔法，这次的魔法就是环绕别名。</p>

<p>假如，对于某个方法名method，我们可以这样环绕起来：</p>

<pre><code>define_method "#{method}_in_chain" do |*params,&amp;block|
	validate_state_for method.to_sym
	self.send "#{method}_out_chain",*params,&amp;block
	update_state_for method.to_sym
	end
alias_method "#{method}_out_chain",method
alias_method method,"#{method}_in_chain"
</code></pre>

<p>这部分代码就是define_chain方法的主体，这样，在定义了状态转移方法链之后，直接调用在方法链中的方法，就会自动使用validate_state_for方法检查方法是否可以被调用，在完成调用后使用update_state_for方法更新状态。</p>

<p>然后我们去实现validate_state_for和update_state_for方法，这两个方法实现很简单，后面再说，我们的State模块看起来基本是这样的：</p>

<pre><code>module State
	def define_chain(*args)
	end

	def validate_state_for(method)
	end
	
	def update_state_for(method)
	end
end
</code></pre>

<p>好吧，问题的最关键部分解决了，但还是有一些细节，不要小看细节，它决定成败。</p>

<h3 id="section-3">3. 类扩展混入</h3>

<p>显然，我们的define_chain方法必须作为类方法存在，这很简单，可以使用扩展混入。即</p>

<pre><code>class Human
  extend State
end
</code></pre>

<p>但问题来了，我只希望define_chain被作为类方法混入，而validate_state_for和update_state_for方法仍然需要作为类实例方法。那么直接混入肯定就不行了，这时就需要使用ruby另一个魔法了——类扩展混入，将部分方法作为类方法混入，部分方法作为实例方法混入。这种魔法使用了included钩子。</p>

<pre><code>module State
	def self.included(base)
		base.extend StateMaker
	end
	module StateMaker
		def define_chain(*args)
		end
	end
	def validate_state_for(method)
	end
	def update_state_for(method)
	end
end
</code></pre>

<p>现在，在使用下面的方法混入，就获得了我想要的效果。我能够用类方法define_chain定义状态方法链，也能够实例化Human对象调用它的validate_state_for实例方法。</p>

<pre><code>class Human
  include State
end
</code></pre>

<h3 id="section-4">4. 最后一步，实现</h3>

<p>我们的State状态转移模块的结构就是这样了，那么下面就需要具体实现了。</p>

<p>状态判断逻辑非常简单：按照状态方法链的定义，从左到右从0开始编号，而对象状态也从0开始，仅到当前状态大于等于方法编号时，才允许调用该方法。</p>

<p>状态更新逻辑：仅当状态方法编号等于当前对象状态时，才更新状态，即将状态值加1。</p>

<p>这就是State模块的实例方法实现：</p>

<pre><code>module State
	def validate_state_for(method)
		raise "State is too low to execute #{method}" unless min_state_for(method) &lt;= state
	end
	def min_state_for(method)
		self.class.state_chain.find_index{|k,v| v.include? method}
	end
	def update_state_for(method)
		@_state_from_object_monitor_+=1 if min_state_for(method) == state
	end
	def reset_state
		@_state_from_object_monitor_=0
	end
	def state
		@_state_from_object_monitor_=0 unless @_state_from_object_monitor_
		@_state_from_object_monitor_
	end
end
</code></pre>

<p>该模块还提供了reset_state方法重置状态值。另外，min_state_for方法用于获取调用某个方法的最低状态值，该方法中实际上也使用了ruby一点点小魔法，类实例变量，state_chain是一个类方法，它获取了是我们定义的状态转移方法链的一个hash表，该表是一个类实例变量，这个hash具体结构马上就会看到。</p>

<p>下面就是State::StateMaker的的define_chain方法的实现：</p>

<pre><code>module State
	module StateMaker
		def define_chain(*args)
			args.map{|x| x}
			args.flatten.each do |method|
				define_method "#{method}_in_chain" do |*params,&amp;block|
					validate_state_for method.to_sym
					self.send "#{method}_out_chain",*params,&amp;block
					update_state_for method.to_sym
					nil
				end
				alias_method "#{method}_out_chain",method
				alias_method method,"#{method}_in_chain"
			end
			@chain_methods=args.each_with_index.inject({}) do |memo,(v,index)|
				memo[index]=v.class==Symbol ? [v] : v
				memo
			end
			nil
		end
		
		def state_chain
			@chain_methods
		end
	end
end
</code></pre>

<p>define_chain方法的前半部分使用环绕别名来包裹特定方法，后半部分就是生成方法链的hash表，生成的hash表被保存在实例变量@chain_methods中，由于define_chain被作为类方法混入，所以它自然也成为了混入类的类实例变量，注意，尽量多使用类实例变量而不要使用类变量。而state_chain方法也同时混入成为类方法，该方法纯粹就是用来获取类实例变量chain_methods的。如1.目标中的方法链生成的hash表的结构是：</p>

<pre><code>{0=&gt;[:feed], 1=&gt;[:protect_env, :help_people], 2=&gt;[:fall_in_love]}
</code></pre>

<h3 id="section-5">5. 结尾</h3>

<p>现在，整个状态转移方法调用就完成了，可以像引言中那样去使用了。不过，这仅仅是个开始，ruby的原则就是DRY，还有细节的地方需要完善修改，比如用ruby2.0就可以更漂亮地完成环绕别名等等。</p>

<h3 id="section-6">6. 附录</h3>

<p>下面是State模块完整代码，供参考。</p>

<pre><code>module State
	def self.included(base)
		base.extend StateMaker
	end
	module StateMaker
		def define_chain(*args)
			args.map{|x| x}
			args.flatten.each do |method|
				define_method "#{method}_in_chain" do |*params,&amp;block|
					validate_state_for method.to_sym
					result=self.send "#{method}_out_chain",*params,&amp;block
					update_state_for method.to_sym
					result
				end
				alias_method "#{method}_out_chain",method
				alias_method method,"#{method}_in_chain"
			end
			@chain_methods=args.each_with_index.inject({}) do |memo,(v,index)|
				memo[index]=v.class==Symbol ? [v] : v
				memo
			end
			nil
		end
		def state_chain
			@chain_methods
		end
	end
	def validate_state_for(method)
		raise "State is too low to execute #{method}" unless min_state_for(method) &lt;= state
	end
	def min_state_for(method)
		self.class.state_chain.find_index{|k,v| v.include? method}
	end
	def update_state_for(method)
		@_state_from_object_monitor_+=1 if min_state_for(method) == state
	end
	def reset_state
		@_state_from_object_monitor_=0
	end
	def state
		@_state_from_object_monitor_=0 unless @_state_from_object_monitor_
		@_state_from_object_monitor_
	end
end
</code></pre>

<h3 id="section-7">7. 后记</h3>
<p>现在回来看这篇文章，感觉那时的思考和视野的局限。其实我需要的是一个状态机，而那时我还不知道这个名词，自己闭门思考实现的这个东西，状态的转移非常局限，无法适应灵活的需求，而且使用方法链的方式本身也局限了进一步升级。同时，<code>alias_method</code>这种技术也可以使用2.0的<code>prepend</code>关键字来更优美地完成。</p>

<p>Anyway,这篇文章还是留着，写这个后记，也说明进步了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识jruby之入门]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-ru-men/"/>
    <updated>2014-02-14T17:24:21+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-ru-men</id>
    <content type="html"><![CDATA[<p>首先，Jruby的官方站点是http://jruby.org/ ，最详尽的资料都在那里。至于为什么选择JRuby，官方站点上列举了诸如jvm的普及以及性能等等优点，但我想最简单的回答就是，我喜欢用ruby编程，而大多数不再充电的老板还固守着java，对他们来说，相对于ruby，java这个词本身先产生了50%的安全感，所以这可能是比较贴近现实的选择。不过我今天想去倒腾倒腾这个东西，则完全是为了了解ruby的方方面面。</p>

<!-- more -->

<h3 id="section">1. 下载安装</h3>

<p>首先在官方下载页下载安装最新的jruby，这部分内容还是老老实实去下载页照着做，话说配置开发环境不是每个程序员的必修课吗？不过放心，jruby安装起来很方便的，安装完成后，查看jruby版本，验证是否正确安装：</p>

<pre><code>C:\&gt;jruby --version
jruby 1.7.4 (1.9.3p392) 2013-05-16 2390d3b on Java HotSpot(TM) 64-Bit Server VM 1.6.0_38-b05 [Windows 7-amd64]
</code></pre>

<h3 id="jrubyrakegem">2. 在jruby中使用rake,gem等</h3>

<p>在jruby下使用这些命令需要前缀一个jruby -S命令，如：</p>

<pre><code>jruby -S gem list --local
jruby -S gem install rails mongrel jdbc-mysql activerecord-jdbcmysql-adapter
jruby -S rails new blog 
cd blog
jruby -S rake -T
jruby -S rake db:create
jruby -S rake db:migrate
</code></pre>

<p>另外，jruby的控制台进入命令时jirb而不是irb：</p>

<pre><code>C:\&gt;jirb
irb(main):001:0&gt;
</code></pre>

<h3 id="jrubyjava">3. 在jruby中调用java类</h3>

<p>例如，在C:\DEMO文件夹下有一个java类文件JavaMan.java：</p>

<pre><code>package example;

public class JavaMan {
  
  public JavaMan() {
  }
  
  public void hello() {
      System.out.println("Hello, I am a Java man!");
  }
  public void hello(String name){
     System.out.println("Hello "+name+", I am a Java man!");
  }
  
}
</code></pre>

<p>然后在命令行中编译该java类文件：</p>

<pre><code>C:\DEMO&gt;javac JavaMan.java -d .
</code></pre>

<p>在C:\DEMO下建立ruby文件demo.rb：</p>

<pre><code>require 'java'
java_import "example.JavaMan" #导入java类JavaMan
j=JavaMan.new
j.hello
j.hello "Jason"
</code></pre>

<p>在命令行中执行该ruby脚本使用jruby命令：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
Hello, I am a Java man!
Hello Jason, I am a Java man!
</code></pre>

<p>也可以直接在jirb中调试ruby程序：</p>

<pre><code>C:\DEMO&gt;jirb
irb(main):001:0&gt; java_import 'example.JavaMan'
=&gt; [Java::Example::JavaMan]
irb(main):002:0&gt; JavaMan.new.hello "Jason"
Hello Jason, I am a Java man!
=&gt; nil
</code></pre>

<h3 id="jrubyjava-1">4. 在jruby中实现java接口</h3>

<p>若有一个java接口类：</p>

<pre><code>package example;
public interface JavaDog{
	public void runs();
}
</code></pre>

<p>那么可以在ruby代码中实现该接口：</p>

<pre><code>require 'java'
java_import "example.JavaDog" #导入java接口

class FastDog
	include JavaDog
	def runs
		puts "I am running fast!"
	end
end

FastDog.new.runs
</code></pre>

<p>运行结果：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
I am running fast!
</code></pre>

<h3 id="jrubyjar">5. 在jruby中调用jar中的类</h3>

<p>若在C:\DEMO\some.jar中包含了一个java bean， example.Person，该类包含了四个属性name,age,sex,country，除了country外其他三个属性都有setter和getter，另外该Person bean还有一个方法getProfile()获取简历。</p>

<pre><code>require 'java'
require 'some.jar'
java_import "example.Person"

p=Person.new
p.name="Jason"
p.age=10
p.sex="Male"
begin
	p.country="China"
rescue NoMethodError =&gt; e
	puts "No country setter in Person bean"
end
puts p.getProfile
</code></pre>

<p>运行结果：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
No country setter in Person bean
Name:Jason Sex:Male Age:10
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby常用的迭代操作]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rubychang-yong-de-die-dai-cao-zuo/"/>
    <updated>2014-02-14T17:18:15+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rubychang-yong-de-die-dai-cao-zuo</id>
    <content type="html"><![CDATA[<p>ruby是一门可以用sexy来形容的语言，下面就列举几个sexy的迭代操作。</p>

<!-- more -->

<h3 id="each">1. each简单迭代</h3>

<p>each是ruby中非常常见的遍历操作，她是年老色衰的for直接替代品。如果需要索引，则可以使用each_with_index方法。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.each do |word|
	puts word
end
</code></pre>

<h3 id="find-">2. find 查找单个元素</h3>

<p>查找到第一个符合条件的元素，find。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.find do |word|
	word.start_with? 'r'
end
=&gt; "ruby"
</code></pre>

<h3 id="select-">3. select 选取元素</h3>

<p>选取所有符合条件的元素，select。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.select do |word|
	word.start_with? 'r'
end
=&gt; ["ruby", "run"]
</code></pre>

<h3 id="reject-">4. reject 剔除元素</h3>

<p>剔除部分符合条件的元素，reject。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.reject do |word|
	word.start_with? 'r'
end
=&gt; ["good", "god", "sexy", "girl"]
</code></pre>

<h3 id="map-">5. map 转换元素</h3>

<p>转换每个元素，map。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.map do |word|
	word.capitalize
end
=&gt; ["Good", "God", "Ruby", "Sexy", "Girl", "Run"]
</code></pre>

<h3 id="uniq-">6. uniq 唯一化</h3>

<p>剔除相等的元素，uniq。</p>

<pre><code>words=%w(good god ruby sexy girl run run god Run)
words.uniq
=&gt; ["good", "god", "ruby", "sexy", "girl", "run", "Run"]
</code></pre>

<p>也可以在块中指定比较的方法，自定义比较的对象。</p>

<pre><code>words=%w(good god ruby sexy girl run run god Run)
words.uniq do |w|
	w.downcase
end
=&gt; ["good", "god", "ruby", "sexy", "girl", "run"]
</code></pre>

<h3 id="groupby-">7. group_by 分组元素</h3>

<p>分组元素，这个真的很sexy，group_by。</p>

<p>按首字母分组：</p>

<pre><code>words=%w(good god ruby sexy girl Run)
words.group_by do |w|
	w.capitalize[0]
end
=&gt; {"G"=&gt;["good", "god", "girl"], "R"=&gt;["ruby", "Run"], "S"=&gt;["sexy"]}
</code></pre>

<h3 id="sortby-">8. sort_by 排序元素</h3>

<p>排序元素，sort_by。</p>

<pre><code>words=%w(good god ruby sexy girl Run)
words.sort_by do |w|
	w.length
end
=&gt; ["Run", "god", "sexy", "ruby", "girl", "good"]
</code></pre>

<h3 id="zip-">9. zip 组合元素</h3>

<p>组合遍历元素，zip。</p>

<pre><code>words=%w(good god ruby sexy girl Run)
numbers=(11..16)
symbols=%w(+ - * / = %)
words.zip(symbols,numbers)
=&gt; [["good", "+", 11], ["god", "-", 12], ["ruby", "*", 13], ["sexy", "/", 14], ["girl", "=", 15], ["Run", "%", 16]]
</code></pre>

<h3 id="inject-">10. inject 累积元素</h3>

<p>累积元素求值，这是我最喜欢的一个，inject。</p>

<pre><code>numbers=(1..10)
numbers.inject do |memo,value|
	memo=memo+value
end
=&gt; 55
</code></pre>

<p>这是比较简单的，举个难点的，如果需要将hash表 {a:1,b:2,c:3,d:1} 的键和值相互调换，即键变值，值变键，并且重复的值变成键后将原本的键变成列表形式的值。</p>

<pre><code>tbl={a:1,b:2,c:3,d:1}
tbl.inject({}) do |memo,(k,v)|
	memo[v]||=[]
	memo[v]&lt;&lt;k
	memo
end
=&gt; {1=&gt;[:a, :d], 2=&gt;[:b], 3=&gt;[:c]}
</code></pre>

<h3 id="partition-">11. partition 分组操作</h3>

<p>将元素分为符合条件和不符合条件的两个组。</p>

<pre><code>(1..6).partition { |v| v.even? }  #=&gt; [[2, 4, 6], [1, 3, 5]] ###12. flatten扁平化列表
</code></pre>

<p>将多级列表合并为一个单独列表，以上例的列表为例。</p>

<pre><code>[[2, 4, 6], [1, 3, 5]].flatten  #=&gt;[ 2 , 4 , 6 , 1 , 3 , 5 ]
</code></pre>

<h3 id="rotate">13. rotate旋转列表</h3>

<pre><code>a = [ "a", "b", "c", "d" ]
a.rotate         #=&gt; ["b", "c", "d", "a"]
a                #=&gt; ["a", "b", "c", "d"]
a.rotate(2)      #=&gt; ["c", "d", "a", "b"]
a.rotate(-3)     #=&gt; ["b", "c", "d", "a"]
</code></pre>

<h3 id="join">14. join将列表转换为一个字符串</h3>

<pre><code>[ "a", "b", "c" ].join        #=&gt; "abc"
[ "a", "b", "c" ].join("-")   #=&gt; "a-b-c"
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby webdriver]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/ruby-webdriver/"/>
    <updated>2014-02-14T17:13:12+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/ruby-webdriver</id>
    <content type="html"><![CDATA[<h3 id="section">前言</h3>

<p>Watir Webdriver是用ruby操作webdriver的很酷的方式，通常被用来做一些rails app的测试。</p>

<!-- more -->

<h3 id="example">Example</h3>

<p>下面的示例是一个网站的登录示例：</p>

<pre><code>require 'watir-webdriver'
b = Watir::Browser.new
b.driver.manage.window.maximize
b.goto "http://xx.com"
b.link(:text =&gt; 'Create Account').click
b.text_field(:id =&gt; 'signupEmail').focus!.set "some@example.com"
b.text_field(:id =&gt; 'signupPassword').focus!.set "1234"
b.text_field(:id =&gt; 'passwordConfirm').focus!.set "1234"
b.checkbox(:id=&gt; 'notifyOptin').focus!.set true
b.button(:id =&gt; 'signupSubmit').focus!.click
# or you can use:
# b.send_keys :enter
b.text.include? 'Welcome to XX website'
b.close
</code></pre>

<p>上面的示例中，很多text_field或button等元素使用了focus！方法，这是因为webdriver无法和浏览器中未显示的元素交互，否则会发生异常，当你拥有一个很长的列表在当前浏览器窗口中无法显示时，如果去和未显示的列表项交互就会发生这种异常。解决办法是调用元素的focus方法，focus方法会将该元素滚动到视野中，但focus方法默认返回nil，如果调用该方法多次就不是一个hacky way。所以需要为webdriver打个补丁，添加一个focus！方法：</p>

<pre><code>class Watir::Element
	def focus!
		self.focus unless self.visible?
		self
	end
end
</code></pre>

<p>有的网站登录会使用一个frame来呈现登录窗口，webdriver可以很方便地和frame交互：</p>

<pre><code>b.frame(:id =&gt; "content_ifr").text_field(:id=&gt;'signinEmail').set "s@gmail.com"
b.frame(:id =&gt; "content_ifr").text_field(:id=&gt;'signinEmail').set "234"
</code></pre>

<p>更多html元素的交互请看elements。
发送特定的按键：</p>

<pre><code>b.send_keys :enter
b.element.send_keys [:control, 'a'], :backspace
b.element.click(:shift, :control)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails为paperclip上传文件添加访问控制]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/railswei-paperclipshang-chuan-wen-jian-tian-jia-fang-wen-kong-zhi/"/>
    <updated>2014-02-14T15:21:11+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/railswei-paperclipshang-chuan-wen-jian-tian-jia-fang-wen-kong-zhi</id>
    <content type="html"><![CDATA[<h3 id="section">0 前言</h3>

<p>由paperclip上传的文件默认是放在rails项目的public目录下的，也就是说，只要能得到该文件的URL，就可以直接访问/下载该文件，如果要对该文件添加访问控制，就需要更改paperclip的默认上传位置。</p>

<!-- more -->

<h3 id="paperclip">1 更改paperclip默认的上传位置</h3>

<p>若有一个story类，每个story有一个封面cover，该cover是一张图片，就可以这样更改model定义：</p>

<pre><code>class Story &lt; ActiveRecord::Base
  has_attached_file :cover,
  :styles=&gt;{:small=&gt;"32x32"}, 
  :path =&gt; ":rails_root/paperclip/:class/:attachment/:id/:style/:filename",
  :url =&gt; "/paperclip/:class/:attachment/:id/:style/:filename"
end
</code></pre>

<p>要同时修改path和url，url是相对于rails工程而言，被rails app用来获取图片渲染页面；而path是相对于rails app服务器而言，在整个宿主文件系统中的路径。必须同时修改path和url。</p>

<p>这里，将保存paperclip的上传文件的目录设置为rails工程根目录下的paperclip目录。</p>

<h3 id="controller">2 添加controller</h3>

<p>在routes.rb中添加路由：</p>

<pre><code>get "/paperclip/:class/:attachment/:id/:style/:filename",to:"assets#show"
</code></pre>

<p>添加assets_controller.rb文件：</p>

<pre><code>class AssetsController &lt; ApplicationController
  def show
    cls=params[:class].singularize.capitalize.constantize
    asset=cls.find params[:id]
    send_file asset.send(params[:attachment].singularize).path(params[:style])
  end
end
</code></pre>

<p>在提交的参数中params[:class]是复数形式，而通常类定义都是单数如Story，params[:attachment]是也复数形式而类定义中cover为单数，所以都要将他们变成单数，如果类中定义的attachment是复数形式，那么这里attachment就不必转换为单数，否则会引发NoMethod异常。</p>

<p>现在，所有的paperclip资源都由AssetsController控制，所以在其中添加诸如身份登录验证等before_filter就很方便了。在加入身份验证后，即便用户得到该cover的URL，在未登录的情况下，也无法直接访问该图片了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails使用bootstrap及bootswatch]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-bootstrapji-bootswatch/"/>
    <updated>2014-02-14T15:14:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-bootstrapji-bootswatch</id>
    <content type="html"><![CDATA[<h3 id="section">1.简介</h3>

<p>Twitter-bootstrap是一个功能强大的前端web框架，使用它可以快速地开发出漂亮的web UI。而thomas-mcdonald/bootstrap-sass是rails sass版本的bootstrap。其他类似的gem还有jlong/sass-twitter-bootstrap，metaskills/less-rails-bootstrap，seyhunak/twitter-bootstrap-rails，前一个也是sass版本，后两个是less版本的。另外，jasny-twitter-bootstrap是bootstrap的一个很好的拓展，添加了文件上传等漂亮的插件。</p>

<p>而Bootswatch是基于bootstrap的主题资源站，提供了很多收费和免费的主题，利用这些现成的主题能够在bootstrap的基础上更进一步加快网站开发，制作出精美的页面。</p>

<!-- more -->

<h3 id="twitter-bootstrap">2.安装twitter-bootstrap</h3>

<p>这里推荐使用tomas-macdonald/bootstrap-sass。首先在gemfile中添加：</p>

<pre><code>gem 'sass-rails', '~&gt; 3.2'
gem 'bootstrap-sass', '~&gt; 2.3.2.0'
</code></pre>

<p>然后执行bundle install安装需要的gem。
在app/assets/javascripts/application.js文件中添加需要的javascript引用：</p>

<pre><code>//= require jquery
//= require jquery_ujs
//= require bootstrap
//= require_tree .
</code></pre>

<p>将app/assets/stylesheets/application.css重命名为app/assets/stylesheets/application.css.scss。</p>

<p>现在可以调整app/views/layouts/application.html.erb模板布局，然后就可以浏览twitter-bootstrap网站按照example美化自己的rails站点了。</p>

<h3 id="bootswatch">3.安装bootswatch主题</h3>

<p>如果还想利用bootswatch的主题，就可以使用maxim/bootswatch-rails来方便地继承bootswatch的免费主题。</p>

<p>在gemfile中添加：</p>

<pre><code>gem 'bootswatch-rails'
</code></pre>

<p>然后执行bundle install安装该gem。在application.css.scss文件中require语句后添加：</p>

<pre><code>// 示例：使用bootswatch免费主题： 'Cerulean' bootswatch
// 首先导入变量
@import "bootswatch/cerulean/variables";

// 导入bootstrap
@import "bootstrap";

// 修改bootstrapbody边距
body { padding-top: 60px; }

// 导入bootstrap Responsive styles
@import "bootstrap-responsive";

// 最后导入需要的bootswatch主题
@import "bootswatch/cerulean/bootswatch";

// 你还可以在base.css.scss文件中添加更多自定义设置
@import "base";
</code></pre>

<p>你需要在application.css.scss文件相同目录下创建base.css.scss文件，如果需要就在其中添加更多自定义选择。</p>

<h3 id="bug-fix">4.Bug fix</h3>

<p>在rails中使用bootswatch可能导致某些css设置失效，通常的可能就是在/app/assets/stylesheets目录下，某些css设置覆盖了bootswatch的配置。比如，按照上述方法配置的bootswatch主题就有可能无法显示主题背景色（body背景色始终是白色）。而rails自动产生的scaffolds.css.sass文件中就覆盖了body的背景色配置，故而导致该bug。所以删除scaffolds.css.scss中除.field_with_errors  和 #error_explanation 其余内容即可。</p>

<p>另外，使用一些其他的rails gem也可能无法使用bootswatch的主题，比如jQuery-modal-rails，它是一个简单的模态对话框gem，但它的对话框就是白底，无法使用bootswatch的主题配置，此时手工配置一下即可，如在需要的页面的.css.sass文件中配置.modal {background-color: green;}，就可以显示绿色的模态对话框。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在CentOS上搭建git服务器]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/zai-centosshang-da-jian-gitfu-wu-qi/"/>
    <updated>2014-02-14T15:01:55+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/zai-centosshang-da-jian-gitfu-wu-qi</id>
    <content type="html"><![CDATA[<h3 id="section">0.定义</h3>

<p>这里的示例中出现的主机有三台：localhost是一台centos主机，也是git服务器；ubuntu是git服务器管理员的workstation；linux是某个git用户jason的workstation。</p>

<p>localhost即git服务器上有两个账户test和git，test是用来搭建git服务器的已存在账户，
git是为git服务器创建的专有账户。</p>

<p>ubuntu是git服务器管理员的workstation，该管理员在自己的这台workstation上的账户是user。</p>

<p>linux是jason的workstation。</p>

<ul>
  <li>git server:                 [test@localhost]     [git@localhost]</li>
  <li>git administrator:      [user@ubuntu]</li>
  <li>git user:                    [jason@linux]</li>
</ul>

<p>文中省略了ssh在各主机间的登录命令及scp复制公钥的过程，注意观察命令前的用户及主机名提示即可。</p>

<!-- more -->

<h3 id="git">1.安装git</h3>

<pre><code>[test@localhost ~]$ sudo yum install git
#检查git是否安装正确
[test@localhost ~]$ git --version
git version 1.7.1
</code></pre>

<h3 id="git-1">2.为git服务器创建专有用户</h3>

<p>通常将该用户取名git</p>

<pre><code>[test@localhost ~]$ sudo useradd git -d /home/git
#最后切换到git用户
[test@localhost ~]$ su - git
</code></pre>

<h3 id="gitolite">3.安装gitolite</h3>

<p>gitolite是一款git服务管理工具，通过公钥对用户进行认证，并能够利用配置文件进行repo的精细授权管理。由于它采用ssh公钥认证，所以先要安装ssh。</p>

<pre><code>[test@localhost ~]$ sudo yum install ssh
[test@localhost ~]$ sudo service sshd start
[test@localhost ~]$ sudo chkconfig sshd on
</code></pre>

<p>然后准备安装gitolite，git服务器的管理员需要先准备自己的密钥对。所以，假设这个管理员在自己的workstation（另一台linux主机，这里只是为了得到管理员自己的密钥，并非一定要在另一台linux机器上）上，他需要创建自己的密钥对（方便起见，不要输入passphrase）：</p>

<pre><code>[user@ubuntu ~]$  ssh-keygen -f ~/.ssh/admin
</code></pre>

<p>该命令在~/.ssh目录下创建密钥对admin和admin.pub。</p>

<p>现在回到git服务器主机，将刚创建的admin.pub复制到git用户的家目录下，即/home/git/下，并且chown为git账户。另外，在安装前须保证不存在文件~/.ssh/authorized_keys或该文件为空。</p>

<p>安装gitolite：</p>

<pre><code>[git@localhost ~]$ git clone git://github.com/sitaramc/gitolite
[git@localhost ~]$ mkdir -p ~/bin
[git@localhost ~]$ gitolite/install -to ~/bin
[git@localhost ~]$ gitolite setup -pk admin.pub
</code></pre>

<p>如果在执行第三条命令时出现错误：</p>

<pre><code>Can't locate Time/HiRes.pm in @INC (@INC contains: /home/git/gitolite/src/lib /usr/local/lib/perl5 /usr/local/share/perl5 /usr/lib/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5 /usr/share/perl5 .) at /home/git/gitolite/src/lib/Gitolite/Common.pm line 76.
BEGIN failed--compilation aborted at /home/git/gitolite/src/lib/Gitolite/Common.pm line 76.
Compilation failed in require at gitolite/install line 15.
BEGIN failed--compilation aborted at gitolite/install line 15.
</code></pre>

<p>说明缺少perl需要的软件Time::HiRes，安装该软件包后，重新执行上面的命令：</p>

<pre><code>[test@localhost ~]$ sudo yum install perl-Time-HiRes
</code></pre>

<h3 id="section-1">4.添加用户</h3>

<p>现在，假设team里有个成员叫jason，他将自己的公钥jason.pub邮件给管理员，要求为他创建一个名为foo的repo，他要求该repo仅自己可以修改，其他人不能修改但可以查看。首先管理员在自己的workstation上先要获取gitolite的管理repo，the_git_host是管理员刚搭建的git服务器地址：</p>

<pre><code>[user@ubuntu ~]$  git clone git@the_git_host:gitolite-admin
</code></pre>

<p>注意，执行该命令时，如果被要求输入密码，说明前面某些配置出错了，需要重新查证后再继续。</p>

<p>克隆完成后，在./gitolite-admin目录下需要关注两个子目录：conf和keydir。conf是gitolite的权限配置文件夹，keydir用于放置所有用户的公钥。所以，现在可以将jason的公钥jason.pub放入文件夹keydir。然后编辑conf/gitolite.conf文件，在文件末尾添加新的repo：</p>

<pre><code>repo foo
       RW+         =   jason
       R           =   @all
</code></pre>

<p>提交更改，完成用户及其库的添加：</p>

<pre><code>[user@ubuntu ~]$  git add conf
[user@ubuntu ~]$  git add keydir
[user@ubuntu ~]$  git commit -m 'added foo, gave access to jason'
[user@ubuntu ~]$   git push
</code></pre>

<h3 id="git-2">5.用户执行git版本管理</h3>

<pre><code>[jason@linux ~]$   git clone git@the_git_host:foo
</code></pre>

<p>命令执行完成，创建一个空库foo，现在jason就可以进行版本管理，在需要的时候进行提交。</p>

<p>如果用户想要查询自己有权访问的所有repo，可以使用下面命令查询：</p>

<pre><code>[jason@linux ~]$ ssh git@the_git_host  info
</code></pre>

<p>注意：从第3步开始，任何地方使用ssh或git登录到git服务器需要输入密码，都说明配置git服务器出现错误，需要重新安装gitolite，重新安装前先清除之前的文件：</p>

<pre><code>[git@localhost ~]$ ls -a | grep gitolite | xargs rm -fr
[git@localhost ~]$ rm -fr ~/repositories ~/bin  ~/projects.list ~/.ssh/authorized_keys
</code></pre>

<h3 id="gitweb">6.配置gitweb</h3>

<p>如果想要能够在网页上访问git库，就可以利用gitweb。</p>

<pre><code>[test@localhost ~]$ sudo yum install gitweb
</code></pre>

<p>打开/etc/gitweb.conf文件，按照注释的格式添加projectroot变量，指向git库：</p>

<pre><code>our $projectroot = "/home/git/repositories";
our @git_base_url_list = qw(git://git.the_git_host
                        ssh://git.the_git_host/var/lib/git);
</code></pre>

<p>最后编辑apache服务器配置文件/etc/httpd/conf/httpd.conf，在文末添加：</p>

<pre><code>&lt;VirtualHost *:80&gt;
    ServerName the_git_host
    DocumentRoot /var/www/git
    &lt;Directory /var/www/git&gt;
        Options ExecCGI +FollowSymLinks +SymLinksIfOwnerMatch
        AllowOverride All
        order allow,deny
        Allow from all
        AddHandler cgi-script cgi
        DirectoryIndex gitweb.cgi
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>最后修改git库的权限，否则会出现404 no projects found错误，最后重启Apache服务器：</p>

<pre><code>[test@localhost ~]$ sudo chmod 775 /home/git/repositories
[test@localhost ~]$ sudo chmod 775 /home/git
[test@localhost ~]$ sudo apachectl restart
</code></pre>

<p>最后在浏览器里键入http://the_git_host 就可以看到git库了，我在本机测试，使用的是http://localhost 来访问服务器。</p>

<p><em>注：</em>如果在完成上述操作后，仍然显示404 no project found，那很可能又是SELinux惹的麻烦，尝试更改selinux的状态为permissive后再刷新页面试试：</p>

<pre><code>[test@localhost ~]$ sudo setenforce 0
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby类和模块的关系]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rubylei-he-mo-kuai-de-guan-xi/"/>
    <updated>2014-02-14T14:47:25+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rubylei-he-mo-kuai-de-guan-xi</id>
    <content type="html"><![CDATA[<p>学习ruby入门的时候，很容易被其类和模块的小trick给迷惑住了，这里为了整理自己的理解，就写出来看看吧。</p>

<!-- more -->

<h3 id="ruby">1.ruby一切皆对象</h3>

<p>ruby是彻底地面向对象，你见到的一切构件都是对象。数字是对象，字符串是对象，类也是对象，模块也是对象，甚至类的类(Class)也是对象……</p>

<pre><code>irb(main):001:0&gt; 1.is_a? Object
=&gt; true
irb(main):002:0&gt; Object.is_a? Object
=&gt; true
irb(main):003:0&gt; Class.is_a? Object
=&gt; true
irb(main):007:0&gt; class Test
irb(main):008:1&gt; end
=&gt; nil
irb(main):009:0&gt; Test.is_a? Object
=&gt; true
</code></pre>

<p>其实在这里，像我这样从传统面向对象语言过来的初学者往往会提出疑问：在Java中，我们总可以明显地看出是那个对象在调用方法，但当我进入irb时，并没有创建任何对象，怎么可以调用puts等等方法？这里先不讨论puts方法来源于哪儿，但是当开始执行第一行ruby代码之前，实际上就存在一个对象了。这个对象叫main，是Object的对象。</p>

<pre><code>irb(main):015:0&gt; self
=&gt; main
irb(main):016:0&gt; self.class
=&gt; Object
</code></pre>

<p>此时所处的环境被称为Top Level Context（顶级上下文）。是ruby调用栈的顶端，通常（不在TLC时并非main在充当当前对象）你调用puts等方法时就是这个main对象在充当调用者（接收者）。</p>

<h3 id="ruby-1">2.ruby的类和模块</h3>

<p>ruby的类和模块可以统一看成是对象的分类，ruby中每个对象都有一个分类：</p>

<pre><code>irb(main):017:0&gt; Object.class
=&gt; Class
irb(main):018:0&gt; t=Test.new
=&gt; #&lt;Test:0x1a5aa48&gt;
irb(main):019:0&gt; t.class
=&gt; Test
irb(main):020:0&gt; Kernel.class
=&gt; Module
irb(main):023:0&gt; Module.class
=&gt; Class
irb(main):024:0&gt; Class.class
=&gt; Class
</code></pre>

<p>可以看到，对象的分类是其普通类，类的分类是Class，Kernel模块的分类是Module，Class的分类也是Class，Module的分类也是类。
甚至于，在ruby中，我们可以认为只有一种分类，那就是模块Module，因为Class是从Module继承而来。</p>

<pre><code>irb(main):011:0&gt; Class.ancestors
=&gt; [Class, Module, Object, Kernel, BasicObject]
</code></pre>

<p>除了很少的几个区别，几乎可以将类和模块一视同仁，类只不过是增强后的模块。那么，ruby中其他普通类和Class/Module有什么关系呢？答案是，其他类（模块）不过是Class(Module)的实例而已。</p>

<pre><code>irb(main):028:0&gt; Test.instance_of? Class
=&gt; true
irb(main):013:0&gt; Kernel.instance_of? Module
=&gt; true
</code></pre>

<p>根据这个原理，就可以像下面这样定义新类：</p>

<pre><code>irb(main):029:0&gt; MyClass=Class.new do
irb(main):030:1* def say
irb(main):031:2&gt; puts "I am MyClass"
irb(main):032:2&gt; end
irb(main):033:1&gt; end
=&gt; MyClass
irb(main):034:0&gt; m=MyClass.new
=&gt; #&lt;MyClass:0x1a4f798&gt;
irb(main):035:0&gt; m.say
I am MyClass
=&gt; nil
</code></pre>

<p>使用Class.new操作就新建了一个类，把这个类赋值给MyClass，这个新类就定义出来了，可以像使用其他类一样使用。这段代码除了证明普通类不过是Class的实例外，还说明了另一个问题：类名不过是一个常量而已。我们可以查看当前常量列表来验证：</p>

<pre><code>irb(main):038:0&gt; Object.constants.grep /MyClass/
=&gt; [:MyClass]
</code></pre>

<h3 id="ruby-2">3.ruby的方法查找</h3>

<p>当在ruby程序中调用一个方法时，ruby解释器以方法的接收者或者self为起点，沿着该对象的祖先链往上查找方法，直到找到这个方法或者抛出异常。</p>

<p>以在TLC中调用puts方法为例，此时puts方法的接收者隐式由self充当，而此时的self是Object类的对象main，那么查看Object类的方法：</p>

<pre><code>irb(main):041:0&gt; Object.methods.grep /puts/
=&gt; []
</code></pre>

<p>在Object中显然并不存在puts方法，那么查看Object的祖先链：</p>

<pre><code>irb(main):042:0&gt; Object.ancestors
=&gt; [Object, Kernel, BasicObject]
       沿着祖先链，我们查看Kernel的方法：

irb(main):043:0&gt; Kernel.methods.grep /puts/
=&gt; [:puts]
</code></pre>

<p>显然puts方法位于Kernel中。从前面知道，Kernel是一个模块，它被混入(Mixin)类中，通常当模块include混入时，模块的方法就成为类的实例方法，由于Kernel模块混入了Object类中，所以在ruby代码的任何地方都可以调用puts方法，因为ruby的几乎全部的类都继承自Object。</p>

<blockquote>
  <p>PS.关于private方法：</p>

  <p>ruby中的private方法有时让人很懊恼。但实际上需要记住的只有一点：private方法只能在隐含的接收者self上被调用，但private方法调用的查找规则和其他方法是一样的。</p>
</blockquote>

<p>所以，即便是TLC中main对象拥有puts方法，但却不能这样调用：</p>

<pre><code>irb(main):046:0&gt; self.puts
NoMethodError: private method `puts' called for main:Object
    from (irb):46
    from C:/RailsInstaller/Ruby1.9.3/bin/irb:12:in `&lt;main&gt;'
</code></pre>

<p>另外，不要和Java等语言中的private混淆，ruby的private方法时可以在子类中调用的：</p>

<pre><code>irb(main):052:0&gt; class Dad
irb(main):053:1&gt; private
irb(main):054:1&gt; def say
irb(main):055:2&gt; puts "Dad says private"
irb(main):056:2&gt; end
irb(main):057:1&gt; end
=&gt; nil
irb(main):058:0&gt; class Son &lt;Dad
irb(main):059:1&gt; def talk
irb(main):060:2&gt; say
irb(main):061:2&gt; puts "son talk"
irb(main):062:2&gt; end
irb(main):063:1&gt; end
=&gt; nil
irb(main):064:0&gt; s=Son.new
=&gt; #&lt;Son:0x1c90cb0&gt;
irb(main):065:0&gt; s.talk
Dad says private
son talk
</code></pre>

<p>最后，补充说一下几个常用方法的调用：</p>

<pre><code>irb(main):067:0&gt; Object.private_methods.grep /method/
=&gt; [:define_method, :method_missing,.........]
</code></pre>

<p>Objcet的method_missing和define_method都是其私有方法，为什么在方法内部调用method_missing正确，而调用define_method就会报错，必须在类上下文充当self时才能调用define_method？</p>

<p>Object#method_missing方法是Object的一个private方法，不能显示地使
用接收者调用，但所有对象都可以隐式调用该方法。
而define_method实际上是Module#define_method方法，该方法是Module的private实例方法，而Class又继承了Module类，所以它变成了Class的实例方法，由于所有的普通类都是Class的实例，所以define_method就成为了所有普通类的类方法，所以在类上下文中能够使用define_method此时self由类充当，而不能在某个具体对象充当self时调用该方法。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install and deploy rails on CentOS]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/install-and-deploy-rails-on-centos/"/>
    <updated>2014-02-14T14:30:55+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/install-and-deploy-rails-on-centos</id>
    <content type="html"><![CDATA[<h3 id="prerequisites">prerequisites:</h3>

<p>I cover all these operations on CentOS 6.4 and with root, so if you encounter some privilege problem, try sudo. And, if using Ubuntu, you needn’t worry about SELinux.</p>

<!-- more -->

<h4 id="install-essentical-library">1. install essentical library</h4>

<pre><code>yum update
yum install gcc g++ make automake autoconf curl-devel openssl-devel zlib-develhttpd-devel apr-devel apr-util-devel sqlite-devel gcc-c++
</code></pre>

<p>then compile and install nodejs</p>

<pre><code>wget http://nodejs.org/dist/v0.10.7/node-v0.10.7.tar.gz
# then compile and install it
</code></pre>

<h4 id="install-libyamlneeded-by-ruby">2. install libyaml(needed by ruby)</h4>

<pre><code>wget http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz
tar xzvf yaml-0.1.4.tar.gz
cd yaml-0.1.4
./configure
make
make install
</code></pre>

<h4 id="install-ruby">3. install ruby</h4>

<pre><code>wget ftp://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p0.tar.gz
# compile and install
ruby –v # check ruby installed correctly
</code></pre>

<h4 id="install-rubygems">4. install rubygems</h4>

<pre><code>wget  http://production.cf.rubygems.org/rubygems/rubygems-2.0.3.tgz
tar vxzf rubygems-2.0.3.tgz
cd rubygems-2.0.3.tgz
ruby setup.rb
gem –v
</code></pre>

<h4 id="install-rails">5. install rails</h4>

<pre><code>gem update
gem update --system
gem install rails –V  #It really costs a longtime, enjoy a coffee now
</code></pre>

<p>Next,we talk about deploy on centos</p>

<h4 id="install-passengerfollow-the-instructions-to-install-extra-lib">6. install passenger(follow the instructions to install extra lib)</h4>

<pre><code>gem  install passenger
passenger-install-apache2-module
</code></pre>

<p>P.S. ==&gt;install passenger &amp; compile nginx</p>

<pre><code>passenger-install-nginx-module
</code></pre>

<p>P.S. install passenger &amp; compile nginx&lt;==</p>

<h4 id="find-the-apache-configure">7. find the apache configure</h4>

<pre><code>apachectl  –V | grep HTTPD_ROOT
apachectl  –V | grep SERVER_CONFIG_FILE
</code></pre>

<p>Add code snippet below to apache config file</p>

<pre><code>&lt;VirtualHost  *:80&gt;
      ServerName   test.com
      DocumentRoot  /var/www/html/blog/public   
      &lt;Directory  /var/www/html/blog/public&gt;
         Allow from all
         AllowOverride all
         Options -MultiViews
      &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>P.S. ==&gt;for nginx</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">   server {
</span><span class="line">      listen 80;
</span><span class="line">      server_name www.yourhost.com;
</span><span class="line">      root /somewhere/public;   # &lt;--- be sure to point to 'public'!
</span><span class="line">      passenger_enabled on;
</span><span class="line">   }</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Add this for development mode in <code>http{</code> node.</p>

<pre><code>passenger_app_env development;
</code></pre>

<p>P.S. for nginx end&lt;==</p>

<p>If something’s wrong, add line below then try again</p>

<pre><code>NameVirtualHost  *:80
</code></pre>

<h4 id="config-mysql-databaseif-you-use-sqliteskip-this-step">8. config mysql database(if you use sqlite,skip this step)</h4>

<p>If you use mysql in production, add below to gemfile</p>

<pre><code>group:production do
    gem ‘mysql2’
end
</code></pre>

<p>Then bundle install</p>

<pre><code>bundle install
</code></pre>

<p>Config mysql</p>

<pre><code>mysql–u root –p # login to mysqlserver
mysql&gt;create database depot_production character set utf8;
mysql&gt;grant all privileges on depot_production.*
mysql&gt;to ‘username’@’localhost’ identified by ‘password’;
mysql&gt;exit;
</code></pre>

<p>Modify the config/database.yml</p>

<pre><code>production:
     adapter: mysql2
     encoding: utf8
     reconnect: false
     database: depot_production
     pool: 5
     username: username
     password: password
     host: localhost
</code></pre>

<h4 id="apply-your-migrations">9. apply your migrations</h4>

<pre><code>rake db:setup RAILS_ENV='production'
</code></pre>

<h4 id="precompile-the-static-resources">10. precompile the static resources</h4>

<pre><code>bundle exec rake assets:precompile RAILS_ENV='production'
</code></pre>

<p>On centos, we must change selinux’s behavior(Everytime you deploy!)</p>

<h4 id="temporarily-go-into-selinux-permissive-mode">11. Temporarily go into SELinux permissive mode</h4>

<pre><code>setenforce  0
</code></pre>

<h4 id="restart-apache">12. restart apache</h4>

<pre><code>apachectl restart
</code></pre>

<h4 id="use-your-rails-app-for-a-while">13. use your rails app for a while</h4>

<h4 id="allow-passenger-run-with-selinux">14. allow passenger run with selinux</h4>

<p>Note: if can’t find audit2allow, you should install it first, otherwise you can skip 2 commands below</p>

<pre><code>yum  provides  \*/audit2allow
yum  install  policycoreutils-python
grep httpd  /var/log/audit/audit.log | audit2allow -M passenger
</code></pre>

<p>install newly created selinux module</p>

<pre><code>semodule  -i passenger.pp
</code></pre>

<h4 id="switch-selinux-back-to-enforcing-mode">15. switch selinux back to enforcing mode</h4>

<pre><code>setenforce 1
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[git常用操作]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/gitchang-yong-cao-zuo/"/>
    <updated>2014-02-14T14:26:31+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/gitchang-yong-cao-zuo</id>
    <content type="html"><![CDATA[<!-- more -->
<p>### 创建远程版本库</p>

<ol>
  <li>
    <p>设置git</p>

    <pre><code> git config --global user.name "MyName"
 git config --global user.email abcde@example.com
</code></pre>
  </li>
  <li>
    <p>创建版本库</p>

    <p>a.新建版本库，并推送到远端</p>

    <pre><code> mkdir TestRepo
 cd TestRepo
 git init
 touch README.md
 git add README.md
 git commit -m 'first commit'
 git remote add origin git@gitserver.com:MyAcountName/TestRepo.git
 git push -u origin master
</code></pre>

    <p>b.使用已有本地版本库，并推送到远端</p>

    <pre><code> cd TestRepo
 git remote add origin git@gitserver.com:MyAcountName/TestRepo.git
 git push -u origin mast
</code></pre>
  </li>
  <li>
    <p>推/拉</p>

    <pre><code> git push origin master
 git pull origin master
</code></pre>
  </li>
</ol>

<h3 id="section">克隆已有的远程版本库</h3>

<pre><code>git clone  git@gitserver.com:MyAcountName/TestRepo.git  usr1/project
cd usr1/project
git config user.name usr1
git config user.email usr1@example.com
echo Hello &gt; README
git add README
git commit –m “initial commit.”
git push origin master
</code></pre>

<h3 id="section-1">克隆本地版本库</h3>

<pre><code>git clone  file:///path/to/repo/TestRepo.git  usr2/project
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Linq中使用委托作为相等比较]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/zai-linqzhong-shi-yong-wei-tuo-zuo-wei-xiang-deng-bi-jiao/"/>
    <updated>2014-02-14T14:13:30+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/zai-linqzhong-shi-yong-wei-tuo-zuo-wei-xiang-deng-bi-jiao</id>
    <content type="html"><![CDATA[<p>Linq中的操作符的相等比较都使用IEqualityComparer<t>作为判断依据，常见的使用该接口的操作符有：</t></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="n">Distinct</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;,</span> <span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;)</span>
</span><span class="line"><span class="n">Contains</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;,</span> <span class="n">TSource</span><span class="p">,</span> <span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">&gt;)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>使用该接口固然可以进行自定义的相等比较，但若对同一类型要做多种相等比较则需要继承实现IEqualityComparer<t>接口的多个子类型，这对于像我这样懒惰的程序员是很难接受的。
<!-- more -->
如果有一个Person类定义如下：</t></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="k">class</span> <span class="nc">Person</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class="line">  <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>而有一个Person[]数组名为people，在代码中我希望这样使用Linq查询：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="kt">var</span> <span class="n">age</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="n">Distinct</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Age</span> <span class="p">==</span> <span class="n">y</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span><span class="line"><span class="kt">var</span> <span class="n">nameandage</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="n">Distinct</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">Age</span> <span class="p">==</span> <span class="n">y</span><span class="p">.</span><span class="n">Age</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">==</span><span class="n">y</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>利用委托实现自定义的相等操作，不论是灵活性还是可读性都要好得多，下面我就要为了写成这样的代码而做做工作了。
首先，要定义一个泛型类去实现IEqualityComparer<t>接口，此外，对该类的要求是要能接受委托比较器，下面即是实现的代码：</t></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MyLinqOperandExtensions</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">private</span> <span class="k">class</span> <span class="nc">DelegateComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IEqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">comparator</span><span class="p">;</span>
</span><span class="line">        <span class="k">public</span> <span class="nf">DelegateComparer</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">comparator</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="k">this</span><span class="p">.</span><span class="n">comparator</span> <span class="p">=</span> <span class="n">comparator</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">y</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="nf">comparator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">public</span> <span class="kt">int</span> <span class="nf">GetHashCode</span><span class="p">(</span><span class="n">T</span> <span class="n">obj</span><span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后，就是需要一个自定义的Distinct操作符，为了和.NET的操作符区分开来，我是用MyDistinct作为新名称：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MyLinqOperandExtensions</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">MyDistinct</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">comparator</span><span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class="line">            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">);</span>
</span><span class="line">        <span class="k">if</span> <span class="p">(</span><span class="n">comparator</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class="line">            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;comparator&quot;</span><span class="p">);</span>
</span><span class="line">        <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="n">Distinct</span><span class="p">(</span><span class="k">new</span> <span class="n">DelegateComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">comparator</span><span class="p">));</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>现在，我们就可以使用委托来使用Distinct操作了，如下示例：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="csharp"><span class="line"><span class="n">Person</span><span class="p">[]</span> <span class="n">people</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">[]</span> <span class="p">{</span>
</span><span class="line">     <span class="k">new</span> <span class="n">Person</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s">&quot;Jack&quot;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">12</span> <span class="p">},</span>
</span><span class="line">     <span class="k">new</span> <span class="n">Person</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s">&quot;Linq&quot;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">22</span> <span class="p">},</span>
</span><span class="line">     <span class="k">new</span> <span class="n">Person</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">22</span> <span class="p">},</span>
</span><span class="line">     <span class="k">new</span> <span class="n">Person</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">12</span> <span class="p">},</span>
</span><span class="line">     <span class="k">new</span> <span class="n">Person</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s">&quot;Jack&quot;</span><span class="p">,</span><span class="n">Age</span><span class="p">=</span><span class="m">22</span> <span class="p">}</span>
</span><span class="line"> <span class="p">};</span>
</span><span class="line"> <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="n">MyDistinct</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">y</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class="line"> <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">n</span> <span class="k">in</span> <span class="n">name</span><span class="p">)</span>
</span><span class="line">     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0} {1}&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span><span class="line"> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;----------------------&quot;</span><span class="p">);</span>
</span><span class="line"> <span class="kt">var</span> <span class="n">age</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="n">MyDistinct</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Age</span> <span class="p">==</span> <span class="n">y</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span><span class="line"> <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">n</span> <span class="k">in</span> <span class="n">age</span><span class="p">)</span>
</span><span class="line">     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0} {1}&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span><span class="line"> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;----------------------&quot;</span><span class="p">);</span>
</span><span class="line"> <span class="kt">var</span> <span class="n">nameandage</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="n">MyDistinct</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">Age</span> <span class="p">==</span> <span class="n">y</span><span class="p">.</span><span class="n">Age</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">==</span><span class="n">y</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
</span><span class="line"> <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">n</span> <span class="k">in</span> <span class="n">nameandage</span><span class="p">)</span>
</span><span class="line">  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0} {1}&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">Age</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[创建自己的gem]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chuang-jian-zi-ji-de-gem/"/>
    <updated>2014-02-14T09:45:52+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chuang-jian-zi-ji-de-gem</id>
    <content type="html"><![CDATA[<p>如果在开发过程中遇到比较通用化的场景，并且估计这种情况其他开发者也可能遇到，就可以把解决方案做成ruby gem，放到<a href="https://rubygems.org">rubygems.org</a>上供所有人使用，并且将源码托管到github上使得解决方案逐步成熟。</p>

<!-- more -->

<p>以创建一个名为jgem的gem为例，下面就是创建gem的具体步骤：</p>

<h3 id="rubygemsorghttpsrubygemsorggithubhttpsgithubcom">1.首先要有<a href="https://rubygems.org">rubygems.org</a>和<a href="https://github.com">github</a>的帐号。</h3>

<h3 id="bundlergem">2.利用bundler创建新的gem：</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>bundle gem jgem
</span><span class="line">		create  jgem/Gemfile
</span><span class="line">		create  jgem/Rakefile
</span><span class="line">		create  jgem/LICENSE.txt
</span><span class="line">		create  jgem/README.md
</span><span class="line">		create  jgem/.gitignore
</span><span class="line">		create  jgem/jgem.gemspec
</span><span class="line">		create  jgem/lib/jgem.rb
</span><span class="line">		create  jgem/lib/jgem/version.rb
</span><span class="line">		Initializing git repo in /Users/jason/Documents/tmp/jgem
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="gemspecgem">3.修改<code>.gemspec</code>文件，主要修改新gem描述：</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>jgem.gemspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">spec</span><span class="o">.</span><span class="n">summary</span>       <span class="o">=</span> <span class="sx">%q{TODO: Write a short summary. Required.}</span>
</span><span class="line"><span class="n">spec</span><span class="o">.</span><span class="n">description</span>   <span class="o">=</span> <span class="sx">%q{TODO: Write a longer description. Optional.}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>添加gem的依赖，包括开发时依赖和运行时依赖：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>jgem.gemspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;rake&quot;</span>
</span><span class="line"><span class="n">spec</span><span class="o">.</span><span class="n">add_runtime_dependency</span> <span class="s2">&quot;activerecord&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="gem">4. 编译gem</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>gem build jgem.gemspec
</span><span class="line">WARNING:  no homepage specified
</span><span class="line">WARNING:  open-ended dependency on rake <span class="o">(</span>&gt;<span class="o">=</span> 0, development<span class="o">)</span> is not recommended
</span><span class="line"><span class="k">if </span>rake is semantically versioned, use:
</span><span class="line">  add_development_dependency <span class="s1">&#39;rake&#39;</span>, <span class="s1">&#39;~&gt; 0&#39;</span>
</span><span class="line">WARNING:  See http://guides.rubygems.org/specification-reference/ <span class="k">for </span><span class="nb">help</span>
</span><span class="line">Successfully built RubyGem
</span><span class="line">Name: jgem
</span><span class="line">Version: 0.0.1
</span><span class="line">File: jgem-0.0.1.gem
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>编译后生成jgem-0.0.1.gem。</p>

<p>注意：在每次<code>gem build</code>编译gem前，必须<code>git add .</code>或<code>git commit</code>一次，因为由于gem和git的紧密关系，没有<code>git add</code>到暂存区的文件变更很可能不会被编译进gem。有的朋友说在bin目录下创建的可执行文件始终无法被编译进gem就是这个原因（他们采取的办法是将<code>.gemspec</code>文件的<code>spec.executables   = spec.files.grep(%r{^bin/}) { |f| File.basename(f) }</code>改成<code>spec.executables =['your_executable_file']</code>，实际这是不必要的）</p>

<h3 id="section">5. 发布</h3>

<p>发布生成的gem到rubygems.org。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>gem push jgem-0.0.1.gem
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>根据提示输入用户信息就行了。</p>

<h3 id="section-1">6. 托管代码</h3>

<p>在github上新建一个代码库，名称最好和gem保持一致为jgem。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">git remote add origin git@github.com:USERNAME/jgem.git
</span><span class="line">git push -u origin master
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="gem-1">7. 更新gem代码</h3>

<p>如果在本地更新代码，需要先<code>git add .</code>或<code>git commit</code>，然后执行<code>gem build</code>才能正确编译。编译好的gem可以先在本地安装试用：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>gem build jgem.gemspec
</span><span class="line"><span class="nv">$ </span>gem install --local jgem-0.0.1.gem
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果要上传到rubygems，则必须更新<code>jgem/lib/jgem/version.rb</code>里的版本号，相同的版本号是不允许重复上传的。到rubygems上传的只是编译好的gem，不要忘了提交代码变更到github。</p>

<p>PS. 如果gem需要添加可执行文件如<code>example_cmd</code>，在jgem目录下创建bin目录来放置这些命令即可(反复提醒，别忘了将新文件添加到git库哦)。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>mkdir bin
</span><span class="line"><span class="nv">$ </span>touch bin/example_cmd
</span><span class="line"><span class="nv">$ </span>chmod a+x bin/example_cmd
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[First Post!]]></title>
    <summary><![CDATA[]]></summary>
    <link href="http://qjpcpu.github.io/blog/2014/02/13/first-post/"/>
    <updated>2014-02-13T22:12:38+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/13/first-post</id>
    <content type="html"><![CDATA[<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">puts</span> <span class="s1">&#39;Hello world!&#39;</span>	
</span></code></pre></td></tr></table></div></figure></notextile></div>
<!-- more -->

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=073d9f3922a446237acaa567a8190333/4e4a20a4462309f7fa4d4851700e0cf3d7cad657.jpg?referer=ac43c04b5143fbf29c3b9313124d&amp;x=.jpg" alt="logo" /></p>

]]></content>
  </entry>
  
</feed>
