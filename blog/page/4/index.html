
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Jason's space</title>
	<meta name="author" content="Jason">

	
	<meta name="description" content="1. 写在前面 算法这个东西，本来不是什么特别复杂的东西，就是为了解决某个问题提出的一个解决方案，说白了，就是一种思路。基本上，所有的算法书上都默认选用了伪代码来表达算法，因为这样可以脱离具体的语言，让算法学习者能够直面算法的本质，理解算法的核心，然后使用自己常用的语言来重新表达， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Jason's space" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Jason's space</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:qjpcpu.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:qjpcpu.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/xue-suan-fa-bing-fei-he-yu-yan-wu-guan/">
		
			学算法并非和语言无关</a>
	</h2>
	<div class="entry-content">
		<h3>1. 写在前面</h3>

<p>算法这个东西，本来不是什么特别复杂的东西，就是为了解决某个问题提出的一个解决方案，说白了，就是一种思路。基本上，所有的算法书上都默认选用了伪代码来表达算法，因为这样可以脱离具体的语言，让算法学习者能够直面算法的本质，理解算法的核心，然后使用自己常用的语言来重新表达，写出能够运行的代码。实际上，在我接触到ruby这类高表达力的语言前，我也这么认为。虽然我能够理解很多算法的核心本质，但往往在实际用C或者java来实现时，总是被一些数组索引等细枝末节的问题所折磨，我通常会告诉自己，嗷，我还没有深刻领悟它，再去看看算法图述和伪码。</p>

<p>但是，今天我想说，我错了。也许，有的语言能够更好地表述算法，表述算法的好的语言应该能够以最接近人类语言的方式表达出来，而且基本就能够运行出结果。</p>

<h3>2. 基本快速排序</h3>

<p>下面是关于快速排序的official描述：
快速排序使用分治法（Divide and conquer）策略来把一个串行（list）分为两个子串行（sub-lists）。</p>

<p>步骤为：</p>

<p>从数列中挑出一个元素，称为 &ldquo;基准&#8221;（pivot），
重新排序数列，所有元素比基准值小的摆放在基准前面，所有元素比基准值大的摆在基准的后面（相同的数可以到任一边）。在这个分区退出之后，该基准就处于数列的中间位置。这个称为分区（partition）操作。
递归地（recursive）把小于基准值元素的子数列和大于基准值元素的子数列排序。</p>

<p>简单地说就是，按数组中某个元素为标准，将数组分为大于该数和不大于该数两个组，然后递归地分别处理这两个组，知道所有元素有序。</p>

<p>那么，我们看看算法导论是怎么用伪码来表述该算法的：</p>

<pre><code>QUICKSORT(A,p,r)
  if p&lt;r
    then q &lt;- PARTITION(A,p,r)
      QUICKSORT(A,p,q-1)
      QUICKSORT(A,q+1,r)

PARTITION(A,p,r)
  x&lt;-A[r]
  i &lt;- p-1
  for j &lt;- p to r-1
    do if A[j]&lt;=x
      then i &lt;- i+1
        exchange A[i] &lt;-&gt; A[j]
  exchange A[i+1] &lt;-&gt; A[r]
  return i+1
</code></pre>

<p>看看吧，不算空行一共14行代码，这甚至还没有包括没有实现的辅助函数exchange呢。反正看算法导论时，我看到这样一堆伪代码时，我都要先去喝杯水，然后深吸一口气，告诉自己，好吧一口气读完吧。</p>

<p>接着，我希望用我爱的ruby重新实现一遍：</p>

<pre><code>def qs(list)
    if list.size&lt;=1
        list
    else
        left,right=list[0..-2].partition{|x| x&lt;=list.last}
        qs(left)+[list.last]+qs(right)
    end
end
</code></pre>

<p>总共8行代码，实际上还可以缩减到5行（可以参考维基百科的ruby实现）。几乎比伪代码节约了一半长度，而且算法表述非常清晰。更重要的是，这是一段可以直接运行的代码，这不是很鼓舞人心吗？</p>

<pre><code>irb(main):056:0&gt; list=[9, 4, 6, 3, 7, 11, 5, 6]
=&gt; [9, 4, 6, 3, 7, 11, 5, 6]
irb(main):066:0&gt; qs list
=&gt; [3, 4, 5, 6, 6, 7, 9, 11]
</code></pre>

<p>最终，如果真的希望使用这段代码，那么就在ruby特有语言基础上再走一步，当然这步和算法表述无关了，只是为了在ruby中更为漂亮地使用该实现。</p>

<pre><code>class Array
    def quick_sort
        if self.size&lt;=1
            self
        else
            left,right=self[0..-2].partition{|x| x&lt;=self.last}
            left.quick_sort+[self.last]+right.quick_sort
        end
    end
end
</code></pre>

<p>使用示例：</p>

<pre><code>irb(main):069:0&gt; list.quick_sort
=&gt; [3, 4, 5, 6, 6, 7, 9, 11]
</code></pre>

<h3>3. 关于UE的一点感悟</h3>

<p>是的，用户体验。各种和计算机打交道的语言也要有好的用户体验，程序员就是编程语言的用户。有时候程序bug很多，真的有可能是语言不好。各种算法书上的伪码真的很让人恶心，所以，伪码也并不简捷。我相信，最终，计算机编程语言会进化到一种，那就是人类语言，那时，就再也没有程序员了，或者，所有人都是程序员。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T17:35:43+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/zhuang-tai-zhuan-yi/">
		
			状态转移</a>
	</h2>
	<div class="entry-content">
		<h3>0. 引言</h3>

<p>昨天遇到一个问题，就是关于对象状态转移的问题，我姑且这样命名吧。简要描述一下就是：对于一个人，他有进食，帮助他人，恋爱等功能，但是这些功能是有先后顺序的，对于刚出生的人，他要先学会进食，然后随着他的成长，他逐渐学会帮助他人，在这个过程中他学会了爱与被爱，当他遇到一个合适的女孩，他就坠入了爱河。整个过程反映到程序上就是，必须按照下面的顺序调用方法：</p>

<pre><code>man=Human.new
man.feed
man.fall_in_love   # Error
man.help_people
man.fall_in_love
</code></pre>

<p>如果你调用某个功能时没有完成前面的事情，就像上面的例子这样，一个人尚未学会帮助他人的人，我们是不希望他去恋爱的，这样一个不懂得互助互爱的人怎么可能珍惜自己的爱人呢？</p>

<p>所以，对象状态转移就是：某个对象随着状态转移获得调用新方法的能力或权限，未达到某个状态前无法调用该状态下的方法。</p>

<h3>1. 目标</h3>

<p>仔细想想，其实这类问题出现还是比较普遍的，比如一个浏览器处理类，它必须要在登陆操作后才允许执行修改个人信息。所以，有必要为了这类问题思考一个解决方法。那么，首先要明确的是，我想要怎样实现这样一个功能。为每个类去实现一个这样的状态转移显然不是ruby way。所以，我觉得对于我自己，我希望这样处理一下我的Human类之后，我就能像引言中那样直接使用状态转移提供的功能：</p>

<pre><code>class Human
    include State
    def feed
        puts"feed myself"
    end
    def protect_env
        puts "protect environment"
    end
    def help_people
        puts "help other people"
    end
    def fall_in_love
        puts "love someone"
    end
    define_chain :feed,[:protect_env,:help_people],:fall_in_love
end
</code></pre>

<p>如代码所示，我希望在我使用的类中包含一个State模块，然后用define_chain定义一个方法链，那么方法链中的方法，必须要在前一个方法调用过之后才可以被调用，否则就会抛出异常。另外，在定义方法链的define_chain中，我希望可以包含列表，列表中的方法需要至少被调用一种才能执行方法链的后续调用。</p>

<p>好吧，这样看起来，似乎是像模像样的ruby解决方法了，那么，下面就看看如何来实现这个State模块。</p>

<h3>2. 环绕别名</h3>

<p>首先，我们肯定需要在define_chain方法上做文章。该方法实际完成状态转移方法链的定义，那么问题的关键是：我知道了这一串方法，怎么样保证在调用下一个方法前，明确上一个方法是否被调用了呢？很显然，我们需要一个变量来保存状态，在每次调用方法前检查是否能够调用当前方法，如果能够，则在调用完成之后更新状态。那么怎么做呢？总不能要求编写Human类的程序员在每个方法调用前先检查一下状态，在调用完成后再更新状态吧，那显然是会被鄙视的。实际上，作为一个ruby程序员，每个人都需要会一点点魔法，这次的魔法就是环绕别名。</p>

<p>假如，对于某个方法名method，我们可以这样环绕起来：</p>

<pre><code>define_method "#{method}_in_chain" do |*params,&amp;block|
    validate_state_for method.to_sym
    self.send "#{method}_out_chain",*params,&amp;block
    update_state_for method.to_sym
    end
alias_method "#{method}_out_chain",method
alias_method method,"#{method}_in_chain"
</code></pre>

<p>这部分代码就是define_chain方法的主体，这样，在定义了状态转移方法链之后，直接调用在方法链中的方法，就会自动使用validate_state_for方法检查方法是否可以被调用，在完成调用后使用update_state_for方法更新状态。</p>

<p>然后我们去实现validate_state_for和update_state_for方法，这两个方法实现很简单，后面再说，我们的State模块看起来基本是这样的：</p>

<pre><code>module State
    def define_chain(*args)
    end

    def validate_state_for(method)
    end

    def update_state_for(method)
    end
end
</code></pre>

<p>好吧，问题的最关键部分解决了，但还是有一些细节，不要小看细节，它决定成败。</p>

<h3>3. 类扩展混入</h3>

<p>显然，我们的define_chain方法必须作为类方法存在，这很简单，可以使用扩展混入。即</p>

<pre><code>class Human
  extend State
end
</code></pre>

<p>但问题来了，我只希望define_chain被作为类方法混入，而validate_state_for和update_state_for方法仍然需要作为类实例方法。那么直接混入肯定就不行了，这时就需要使用ruby另一个魔法了——类扩展混入，将部分方法作为类方法混入，部分方法作为实例方法混入。这种魔法使用了included钩子。</p>

<pre><code>module State
    def self.included(base)
        base.extend StateMaker
    end
    module StateMaker
        def define_chain(*args)
        end
    end
    def validate_state_for(method)
    end
    def update_state_for(method)
    end
end
</code></pre>

<p>现在，在使用下面的方法混入，就获得了我想要的效果。我能够用类方法define_chain定义状态方法链，也能够实例化Human对象调用它的validate_state_for实例方法。</p>

<pre><code>class Human
  include State
end
</code></pre>

<h3>4. 最后一步，实现</h3>

<p>我们的State状态转移模块的结构就是这样了，那么下面就需要具体实现了。</p>

<p>状态判断逻辑非常简单：按照状态方法链的定义，从左到右从0开始编号，而对象状态也从0开始，仅到当前状态大于等于方法编号时，才允许调用该方法。</p>

<p>状态更新逻辑：仅当状态方法编号等于当前对象状态时，才更新状态，即将状态值加1。</p>

<p>这就是State模块的实例方法实现：</p>

<pre><code>module State
    def validate_state_for(method)
        raise "State is too low to execute #{method}" unless min_state_for(method) &lt;= state
    end
    def min_state_for(method)
        self.class.state_chain.find_index{|k,v| v.include? method}
    end
    def update_state_for(method)
        @_state_from_object_monitor_+=1 if min_state_for(method) == state
    end
    def reset_state
        @_state_from_object_monitor_=0
    end
    def state
        @_state_from_object_monitor_=0 unless @_state_from_object_monitor_
        @_state_from_object_monitor_
    end
end
</code></pre>

<p>该模块还提供了reset_state方法重置状态值。另外，min_state_for方法用于获取调用某个方法的最低状态值，该方法中实际上也使用了ruby一点点小魔法，类实例变量，state_chain是一个类方法，它获取了是我们定义的状态转移方法链的一个hash表，该表是一个类实例变量，这个hash具体结构马上就会看到。</p>

<p>下面就是State::StateMaker的的define_chain方法的实现：</p>

<pre><code>module State
    module StateMaker
        def define_chain(*args)
            args.map{|x| x}
            args.flatten.each do |method|
                define_method "#{method}_in_chain" do |*params,&amp;block|
                    validate_state_for method.to_sym
                    self.send "#{method}_out_chain",*params,&amp;block
                    update_state_for method.to_sym
                    nil
                end
                alias_method "#{method}_out_chain",method
                alias_method method,"#{method}_in_chain"
            end
            @chain_methods=args.each_with_index.inject({}) do |memo,(v,index)|
                memo[index]=v.class==Symbol ? [v] : v
                memo
            end
            nil
        end

        def state_chain
            @chain_methods
        end
    end
end
</code></pre>

<p>define_chain方法的前半部分使用环绕别名来包裹特定方法，后半部分就是生成方法链的hash表，生成的hash表被保存在实例变量@chain_methods中，由于define_chain被作为类方法混入，所以它自然也成为了混入类的类实例变量，注意，尽量多使用类实例变量而不要使用类变量。而state_chain方法也同时混入成为类方法，该方法纯粹就是用来获取类实例变量chain_methods的。如1.目标中的方法链生成的hash表的结构是：</p>

<pre><code>{0=&gt;[:feed], 1=&gt;[:protect_env, :help_people], 2=&gt;[:fall_in_love]}
</code></pre>

<h3>5. 结尾</h3>

<p>现在，整个状态转移方法调用就完成了，可以像引言中那样去使用了。不过，这仅仅是个开始，ruby的原则就是DRY，还有细节的地方需要完善修改，比如用ruby2.0就可以更漂亮地完成环绕别名等等。</p>

<h3>6. 附录</h3>

<p>下面是State模块完整代码，供参考。</p>

<pre><code>module State
    def self.included(base)
        base.extend StateMaker
    end
    module StateMaker
        def define_chain(*args)
            args.map{|x| x}
            args.flatten.each do |method|
                define_method "#{method}_in_chain" do |*params,&amp;block|
                    validate_state_for method.to_sym
                    result=self.send "#{method}_out_chain",*params,&amp;block
                    update_state_for method.to_sym
                    result
                end
                alias_method "#{method}_out_chain",method
                alias_method method,"#{method}_in_chain"
            end
            @chain_methods=args.each_with_index.inject({}) do |memo,(v,index)|
                memo[index]=v.class==Symbol ? [v] : v
                memo
            end
            nil
        end
        def state_chain
            @chain_methods
        end
    end
    def validate_state_for(method)
        raise "State is too low to execute #{method}" unless min_state_for(method) &lt;= state
    end
    def min_state_for(method)
        self.class.state_chain.find_index{|k,v| v.include? method}
    end
    def update_state_for(method)
        @_state_from_object_monitor_+=1 if min_state_for(method) == state
    end
    def reset_state
        @_state_from_object_monitor_=0
    end
    def state
        @_state_from_object_monitor_=0 unless @_state_from_object_monitor_
        @_state_from_object_monitor_
    end
end
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T17:30:39+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/chu-shi-jrubyzhi-ru-men/">
		
			初识jruby之入门</a>
	</h2>
	<div class="entry-content">
		<p>首先，Jruby的官方站点是<a href="http://jruby.org/%EF%BC%8C%E6%9C%80%E8%AF%A6%E5%B0%BD%E7%9A%84%E8%B5%84%E6%96%99%E9%83%BD%E5%9C%A8%E9%82%A3%E9%87%8C%E3%80%82%E8%87%B3%E4%BA%8E%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9JRuby%EF%BC%8C%E5%AE%98%E6%96%B9%E7%AB%99%E7%82%B9%E4%B8%8A%E5%88%97%E4%B8%BE%E4%BA%86%E8%AF%B8%E5%A6%82jvm%E7%9A%84%E6%99%AE%E5%8F%8A%E4%BB%A5%E5%8F%8A%E6%80%A7%E8%83%BD%E7%AD%89%E7%AD%89%E4%BC%98%E7%82%B9%EF%BC%8C%E4%BD%86%E6%88%91%E6%83%B3%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%9B%9E%E7%AD%94%E5%B0%B1%E6%98%AF%EF%BC%8C%E6%88%91%E5%96%9C%E6%AC%A2%E7%94%A8ruby%E7%BC%96%E7%A8%8B%EF%BC%8C%E8%80%8C%E5%A4%A7%E5%A4%9A%E6%95%B0%E4%B8%8D%E5%86%8D%E5%85%85%E7%94%B5%E7%9A%84%E8%80%81%E6%9D%BF%E8%BF%98%E5%9B%BA%E5%AE%88%E7%9D%80java%EF%BC%8C%E5%AF%B9%E4%BB%96%E4%BB%AC%E6%9D%A5%E8%AF%B4%EF%BC%8C%E7%9B%B8%E5%AF%B9%E4%BA%8Eruby%EF%BC%8Cjava%E8%BF%99%E4%B8%AA%E8%AF%8D%E6%9C%AC%E8%BA%AB%E5%85%88%E4%BA%A7%E7%94%9F%E4%BA%8650%%E7%9A%84%E5%AE%89%E5%85%A8%E6%84%9F%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E5%8F%AF%E8%83%BD%E6%98%AF%E6%AF%94%E8%BE%83%E8%B4%B4%E8%BF%91%E7%8E%B0%E5%AE%9E%E7%9A%84%E9%80%89%E6%8B%A9%E3%80%82%E4%B8%8D%E8%BF%87%E6%88%91%E4%BB%8A%E5%A4%A9%E6%83%B3%E5%8E%BB%E5%80%92%E8%85%BE%E5%80%92%E8%85%BE%E8%BF%99%E4%B8%AA%E4%B8%9C%E8%A5%BF%EF%BC%8C%E5%88%99%E5%AE%8C%E5%85%A8%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BA%86%E8%A7%A3ruby%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2%E3%80%82">http://jruby.org/%EF%BC%8C%E6%9C%80%E8%AF%A6%E5%B0%BD%E7%9A%84%E8%B5%84%E6%96%99%E9%83%BD%E5%9C%A8%E9%82%A3%E9%87%8C%E3%80%82%E8%87%B3%E4%BA%8E%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9JRuby%EF%BC%8C%E5%AE%98%E6%96%B9%E7%AB%99%E7%82%B9%E4%B8%8A%E5%88%97%E4%B8%BE%E4%BA%86%E8%AF%B8%E5%A6%82jvm%E7%9A%84%E6%99%AE%E5%8F%8A%E4%BB%A5%E5%8F%8A%E6%80%A7%E8%83%BD%E7%AD%89%E7%AD%89%E4%BC%98%E7%82%B9%EF%BC%8C%E4%BD%86%E6%88%91%E6%83%B3%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%9B%9E%E7%AD%94%E5%B0%B1%E6%98%AF%EF%BC%8C%E6%88%91%E5%96%9C%E6%AC%A2%E7%94%A8ruby%E7%BC%96%E7%A8%8B%EF%BC%8C%E8%80%8C%E5%A4%A7%E5%A4%9A%E6%95%B0%E4%B8%8D%E5%86%8D%E5%85%85%E7%94%B5%E7%9A%84%E8%80%81%E6%9D%BF%E8%BF%98%E5%9B%BA%E5%AE%88%E7%9D%80java%EF%BC%8C%E5%AF%B9%E4%BB%96%E4%BB%AC%E6%9D%A5%E8%AF%B4%EF%BC%8C%E7%9B%B8%E5%AF%B9%E4%BA%8Eruby%EF%BC%8Cjava%E8%BF%99%E4%B8%AA%E8%AF%8D%E6%9C%AC%E8%BA%AB%E5%85%88%E4%BA%A7%E7%94%9F%E4%BA%8650%%E7%9A%84%E5%AE%89%E5%85%A8%E6%84%9F%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E5%8F%AF%E8%83%BD%E6%98%AF%E6%AF%94%E8%BE%83%E8%B4%B4%E8%BF%91%E7%8E%B0%E5%AE%9E%E7%9A%84%E9%80%89%E6%8B%A9%E3%80%82%E4%B8%8D%E8%BF%87%E6%88%91%E4%BB%8A%E5%A4%A9%E6%83%B3%E5%8E%BB%E5%80%92%E8%85%BE%E5%80%92%E8%85%BE%E8%BF%99%E4%B8%AA%E4%B8%9C%E8%A5%BF%EF%BC%8C%E5%88%99%E5%AE%8C%E5%85%A8%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BA%86%E8%A7%A3ruby%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2%E3%80%82</a></p>

<h3>1. 下载安装</h3>

<p>首先在官方下载页下载安装最新的jruby，这部分内容还是老老实实去下载页照着做，话说配置开发环境不是每个程序员的必修课吗？不过放心，jruby安装起来很方便的，安装完成后，查看jruby版本，验证是否正确安装：</p>

<pre><code>C:\&gt;jruby --version
jruby 1.7.4 (1.9.3p392) 2013-05-16 2390d3b on Java HotSpot(TM) 64-Bit Server VM 1.6.0_38-b05 [Windows 7-amd64]
</code></pre>

<h3>2. 在jruby中使用rake,gem等</h3>

<p>在jruby下使用这些命令需要前缀一个jruby -S命令，如：</p>

<pre><code>jruby -S gem list --local
jruby -S gem install rails mongrel jdbc-mysql activerecord-jdbcmysql-adapter
jruby -S rails new blog 
cd blog
jruby -S rake -T
jruby -S rake db:create
jruby -S rake db:migrate
</code></pre>

<p>另外，jruby的控制台进入命令时jirb而不是irb：</p>

<pre><code>C:\&gt;jirb
irb(main):001:0&gt;
</code></pre>

<h3>3. 在jruby中调用java类</h3>

<p>例如，在C:\DEMO文件夹下有一个java类文件JavaMan.java：</p>

<pre><code>package example;

public class JavaMan {

  public JavaMan() {
  }

  public void hello() {
      System.out.println("Hello, I am a Java man!");
  }
  public void hello(String name){
     System.out.println("Hello "+name+", I am a Java man!");
  }

}
</code></pre>

<p>然后在命令行中编译该java类文件：</p>

<pre><code>C:\DEMO&gt;javac JavaMan.java -d .
</code></pre>

<p>在C:\DEMO下建立ruby文件demo.rb：</p>

<pre><code>require 'java'
java_import "example.JavaMan" #导入java类JavaMan
j=JavaMan.new
j.hello
j.hello "Jason"
</code></pre>

<p>在命令行中执行该ruby脚本使用jruby命令：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
Hello, I am a Java man!
Hello Jason, I am a Java man!
</code></pre>

<p>也可以直接在jirb中调试ruby程序：</p>

<pre><code>C:\DEMO&gt;jirb
irb(main):001:0&gt; java_import 'example.JavaMan'
=&gt; [Java::Example::JavaMan]
irb(main):002:0&gt; JavaMan.new.hello "Jason"
Hello Jason, I am a Java man!
=&gt; nil
</code></pre>

<h3>4. 在jruby中实现java接口</h3>

<p>若有一个java接口类：</p>

<pre><code>package example;
public interface JavaDog{
    public void runs();
}
</code></pre>

<p>那么可以在ruby代码中实现该接口：</p>

<pre><code>require 'java'
java_import "example.JavaDog" #导入java接口

class FastDog
    include JavaDog
    def runs
        puts "I am running fast!"
    end
end

FastDog.new.runs
</code></pre>

<p>运行结果：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
I am running fast!
</code></pre>

<h3>5. 在jruby中调用jar中的类</h3>

<p>若在C:\DEMO\some.jar中包含了一个java bean， example.Person，该类包含了四个属性name,age,sex,country，除了country外其他三个属性都有setter和getter，另外该Person bean还有一个方法getProfile()获取简历。</p>

<pre><code>require 'java'
require 'some.jar'
java_import "example.Person"

p=Person.new
p.name="Jason"
p.age=10
p.sex="Male"
begin
    p.country="China"
rescue NoMethodError =&gt; e
    puts "No country setter in Person bean"
end
puts p.getProfile
</code></pre>

<p>运行结果：</p>

<pre><code>C:\DEMO&gt;jruby demo.rb
No country setter in Person bean
Name:Jason Sex:Male Age:10
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T17:24:21+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/jruby/'>jruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/rubychang-yong-de-die-dai-cao-zuo/">
		
			Ruby常用的迭代操作</a>
	</h2>
	<div class="entry-content">
		<p>ruby是一门可以用sexy来形容的语言，下面就列举几个sexy的迭代操作。</p>

<h3>1. each简单迭代</h3>

<p>each是ruby中非常常见的遍历操作，她是年老色衰的for直接替代品。如果需要索引，则可以使用each_with_index方法。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.each do |word|
    puts word
end
</code></pre>

<h3>2. find 查找单个元素</h3>

<p>查找到第一个符合条件的元素，find。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.find do |word|
    word.start_with? 'r'
end
=&gt; "ruby"
</code></pre>

<h3>3. select 选取元素</h3>

<p>选取所有符合条件的元素，select。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.select do |word|
    word.start_with? 'r'
end
=&gt; ["ruby", "run"]
</code></pre>

<h3>4. reject 剔除元素</h3>

<p>剔除部分符合条件的元素，reject。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.reject do |word|
    word.start_with? 'r'
end
=&gt; ["good", "god", "sexy", "girl"]
</code></pre>

<h3>5. map 转换元素</h3>

<p>转换每个元素，map。</p>

<pre><code>words=%w(good god ruby sexy girl run)
words.map do |word|
    word.capitalize
end
=&gt; ["Good", "God", "Ruby", "Sexy", "Girl", "Run"]
</code></pre>

<h3>6. uniq 唯一化</h3>

<p>剔除相等的元素，uniq。</p>

<pre><code>words=%w(good god ruby sexy girl run run god Run)
words.uniq
=&gt; ["good", "god", "ruby", "sexy", "girl", "run", "Run"]
</code></pre>

<p>也可以在块中指定比较的方法，自定义比较的对象。</p>

<pre><code>words=%w(good god ruby sexy girl run run god Run)
words.uniq do |w|
    w.downcase
end
=&gt; ["good", "god", "ruby", "sexy", "girl", "run"]
</code></pre>

<h3>7. group_by 分组元素</h3>

<p>分组元素，这个真的很sexy，group_by。</p>

<p>按首字母分组：</p>

<pre><code>words=%w(good god ruby sexy girl Run)
words.group_by do |w|
    w.capitalize[0]
end
=&gt; {"G"=&gt;["good", "god", "girl"], "R"=&gt;["ruby", "Run"], "S"=&gt;["sexy"]}
</code></pre>

<h3>8. sort_by 排序元素</h3>

<p>排序元素，sort_by。</p>

<pre><code>words=%w(good god ruby sexy girl Run)
words.sort_by do |w|
    w.length
end
=&gt; ["Run", "god", "sexy", "ruby", "girl", "good"]
</code></pre>

<h3>9. zip 组合元素</h3>

<p>组合遍历元素，zip。</p>

<pre><code>words=%w(good god ruby sexy girl Run)
numbers=(11..16)
symbols=%w(+ - * / = %)
words.zip(symbols,numbers)
=&gt; [["good", "+", 11], ["god", "-", 12], ["ruby", "*", 13], ["sexy", "/", 14], ["girl", "=", 15], ["Run", "%", 16]]
</code></pre>

<h3>10. inject 累积元素</h3>

<p>累积元素求值，这是我最喜欢的一个，inject。</p>

<pre><code>numbers=(1..10)
numbers.inject do |memo,value|
    memo=memo+value
end
=&gt; 55
</code></pre>

<p>这是比较简单的，举个难点的，如果需要将hash表 {a:1,b:2,c:3,d:1} 的键和值相互调换，即键变值，值变键，并且重复的值变成键后将原本的键变成列表形式的值。</p>

<pre><code>tbl={a:1,b:2,c:3,d:1}
tbl.inject({}) do |memo,(k,v)|
    memo[v]||=[]
    memo[v]&lt;&lt;k
    memo
end
=&gt; {1=&gt;[:a, :d], 2=&gt;[:b], 3=&gt;[:c]}
</code></pre>

<h3>11. partition 分组操作</h3>

<p>将元素分为符合条件和不符合条件的两个组。</p>

<pre><code>(1..6).partition { |v| v.even? }  #=&gt; [[2, 4, 6], [1, 3, 5]]
</code></pre>

<h3>12. flatten扁平化列表</h3>

<p>将多级列表合并为一个单独列表，以上例的列表为例。</p>

<pre><code>[[2, 4, 6], [1, 3, 5]].flatten  #=&gt;[ 2 , 4 , 6 , 1 , 3 , 5 ]
</code></pre>

<h3>13. rotate旋转列表</h3>

<pre><code>a = [ "a", "b", "c", "d" ]
a.rotate         #=&gt; ["b", "c", "d", "a"]
a                #=&gt; ["a", "b", "c", "d"]
a.rotate(2)      #=&gt; ["c", "d", "a", "b"]
a.rotate(-3)     #=&gt; ["b", "c", "d", "a"]
</code></pre>

<h3>14. join将列表转换为一个字符串</h3>

<pre><code>[ "a", "b", "c" ].join        #=&gt; "abc"
[ "a", "b", "c" ].join("-")   #=&gt; "a-b-c"
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T17:18:15+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/ruby-webdriver/">
		
			Ruby Webdriver</a>
	</h2>
	<div class="entry-content">
		<h3>前言</h3>

<p>Watir Webdriver是用ruby操作webdriver的很酷的方式，通常被用来做一些rails app的测试。</p>

<h3>Example</h3>

<p>下面的示例是一个网站的登录示例：</p>

<pre><code>require 'watir-webdriver'
b = Watir::Browser.new
b.driver.manage.window.maximize
b.goto "http://xx.com"
b.link(:text =&gt; 'Create Account').click
b.text_field(:id =&gt; 'signupEmail').focus!.set "some@example.com"
b.text_field(:id =&gt; 'signupPassword').focus!.set "1234"
b.text_field(:id =&gt; 'passwordConfirm').focus!.set "1234"
b.checkbox(:id=&gt; 'notifyOptin').focus!.set true
b.button(:id =&gt; 'signupSubmit').focus!.click
# or you can use:
# b.send_keys :enter
b.text.include? 'Welcome to XX website'
b.close
</code></pre>

<p>上面的示例中，很多text_field或button等元素使用了focus！方法，这是因为webdriver无法和浏览器中未显示的元素交互，否则会发生异常，当你拥有一个很长的列表在当前浏览器窗口中无法显示时，如果去和未显示的列表项交互就会发生这种异常。解决办法是调用元素的focus方法，focus方法会将该元素滚动到视野中，但focus方法默认返回nil，如果调用该方法多次就不是一个hacky way。所以需要为webdriver打个补丁，添加一个focus！方法：</p>

<pre><code>class Watir::Element
    def focus!
        self.focus unless self.visible?
        self
    end
end
</code></pre>

<p>有的网站登录会使用一个frame来呈现登录窗口，webdriver可以很方便地和frame交互：</p>

<pre><code>b.frame(:id =&gt; "content_ifr").text_field(:id=&gt;'signinEmail').set "s@gmail.com"
b.frame(:id =&gt; "content_ifr").text_field(:id=&gt;'signinEmail').set "234"
</code></pre>

<p>更多html元素的交互请看elements。
发送特定的按键：</p>

<pre><code>b.send_keys :enter
b.element.send_keys [:control, 'a'], :backspace
b.element.click(:shift, :control)
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T17:13:12+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/railswei-paperclipshang-chuan-wen-jian-tian-jia-fang-wen-kong-zhi/">
		
			Rails为paperclip上传文件添加访问控制</a>
	</h2>
	<div class="entry-content">
		<h3>0 前言</h3>

<p>由paperclip上传的文件默认是放在rails项目的public目录下的，也就是说，只要能得到该文件的URL，就可以直接访问/下载该文件，如果要对该文件添加访问控制，就需要更改paperclip的默认上传位置。</p>

<h3>1 更改paperclip默认的上传位置</h3>

<p>若有一个story类，每个story有一个封面cover，该cover是一张图片，就可以这样更改model定义：</p>

<pre><code>class Story &lt; ActiveRecord::Base
  has_attached_file :cover,
  :styles=&gt;{:small=&gt;"32x32"}, 
  :path =&gt; ":rails_root/paperclip/:class/:attachment/:id/:style/:filename",
  :url =&gt; "/paperclip/:class/:attachment/:id/:style/:filename"
end
</code></pre>

<p>要同时修改path和url，url是相对于rails工程而言，被rails app用来获取图片渲染页面；而path是相对于rails app服务器而言，在整个宿主文件系统中的路径。必须同时修改path和url。</p>

<p>这里，将保存paperclip的上传文件的目录设置为rails工程根目录下的paperclip目录。</p>

<h3>2 添加controller</h3>

<p>在routes.rb中添加路由：</p>

<pre><code>get "/paperclip/:class/:attachment/:id/:style/:filename",to:"assets#show"
</code></pre>

<p>添加assets_controller.rb文件：</p>

<pre><code>class AssetsController &lt; ApplicationController
  def show
    cls=params[:class].singularize.capitalize.constantize
    asset=cls.find params[:id]
    send_file asset.send(params[:attachment].singularize).path(params[:style])
  end
end
</code></pre>

<p>在提交的参数中params[:class]是复数形式，而通常类定义都是单数如Story，params[:attachment]是也复数形式而类定义中cover为单数，所以都要将他们变成单数，如果类中定义的attachment是复数形式，那么这里attachment就不必转换为单数，否则会引发NoMethod异常。</p>

<p>现在，所有的paperclip资源都由AssetsController控制，所以在其中添加诸如身份登录验证等before_filter就很方便了。在加入身份验证后，即便用户得到该cover的URL，在未登录的情况下，也无法直接访问该图片了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T15:21:11+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/railsshi-yong-bootstrapji-bootswatch/">
		
			Rails使用bootstrap及bootswatch</a>
	</h2>
	<div class="entry-content">
		<h3>1.简介</h3>

<p>Twitter-bootstrap是一个功能强大的前端web框架，使用它可以快速地开发出漂亮的web UI。而thomas-mcdonald/bootstrap-sass是rails sass版本的bootstrap。其他类似的gem还有jlong/sass-twitter-bootstrap，metaskills/less-rails-bootstrap，seyhunak/twitter-bootstrap-rails，前一个也是sass版本，后两个是less版本的。另外，jasny-twitter-bootstrap是bootstrap的一个很好的拓展，添加了文件上传等漂亮的插件。</p>

<p>而Bootswatch是基于bootstrap的主题资源站，提供了很多收费和免费的主题，利用这些现成的主题能够在bootstrap的基础上更进一步加快网站开发，制作出精美的页面。</p>

<h3>2.安装twitter-bootstrap</h3>

<p>这里推荐使用tomas-macdonald/bootstrap-sass。首先在gemfile中添加：</p>

<pre><code>gem 'sass-rails', '~&gt; 3.2'
gem 'bootstrap-sass', '~&gt; 2.3.2.0'
</code></pre>

<p>然后执行bundle install安装需要的gem。
在app/assets/javascripts/application.js文件中添加需要的javascript引用：</p>

<pre><code>//= require jquery
//= require jquery_ujs
//= require bootstrap
//= require_tree .
</code></pre>

<p>将app/assets/stylesheets/application.css重命名为app/assets/stylesheets/application.css.scss。</p>

<p>现在可以调整app/views/layouts/application.html.erb模板布局，然后就可以浏览twitter-bootstrap网站按照example美化自己的rails站点了。</p>

<h3>3.安装bootswatch主题</h3>

<p>如果还想利用bootswatch的主题，就可以使用maxim/bootswatch-rails来方便地继承bootswatch的免费主题。</p>

<p>在gemfile中添加：</p>

<pre><code>gem 'bootswatch-rails'
</code></pre>

<p>然后执行bundle install安装该gem。在application.css.scss文件中require语句后添加：</p>

<pre><code>// 示例：使用bootswatch免费主题： 'Cerulean' bootswatch
// 首先导入变量
@import "bootswatch/cerulean/variables";

// 导入bootstrap
@import "bootstrap";

// 修改bootstrapbody边距
body { padding-top: 60px; }

// 导入bootstrap Responsive styles
@import "bootstrap-responsive";

// 最后导入需要的bootswatch主题
@import "bootswatch/cerulean/bootswatch";

// 你还可以在base.css.scss文件中添加更多自定义设置
@import "base";
</code></pre>

<p>你需要在application.css.scss文件相同目录下创建base.css.scss文件，如果需要就在其中添加更多自定义选择。</p>

<h3>4.Bug fix</h3>

<p>在rails中使用bootswatch可能导致某些css设置失效，通常的可能就是在/app/assets/stylesheets目录下，某些css设置覆盖了bootswatch的配置。比如，按照上述方法配置的bootswatch主题就有可能无法显示主题背景色（body背景色始终是白色）。而rails自动产生的scaffolds.css.sass文件中就覆盖了body的背景色配置，故而导致该bug。所以删除scaffolds.css.scss中除.field_with_errors  和 #error_explanation 其余内容即可。</p>

<p>另外，使用一些其他的rails gem也可能无法使用bootswatch的主题，比如jQuery-modal-rails，它是一个简单的模态对话框gem，但它的对话框就是白底，无法使用bootswatch的主题配置，此时手工配置一下即可，如在需要的页面的.css.sass文件中配置.modal {background-color: green;}，就可以显示绿色的模态对话框。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T15:14:34+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/zai-centosshang-da-jian-gitfu-wu-qi/">
		
			在CentOS上搭建git服务器</a>
	</h2>
	<div class="entry-content">
		<h3>0.定义</h3>

<p>这里的示例中出现的主机有三台：localhost是一台centos主机，也是git服务器；ubuntu是git服务器管理员的workstation；linux是某个git用户jason的workstation。</p>

<p>localhost即git服务器上有两个账户test和git，test是用来搭建git服务器的已存在账户，
git是为git服务器创建的专有账户。</p>

<p>ubuntu是git服务器管理员的workstation，该管理员在自己的这台workstation上的账户是user。</p>

<p>linux是jason的workstation。</p>

<ul>
<li>git server:                 [test@localhost]     [git@localhost]</li>
<li>git administrator:      [user@ubuntu]</li>
<li>git user:                    [jason@linux]</li>
</ul>


<p>文中省略了ssh在各主机间的登录命令及scp复制公钥的过程，注意观察命令前的用户及主机名提示即可。</p>

<h3>1.安装git</h3>

<pre><code>[test@localhost ~]$ sudo yum install git
#检查git是否安装正确
[test@localhost ~]$ git --version
git version 1.7.1
</code></pre>

<h3>2.为git服务器创建专有用户</h3>

<p>通常将该用户取名git</p>

<pre><code>[test@localhost ~]$ sudo useradd git -d /home/git
#最后切换到git用户
[test@localhost ~]$ su - git
</code></pre>

<h3>3.安装gitolite</h3>

<p>gitolite是一款git服务管理工具，通过公钥对用户进行认证，并能够利用配置文件进行repo的精细授权管理。由于它采用ssh公钥认证，所以先要安装ssh。</p>

<pre><code>[test@localhost ~]$ sudo yum install ssh
[test@localhost ~]$ sudo service sshd start
[test@localhost ~]$ sudo chkconfig sshd on
</code></pre>

<p>然后准备安装gitolite，git服务器的管理员需要先准备自己的密钥对。所以，假设这个管理员在自己的workstation（另一台linux主机，这里只是为了得到管理员自己的密钥，并非一定要在另一台linux机器上）上，他需要创建自己的密钥对（方便起见，不要输入passphrase）：</p>

<pre><code>[user@ubuntu ~]$  ssh-keygen -f ~/.ssh/admin
</code></pre>

<p>该命令在~/.ssh目录下创建密钥对admin和admin.pub。</p>

<p>现在回到git服务器主机，将刚创建的admin.pub复制到git用户的家目录下，即/home/git/下，并且chown为git账户。另外，在安装前须保证不存在文件~/.ssh/authorized_keys或该文件为空。</p>

<p>安装gitolite：</p>

<pre><code>[git@localhost ~]$ git clone git://github.com/sitaramc/gitolite
[git@localhost ~]$ mkdir -p ~/bin
[git@localhost ~]$ gitolite/install -to ~/bin
[git@localhost ~]$ gitolite setup -pk admin.pub
</code></pre>

<p>如果在执行第三条命令时出现错误：</p>

<pre><code>Can't locate Time/HiRes.pm in @INC (@INC contains: /home/git/gitolite/src/lib /usr/local/lib/perl5 /usr/local/share/perl5 /usr/lib/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5 /usr/share/perl5 .) at /home/git/gitolite/src/lib/Gitolite/Common.pm line 76.
BEGIN failed--compilation aborted at /home/git/gitolite/src/lib/Gitolite/Common.pm line 76.
Compilation failed in require at gitolite/install line 15.
BEGIN failed--compilation aborted at gitolite/install line 15.
</code></pre>

<p>说明缺少perl需要的软件Time::HiRes，安装该软件包后，重新执行上面的命令：</p>

<pre><code>[test@localhost ~]$ sudo yum install perl-Time-HiRes
</code></pre>

<h3>4.添加用户</h3>

<p>现在，假设team里有个成员叫jason，他将自己的公钥jason.pub邮件给管理员，要求为他创建一个名为foo的repo，他要求该repo仅自己可以修改，其他人不能修改但可以查看。首先管理员在自己的workstation上先要获取gitolite的管理repo，the_git_host是管理员刚搭建的git服务器地址：</p>

<pre><code>[user@ubuntu ~]$  git clone git@the_git_host:gitolite-admin
</code></pre>

<p>注意，执行该命令时，如果被要求输入密码，说明前面某些配置出错了，需要重新查证后再继续。</p>

<p>克隆完成后，在./gitolite-admin目录下需要关注两个子目录：conf和keydir。conf是gitolite的权限配置文件夹，keydir用于放置所有用户的公钥。所以，现在可以将jason的公钥jason.pub放入文件夹keydir。然后编辑conf/gitolite.conf文件，在文件末尾添加新的repo：</p>

<pre><code>repo foo
       RW+         =   jason
       R           =   @all
</code></pre>

<p>提交更改，完成用户及其库的添加：</p>

<pre><code>[user@ubuntu ~]$  git add conf
[user@ubuntu ~]$  git add keydir
[user@ubuntu ~]$  git commit -m 'added foo, gave access to jason'
[user@ubuntu ~]$   git push
</code></pre>

<h3>5.用户执行git版本管理</h3>

<pre><code>[jason@linux ~]$   git clone git@the_git_host:foo
</code></pre>

<p>命令执行完成，创建一个空库foo，现在jason就可以进行版本管理，在需要的时候进行提交。</p>

<p>如果用户想要查询自己有权访问的所有repo，可以使用下面命令查询：</p>

<pre><code>[jason@linux ~]$ ssh git@the_git_host  info
</code></pre>

<p>注意：从第3步开始，任何地方使用ssh或git登录到git服务器需要输入密码，都说明配置git服务器出现错误，需要重新安装gitolite，重新安装前先清除之前的文件：</p>

<pre><code>[git@localhost ~]$ ls -a | grep gitolite | xargs rm -fr
[git@localhost ~]$ rm -fr ~/repositories ~/bin  ~/projects.list ~/.ssh/authorized_keys
</code></pre>

<h3>6.配置gitweb</h3>

<p>如果想要能够在网页上访问git库，就可以利用gitweb。</p>

<pre><code>[test@localhost ~]$ sudo yum install gitweb
</code></pre>

<p>打开/etc/gitweb.conf文件，按照注释的格式添加projectroot变量，指向git库：</p>

<pre><code>our $projectroot = "/home/git/repositories";
our @git_base_url_list = qw(git://git.the_git_host
                        ssh://git.the_git_host/var/lib/git);
</code></pre>

<p>最后编辑apache服务器配置文件/etc/httpd/conf/httpd.conf，在文末添加：</p>

<pre><code>&lt;VirtualHost *:80&gt;
    ServerName the_git_host
    DocumentRoot /var/www/git
    &lt;Directory /var/www/git&gt;
        Options ExecCGI +FollowSymLinks +SymLinksIfOwnerMatch
        AllowOverride All
        order allow,deny
        Allow from all
        AddHandler cgi-script cgi
        DirectoryIndex gitweb.cgi
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>最后修改git库的权限，否则会出现404 no projects found错误，最后重启Apache服务器：</p>

<pre><code>[test@localhost ~]$ sudo chmod 775 /home/git/repositories
[test@localhost ~]$ sudo chmod 775 /home/git
[test@localhost ~]$ sudo apachectl restart
</code></pre>

<p>最后在浏览器里键入<a href="http://the_git_host%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0git%E5%BA%93%E4%BA%86%EF%BC%8C%E6%88%91%E5%9C%A8%E6%9C%AC%E6%9C%BA%E6%B5%8B%E8%AF%95%EF%BC%8C%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AFhttp://localhost%E6%9D%A5%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">http://the_git_host%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0git%E5%BA%93%E4%BA%86%EF%BC%8C%E6%88%91%E5%9C%A8%E6%9C%AC%E6%9C%BA%E6%B5%8B%E8%AF%95%EF%BC%8C%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AFhttp://localhost%E6%9D%A5%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82</a></p>

<p><em>注：</em>如果在完成上述操作后，仍然显示404 no project found，那很可能又是SELinux惹的麻烦，尝试更改selinux的状态为permissive后再刷新页面试试：</p>

<pre><code>[test@localhost ~]$ sudo setenforce 0
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T15:01:55+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/git/'>git</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/rubylei-he-mo-kuai-de-guan-xi/">
		
			Ruby类和模块的关系</a>
	</h2>
	<div class="entry-content">
		<p>学习ruby入门的时候，很容易被其类和模块的小trick给迷惑住了，这里为了整理自己的理解，就写出来看看吧。</p>

<h3>1.ruby一切皆对象</h3>

<p>ruby是彻底地面向对象，你见到的一切构件都是对象。数字是对象，字符串是对象，类也是对象，模块也是对象，甚至类的类(Class)也是对象&hellip;&hellip;</p>

<pre><code>irb(main):001:0&gt; 1.is_a? Object
=&gt; true
irb(main):002:0&gt; Object.is_a? Object
=&gt; true
irb(main):003:0&gt; Class.is_a? Object
=&gt; true
irb(main):007:0&gt; class Test
irb(main):008:1&gt; end
=&gt; nil
irb(main):009:0&gt; Test.is_a? Object
=&gt; true
</code></pre>

<p>其实在这里，像我这样从传统面向对象语言过来的初学者往往会提出疑问：在Java中，我们总可以明显地看出是那个对象在调用方法，但当我进入irb时，并没有创建任何对象，怎么可以调用puts等等方法？这里先不讨论puts方法来源于哪儿，但是当开始执行第一行ruby代码之前，实际上就存在一个对象了。这个对象叫main，是Object的对象。</p>

<pre><code>irb(main):015:0&gt; self
=&gt; main
irb(main):016:0&gt; self.class
=&gt; Object
</code></pre>

<p>此时所处的环境被称为Top Level Context（顶级上下文）。是ruby调用栈的顶端，通常（不在TLC时并非main在充当当前对象）你调用puts等方法时就是这个main对象在充当调用者（接收者）。</p>

<h3>2.ruby的类和模块</h3>

<p>ruby的类和模块可以统一看成是对象的分类，ruby中每个对象都有一个分类：</p>

<pre><code>irb(main):017:0&gt; Object.class
=&gt; Class
irb(main):018:0&gt; t=Test.new
=&gt; #&lt;Test:0x1a5aa48&gt;
irb(main):019:0&gt; t.class
=&gt; Test
irb(main):020:0&gt; Kernel.class
=&gt; Module
irb(main):023:0&gt; Module.class
=&gt; Class
irb(main):024:0&gt; Class.class
=&gt; Class
</code></pre>

<p>可以看到，对象的分类是其普通类，类的分类是Class，Kernel模块的分类是Module，Class的分类也是Class，Module的分类也是类。
甚至于，在ruby中，我们可以认为只有一种分类，那就是模块Module，因为Class是从Module继承而来。</p>

<pre><code>irb(main):011:0&gt; Class.ancestors
=&gt; [Class, Module, Object, Kernel, BasicObject]
</code></pre>

<p>除了很少的几个区别，几乎可以将类和模块一视同仁，类只不过是增强后的模块。那么，ruby中其他普通类和Class/Module有什么关系呢？答案是，其他类（模块）不过是Class(Module)的实例而已。</p>

<pre><code>irb(main):028:0&gt; Test.instance_of? Class
=&gt; true
irb(main):013:0&gt; Kernel.instance_of? Module
=&gt; true
</code></pre>

<p>根据这个原理，就可以像下面这样定义新类：</p>

<pre><code>irb(main):029:0&gt; MyClass=Class.new do
irb(main):030:1* def say
irb(main):031:2&gt; puts "I am MyClass"
irb(main):032:2&gt; end
irb(main):033:1&gt; end
=&gt; MyClass
irb(main):034:0&gt; m=MyClass.new
=&gt; #&lt;MyClass:0x1a4f798&gt;
irb(main):035:0&gt; m.say
I am MyClass
=&gt; nil
</code></pre>

<p>使用Class.new操作就新建了一个类，把这个类赋值给MyClass，这个新类就定义出来了，可以像使用其他类一样使用。这段代码除了证明普通类不过是Class的实例外，还说明了另一个问题：类名不过是一个常量而已。我们可以查看当前常量列表来验证：</p>

<pre><code>irb(main):038:0&gt; Object.constants.grep /MyClass/
=&gt; [:MyClass]
</code></pre>

<h3>3.ruby的方法查找</h3>

<p>当在ruby程序中调用一个方法时，ruby解释器以方法的接收者或者self为起点，沿着该对象的祖先链往上查找方法，直到找到这个方法或者抛出异常。</p>

<p>以在TLC中调用puts方法为例，此时puts方法的接收者隐式由self充当，而此时的self是Object类的对象main，那么查看Object类的方法：</p>

<pre><code>irb(main):041:0&gt; Object.methods.grep /puts/
=&gt; []
</code></pre>

<p>在Object中显然并不存在puts方法，那么查看Object的祖先链：</p>

<pre><code>irb(main):042:0&gt; Object.ancestors
=&gt; [Object, Kernel, BasicObject]
       沿着祖先链，我们查看Kernel的方法：

irb(main):043:0&gt; Kernel.methods.grep /puts/
=&gt; [:puts]
</code></pre>

<p>显然puts方法位于Kernel中。从前面知道，Kernel是一个模块，它被混入(Mixin)类中，通常当模块include混入时，模块的方法就成为类的实例方法，由于Kernel模块混入了Object类中，所以在ruby代码的任何地方都可以调用puts方法，因为ruby的几乎全部的类都继承自Object。</p>

<blockquote><p>PS.关于private方法：</p>

<p>ruby中的private方法有时让人很懊恼。但实际上需要记住的只有一点：private方法只能在隐含的接收者self上被调用，但private方法调用的查找规则和其他方法是一样的。</p></blockquote>

<p>所以，即便是TLC中main对象拥有puts方法，但却不能这样调用：</p>

<pre><code>irb(main):046:0&gt; self.puts
NoMethodError: private method `puts' called for main:Object
    from (irb):46
    from C:/RailsInstaller/Ruby1.9.3/bin/irb:12:in `&lt;main&gt;'
</code></pre>

<p>另外，不要和Java等语言中的private混淆，ruby的private方法时可以在子类中调用的：</p>

<pre><code>irb(main):052:0&gt; class Dad
irb(main):053:1&gt; private
irb(main):054:1&gt; def say
irb(main):055:2&gt; puts "Dad says private"
irb(main):056:2&gt; end
irb(main):057:1&gt; end
=&gt; nil
irb(main):058:0&gt; class Son &lt;Dad
irb(main):059:1&gt; def talk
irb(main):060:2&gt; say
irb(main):061:2&gt; puts "son talk"
irb(main):062:2&gt; end
irb(main):063:1&gt; end
=&gt; nil
irb(main):064:0&gt; s=Son.new
=&gt; #&lt;Son:0x1c90cb0&gt;
irb(main):065:0&gt; s.talk
Dad says private
son talk
</code></pre>

<p>最后，补充说一下几个常用方法的调用：</p>

<pre><code>irb(main):067:0&gt; Object.private_methods.grep /method/
=&gt; [:define_method, :method_missing,.........]
</code></pre>

<p>Objcet的method_missing和define_method都是其私有方法，为什么在方法内部调用method_missing正确，而调用define_method就会报错，必须在类上下文充当self时才能调用define_method？</p>

<p>Object#method_missing方法是Object的一个private方法，不能显示地使
用接收者调用，但所有对象都可以隐式调用该方法。
而define_method实际上是Module#define_method方法，该方法是Module的private实例方法，而Class又继承了Module类，所以它变成了Class的实例方法，由于所有的普通类都是Class的实例，所以define_method就成为了所有普通类的类方法，所以在类上下文中能够使用define_method此时self由类充当，而不能在某个具体对象充当self时调用该方法。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T14:47:25+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/install-and-deploy-rails-on-centos/">
		
			Install and Deploy Rails on CentOS</a>
	</h2>
	<div class="entry-content">
		<h3>prerequisites:</h3>

<p>I cover all these operations on CentOS 6.4 and with root, so if you encounter some privilege problem, try sudo. And, if using Ubuntu, you needn&rsquo;t worry about SELinux.</p>

<h4>1. install essentical library</h4>

<pre><code>yum update
yum install gcc g++ make automake autoconf curl-devel openssl-devel zlib-develhttpd-devel apr-devel apr-util-devel sqlite-devel gcc-c++
</code></pre>

<p>then compile and install nodejs</p>

<pre><code>wget http://nodejs.org/dist/v0.10.7/node-v0.10.7.tar.gz
# then compile and install it
</code></pre>

<h4>2. install libyaml(needed by ruby)</h4>

<pre><code>wget http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz
tar xzvf yaml-0.1.4.tar.gz
cd yaml-0.1.4
./configure
make
make install
</code></pre>

<h4>3. install ruby</h4>

<pre><code>wget ftp://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p0.tar.gz
# compile and install
ruby –v # check ruby installed correctly
</code></pre>

<h4>4. install rubygems</h4>

<pre><code>wget  http://production.cf.rubygems.org/rubygems/rubygems-2.0.3.tgz
tar vxzf rubygems-2.0.3.tgz
cd rubygems-2.0.3.tgz
ruby setup.rb
gem –v
</code></pre>

<h4>5. install rails</h4>

<pre><code>gem update
gem update --system
gem install rails –V  #It really costs a longtime, enjoy a coffee now
</code></pre>

<p>Next,we talk about deploy on centos</p>

<h4>6. install passenger(follow the instructions to install extra lib)</h4>

<pre><code>gem  install passenger
passenger-install-apache2-module
</code></pre>

<h4>7. find the apache configure</h4>

<pre><code>apachectl  –V | grep HTTPD_ROOT
apachectl  –V | grep SERVER_CONFIG_FILE
</code></pre>

<p>Add code snippet below to apache config file</p>

<pre><code>&lt;VirtualHost*:80&gt;
      ServerName   test.com
      DocumentRoot  /var/www/html/blog/public   
      &lt;Directory  /var/www/html/blog/public&gt;
         AllowOverride all
         Options -MultiViews
      &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>If something’s wrong, add line below then try again</p>

<pre><code>NameVirtualHost*:80
</code></pre>

<h4>8. config mysql database(if you use sqlite,skip this step)</h4>

<p>If you use mysql in production, add below to gemfile</p>

<pre><code>group:production do
    gem ‘mysql2’
end
</code></pre>

<p>Then bundle install</p>

<pre><code>bundle install
</code></pre>

<p>Config mysql</p>

<pre><code>mysql–u root –p # login to mysqlserver
mysql&gt;create database depot_production character set utf8;
mysql&gt;grant all privileges on depot_production.*
mysql&gt;to ‘username’@’localhost’ identified by ‘password’;
mysql&gt;exit;
</code></pre>

<p>Modify the config/database.yml</p>

<pre><code>production:
     adapter: mysql2
     encoding: utf8
     reconnect: false
     database: depot_production
     pool: 5
     username: username
     password: password
     host: localhost
</code></pre>

<h4>9. apply your migrations</h4>

<pre><code>rake db:setup RAILS_ENV=”production”
</code></pre>

<h4>10. precompile the static resources</h4>

<pre><code>bundle exec rake assets:precompile
</code></pre>

<p>On centos, we must change selinux’s behavior(Everytime you deploy!)</p>

<h4>11. Temporarily go into SELinux permissive mode</h4>

<pre><code>setenforce  0
</code></pre>

<h4>12. restart apache</h4>

<pre><code>apachectl restart
</code></pre>

<h4>13. use your rails app for a while</h4>

<h4>14. allow passenger run with selinux</h4>

<p>Note: if can&rsquo;t find audit2allow, you should install it first, otherwise you can skip 2 commands below</p>

<pre><code>yum  provides  \*/audit2allow
yum  install  policycoreutils-python
grep httpd  /var/log/audit/audit.log | audit2allow -M passenger
</code></pre>

<p>install newly created selinux module</p>

<pre><code>semodule  -i passenger.pp
</code></pre>

<h4>15. switch selinux back to enforcing mode</h4>

<pre><code>setenforce 1
</code></pre>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T14:30:55+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Jason

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>