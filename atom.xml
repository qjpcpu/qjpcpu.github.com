<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Jason's space]]></title>
  <link href="http://qjpcpu.github.io/atom.xml" rel="self"/>
  <link href="http://qjpcpu.github.io/"/>
  <updated>2014-02-15T18:24:56+08:00</updated>
  <id>http://qjpcpu.github.io/</id>
  <author>
    <name><![CDATA[Jason]]></name>
    <email><![CDATA[qjpcpu@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(四)——条件格式化]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-si-tiao-jian-ge-shi-hua/"/>
    <updated>2014-02-15T00:47:04+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-si-tiao-jian-ge-shi-hua</id>
    <content type="html"><![CDATA[<h3>定义格式化操作</h3>

<p>条件格式化风格定义也是使用格式化定义语句add_style，不同的是必须将type指定为:dxf。</p>

<pre><code># define the style for conditional formatting
profitable = book.styles.add_style( :fg_color =&gt; "FF428751", :type =&gt; :dxf )
unprofitable = book.styles.add_style( :fg_color =&gt; "FF0000", :type =&gt; :dxf )
</code></pre>

<p>条件格式化有四种类型cellIs，colorScale，dataBar，iconSet。</p>

<!-- more -->


<h3>cellIs</h3>

<p>cellIs条件格式化使用得较为普遍，即对满足条件的单元格更改字体颜色，字体大小，背景色等等。</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=0cc20173b8a1cd1101b672258929b9c1/d000baa1cd11728bb30e6961cafcc3cec3fd2c56.jpg?referer=3c8b0130af4bd1135dda82028c4c&amp;x=.jpg" alt="image" /></p>

<p>对于B列，如果数值大于100000表示盈利，则更改字体颜色；对于亏损的，则在C列中将百分比小于100%的赤字显示。</p>

<pre><code>book.add_worksheet(:name =&gt; "Cell Is") do |ws|

  # 产生20行数据
  ws.add_row ["Previous Year Quarterly Profits (JPY)"]
  ws.add_row ["Quarter", "Profit", "% of Total"]
  offset = 3
  rows = 20
  offset.upto(rows + offset) do |i|
    ws.add_row ["Q#{i}", 10000*((rows/2-i) * (rows/2-i)), "=100*B#{i}/SUM(B3:B#{rows+offset})"], :style=&gt;[nil, money, percent]
  end

# 格式化条件&gt;100000
  ws.add_conditional_formatting("B3:B100", { :type =&gt; :cellIs, :operator =&gt; :greaterThan, :formula =&gt; "100000", :dxfId =&gt; profitable, :priority =&gt; 1 })
# 格式化条件0.00%&lt;x&lt;100%
  ws.add_conditional_formatting("C3:C100", { :type =&gt; :cellIs, :operator =&gt; :between, :formula =&gt; ["0.00%","100.00%"], :dxfId =&gt; unprofitable, :priority =&gt; 1 })
end
</code></pre>

<p>add_conditional_formatting方法指定条件格式化，类型type是cellIs，条件由operator和formula共同指定，dxfId就是我们上面定义的格式化操作，priority优先级数值越小，优先级越高。</p>

<h3>colorScale</h3>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=3d1d3870938fa0ec7bc7640816ac28d3/f603918fa0ec08fa0ef0e9e45bee3d6d54fbda85.jpg?referer=6b56cc4859b5c9ea3be437d3269b&amp;x=.jpg" alt="image" /></p>

<p>colorScale是以颜色渐变的方式来格式化表格。</p>

<pre><code>book.add_worksheet(:name =&gt; "Color Scale") do |ws|
  ws.add_row ["Previous Year Quarterly Profits (JPY)"]
  ws.add_row ["Quarter", "Profit", "% of Total"]
  offset = 3
  rows = 20
  offset.upto(rows + offset) do |i|
    ws.add_row ["Q#{i}", 10000*((rows/2-i) * (rows/2-i)), "=100*B#{i}/SUM(B3:B#{rows+offset})"], :style=&gt;[nil, money, percent]
  end

  color_scale = Axlsx::ColorScale.new
  ws.add_conditional_formatting("B3:B100", { :type =&gt; :colorScale, :operator =&gt; :greaterThan, :formula =&gt; "100000", :dxfId =&gt; profitable, :priority =&gt; 1, :color_scale =&gt; color_scale })
end
</code></pre>

<p>大于100000的单元格颜色越来越深，而小于的单元格越来越浅。</p>

<h3>dataBar</h3>

<p>dataBar格式化能够在单元格中同时显示数值和一个柱形图，非常直观漂亮。</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=435a969d3f6d55fbc1c676235d193e77/58ee3d6d55fbb2fb26dba2514d4a20a44723dc85.jpg?referer=b0f4797338f33a87c77a342a1c9b&amp;x=.jpg" alt="image" /></p>

<pre><code>book.add_worksheet(:name =&gt; "Data Bar") do |ws|
  ws.add_row ["Previous Year Quarterly Profits (JPY)"]
  ws.add_row ["Quarter", "Profit", "% of Total"]
  offset = 3
  rows = 20
  offset.upto(rows + offset) do |i|
    ws.add_row ["Q#{i}", 10000*((rows/2-i) * (rows/2-i)), "=100*B#{i}/SUM(B3:B#{rows+offset})"], :style=&gt;[nil, money, percent]
  end

  data_bar = Axlsx::DataBar.new
  ws.add_conditional_formatting("B3:B100", { :type =&gt; :dataBar, :dxfId =&gt; profitable, :priority =&gt; 1, :data_bar =&gt; data_bar })
end
</code></pre>

<h3>iconSet</h3>

<p>iconSet方式是对于满足条件和不满足条件的单元格分别使用不同的图标。</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=c718e589e4cd7b89ed6c3a863f1f339a/34fae6cd7b899e511cacdf5740a7d933c8950d56.jpg?referer=a0046022fa1986181850dab46b4d&amp;x=.jpg" alt="image" /></p>

<pre><code>book.add_worksheet(:name =&gt; "Icon Set") do |ws|
  ws.add_row ["Previous Year Quarterly Profits (JPY)"]
  ws.add_row ["Quarter", "Profit", "% of Total"]
  offset = 3
  rows = 20
  offset.upto(rows + offset) do |i|
    ws.add_row ["Q#{i}", 10000*((rows/2-i) * (rows/2-i)), "=100*B#{i}/SUM(B3:B#{rows+offset})"], :style=&gt;[nil, money, percent]
  end

  icon_set = Axlsx::IconSet.new
  ws.add_conditional_formatting("B3:B100", { :type =&gt; :iconSet, :dxfId =&gt; profitable, :priority =&gt; 1, :icon_set =&gt; icon_set })
end
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(三)创建图表]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-san-chuang-jian-tu-biao/"/>
    <updated>2014-02-15T00:42:48+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-san-chuang-jian-tu-biao</id>
    <content type="html"><![CDATA[<h3>饼图</h3>

<p>axlsx创建饼状图非常简单，上图：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4ccd2d6c4334970a4373102aa5f1a0f5/fc1f4134970a304ec10145b9d3c8a786c9175c56.jpg?referer=ddc5668e5066d016270eab189c4c&amp;x=.jpg" alt="image" /></p>

<!-- more -->


<pre><code>wb.add_worksheet(:name =&gt; "Pie Chart") do |sheet|
  sheet.add_row ["First", "Second", "Third", "Fourth"]
  sheet.add_row [1, 2, 3, 4]
  sheet.add_chart(Axlsx::Pie3DChart, :start_at =&gt; [0,2], :end_at =&gt; [5, 15], :title=&gt; 'dark corner here') do |chart|
    chart.add_series :data =&gt; sheet["A2:D2"], :labels =&gt; sheet["A1:D1"]    #数据点序列及其名称
    chart.d_lbls.show_val = true       #是否在饼状图中显示数值
    chart.d_lbls.show_percent = true    #是否在饼状图中显示所占百分比
    chart.d_lbls.d_lbl_pos = :outEnd    #图例位于图标外部
    chart.d_lbls.show_leader_lines = true  #是否显示数据和数值间的指示线
  end
end
</code></pre>

<p>在add_chart方法中，第一个参数指定图标的类型Aslsx::Pie3DChart，而start_at和end_at分别指定图表的左上角单元格和右下角+1单元格，注意图中饼图的右下角单元格是E15即[4,14]，而end_at是[5,15]，所以称为右下角+1单元格，此外注意和excel编号不同，这里单元格序号是从0开始的。</p>

<ul>
<li>chart.add_series方法是创建图表的主要方法，用来添加点序列的值及其名称。</li>
<li>chart.d_lbls是Data Lables的缩写，顾名思义就是数据标签。</li>
</ul>


<p>饼图中每块扇形的颜色是自动生成的，如果想要手动指定也是可以的：</p>

<pre><code>chart.add_series :data =&gt; sheet["A2:D2"], :labels =&gt; ["A1:D1"], :colors =&gt; ['FF0000', '00FF00', '0000FF']
</code></pre>

<h3>折线图</h3>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=7fd401bba586c9170c03523cf90601f2/d0c8a786c9177f3e8d17194e72cf3bc79f3d5656.jpg?referer=7d35047437fae6cd55a39e51924c&amp;x=.jpg" alt="image" /></p>

<pre><code> wb.add_worksheet(:name =&gt; "Line Chart") do |sheet|
  sheet.add_row ['l1','l2','l3','l4']
  sheet.add_row [1, 2, 100, '=sum(A2:C2)']
  sheet.add_chart(Axlsx::Line3DChart, :start_at =&gt; [0,2], :end_at =&gt; [8, 17], :title =&gt; "Chart") do |chart|
    chart.add_series :data =&gt; sheet["A2:D2"], :labels =&gt; sheet["A1:D1"], :title =&gt; 'bob'
    chart.d_lbls.show_val = true
    chart.d_lbls.show_cat_name = true
    chart.catAxis.tick_lbl_pos = :none   #不在横轴上显示坐标

  end
 end
</code></pre>

<p>chart.d_lbls.show_val表示显示数值，而chart.d_lbls.show_cat_name表示显示每个数值的名称。</p>

<h3>柱形图</h3>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4cc5e74b1d30e924cba49c347c331f3b/29381f30e924b899e2cc837b6c061d950b7bf685.jpg?referer=473e18b979cb0a46dc35bf09329b&amp;x=.jpg" alt="image" /></p>

<pre><code>wb.add_worksheet(:name =&gt; "Bar Chart") do |sheet|
  sheet.add_row ["A Simple Bar Chart"]
  sheet.add_row ["First", "Second", "Third"]
  sheet.add_row [1, 2, 3]
  sheet.add_chart(Axlsx::Bar3DChart, :start_at =&gt; "A4", :end_at =&gt; "F17") do |chart|
    chart.add_series :data =&gt; sheet["A3:C3"], :labels =&gt; sheet["A2:C2"], :title =&gt; sheet["A1"]
    chart.valAxis.label_rotation = -45
    chart.catAxis.label_rotation = 45
    chart.d_lbls.d_lbl_pos = :outEnd
    chart.d_lbls.show_val = true

    chart.catAxis.tick_lbl_pos = :none
  end
  sheet.add_chart(Axlsx::Bar3DChart, :barDir =&gt; :col,:start_at =&gt; "A17", :end_at =&gt; "F30") do |chart| #barDir指定方向:bar或:col
    chart.add_series :data =&gt; sheet["A3:C3"], :labels =&gt; sheet["A2:C2"], :title =&gt; sheet["A1"]
    chart.valAxis.label_rotation = -45
    chart.catAxis.label_rotation = 45
    chart.d_lbls.d_lbl_pos = :outEnd
    chart.d_lbls.show_val = true

    chart.catAxis.tick_lbl_pos = :none
  end
 end
</code></pre>

<p>这里的图表位置start_at和end_at使用了和上面不同的方式，直接使用单元格名称如A4，F17，但end_at仍然是右下角单元格+1。其他代码的自解释性很强，无须赘述了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(二)格式化为美观的表格]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-er-ge-shi-hua-wei-mei-guan-de-biao-ge/"/>
    <updated>2014-02-15T00:38:10+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-er-ge-shi-hua-wei-mei-guan-de-biao-ge</id>
    <content type="html"><![CDATA[<h3>基础知识</h3>

<p>axlsx的格式化使用Aslsx::Styles类来处理，通常使用Axlsx::Styles#add_style 帮助方法来添加格式，该方法定义：</p>

<pre><code>(Integer) add_style(options = {})
</code></pre>

<!-- more -->


<p>所有的格式设置操作都在options这个hash中指定，该hash的键名非常好记，下面是常见的键值列表：</p>

<pre><code>Options Hash (options):
fg_color (String) — 字体颜色，如：FFFF0000
sz (Integer) — 字体大小
b (Boolean) — 是否粗体
i (Boolean) — 是否斜体
u (Boolean) — 是否加下划线
strike (Boolean) — 是否加删除线
shadow (Boolean) — 是否加阴影
charset (Integer) — 字符集，可选的字符集列表：
0   ANSI_CHARSET
1   DEFAULT_CHARSET
2   SYMBOL_CHARSET
77  MAC_CHARSET
128 SHIFTJIS_CHARSET
129 HANGUL_CHARSET
130 JOHAB_CHARSET
134 GB2312_CHARSET
136 CHINESEBIG5_CHARSET
161 GREEK_CHARSET
162 TURKISH_CHARSET
163 VIETNAMESE_CHARSET
177 HEBREW_CHARSET
178 ARABIC_CHARSET
186 BALTIC_CHARSET
204 RUSSIAN_CHARSET
222 THAI_CHARSET
238 EASTEUROPE_CHARSET
255 OEM_CHARSET


family (Integer) — 字体，可选字体：
0 Not applicable.
1 Roman
2 Swiss
3 Modern
4 Script
5 Decorative
6..14 Reserved for future use


font_name (String) — 字体名称
num_fmt (Integer) — 数字格式：可选格式：
1 0
2 0.00
3 #,##0
4 #,##0.00
5 $#,##0_);($#,##0)
6 $#,##0_);[Red]($#,##0)
7 $#,##0.00_);($#,##0.00)
8 $#,##0.00_);[Red]($#,##0.00)
9 0%
10 0.00%
11 0.00E+00
12 # ?/?
13 # ??/??
14 m/d/yyyy
15 d-mmm-yy
16 d-mmm
17 mmm-yy
18 h:mm AM/PM
19 h:mm:ss AM/PM
20 h:mm
21 h:mm:ss
22 m/d/yyyy h:mm
37 #,##0_);(#,##0)
38 #,##0_);[Red](#,##0)
39 #,##0.00_);(#,##0.00)
40 #,##0.00_);[Red](#,##0.00)
45 mm:ss
46 [h]:mm:ss
47 mm:ss.0
48 ##0.0E+0
49 @


format_code (String) — 自定义格式如'yyyy-mm-dd'，如果设置了该值，则num_fmt将被忽略.
border (Integer|Hash) — 边框样式.
bg_color (String) — 单元格背景色
hidden (Boolean) — 是否隐藏单元格
locked (Boolean) — 是否锁定单元格
type (Symbol) — 风格类型，可选的类型有[:dxf, :xf]. :xf事默认类型
alignment (Hash) — 对齐.该hash的包括：
horizontal (Symbol)，该键对应的值包括有：
:general
:left
:center
:right
:fill
:justify
:centerContinuous
:distributed
vertical (Symbol)，该键对应的值有：
:top
:center
:bottom
:justify
:distributed
textRotation (Integer)
wrapText (Boolean)
indent (Integer)
relativeIndent (Integer)
justifyLastLine (Boolean)
shrinkToFit (Boolean)
readingOrder (Integer)
</code></pre>

<h3>格式化报表示例</h3>

<p>格式化报表是以单元格为单位执行的，通常在添加行的时候，在add_row第二个hash参数里指定：</p>

<pre><code>sheet.add_row ['a', "b"], :style =&gt; [nil, header] #header是创建好的style
#or
sheet.add_row ["a', "b"], :style =&gt; header
</code></pre>

<p>如果style是一个列表，那么列表里每一个格式对应于行内每个单元格，也可以像第二行代码那样为整行指定同一种格式。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=9b79859e2c738bd4c021b23491b0f6eb/4bed2e738bd4b31cc6cc6ef885d6277f9f2ff885.jpg?referer=f3368c656f224f4a0e8e4723389b&amp;x=.jpg" alt="image" /></p>

<p>下面是创建如图报表的部分代码：</p>

<pre><code>require 'axlsx'

Axlsx::Package.new do |p|
  p.workbook do |wb|
    styles = wb.styles
    header     = styles.add_style :bg_color =&gt; "FFFF33",:fg_color=&gt;"0033CC", :sz =&gt; 16, :b =&gt; true, :alignment =&gt; {:horizontal =&gt; :center}
    tbl_header = styles.add_style :bg_color=&gt;"99FF33",:b =&gt; true, :alignment =&gt; { :horizontal =&gt; :center }
    ind_header = styles.add_style :bg_color =&gt; "FFDFDEDF", :b =&gt; true, :alignment =&gt; {:indent =&gt; 1}
    col_header = styles.add_style :bg_color =&gt; "FFDFDEDF", :b =&gt; true, :alignment =&gt; { :horizontal =&gt; :center }
    label      = styles.add_style :alignment =&gt; { :indent =&gt; 1 }
    money      = styles.add_style :num_fmt =&gt; 5
    t_label    = styles.add_style :b =&gt; true, :bg_color =&gt; "FFDFDEDF"
    t_money    = styles.add_style :b =&gt; true, :num_fmt =&gt; 5, :bg_color =&gt; "FFDFDEDF"

    wb.add_worksheet do |sheet|
      sheet.add_row               #添加空行
      sheet.add_row [nil, "College Budget"], :style =&gt; [nil, header]        #标题，大字体居中
      sheet.add_row
      sheet.add_row [nil, "What's coming in this month.", nil, nil, "How am I doing"], :style =&gt; tbl_header
      sheet.add_row [nil, "Item", "Amount", nil, "Item", "Amount"], :style =&gt; [nil, ind_header, col_header, nil, ind_header, col_header]
      sheet.add_row [nil, "Estimated monthly net income", 500, nil, "Monthly income", "=C9"], :style =&gt; [nil, label, money, nil, label, money]
      #省略部分代码
      %w(B4:C4 E4:F4 B11:C11 E11:F11 B2:F2).each { |range| sheet.merge_cells(range) }
      sheet.column_widths 2, nil, nil, 2, nil, nil, 2
    end
  end
  p.use_shared_strings = true
  p.serialize 'styles.xlsx'
end
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[axlsx报表工具(一)安装及入门]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-%5B%3F%5D-an-zhuang-ji-ru-men/"/>
    <updated>2014-02-15T00:34:19+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/axlsxbao-biao-gong-ju-[?]-an-zhuang-ji-ru-men</id>
    <content type="html"><![CDATA[<h3>安装</h3>

<p>axlsx是一个基于ruby的Office Open XML Spreadsheet报表生成工具，下图是它生成的一个报表截图</p>

<p><img src="https://raw.github.com/randym/axlsx/master/examples/sample.png" alt="axlsx" /></p>

<!-- more -->


<p>安装axlsx和安装其他gem一样：</p>

<pre><code>$ gem install axlsx
</code></pre>

<h3>创建第一个报表</h3>

<p>axlsx使用的对象和office文档使用的对象完全一样，workbook代表一个文档，worksheet代表一张表，row和cell代表行和单元格，基本上所有的对象顾名思义即可，而不需要了解文档ECMA规范。</p>

<p>比如要创建一张如图所示的报表：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=0b461ccc6e81800a6ae5890b810e42c7/cdbf6c81800a19d86620614631fa828ba61e4656.jpg?referer=5d8a74b17f1ed21b20de1bd5a24c&amp;x=.jpg" alt="image" /></p>

<pre><code>require 'axlsx'

p = Axlsx::Package.new
wb = p.workbook

wb.add_worksheet(:name =&gt; "Basic Worksheet") do |sheet|
  sheet.add_row ["First Column", "Second", "Third","Total"]
  sheet.add_row [1, 2, 3,"=SUM(A2:C2)"]
  sheet.add_row ['This is a very very long sentence.']
  sheet.merge_cells "A3:D3"
end

p.serialize 'basic.xlsx'
</code></pre>

<p>代码非常简单明了，创建worksheet，再一行行添加数据，在添加第二行数据时甚至使用了一个求和函数，所以我们使用过的Excel的知识完全可以直接拿过来使用，甚至对于较长的内容可以合并单元格，但这里没有居中显示所以还不够美观，美观的事情可以格式化来解决，不过这是下一篇的内容了。</p>

<p>最后一行是将报表序列化到xlsx格式的文件，该文件可以用MSOffice直接打开查看。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一步一步搭建mysql主从同步]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/%5B%3F%5D-bu-%5B%3F%5D-bu-da-jian-mysqlzhu-cong-tong-bu/"/>
    <updated>2014-02-15T00:24:49+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/[?]-bu-[?]-bu-da-jian-mysqlzhu-cong-tong-bu</id>
    <content type="html"><![CDATA[<h3>下载mysql数据库</h3>

<pre><code>$ wget http://cdn.mysql.com/Downloads/MySQL-5.1/mysql-5.1.73.tar.gz
tar vzxf mysql-5.1.73.tar.gz
</code></pre>

<!-- more -->


<h3>编译安装</h3>

<p>最好专门创建一个用户mysql来安装数据库。</p>

<pre><code>MYSQL_BASEDIR=$HOME/mysql
cd mysql-5.1.73
./configure 
--prefix=${MYSQL_BASEDIR} 
--with-charset=gbk 
--with-extra-charsets=gbk,utf8,ascii,big5,latin1,binary 
--with-unix-socket-path=${MYSQL_BASEDIR}/tmp/mysql.sock 
--with-mysqld-user=mysql     #以哪个用户执行mysqld进程
make
make install
</code></pre>

<h3>初始化数据库</h3>

<p>复制必要的配置文件和启停脚本</p>

<pre><code>cd ${MYSQL_BASEDIR}
mkdir etc log tmp var
cp share/mysql/my-medium.cnf  my.cnf
cp share/mysql/mysql.server  bin/
</code></pre>

<h3>修改配置文件</h3>

<pre><code>vim ./my.cnf
</code></pre>

<p>在[mysqld]下添加配置项：</p>

<pre><code>basedir= ${MYSQL_BASEDIR}   # ${MYSQL_BASEDIR}是你的mysql安装目录
datadir = ${MYSQL_BASEDIR}/var   # mysql数据路径
tmpdir = ${MYSQL_BASEDIR}/tmp   # 临时文件路径
slave-load-tmpdir = ${MYSQL_BASEDIR}/tmp   # 从服务器同步LOAD DATA INFILE语句时创建临时文件的目录名
port = 3306   # 如果修改port，[mysqld] 和 [client]下的port都要修改
pid-file = ${MYSQL_BASEDIR}/var/mysql.pid  # mysqld PID文件位置
#以下为可选
socket = ${MYSQL_BASEDIR}/tmp/mysql.sock  # 用于指定本地连接的Unix套接字文件位置，[mysqld] 和 [client]下的port都要修改
#skip-name-resolve   # 是否仅使用ip验证客户端
#skip-symbolic-links  #忽略MyISAM表的数据及索引文件连接到另一个目录下
max_connect_errors = 10000
max_connections = 500
wait-timeout = 30
</code></pre>

<p>启动数据库</p>

<pre><code>$ ./bin/mysql_install_db  #安装数据库文件
$ ./bin/mysql.server start    #出现下面这行说数据库启动ok了
Starting MySQL.                                            [  OK  ]
</code></pre>

<h3>配置mysql用户</h3>

<p>使用./bin目录下的mysql命令可以登录到数据库，登录后删除匿名用户并且为root设置密码：</p>

<pre><code>$ mysql -u root
&gt; delete from mysql.user where user='';
&gt; UPDATE mysql.user SET Password = PASSWORD('password') WHERE user='root';
</code></pre>

<p>按照以上同样的步骤再搭建一个mysql，注意，如果在同一主机搭建多个mysql实例，那么就需要将端口改成不同才行。</p>

<p>下面开始配置主从同步。</p>

<p>首先在主库新建专门用于同步的数据库账号mysqlsync</p>

<pre><code>&gt; GRANT REPLICATION SLAVE ON *.* TO 'mysqlsync'@'%' IDENTIFIED BY 'password';
</code></pre>

<h3>主库配置</h3>

<p>所有的配置项还是在my.cnf中的[mysqld]下添加。</p>

<p>首先server-id作为MySQL服务器的标识，具有相关联上下游同步系统需具有全局唯一性。主库我们将server-id配置为1。其他主库需要添加的配置有：</p>

<pre><code>server-id=1
# 同步过程中需要忽略的表，支持正则表达式。全库同步时，必须屏蔽mysql系统库和test测试库。
replicate-wild-ignore-table = mysql.%
replicate-wild-ignore-table = test.%
# 需要同步的表，多个表需多次指定，这里我们使用全库同步,方便点
# replicate-do-table = database.table
log-bin = mysql-bin  #二进制日志，强制开启
log-bin-index = mysql-bin.index  # 记录二进制日志索引文件
relay-log-index = relay-log.index # 记录中继日志索引文件
</code></pre>

<h3>从库配置</h3>

<pre><code>server-id=2
read-only # 在从库开启该选项，避免在从库上进行写操作，导致主从数据不一致（不过对super权限无效哦）
skip-slave-start # 在从库开启该选项，启动数据库后，需手动开启同步进程
relay-log = mysql-relay #中继日志，从库开启
relay-log-index = relay-log.index
log-bin = mysql-bin
log-bin-index = mysql-bin.index
replicate-wild-ignore-table = mysql.%
replicate-wild-ignore-table = test.%
</code></pre>

<h3>同步设置</h3>

<p>启动主数据库，并查看主库状态：</p>

<pre><code>$ ./bin/mysql.server start
$ mysql -u root -p
mysql&gt; show master status;
</code></pre>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=21e536be79899e517c8e3a11729ca80e/e7cd7b899e510fb31b3b92d4db33c895d1430c56.jpg?referer=a44e286a8418367af49e4aed6c4d&amp;x=.jpg" alt="image" /></p>

<p>记下来log文件名和位置，这里是“mysql-bin.000005&#8221;和”106“。</p>

<p>然后启动从库，</p>

<pre><code>$ ./bin/mysql.server start
$ mysql -u root -p
mysql&gt; change master to master_host='your_host',master_port=3307,master_user='mysqlsync',master_password='pasword',master_log_file='mysql-bin.000005',master_log_pos=106;
mysql&gt; startslave;  #启动从库
mysql&gt; show slave status\G;
</code></pre>

<p>最后一条sql命令得到如图结果：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=a307b4b80846f21fcd345e56c61f1a5d/7acb0a46f21fbe091fae395769600c338644ad85.jpg?referer=781a5e5095dda144831e58820b9b&amp;x=.jpg" alt="image" /></p>

<p>其中Slave_IO_Running和Slave_SQL_Running是yes就对了。</p>

<p>最后，可以验证一下，在主库修改记录，从库可以看到同步过来的变化。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在rails外单独使用ActiveRecord]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/zai-railswai-dan-du-shi-yong-activerecord/"/>
    <updated>2014-02-15T00:20:50+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/zai-railswai-dan-du-shi-yong-activerecord</id>
    <content type="html"><![CDATA[<!-- more -->


<h3>单独使用ActiveRecord</h3>

<p>需要在应用根目录demo/下的app.rb文件中写入：</p>

<pre><code>require 'active_record'  
require 'sqlite3'  

ActiveRecord::Base.establish_connection(  
    :adapter=&gt;'sqlite3',  
    :database=&gt;'data.sqlite3',  
    :pool=&gt;5,  
    :timeout=&gt;5000  
    )  

class CreateUsers &lt; ActiveRecord::Migration  
  def change  
    create_table :users do |t|  
      t.string :name  
      t.integer :age  
    end 
  end  
end  

CreateUsers.new.change

class User &lt; ActiveRecord::Base  
end  

User.create name:"Jack",age:12
</code></pre>

<p>首先，使用ActiveRecord::Base.establish_connection建立连接，然后定义数据表迁移，再使迁移生效建立数据表，最后就可以像在rails中一样定义model，然后正常使用ActiveRecord了。</p>

<p>代码可以正常工作了，但可以做的工作还有很多，因为这段代码实在是不美观。</p>

<h3>像样的结构</h3>

<p>大杂烩式的代码文件总是不美的，上面代码中包含了数据库连接，表创建，model定义和实际的应用代码四部分，这么多功能各异的部件还是分开好。首先创建demo/db目录，在这个目录下放置所有数据库连接的定义；创建demo/models目录，在下面放置model定义文件。demo/app.rb文件位置不变。</p>

<h3>model定义</h3>

<p>model定义文件demo/user.rb的内容就是将上面的user类定义复制过来即可。</p>

<pre><code>class User &lt; ActiveRecord::Base
end
</code></pre>

<h3>ActiveRecord配置</h3>

<p>新建demo/db/connection.rb文件，该文件里设置数据库连接：</p>

<pre><code>require 'active_record'
require 'yaml'

dbconfig = YAML::load(File.open('db/database.yml'))
ActiveRecord::Base.establish_connection(dbconfig)
</code></pre>

<p>这里模仿rails使用了yaml来配置连接，该文件也在demo/db目录下，内容为：</p>

<pre><code>adapter: sqlite3
database: data.sqlite3
pool: 5
timeout: 5000
</code></pre>

<p>现在的demo/app.rb清爽多了：</p>

<pre><code>require File.expand_path('../db/connection',__FILE__)
Dir[File.expand_path('../models',__FILE__)+'/*.rb'].each{|f| require f }

User.create name:"Jack",age:12
</code></pre>

<h3>数据表迁移</h3>

<p>现在还有一个问题，我也想像rails中那样利用rake来迁移数据表定义。参考我前一篇博客Rake就可以轻松写出数据迁移的rakefile。在demo/根目录下创建rakefile文件：</p>

<pre><code>require 'active_record'
require 'yaml'
require 'logger'

task :default =&gt; :migrate

task :migrate =&gt; :environment do
  ActiveRecord::Migrator.migrate('db/migrate', ENV["VERSION"] ? ENV["VERSION"].to_i : nil )
end

task :environment do
  ActiveRecord::Base.establish_connection(YAML::load(File.open('db/database.yml')))
  ActiveRecord::Base.logger = Logger.new(File.open('db/database.log', 'a'))
end
</code></pre>

<p>只要在终端中执行rake命令就可能完成数据迁移：</p>

<pre><code>$ rake
==  CreateUsers: migrating ====================================================
-- create_table(:users)
   -&gt; 0.0020s
==  CreateUsers: migrated (0.0040s) ===========================================
</code></pre>

<p>实际上现在还无法得出这样的输出，因为还没有编写迁移代码文件。那么迁移文件写在哪儿呢？在demo/db/migrate/目录中专门用来放置数据迁移代码，比如现在我们在该目录下新建一个迁移文件001_create_users.rb，写入迁移代码：</p>

<pre><code>class CreateUsers &lt; ActiveRecord::Migration  
  def change  
    create_table :users do |t|  
      t.string :name  
      t.integer :age  
    end 
  end  
end  
</code></pre>

<p>现在执行rake命令才能得出上面给出的正确输出。</p>

<p>最后给出示例应用的最终目录结构：</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=8350422bd309b3deefbfe46dfc841dbc/9358d109b3de9c8204461ccc6e81800a19d84356.jpg?referer=16e32c709045d688fa158794ad4c&amp;x=.jpg" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rspec]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/rspec/"/>
    <updated>2014-02-15T00:14:29+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/rspec</id>
    <content type="html"><![CDATA[<h2>RSpec断言规则</h2>

<p>RSpec有一些常见的断言规则。Ruby的断言方法是以问号结尾并且返回true或false的方法，常见的如： empty?   nil?    instance_of? 等。在spec中的断言很简单，就是should be_去掉问号的断言方法。如：</p>

<pre><code>[].should be_empty =&gt; [].empty? #passes
[].should_not be_empty =&gt; [].empty? #fails
</code></pre>

<!-- more -->


<p>除了用&#8221;be_&ldquo;来前缀断言方法，也可以用&#8221;be_a_&#8221;和&#8221;be_an_&#8221;前缀，使得代码读起来更加自然：</p>

<pre><code>"a string".should be_an_instance_of(String) =&gt;"a string".instance_of?(String)#passes
3.should be_a_kind_of(Fixnum) =&gt; 3.kind_of?(Numeric) #passes
3.should be_a_kind_of(Numeric) =&gt; 3.kind_of?(Numeric) #passes
3.should be_an_instance_of(Fixnum) =&gt; 3.instance_of?(Fixnum) #passes 
3.should_not be_instance_of(Numeric) =&gt; 3.instance_of?(Numeric) #fails
</code></pre>

<p>Rspec也会为诸如“has_key?”之类的断言创建匹配器，要使用该特性，在断言对象上使用 should have_key(:key) 就可以了，rspec会自动在对象上调用has_key?(:key)。如：</p>

<pre><code>{:a =&gt; "A"}.should have_key(:a) =&gt; {:a =&gt; "A"}.has_key?(:a) #passes
{:a =&gt; "A"}.should have_key(:b) =&gt; {:a =&gt; "A"}.has_key?(:b) #fails
</code></pre>

<p>还有一些常见的断言方法如： be  be_close  change  eql  have  be_true  be_false be_nil include raise_error respond_to throw_symbol   等等</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rake based application]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/15/rake-based-application/"/>
    <updated>2014-02-15T00:04:13+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/15/rake-based-application</id>
    <content type="html"><![CDATA[<h3>1.什么是rack</h3>

<p>rack是基于ruby的web服务器接口，它将http协议以非常简单的方式包裹起来，为web服务器和应用提供一致性的接口。rack被用于几乎所有的ruby web应用开发框架中。这是维基百科上给出的一个基于rack的ruby应用：</p>

<pre><code>app = lambda do |env|
  body = "Hello, World!"
  [200, {"Content-Type" =&gt; "text/plain", "Content-Length" =&gt; body.length.to_s}, [body]]
end

run app
</code></pre>

<p>重点是第三行，一个基于rack的ruby应用只需要一个包含call方法的对象，在调用call方法后该对象会返回形如第三行的一个列表，该列表包含三个元素：第一个元素是这次http请求的返回状态码200，第二个元素是一个返回的http响应headers的hash表，第三个元素是http响应体的列表，所以该列表的形式为：</p>

<pre><code>[ status_code, headers, body ]
</code></pre>

<!-- more -->


<h3>2.一个简单的rack-based-application</h3>

<p>编写一个最简单的rack based application，ok，需要一个能响应call方法的对象，在该对象上调用call方法能返回[ status_code, headers, body ]列表。在文件夹rack_based下新建simple.ru文件，*.ru被称为rakcup文件，rack使用该文件来启动rack应用。该文件内容为：</p>

<pre><code>run lambda { |env| [200,{'Content-Type'=&gt;'text/plain'},['OK']]}
</code></pre>

<p>That&rsquo;s all.这个基于rack的应用已经编写完成了，在terminal中键入下面命令即可启动这个应用了：</p>

<pre><code>rackup rack_based/simple.ru
</code></pre>

<p>rack使用默认的内置WEBrick服务器，用rackup命令在端口9292启动该应用：</p>

<pre><code>JasondeMacBook-Pro:Projects jason$ rackup rack_based/simple.ru 
Thin web server (v1.6.1 codename Death Proof)
Maximum connections set to 1024
Listening on 0.0.0.0:9292, CTRL+C to stop
</code></pre>

<p>在浏览器中访问<a href="http://localhost:9292%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA%E2%80%9COK%E2%80%9D%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%BA%94%E7%94%A8%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%BA%86%E3%80%82">http://localhost:9292%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA%E2%80%9COK%E2%80%9D%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%BA%94%E7%94%A8%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%BA%86%E3%80%82</a></p>

<p>Rails也是基于rack的框架，所以，rails的rackup配置文件是位于应用根目录下的config.ru：</p>

<pre><code># This file is used by Rack-based servers to start the application.

require ::File.expand_path('../config/environment',  __FILE__)
run Rails.application
</code></pre>

<p>所以，Rails.application也能响应call方法。</p>

<p>另外，call方法还带有一个env参数，该参数是一个hash表，包含了请求所有的环境信息，rack应用可以根据env信息给予不同的响应，如下面将simple.ru略作修改，使得它可以返回所有的请求信息：</p>

<pre><code>module Simple
    class Application
        def self.call(env)
            [200,{'Content-Type'=&gt;'text/plain'},[env.to_s]]
        end
    end
end
run Simple::Application
</code></pre>

<p>启动该应用，则可以看到结果：</p>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6bc04cf1d358ccbf1fbcb53f29e3cd03/9d82d158ccbf6c815814c9abbe3eb13533fa4056.jpg?referer=0e96044c8594a4c25334d21ba04c&amp;x=.jpg" alt="image" /></p>

<h3>3.middleware</h3>

<p>这是一个rack应用的请求栈：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=70915c2796eef01f491418c0d0c5e818/8d5494eef01f3a29e9eb308d9b25bc315c607c56.jpg?referer=639819647d3e6709e71770cfbc4c&amp;x=.jpg" alt="image" /></p>

<p>浏览器发出http请求到web Server，web server 再将请求转交给rack，rack负责将请求转交给应用程序栈。在应用栈中，请求经过一层层的中间层middleware后，最好才传达给rack应用，譬如rails的应用的controller最后来处理请求，当rack应用处理完请求后，又逐层返回，最后由rack上交给web server完成响应。注意，并非每次请求都需要完成从上到下的全部栈层次，比如请求一个存在的静态文件，就可能直接由处理静态文件的middleware发送文件，而根本不会将请求传递到rack应用controller中去。</p>

<p>由这张图可以看出来，rack是web server和应用之间的桥梁，或者说适配器。另外，rack应用处在请求栈的最后一层，web请求经过了无数的middleware后才真正到达应用这里。middleware所起的作用和java struts中的拦截器概念非常相似，它们都负责将请求逐层包裹最后递交给应用的是一个非常友好的请求包，使得应用可以更方便地处理逻辑。</p>

<p>下面就来创建一个自定义的middleware，该middleware可以将请求网页内所有&lt;h1>标记内的内容的e改写成大写的X。</p>

<p>首先新建一个rails app，在新建完成后，实用下面命令可以查看rails已经使用的middleware：</p>

<pre><code>rake middleware

use Rack::Sendfile
use ActionDispatch::Static
......
use Rack::Head
use Rack::ConditionalGet
use Rack::ETag
run Demo::Application.routes
</code></pre>

<p>现在在应用的lib目录下新建文件link_jumbler.rb，文件app/lib/link_jumbler.rb的内容：</p>

<pre><code>require 'nokogiri'

class LinkJumbler
    def initialize(app,letters)
        @app=app
        @letters=letters
    end

    def call(env)
        status, headers, response = @app.call(env)
        body=Nokogiri::HTML(response.body)
        body.css("h1").each do |a|
            @letters.each do |f,r|
                a.content=a.content.gsub f.to_s,r.to_s
            end
        end

        [status,headers,[body.to_s]]
    end
end
</code></pre>

<p>首先，在initialize方法中，接受了两个参数，一个是app参数，它会在各个middleware中传递，需要对它调用call方法。另一个参数letters是我们这个middleware需要的参数，这个参数来源是挂载middleware时产生的。不同middleware的传递的这个参数不同，也可能根本没有这个额外的参数。在call方法中，先对@app调用了call方法获得了一个rack风格的响应结果，这里利用nokogiri解析结果，并做出修改，最后返回结果。在java struts中有个前拦截器和后拦截器，从这里也可以看出middleware也可以有相同的功能，比如这里就是对结果作处理，属于一个后处理的middleware。</p>

<p>然后将这个middleware添加到该应用的middleware栈中（看到letters哪儿来的了吧），在app/config/application.rb中添加
<code>config.middleware.use LinkJumbler,{"e"=&gt;"X"}</code>
添加完成后app/config/application.rb文件内容为：</p>

<pre><code>require File.expand_path('../boot', __FILE__)

require 'rails/all'
require File.expand_path('../../lib/link_jumbler', __FILE__)

Bundler.require(:default, Rails.env)

module Demo
  class Application &lt; Rails::Application
    config.middleware.use LinkJumbler,{"e"=&gt;"X"}
  end
end
</code></pre>

<p>再次执行rake middleware命令，可以看到LinkJumbler被添加到最后一层middleware：</p>

<pre><code>use Rack::Sendfile
use ActionDispatch::Static
......
use Rack::Head
use Rack::ConditionalGet
use Rack::ETag
use LinkJumbler
run Demo::Application.routes
</code></pre>

<p>启动该rails应用，可以看到和标准rails欢迎界面的区别了吗？</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=513d3845adc379317968862cdbffc678/f636afc379310a559ad424b7b54543a983261084.jpg?referer=65c5a1751f950a7b2c227af4509b&amp;x=.jpg" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识jruby之在tomcat上部署jruby-on-rails]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-zai-tomcatshang-bu-shu-jruby-on-rails/"/>
    <updated>2014-02-14T23:58:44+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-zai-tomcatshang-bu-shu-jruby-on-rails</id>
    <content type="html"><![CDATA[<h3>1. prerequesite</h3>

<p>假定部署的sever上已经安装好了Java环境和mysql数据库（因为这里我将以mysql为例）。并且，这里为了和前面几篇博文保持一致，还是在windows上进行部署，实际在linux上部署的节奏也差不多了，即便遇到问题，google is ready for you.</p>

<!-- more -->


<h3>2. 安装配置Apache Tomcat</h3>

<p>首先，在Apache Tomcat网站上下载tomcat压缩包，目前的版本是7.0。下载完成后解压缩，如解压到C:\，解压缩后目录结构如图：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=c5fe07e6d343ad4ba22e46c5b2392b92/c995d143ad4bd1136f3d4d7158afa40f4afb0584.jpg?referer=97197c6f8501a18ba9fc267f639b&amp;x=.jpg" alt="image" /></p>

<p>进入其中bin目录，并以管理员身份运行startup.bat批处理文件启动tomcat，tomcat默认端口为8080，所以，在浏览器中访问<a href="http://localhost:8080">http://localhost:8080</a> ，如果出现图示页面说明tomcat安装配置正确。</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=79626b7c49fbfbedd859367a48cb860b/a50f4bfbfbedab642082b783f536afc378311e84.jpg?referer=24c5e74b1d30e92496b3a8015a9b&amp;x=.jpg" alt="image" /></p>

<h3>3. 下载安装jruby</h3>

<p>安装jruby在前一篇博文讲解较细，这里不再赘述。</p>

<p>安装必要的JDBC。</p>

<pre><code>jruby -S gem install activerecord-jdbcmysql-adapter -v 1.3.0.beta2
</code></pre>

<p>如果要将jruby on rails工程打包为war发布到tomcat上，就必须要用到warbler Gem：</p>

<pre><code>jruby -S gem install warbler
</code></pre>

<h3>4. 打包jruby on rails工程</h3>

<p>首先确认database.yml文件production环境配置正确：</p>

<pre><code>production:
  adapter: mysql
  encoding: utf8
  reconnect: false
  database: demo_production
  username: user
  password: password
  host: localhost
  port: 3306
</code></pre>

<p>配置正确的production数据库，及其用户密码。</p>

<p>在数据库中创建production数据库demo_production，并且赋予用户user对该数据库的完全权限。</p>

<p>然后开始打包工程，在rails app根目录下执行：</p>

<pre><code>jruby -S warble
</code></pre>

<p>该命令会在工程根目录下生成一个war文件，如demo.war，该war会将必要的gem打包进去，使得我们能够像普通java工程war文件那样部署到tomcat中。</p>

<h3>5. 部署war</h3>

<p>将该war复制到tomcat的webapps目录下，等待大约几秒钟，tomcat会自动释放文件完成部署。</p>

<p>最后一步，进入tomcat释放的文件夹demo中，生成数据库schema：</p>

<pre><code>C:\apache-tomcat-7.0.35\webapps\demo&gt;jruby -S rake db:migrate RAILS_ENV="production"
</code></pre>

<p>现在可以访问<a href="http://localhost:8080/demo">http://localhost:8080/demo</a> ，可以看到rails app的首页了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[初识jruby之安装配置jrubyonrails]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-an-zhuang-pei-zhi-jrubyonrails/"/>
    <updated>2014-02-14T23:49:23+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/chu-shi-jrubyzhi-an-zhuang-pei-zhi-jrubyonrails</id>
    <content type="html"><![CDATA[<h3>1. prerequesite</h3>

<p>假设你已经安装好了jruby，并且使用的jdk最好是1.7。</p>

<h3>2. 安装rails</h3>

<p>安装rails4.0.0：</p>

<pre><code>C:\&gt;jruby -S gem install rails -V
</code></pre>

<p>查看安装的rails版本：</p>

<pre><code>C:\&gt;jruby -S rails -v
Rails 4.0.0
</code></pre>

<!-- more -->


<h3>3. 新建一个rails Apps</h3>

<pre><code>C:\&gt;jruby -S rails new demo
</code></pre>

<p>并且取消bundle install，因为使用默认安装的ActiveRecord-JDBC-adapter的master分支版本目前，会导致执行rake db:migrate命令时发生wrong number of arguments calling exec_insert (5 for 3) error错误，所以，修改gemfile使用它的1.3.0.beta2版本（这个步骤是现在的权宜之计，以后肯定不必这么麻烦了。后注：此问题目前已修复)：</p>

<p>如果使用的是sqlite数据库，则将：</p>

<pre><code>gem 'activerecord-jdbcsqlite3-adapter'
</code></pre>

<p>改为：</p>

<pre><code>gem 'activerecord-jdbcsqlite3-adapter', '1.3.0.beta2'
</code></pre>

<p>如果使用的mysql数据库，则将：</p>

<pre><code>gem 'activerecord-jdbcmysql-adapter'
</code></pre>

<p>改为：</p>

<pre><code>gem 'activerecord-jdbcmysql-adapter','1.3.0.beta2'
</code></pre>

<p>然后再进行 jruby -S bundle install 安装gem。</p>

<p>如果使用sqlite数据库，默认配置即可，如果使用mysql数据库，则修改database.yml，以development
环境为例，这里的username，password，host，port按照具体情况进行具体配置：</p>

<pre><code>development:
  adapter: mysql
  encoding: utf8
  reconnect: false
  database: demo_development
  username: user
  password: user_password
  host: localhost
  port: 3306
</code></pre>

<p>最后，启动rails app：</p>

<pre><code>C:\DEMO&gt;jruby -S rails s
</code></pre>

<p>然而此时又出错了：</p>

<pre><code>OpenSSL::Cipher::CipherError: Illegal key size: possibly you need to install Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for your JRE
</code></pre>

<p>要求安装JCE，到Oracle 官网上下载一个UnlimitedJCEPolicyJDK7.zip文件，解压缩后包含两个jar文件：local_policy.jar和US_export_policy.jar。将这两个文件替换$JAVA_HOME/jre/lib/security目录下两个同名文件，如，在我的电脑是就是替换C:\Program Files\Java\jdk1.7.0_25\jre\lib\security目录下两个文件。替换后，重启电脑。</p>

<p>此时，再jruby -S rails s启动app则可以正确运行了。</p>

<h3>4. 配置java类路径</h3>

<p>如果需要在rails中使用java外部类，则需要配置一下$CLASSPATH，首先，假设我们将需要的java类都放在rails_root/lib/java文件夹下。那么就在environment.rb文件中require File.expand_path(&lsquo;../
application&rsquo;, __FILE__)后添加代码：</p>

<pre><code>require 'java'
$CLASSPATH &lt;&lt; File.join(Rails.root, 'lib','java')
</code></pre>

<p>这样，如果在该目录下有一个编译好的java类example.MyClass在rails中就可以像这样使用该类：</p>

<pre><code>mc=Java::example.MyClass.new
</code></pre>

<p>如果还使用了外部jar，则还要添加引用jar的代码，同样在environment.rb文件中添加：</p>

<pre><code>Dir.glob(File.join(Rails.root, 'lib','java',"**","*.jar")).each do |jar| 
    $CLASSPATH &lt;&lt; jar
end
</code></pre>

<p>所以最终environment.rb文件看起来是这样的：</p>

<blockquote><p>environment.rb</p></blockquote>

<pre><code># Load the rails application
require File.expand_path('../application',__FILE__)
requrie 'java'
$CLASSPATH&lt;&lt;File.join(Rails.root,'lib','java')
Dir.glob(File.join(Rails.root,'lib','java','**','*.jar)).each do |jar|
    $CLASSPATH &lt;&lt; jar
end

Demo::Application.initialize!
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在一组方法中共享变量]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/zai-%5B%3F%5D-zu-fang-fa-zhong-gong-xiang-bian-liang/"/>
    <updated>2014-02-14T23:46:19+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/zai-[?]-zu-fang-fa-zhong-gong-xiang-bian-liang</id>
    <content type="html"><![CDATA[<pre><code>lambda{
    shared=10
    Kernel.send :define_method, :counter do
        shared+=1
    end
    Kernel.send :define_method, :show do
        shared
    end
}.call

show #=&gt;10
3.times{counter}
show #=&gt;13
</code></pre>

<!-- more -->

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 在javascript中使用ruby对象]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-zai-javascriptzhong-shi-yong-rubydui-xiang/"/>
    <updated>2014-02-14T23:40:15+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-zai-javascriptzhong-shi-yong-rubydui-xiang</id>
    <content type="html"><![CDATA[<h3>1.在javascript中使用ruby简单对象</h3>

<p>如，需要将ruby对象转换成javascript的简单变量：</p>

<pre><code>&lt;%= javascript_tag do %&gt;
  url = '&lt;%= j products_url %&gt;';
&lt;% end %&gt;
</code></pre>

<p>此时的&lt;%=  %>是由引号包裹的。rails的j方法是为了正确地转义ruby对象从而嵌入javascript中。</p>

<!-- more -->


<h3>2.在javascript中使用ruby复杂对象</h3>

<p>公共桥梁显然是json，但要正确地转义json就需要raw方法：</p>

<pre><code>&lt;%= javascript_tag do %&gt;
  products = &lt;%= raw Product.limit(10).to_json %&gt;
&lt;% end %&gt;
</code></pre>

<p>此时&lt;%= %>无引号包裹。</p>

<h3>3.Gon gem</h3>

<p>如果有大量的ruby对象需要在javascript中使用，这种方法就不好了。Gon就是为了解决这个问题。</p>

<p>首先在gemfile中添加gon：</p>

<pre><code>gem 'gon'
</code></pre>

<p>然后在/app/views/layouts/application.html.erb文件中包含gon：</p>

<pre><code>&lt;head&gt;
  &lt;title&gt;Store&lt;/title&gt;
  &lt;%= include_gon %&gt;
  &lt;%= stylesheet_link_tag    "application", media: "all" %&gt;
  &lt;%= javascript_include_tag "application" %&gt;
  &lt;%= csrf_meta_tag %&gt;
&lt;/head&gt;
</code></pre>

<p>然后在controller中就可以以这种形式为javascript对象赋值：</p>

<pre><code>gon.variable_name = variable_value
# or new syntax
gon.push({
  :user_id =&gt; 1,
  :user_role =&gt; "admin"
})
gon.push(any_object) # any_object with respond_to? :each_pair
</code></pre>

<p>例如：</p>

<pre><code>class ProductsController &lt; ApplicationController
    def index
        gon.products = Product.limit(10)
    end
end
</code></pre>

<p>在js中获取变量的方法：</p>

<pre><code>gon.variable_name
</code></pre>

<p>即：</p>

<pre><code>go.products
</code></pre>

<h3>参考文献</h3>

<ul>
<li><a href="https://github.com/gazay/gon">gon</a></li>
<li><a href="http://railscasts.com/episodes/324-passing-data-to-javascript?view=asciicast">Passing data to javascript</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails URL路由]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-urllu-you/"/>
    <updated>2014-02-14T23:26:35+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-urllu-you</id>
    <content type="html"><![CDATA[<p>rails URL路由的最权威文档当然是其官方站点Rails routing from the outside in，我这里只提几个文档中常用的要点。</p>

<h3>1.CRUB</h3>

<p>由resources建立的资源，是rails中最常见的路由方式，不用多说。</p>

<pre><code>resources :photos
</code></pre>

<!-- more -->


<h3>2.单例资源</h3>

<p>单例资源也比较常用，官方文档上举的例子很形象也很常见，用户user需要拥有一个profile资源，而每个用户必然只有一个profile，所以如果生成类似/profiles/:id的URL显然是不美观的，此时就需要单例资源，单例资源的生成使用的是单数形式方法resource：</p>

<pre><code>resource :profile
</code></pre>

<p>该语句生成的路由如下：</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=97c9415095dda144de096cb7828ca19f/902397dda144ad34c29c62c4d2a20cf431ad8556.jpg?referer=68c064fc8e5494eede353a29e34c&amp;x=.jpg" alt="image" /></p>

<h3>3.嵌入的路由</h3>

<p>适用于某种资源必须依赖于另一种资源才有意义，比如某些comment必然在针对的event下存在，所以comment就必须依赖于event。</p>

<pre><code>resources :events do
    resources :comments
end
</code></pre>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=8d06f6a8b4fd5266a32b3c119b23e616/38dbb6fd5266d01605e9646b952bd40734fa3584.jpg?referer=12da45f1bb014a90d829728d739b&amp;x=.jpg" alt="image" /></p>

<p>对应的也自动生成了诸如event_comment_path之类的url 帮助方法。对于嵌入式资源，官方建议不要超过两层。最简单的理由，路由层次过深，除了增加逻辑的复杂度外，也得不到任何好处。</p>

<h3>4.namespace和scope路由</h3>

<p>以下规则同时适用于resources和controller。</p>

<p>比如，如果想要在特定的命名空间(admin)下访问某个资源(post)，这时就可以利用namespace。</p>

<pre><code>namespace :admin do
  resources :posts
end
</code></pre>

<p>此时，处理该路由的controller是Admin::PostsController，体现在rails工程中是在controller文件夹下的admin文件夹下的posts_controller.rb文件。而产生的路由全部以/admin开头：</p>

<p><img src="http://g.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=b8309d15d2160924d825a21ee43c44c7/5366d0160924ab1899e61b7437fae6cd7a890b84.jpg?referer=b7cc85e3f403738d875d3812759b&amp;x=.jpg" alt="image" /></p>

<p>一言以蔽之，由namespace产生的资源路由，controller和url都由该namespace作“前缀”。</p>

<p>如果需要让资源路由没有前缀，而又希望该路由url被某个模块下的controller受理，那么就需要使用
scope。</p>

<pre><code>scope module: 'admin' do
  resources :posts
end
</code></pre>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=8e21687d79ec54e745ec1a1b8903ea6d/b90e7bec54e736d18030694b99504fc2d5626956.jpg?referer=7e1763ad9e82d158e2956c81d74c&amp;x=.jpg" alt="image" /></p>

<p>由rake routes输出可以看出，路由url没有了admin前缀，而posts资源都由admin模块下的Admin::PostsController受理。</p>

<p>一言以蔽之，带module的scope产生的资源路由，路由url无“前缀”，controller以module指定模块为“前缀”。</p>

<p>反过来，如果希望给资源附加一个前缀，而由普通controller受理该url，则需要另一种形式的scope：</p>

<pre><code>scope '/admin' do
  resources :posts
end
</code></pre>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6c4451220db30f24319aec06f8aea07e/9f510fb30f2442a7cefe07e6d343ad4bd0130284.jpg?referer=91d5f909d8b44aed00598ad46e9b&amp;x=.jpg" alt="image" /></p>

<p>此时，资源posts每个url都附加了/admin为前缀，而受理这些url的是PostsController。</p>

<p>一言以蔽之，这种形式的scope产生的资源路由，路由url有“前缀”，controller无“前缀”。</p>

<p>另外，这种形式的路由还有一种简写：</p>

<pre><code>resources :posts, path: '/admin/posts'
</code></pre>

<p>该简写和使用scope产生的结果完全一样。不过，path还有另外的用途，如果保持controller及url helper不变，仅仅希望为url路由中的资源改个名称，这时path就派上用场了：</p>

<pre><code>resources :posts, path: '/articles'
</code></pre>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=596a1640ca95d143de76e42643cbf33f/d833c895d143ad4bcadebc8380025aafa50f0684.jpg?referer=35be44a7b11c87018fa186d6629b&amp;x=.jpg" alt="image" /></p>

<h3>5.新增RESTful动词</h3>

<p>以下规则同样适用于resources和controller。</p>

<pre><code>resources :photos do
  get 'preview', on: :member
end
</code></pre>

<p>该语句为某个特定photo新增了一个preview动作，该动作是一个get请求，默认photos_controller中存在一个preview方法处理该动作。</p>

<p>类似的，如果需要为photos集合新增一个动词，只需要将语句中member改成collection即可。</p>

<p>如果，需要为特定photo增加多个动词preview1和preview2，改成下面的形式即可，甚至可以指定
controller中处理该请求的方法，以及自定义url helper：</p>

<pre><code>resources :photos do
  member do
    get 'preview1'=&gt;:pre1, as:"p1"
    get 'preview2'=&gt;:pre2, as:"p2"
  end
end
</code></pre>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=15e98dd4db33c895a27e987ee12802cd/43a7d933c895d143b7861e6071f082025baf0784.jpg?referer=5020e10089d4b31ca92ba08b619b&amp;x=.jpg" alt="image" /></p>

<h3>6.非resourceful路由</h3>

<h4>使用参数：</h4>

<pre><code>controller :photos do
  get 'check/:id',:to=&gt;:check
end
</code></pre>

<p>产生的路由输出如下：</p>

<pre><code>GET /check/:id(.:format) photos#check
</code></pre>

<p>在执行该get请求如/check/23，后photos_controller的check方法受理该请求，并在params中将参数设置为23。</p>

<h4>限制参数格式：</h4>

<pre><code>get 'photos/:id', to: 'photos#show', constraints: { id: /[A-Z]\d{5}/ }
</code></pre>

<p>该路由规则能接受/photos/A12345却不能接受/photos/893。</p>

<h4>指定请求的默认类型：</h4>

<pre><code>get 'articles/:id', to: 'articles#show', defaults: { format: 'xml' }
</code></pre>

<p>若get请求/articles/2，该路由规则会自动将params的params[:format]置为&#8221;xml&#8221;。</p>

<p>该方法仅仅是在请求未指定format时指定默认类型，如果需要某个controller仅接受某些格式的请求如xml和json，则可以在该controller类定义中添加如下代码，这在书写api时常常用到：</p>

<pre><code>respond_to :json, :xml
</code></pre>

<h4>更换资源的controller：</h4>

<p>如果不希望为某个资源使用默认的controller，则：</p>

<pre><code>resources :photos, controller: 'images'
</code></pre>

<p>此时photos资源的所有请求都由images_controller受理，而photos的路由url和url helper都不变。</p>

<h4>限制资源的默认动作：</h4>

<p>如果仅希望使用资源的部分动作，如仅使用资源photos的index和show动作：</p>

<pre><code>resources :photos, only: [:index, :show]
</code></pre>

<p>或者使用除了destroy动作外的所有默认动作：</p>

<pre><code>resources :photos, except: :destroy
</code></pre>

<p>还可以使用:all（所有默认动作），:none（没有默认动作）：</p>

<pre><code>resources :photos, :only=&gt;:none
</code></pre>

<h4>为new和edit的url路由改名：</h4>

<pre><code>resources :photos, path_names: { new: 'make', edit: 'change' }
</code></pre>

<p>产生的新路由为：</p>

<pre><code>/photos/make
/photos/1/change
</code></pre>

<p>而此时受理该路由的方法仍为new和edit，即controller中的方法并未改名。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 填充数据库初始数据]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-tian-chong-shu-ju-ku-chu-shi-shu-ju/"/>
    <updated>2014-02-14T23:21:46+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-tian-chong-shu-ju-ku-chu-shi-shu-ju</id>
    <content type="html"><![CDATA[<!-- more -->


<p>利用db/seeds.rb文件将数据库的initial data填入即可，该文件位于rails环境中，可以访问railsApp中任何类和方法。如，填充product表的初始数据：</p>

<blockquote><p>seeds.rb</p></blockquote>

<pre><code>5.times do |i|
    Product.create(name:"Product ##{i}",description:"A product")
end
</code></pre>

<p>使用rake命令填充数据：</p>

<pre><code>rake db:seed
</code></pre>

<p>或者从头调用所有migration创建空的数据库并自动seed填充数据库：</p>

<pre><code>rake db:setup
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 配置使用jquery-file-upload  step by step]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-pei-zhi-shi-yong-jquery-file-upload-step-by-step/"/>
    <updated>2014-02-14T23:11:06+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-pei-zhi-shi-yong-jquery-file-upload-step-by-step</id>
    <content type="html"><![CDATA[<p>一步步安装使用jquery-file-upload</p>

<!-- more -->


<h3>1.安装Gem</h3>

<p>在gemfile中添加jquery-fileupload-rails和paperclip的gem：</p>

<pre><code>gem "jquery-fileupload-rails"
gem 'paperclip'
</code></pre>

<h3>2.在app/assets/application.js添加</h3>

<pre><code>//= require jquery-fileupload
</code></pre>

<h3>3.在app/assets/stylesheets/application.css添加</h3>

<pre><code>*= require jquery.fileupload-ui
</code></pre>

<h3>4.创建Picture数据表</h3>

<pre><code>rails g model Picture avatar:attachment
rake db:migrate
</code></pre>

<p>pictures表的avatar属性代表上传的文件对象。</p>

<p>修改picture.rb的内容：</p>

<pre><code>class Picture &lt; ActiveRecord::Base
    has_attached_file :avatar

    include Rails.application.routes.url_helpers

    def to_json_picture
        {
            'name'=&gt;read_attribute(:avatar_file_name),
            'size'=&gt;read_attribute(:avatar_file_size),
            'url'=&gt;avatar.url(:original),
            'delete_url'=&gt;picture_path(self),
            'delete_type'=&gt;'DELETE'
        }
    end
end
</code></pre>

<p>在model中，使用类方法has_attached_file指明文件对象是avatar，并且定义了to_json_picture方法，该方法将picture对象转换成一个hash，在jquery-fileupload和server的交互中被转变为json数据。</p>

<h3>5.创建view</h3>

<p>只需要创建一个上传界面index.html.erb，自定义你自己的view时，仅需要将form_for Picture.new和f.file_field :avatar修改为自己model即可，其他内容都可以直接copy-paste。</p>

<div><script src='https://gist.github.com/9017226.js?file=jquery_template.html.erb'></script>
<noscript><pre><code>&lt;div class=&quot;container&quot;&gt;
  &lt;h2&gt;Upload file&lt;/h2&gt;
  &lt;%= form_for Picture.new, :html =&gt; { :multipart =&gt; true, :id =&gt; &quot;fileupload&quot;  } do |f| %&gt;
    &lt;!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload --&gt;
    &lt;div class=&quot;row fileupload-buttonbar&quot;&gt;
      &lt;div class=&quot;span7&quot;&gt;
        &lt;!-- The fileinput-button span is used to style the file input field as button --&gt;
        &lt;span class=&quot;btn btn-success fileinput-button&quot;&gt;
          &lt;i class=&quot;icon-plus icon-white&quot;&gt;&lt;/i&gt;
          &lt;span&gt;Add files...&lt;/span&gt;
          &lt;%= f.file_field :avatar %&gt;
        &lt;/span&gt;
        &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary start&quot;&gt;
          &lt;i class=&quot;icon-upload icon-white&quot;&gt;&lt;/i&gt;
          &lt;span&gt;Start upload&lt;/span&gt;
        &lt;/button&gt;
        &lt;button type=&quot;reset&quot; class=&quot;btn btn-warning cancel&quot;&gt;
          &lt;i class=&quot;icon-ban-circle icon-white&quot;&gt;&lt;/i&gt;
          &lt;span&gt;Cancel upload&lt;/span&gt;
        &lt;/button&gt;
        &lt;button type=&quot;button&quot; class=&quot;btn btn-danger delete&quot;&gt;
          &lt;i class=&quot;icon-trash icon-white&quot;&gt;&lt;/i&gt;
          &lt;span&gt;Delete&lt;/span&gt;
        &lt;/button&gt;
        &lt;input type=&quot;checkbox&quot; class=&quot;toggle&quot;&gt;
      &lt;/div&gt;
      &lt;div class=&quot;span5&quot;&gt;
        &lt;!-- The global progress bar --&gt;
        &lt;div class=&quot;progress progress-success progress-striped active fade&quot;&gt;
          &lt;div class=&quot;bar&quot; style=&quot;width:0%;&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- The loading indicator is shown during image processing --&gt;
    &lt;div class=&quot;fileupload-loading&quot;&gt;&lt;/div&gt;
    &lt;br&gt;
    &lt;!-- The table listing the files available for upload/download --&gt;
    &lt;table class=&quot;table table-striped&quot;&gt;&lt;tbody class=&quot;files&quot; data-toggle=&quot;modal-gallery&quot; data-target=&quot;#modal-gallery&quot;&gt;&lt;/tbody&gt;
    &lt;/table&gt;
  &lt;% end %&gt;

&lt;/div&gt;
&lt;script&gt;
  var fileUploadErrors = {
  maxFileSize: &#39;File is too big&#39;,
  minFileSize: &#39;File is too small&#39;,
  acceptFileTypes: &#39;Filetype not allowed&#39;,
  maxNumberOfFiles: &#39;Max number of files exceeded&#39;,
  uploadedBytes: &#39;Uploaded bytes exceed file size&#39;,
  emptyResult: &#39;Empty file upload result&#39;
  };
&lt;/script&gt;

&lt;!-- The template to display files available for upload --&gt;
&lt;script id=&quot;template-upload&quot; type=&quot;text/x-tmpl&quot;&gt;
  {% for (var i=0, file; file=o.files[i]; i++) { %}
  &lt;tr class=&quot;template-upload fade&quot;&gt;
    &lt;td class=&quot;preview&quot;&gt;&lt;span class=&quot;fade&quot;&gt;&lt;/span&gt;&lt;/td&gt;
    &lt;td class=&quot;name&quot;&gt;&lt;span&gt;{%=file.name%}&lt;/span&gt;&lt;/td&gt;
    &lt;td class=&quot;size&quot;&gt;&lt;span&gt;{%=o.formatFileSize(file.size)%}&lt;/span&gt;&lt;/td&gt;
    {% if (file.error) { %}
    &lt;td class=&quot;error&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;label label-important&quot;&gt;{%=locale.fileupload.error%}&lt;/span&gt; {%=locale.fileupload.errors[file.error] || file.error%}&lt;/td&gt;
    {% } else if (o.files.valid &amp;&amp; !i) { %}
    &lt;td&gt;
      &lt;div class=&quot;progress progress-success progress-striped active&quot;&gt;&lt;div class=&quot;bar&quot; style=&quot;width:0%;&quot;&gt;&lt;/div&gt;&lt;/div&gt;
    &lt;/td&gt;
    &lt;td class=&quot;start&quot;&gt;{% if (!o.options.autoUpload) { %}
      &lt;button class=&quot;btn btn-primary&quot;&gt;
        &lt;i class=&quot;icon-upload icon-white&quot;&gt;&lt;/i&gt;
        &lt;span&gt;{%=locale.fileupload.start%}&lt;/span&gt;
      &lt;/button&gt;
      {% } %}&lt;/td&gt;
    {% } else { %}
    &lt;td colspan=&quot;2&quot;&gt;&lt;/td&gt;
    {% } %}
    &lt;td class=&quot;cancel&quot;&gt;{% if (!i) { %}
      &lt;button class=&quot;btn btn-warning&quot;&gt;
        &lt;i class=&quot;icon-ban-circle icon-white&quot;&gt;&lt;/i&gt;
        &lt;span&gt;{%=locale.fileupload.cancel%}&lt;/span&gt;
      &lt;/button&gt;
      {% } %}&lt;/td&gt;
  &lt;/tr&gt;
  {% } %}
&lt;/script&gt;
&lt;!-- The template to display files available for download --&gt;
&lt;script id=&quot;template-download&quot; type=&quot;text/x-tmpl&quot;&gt;
  {% for (var i=0, file; file=o.files[i]; i++) { %}
    &lt;tr class=&quot;template-download fade&quot;&gt;
      {% if (file.error) { %}
        &lt;td&gt;&lt;/td&gt;
        &lt;td class=&quot;name&quot;&gt;&lt;span&gt;{%=file.name%}&lt;/span&gt;&lt;/td&gt;
        &lt;td class=&quot;size&quot;&gt;&lt;span&gt;{%=o.formatFileSize(file.size)%}&lt;/span&gt;&lt;/td&gt;
        &lt;td class=&quot;error&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;label label-important&quot;&gt;{%=locale.fileupload.error%}&lt;/span&gt; {%=locale.fileupload.errors[file.error] || file.error%}&lt;/td&gt;
        {% } else { %}
        &lt;td class=&quot;preview&quot;&gt;{% if (file.thumbnail_url) { %}
          &lt;a href=&quot;{%=file.url%}&quot; title=&quot;{%=file.name%}&quot; rel=&quot;gallery&quot; download=&quot;{%=file.name%}&quot;&gt;&lt;img src=&quot;{%=file.thumbnail_url%}&quot;&gt;&lt;/a&gt;
          {% } %}&lt;/td&gt;
        &lt;td class=&quot;name&quot;&gt;
          &lt;a href=&quot;{%=file.url%}&quot; title=&quot;{%=file.name%}&quot; rel=&quot;{%=file.thumbnail_url&amp;&amp;&#39;gallery&#39;%}&quot; download=&quot;{%=file.name%}&quot;&gt;{%=file.name%}&lt;/a&gt;
        &lt;/td&gt;
        &lt;td class=&quot;size&quot;&gt;&lt;span&gt;{%=o.formatFileSize(file.size)%}&lt;/span&gt;&lt;/td&gt;
        &lt;td colspan=&quot;2&quot;&gt;&lt;/td&gt;
        {% } %}
      &lt;td class=&quot;delete&quot;&gt;
        &lt;button class=&quot;btn btn-danger&quot; data-type=&quot;{%=file.delete_type%}&quot; data-url=&quot;{%=file.delete_url%}&quot;&gt;
          &lt;i class=&quot;icon-trash icon-white&quot;&gt;&lt;/i&gt;
          &lt;span&gt;{%=locale.fileupload.destroy%}&lt;/span&gt;
        &lt;/button&gt;
        &lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; value=&quot;1&quot;&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    {% } %}
&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
  $(function () {
      // Initialize the jQuery File Upload widget:
      $(&#39;#fileupload&#39;).fileupload();
      // 
      // Load existing files:
      $.getJSON($(&#39;#fileupload&#39;).prop(&#39;action&#39;), function (files) {
        var fu = $(&#39;#fileupload&#39;).data(&#39;blueimpFileupload&#39;), 
          template;
        fu._adjustMaxNumberOfFiles(-files.length);
        console.log(files);
        template = fu._renderDownload(files)
          .appendTo($(&#39;#fileupload .files&#39;));
        // Force reflow:
        fu._reflow = fu._transition &amp;&amp; template.length &amp;&amp;
          template[0].offsetWidth;
        template.addClass(&#39;in&#39;);
        $(&#39;#loading&#39;).remove();
      });

  });
&lt;/script&gt;
</code></pre></noscript></div>


<h3>6.创建controller</h3>

<pre><code>rails g controller pictures index create destroy
</code></pre>

<p>&ndash;</p>

<pre><code>class PicturesController &lt; ApplicationController
  def index
    @pictures = Picture.all

    respond_to do |format|
      format.html # index.html.erb
      format.json { render json: @pictures.map{|picuture| picuture.to_json_picture } }
    end
  end

  # POST /picture
  # POST /picture.json
  def create
    @picture = Picture.new(params[:picture])

    respond_to do |format|
      if @picture.save
        format.html {
          render :json =&gt; [@picture.to_json_picture].to_json,
          :content_type =&gt; 'text/html',
          :layout =&gt; false
        }
        format.json { render json: {files: [@picture.to_json_picture]}, status: :created, location: @picture }
      else
        format.html { render action: "new" }
        format.json { render json: @picture.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /picture/1
  # DELETE /picture/1.json
  def destroy
    @picture = Picture.find(params[:id])
    @picture.destroy

    respond_to do |format|
      format.html { redirect_to picture_url }
      format.json { head :no_content }
    end
  end
end
</code></pre>

<h3>7.效果图</h3>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=794ee559c45c1038207ecec7822ae22e/342ac65c103853436bec62629113b07eca808856.jpg?referer=457c5546e7dde711bec576c6e84c&amp;x=.jpg" alt="image" /></p>

<p>这就是最终结果了，如果想要达到jqeury-fileupload Demo中漂亮的结果，如下图，就需要使用Twitter-bootstrap或者自己写写CSS了。</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=ff26dca4932397ddd279980169b9c38a/0dd7912397dda144372a89f1b0b7d0a20cf48656.jpg?referer=354f23adb68f8c54bac4f01fe24c&amp;x=.jpg" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails Eagerloading]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-eagerloading/"/>
    <updated>2014-02-14T23:05:33+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-eagerloading</id>
    <content type="html"><![CDATA[<p>若存在如下Post model：</p>

<pre><code>class Post &lt; ActiveRecord::Base
    belongs_to :author
    has_many :comments
end
</code></pre>

<p>使用下面的循环加载数据时产生了N+1查询问题：</p>

<pre><code>Post.all.each do |post|
  puts "Post:            " + post.title
  puts "Written by:      " + post.author.name
  puts "Last comment on: " + post.comments.first.created_on
end
</code></pre>

<!-- more -->


<p>首先，解决author获取问题：</p>

<pre><code>Post.includes(:author).each do |post|
</code></pre>

<p>然后解决comments加载：</p>

<pre><code>Post.includes(:author, :comments).each do |post|
</code></pre>

<p>带条件的eager loading：</p>

<pre><code>Post.includes([:author, :comments]).where(['comments.approved = ?', true]).all
</code></pre>

<p>多态关系的eager laoding</p>

<pre><code>class Address &lt; ActiveRecord::Base
    belongs_to :addressable, :polymorphic=&gt;true
end
Address.includes(:addressable)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails 创建数据库索引]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-chuang-jian-shu-ju-ku-suo-yin/"/>
    <updated>2014-02-14T23:01:32+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-chuang-jian-shu-ju-ku-suo-yin</id>
    <content type="html"><![CDATA[<p>以经典的customer-order为例</p>

<ol>
<li>在创建数据表时直接创建索引</li>
</ol>


<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=d1364df8a41ea8d38e227401a7314173/838ba61ea8d3fd1fa3f85879324e251f94ca5f84.jpg?referer=3f089ea983cb39db98d75366999a&amp;x=.jpg" alt="image" /></p>

<p>查看order的migration文件，rails自动为我们添加了index：</p>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=a6f85879324e251fe6f7e4fd97bdb82a/960a304e251f95ca360468f5cb177f3e66095284.jpg?referer=b5aa1f650b24ab18b901d5079e9a&amp;x=.jpg" alt="image" /></p>

<!-- more -->


<ol>
<li>手动附加索引</li>
</ol>


<p>此时创建数据表是以普通字段创建的外键</p>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=84258bc6cbea15ce45eee00c863b4bce/5ab5c9ea15ce36d35227667338f33a87e950b156.jpg?referer=a621687d79ec54e718fb2f2eff4c&amp;x=.jpg" alt="image" /></p>

<p>如果需要创建索引，就需要手动新建一个migration来添加索引：</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=d982ea6c97cad1c8d4bbfc224f051634/241f95cad1c8a78620dbb04d6509c93d71cf5084.jpg?referer=e0e8646b952bd4071bd0e7cd909a&amp;x=.jpg" alt="image" /></p>

<p>修改migration文件，手动添加index</p>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=97c5064e72cf3bc7ec00cde9e13bcb9c/c83d70cf3bc79f3d08101e73b8a1cd11738b2984.jpg?referer=6e9dc0c00d2442a7f719c995979a&amp;x=.jpg" alt="image" /></p>

<ol>
<li>many-to-many关系中添加index</li>
</ol>


<p>以man-address为例，直接创建中间表并不会自动添加索引，所以需要在中间表内手动添加索引：</p>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=b5993923372ac65c63056676cbc9c32c/e850352ac65c1038dc5d2b81b0119313b07e8956.jpg?referer=c0dc05118735e5ddc93b90eff74c&amp;x=.jpg" alt="image" /></p>

<ol>
<li>建议</li>
</ol>


<p>所有的外键最好都添加索引。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails使用devise验证用户]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-deviseyan-zheng-yong-hu/"/>
    <updated>2014-02-14T22:46:34+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/railsshi-yong-deviseyan-zheng-yong-hu</id>
    <content type="html"><![CDATA[<h3>安装配置devise</h3>

<p>在gemfile中添加一行：</p>

<pre><code>gem 'devise'
</code></pre>

<p>执行bundle install后，需要安装devise到工程：</p>

<pre><code>rails generate devise:install
</code></pre>

<p>创建验证用户model，通常用user，也可以使用其他名称：</p>

<pre><code>rails generate devise user
rake db:migrate
</code></pre>

<!-- more -->


<p>查看models文件夹下devise创建了user.rb文件：</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=f2f25a60612762d0843ea4ba90d779c7/8b13632762d0f703ca91709f0afa513d2697c556.jpg?referer=7e3304592a34349b2d115bb5234c&amp;x=.jpg" alt="image" /></p>

<p>devise方法来自Devise gem，其中默认启用了database_authenticatable,registerable等模块，注释部分列出了其他模块默认未启用，根据devise文档按需要使能。</p>

<p>attr_accessible定义的属性可以被create, update_attributes使用，未在这里定义的属性会引发这两个方法的 mass-assignment异常。</p>

<p>查看路由文件 routes.rb，devise gem在创建model时在路由文件中添加了： <code>devise_for :users</code></p>

<p>执行rake routes可以看到devise创建的url：</p>

<p><img src="http://g.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=4a985b9df21f3a295ec8d5cba91ecd0c/95eef01f3a292df526325656be315c6035a87384.jpg?referer=0fdbb04d6509c93d5ee53ac7bd9a&amp;x=.jpg" alt="image" /></p>

<p>注意devise gem提供的账户注销和用户退出登陆都是默认使用的DELETE方法，该url设计常导致编码出错，但它确是遵循了RESTful规范，留意下即可。</p>

<p>在需要的页面上添加注册、登陆的代码（我添加在application.html.erb中yield语句上方）：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6ae4814e249759ee4e5060ce82c0322b/503d269759ee3d6d37e5628841166d224f4ade56.jpg?referer=77d0e6a0d739b60014d93a871a4c&amp;x=.jpg" alt="image" /></p>

<p>rails server启动服务器，即可查看注册登陆页面：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=e7392f8d9b25bc312f5d019d6ee4fc8c/e1fe9925bc315c60fe6491ac8fb1cb1348547784.jpg?referer=ba03f4b49d3df8dcff2abba1b19a&amp;x=.jpg" alt="image" /></p>

<h3>devise提供的常用method</h3>

<pre><code>* authenticate_user!，验证用户是否登陆，常用于before_filter: `before_filter :authenticate_user!`. 另，如果你创建的devise model叫admin，那么该方法就是authenticate_admin!，以下方法同理。这又是ruby玩的一个小把戏了。
* user_signed_in?，当前是否有登陆用户
* current_user， 获取当前登陆用户
* user_session, 用户session，类似于session，也是一个hash表，可以用来保存用户特有的数据
* after_sign_in_path_for和after_sign_out_path_for方法指定用户登入/登出后的跳转url.
</code></pre>

<h3>自定义views</h3>

<p>devise gem提供了足够功能的用户验证，但是由上图可见，其自带的view未免太过简单。如果需要自定义视图，就需要将devise默认的view拷贝到rails工程：</p>

<pre><code>rails generate devise:views
</code></pre>

<p><img src="http://h.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=ff4c4851700e0cf3a4f74efe3a7d8322/9922720e0cf3d7ca14d5da35f01fbe096b63a956.jpg?referer=fc0d600dc880653822fd9123174c&amp;x=.jpg" alt="image" /></p>

<p>该命令将devise的views复制到工程目录app/views下，分类为多个文件夹。修改需要的view模板就能够改变对应界面。</p>

<h3>自定义controller</h3>

<ul>
<li><p>如果需要自定义controller，如Devise::SessionController：</p>

<pre><code>  class Admins::SessionsController &lt; Devise::SessionsController
  end
</code></pre></li>
<li><p>在路由文件routes.rb中更新配置，告诉devise使用新的controller</p>

<pre><code>  devise_for :users, :controllers =&gt; { :sessions =&gt; "admins/sessions" }
</code></pre></li>
<li><p>更新了controller后，在app/views/devise/sessions下的views不会再被使用，所以，还需要将这部分views复制到app/views/admins/sessions下，或者在该目录下建立新的views。</p></li>
</ul>


<h3>邮件确认</h3>

<p>如果需要更安全一点的注册验证，可以使用邮件确认方式。</p>

<p>首先，修改user.rb文件，启用devise的confirmable模块：</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=7f58226cbc096b6385195e553c08f679/f31fbe096b63f6241e7edc408544ebf81a4ca356.jpg?referer=e2c37137af3459829c9dd0a20d4c&amp;x=.jpg" alt="image" /></p>

<p>在数据表users中新加字段：</p>

<pre><code>rails g migration add_confirmable_fields_to_users
</code></pre>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=117edc408544ebf86971643ae9c2a617/0d338744ebf81a4c2b11098ad52a6059252da656.jpg?referer=aabcdc8733adcbef58234b36024c&amp;x=.jpg" alt="image" /></p>

<p>新用户是以邮件的方式确认，所以，需要更改rails的环境配置。rails的环境配置位于config/environments/xxx.rb文件，xx代表develepment/test/production，三个文件的配置选项都十分类似，下面以production环境为例，打开config/environments/production.rb，在最后的end前添加：</p>

<p><img src="http://c.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=464e1e2bcebf6c81f3372ced8c05c008/d058ccbf6c81800ac314734db33533fa838b4784.jpg?referer=0ef348e7a6c27d1efc310ff4a19a&amp;x=.jpg" alt="image" /></p>

<p>配置邮件帐户，在production时rails建议使用邮件服务如Mandrill，这里为了简单，使用gmail帐户示例。</p>

<p>在改文件中继续添加smtp配置，新添加的内容最终如下：</p>

<p><img src="http://a.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=5cf27e4631fa828bd5239de6cd243009/b03533fa828ba61e481f326c4334970a314e5984.jpg?referer=fb19621ddfc451daafe138dba79a&amp;x=.jpg" alt="image" /></p>

<p>最后，修改devise.rb文件</p>

<pre><code>config.mailer_sender = "replyme@126.com" 
</code></pre>

<p>现在，当新用户new@test.com注册后，它会收到一封确认邮件，邮件from: your_gmail_username@gmail.com, to: new@test.com, reply_to: replyme@126.com，邮件包含一个链接，指向用户激活地址。用户点击该链接激活帐户后才能登陆网站。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby线程]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rubyxian-cheng/"/>
    <updated>2014-02-14T22:35:53+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rubyxian-cheng</id>
    <content type="html"><![CDATA[<ol>
<li>创建线程</li>
</ol>


<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=c21f71f885d6277fed12323d18036e0d/a08b87d6277f9e2f4216f84b1d30e924b899f356.jpg?referer=033dd984925298225c240cf33d4c&amp;x=.jpg" alt="image" /></p>

<p>ruby使用在Thread.new创建线程，线程创建后立即返回，线程也同时开始执行。ruby线程可以在创建块中使用外部变量，也可以使用本地变量，值变量在线程内部保存的是本地副本，而引用变量保存的是一个本地引用。</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6326cf43eb24b899da3c793d5e3d6ca8/1e30e924b899a9010716be751f950a7b0208f556.jpg?referer=9cd4abb80846f21f90236b63334c&amp;x=.jpg" alt="image" /></p>

<!-- more -->


<p>新线程中保存num的副本，在线程中更改num并不影响外部num值，而新线程对book的修改会直接影响外部book，在新线程中也可打破作用域直接访问外部count并作出修改。</p>

<p>常用方法</p>

<p><img src="http://d.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6326cf43eb24b899da3c793d5e3d6ca8/1e30e924b899a9010716be751f950a7b0208f556.jpg?referer=9cd4abb80846f21f90236b63334c&amp;x=.jpg" alt="image" /></p>

<p>线程可以将某些信息放在自身的hash表中，让别的线程访问。使用Thread#value（阻塞方法）访问线程执行最后一行代码的结果：</p>

<p><img src="http://e.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=5bdd5f9c74c6a7efbd26a823cdc1de6c/91ef76c6a7efce1b21da3289ad51f3deb58f6584.jpg?referer=1ad267a0ff1f4134b920314ec39a&amp;x=.jpg" alt="image" /></p>

<ol>
<li>Mutex</li>
</ol>


<p>来自ruby-doc的例子</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6cae4a46e7dde711e3d243f397d4bf26/8435e5dde71190efcf0a689ccc1b9d16fcfa6084.jpg?referer=08f9fc89808ba61e86f9fc1fc09a&amp;x=.jpg" alt="image" /></p>

<ol>
<li>Condition Variables</li>
</ol>


<p>来自ruby-doc</p>

<p><img src="http://f.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=9ae2764b99504fc2a65fb000d5e6962c/b8389b504fc2d56230f92aaee51190ef77c66c84.jpg?referer=d94d4f791bd8bc3e9f1f32facc9a&amp;x=.jpg" alt="image" /></p>

<p>在进入临界区并在cv上等待时，会释放该互斥锁mutex，从而才能让别的线程进入临界区，不至于发生死锁。</p>

<ol>
<li>Queue</li>
</ol>


<p>ruby的Queue和java的BlockingQueue十分类似。当Queue为空时，执行pop操作会导致线程挂起等待。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=6cae4a46e7dde711e3d243f397d4bf26/8435e5dde71190efcf0a689ccc1b9d16fcfa6084.jpg?referer=08f9fc89808ba61e86f9fc1fc09a&amp;x=.jpg" alt="image" /></p>

<p>ruby还提供了一个SizedQueue，当达到队列最大长度后，执行push操作时也会导致线程挂起。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails ActiveRecord数据库关系1:n]]></title>
    <link href="http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-n/"/>
    <updated>2014-02-14T22:05:20+08:00</updated>
    <id>http://qjpcpu.github.io/blog/2014/02/14/rails-activerecordshu-ju-ku-guan-xi-1-n</id>
    <content type="html"><![CDATA[<p>如图所示，在demo数据库中有customers和orders两张表。一个customer有多个order，一个order属于一个customer，是一个1:n关系。</p>

<p><img src="http://b.hiphotos.bdimg.com/album/s%3D550%3Bq%3D90%3Bc%3Dxiangce%2C100%2C100/sign=12b2395769600c33f479decd2a772032/f7246b600c3387449229d53f530fd9f9d62aa081.jpg?referer=20537dc4d2a20cf41f87caef009f&amp;x=.jpg" alt="1:n" /></p>

<ol>
<li><p>建立数据表</p>

<pre><code> $ rails g model customer name:string
 $ rails g model order customer_id:integer order_date:datetime
 $ rails g model rake db:migrate
</code></pre></li>
</ol>


<!-- more -->


<ol>
<li>修改model，添加关系</li>
</ol>


<p>在这个1:n关系中，orders拥有外键customer_id，所以需要在order.rb中添加belongs_to关系，相对应在customer.rb中添加has_many关系。注意rails的约定，用rails g命令创建model时使用单数形式（首字母大小写无所谓），得到的数据库的表名是小写的复数形式，model的类名是驼峰形式的单数形式，model文件名是小写单数形式。</p>

<p>类似1:1关系，同样添加inverse_of和dependent选项。此处dependent选项的多了一个delete_all，即:dependent=>:delete_all，表示移除customer时会删除其order的所有数据库记录，但不调用这些order的destroy方法销毁对象。</p>

<blockquote><p>customer.rb</p></blockquote>

<pre><code>class Customer &lt; ActiveRecord::Base
    has_many :orders, :dependent =&gt; :destory, :inverse_of =&gt; :customer
end
</code></pre>

<blockquote><p>order.rb</p></blockquote>

<pre><code>class Order &lt; ActiveRecord::Base
    belongs_to :customer, :inverse_of =&gt; :orders
end
</code></pre>

<ol>
<li>操作关系</li>
</ol>


<p>1：n关系中，在belongs_to关系端添加的方法和1：1中类似，不再赘述。在has_many端添加了如下方法：</p>

<pre><code>collection(force_reload=false)
collection&lt;&lt;(object, ...)
collection.delete(object,...)
collection = objects
collection_singular_ids
collection_singular_ids = ids
collection.clear
collection.empty?
collection.size
collection.find(...)
collection.where(...)
collection.exists?(...)
collection.build(attributes={},...)
collection.create(attributes={})
</code></pre>

<p>使用举例：</p>

<pre><code>c = Customer.first
order_list = c.orders #获取customer c的所有orders
c.orders.delete order_list.first #解除关系
c.orders.clear #清空当前customer的所有order
ar = c.order_ids # =&gt; [1,2,3,4,9,12]
c.orders &lt;&lt; Order.create( order_date:DateTime.now ) #自动保存关系到数据库
c.orders.create(order_date:DateTime.now) #和上一行等同
c.orders.build(order_date:DateTime.now) #需要手动保存该order对象
c.orders.size #获取orders的数量
c.orders.find 6 # 找到customer的orders中id为6的order
c.orders.where :order_date=&gt;DateTime.now
c.orders.where("id &gt; ?",6)
c.orders.empty?
</code></pre>

<ol>
<li>特殊的1：n关系——自引用关联</li>
</ol>


<p>如，一个Employee拥有多个下属，同时也拥有一个主管，这就是一个自引用关系表。</p>

<pre><code>$ rails g model employee name:string manager_id:integer
$ rake db:migrate
</code></pre>

<blockquote><p>employee.rb</p></blockquote>

<pre><code>class Employee &lt; ActiveRecord::Base
    has_many :subordinates, :class_name=&gt;'Employee', :forgeign_key=&gt;'manager_id'
    belongs_to :manager, :class_name=&gt;'Employee'
end
</code></pre>

<p>建立好model后，和普通1：n关系使用方法并无二致：</p>

<pre><code>manger = Emloyee.where(manager_id:nil).first
manager.subordinates.each do |s|
    puts s.name
end
</code></pre>

<ol>
<li>特殊的1：n关系——多态关系</li>
</ol>


<p>多态关系(polymorphic)可以看作是一种特殊的1：n关系。考虑一种情况，Emplyee和Picture是1：n的关系，Product和Picture也是1：n的关系，Company和Picture也是1：n的关系，这样，在Picture的model中就需要添加许多的belongs_to关系，这些belongs_to的功能是非常类似的，多态关系就是为了解决这类重复。</p>

<p>以Picture,Employee,Product为例，首先创建数据表。</p>

<pre><code>$ rails g model picture name:string owner_id:integer owner_type:string
$ rails g model employee
$ rails g model product
</code></pre>

<p>注意在创建pictures时，将所有拥有Picture的model称为owner（也可以取别的名称，如RailsGuide上取名为imageable，个人觉得称为owner更形象），并创建了owner_id和owner_type两个字段，分别表示拥有者model的id和类型。</p>

<p>修改model：</p>

<blockquote><p>product.rb</p></blockquote>

<pre><code>class Product &lt; ActiveRecord::Base
    has_many :picture, :as=&gt;:owner
end
</code></pre>

<blockquote><p>employee.rb</p></blockquote>

<pre><code>class Employee &lt; ActiveRecord::Base
    has_many :pictures, :as=&gt;:owner
end
</code></pre>

<blockquote><p>picture.rb</p></blockquote>

<pre><code>class Picture &lt; ActiveRecord:Base
    belongs_to :owner, :polymorphic =&gt; true
end
</code></pre>

<p>所有拥有picture的model中，都在其has_many关系中添加了选项:as=>:owner，而picture的model中belongs_to关系添加了:polymorphic=>true选项。这样，如果以后还有新的model和picture是1:n的关系，那么在其中写入has_many :pictures,:as=>:owner即可，不必修改Picture的model及其数据表。</p>

<p>关系的使用：</p>

<pre><code>p1=Picture.create name:'picture-1'
p2=Picture.create name:'picture-2'
e=Employee.create
pro=Product.create
e.pictures&lt;&lt;p1
pro.pictures&lt;&lt;p2

p1.owner.class.name # =&gt; 'Employee'
p2.owner.class.naem # =&gt; 'Product'
</code></pre>
]]></content>
  </entry>
  
</feed>
